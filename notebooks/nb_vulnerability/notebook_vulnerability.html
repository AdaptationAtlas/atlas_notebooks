<!doctype html><html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head><meta charset="utf-8"><meta name="generator" content="quarto-1.8.25"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes"><title>Where are investments needed?</title><style>code{white-space:pre-wrap}span.smallcaps{font-variant:small-caps}div.columns{display:flex;gap:min(4vw,1.5em)}div.column{flex:auto;overflow-x:auto}div.hanging-indent{margin-left:1.5em;text-indent:-1.5em}ul.task-list{list-style:none}ul.task-list li input[type=checkbox]{width:.8em;margin:0 .8em .2em -1em;vertical-align:middle}html{-webkit-text-size-adjust:100%}pre>code.sourceCode{white-space:pre;position:relative}pre>code.sourceCode>span{display:inline-block;line-height:1.25}pre>code.sourceCode>span:empty{height:1.2em}.sourceCode{overflow:visible}code.sourceCode>span{color:inherit;text-decoration:inherit}div.sourceCode{margin:1em 0}pre.sourceCode{margin:0}@media screen{div.sourceCode{overflow:auto}}@media print{pre>code.sourceCode{white-space:pre-wrap}pre>code.sourceCode>span{text-indent:-5em;padding-left:5em}}pre.numberSource code{counter-reset:source-line 0}pre.numberSource code>span{position:relative;left:-4em;counter-increment:source-line}pre.numberSource code>span>a:first-child::before{content:counter(source-line);position:relative;left:-1em;text-align:right;vertical-align:baseline;border:none;display:inline-block;-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;padding:0 4px;width:4em}pre.numberSource{margin-left:3em;padding-left:4px}@media screen{pre>code.sourceCode>span>a:first-child::before{text-decoration:underline}}</style><script src="../../site_libs/quarto-nav/quarto-nav.js"></script><script src="../../site_libs/quarto-nav/headroom.min.js"></script><link href="../../images/atlas-icon.svg" rel="icon" type="image/svg+xml"><script src="../../site_libs/clipboard/clipboard.min.js"></script><script src="../../site_libs/quarto-html/quarto.js" type="module"></script><script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script><script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script><script src="../../site_libs/quarto-html/popper.min.js"></script><script src="../../site_libs/quarto-html/tippy.umd.min.js"></script><link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet"><link href="../../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles"><script src="../../site_libs/bootstrap/bootstrap.min.js"></script><link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet"><link href="../../site_libs/bootstrap/bootstrap-53a0a1c902e82bd70cf7a7f6e7189f61.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&amp;display=swap" rel="stylesheet"><script type="module" src="../../site_libs/quarto-ojs/quarto-ojs-runtime.js"></script><link href="../../site_libs/quarto-ojs/quarto-ojs.css" rel="stylesheet"><link rel="stylesheet" href="../../styles.css"><link rel="stylesheet" href="styles.css"></head><body class="nav-fixed fullcontent quarto-light"><div id="quarto-search-results"></div><header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg" data-bs-theme="dark"><div class="navbar-container container-fluid"><div class="navbar-brand-container mx-auto"><a href="https://adaptationatlas.cgiar.org" class="navbar-brand navbar-brand-logo"><img src="../../images/atlas-logo.svg" alt="The Africa Agriculture Adaptation Atlas" class="navbar-logo light-content"> <img src="../../images/atlas-logo.svg" alt="The Africa Agriculture Adaptation Atlas" class="navbar-logo dark-content"></a></div><button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="window.quartoToggleHeadroom&&window.quartoToggleHeadroom()"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarCollapse"><ul class="navbar-nav navbar-nav-scroll ms-auto"><li class="nav-item"><a class="nav-link" href="../../docs/doc_index.html"><i class="bi bi-info-circle" role="img" aria-label="More Information"></i> <span class="menu-text">Documentation</span></a></li><li class="nav-item"><a class="nav-link" href="https://github.com/AdaptationAtlas/atlas_notebooks/issues/new"><span class="menu-text">Report an Issue</span></a></li><li class="nav-item compact"><a class="nav-link" href="https://github.com/AdaptationAtlas/atlas_notebooks"><i class="bi bi-github" role="img" aria-label="GitHub"></i> <span class="menu-text"></span></a></li></ul></div><div class="quarto-navbar-tools"></div></div></nav></header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar"><main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb1" data-startfrom="14" data-source-offset="-33"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line 13"><span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { lang <span class="im">as</span> Lang } <span class="im">from</span> <span class="st">"/helpers/lang.js"</span><span class="op">;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { atlasTOC<span class="op">,</span> atlasHero<span class="op">,</span> downloadButton } <span class="im">from</span> <span class="st">"/helpers/uiComponents.ojs"</span><span class="op">;</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { patchWindowsCache } <span class="im">from</span> <span class="st">"/helpers/data.js"</span><span class="op">;</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co">// Required libraries</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>topojson <span class="op">=</span> <span class="pp">require</span>(<span class="st">"topojson"</span>)<span class="op">;</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>d3 <span class="op">=</span> <span class="pp">require</span>(<span class="st">"d3@6"</span>)<span class="op">;</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co">// Data imports</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>general_translations <span class="op">=</span> <span class="cf">await</span> <span class="fu">FileAttachment</span>(</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"/data/shared/generalTranslations.json"</span><span class="op">,</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>)<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>vulnerability_translations <span class="op">=</span> <span class="cf">await</span> <span class="fu">FileAttachment</span>(</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"/data/vulnerability_notebook/translations.json"</span><span class="op">,</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>)<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co">// Hero image configuration</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>hero_url <span class="op">=</span> <span class="st">"./../../images/default_crop.webp"</span><span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-1-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-1-2" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-1-3" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-1-4" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-1-5" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-1-6" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-1-7" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-1-8" data-nodetype="declaration"></div></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb2" data-startfrom="40" data-source-offset="-62"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line 39"><span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>mapWidth <span class="op">=</span> <span class="kw">typeof</span> width <span class="op">!==</span> <span class="st">'undefined'</span> <span class="op">?</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(width<span class="op">,</span> <span class="dv">625</span>) <span class="op">:</span> <span class="dv">625</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>mapHeight <span class="op">=</span> <span class="dv">600</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a><span class="co">// Mutable state for cross-section reactivity - CENTRALIZED ADMIN SELECTIONS</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>mutable sharedAdmin0 <span class="op">=</span> <span class="kw">null</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>mutable sharedAdmin1 <span class="op">=</span> <span class="kw">null</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>mutable sharedAdmin2 <span class="op">=</span> <span class="kw">null</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a><span class="co"> * Update all shared admin selections synchronously across all sections</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{string|null}</span><span class="co"> admin0 - Admin0 selection value</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{string|null}</span><span class="co"> admin1 - Admin1 selection value  </span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{string|null}</span><span class="co"> admin2 - Admin2 selection value</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">updateSharedAdminSelections</span>(admin0<span class="op">,</span> admin1<span class="op">,</span> admin2) {</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>  mutable sharedAdmin0 <span class="op">=</span> admin0<span class="op">;</span></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>  mutable sharedAdmin1 <span class="op">=</span> admin1<span class="op">;</span></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>  mutable sharedAdmin2 <span class="op">=</span> admin2<span class="op">;</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-2-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-2-2" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-2-3" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-2-4" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-2-5" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-2-6" data-nodetype="declaration"></div></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb3" data-startfrom="70" data-source-offset="-26"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line 69"><span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>languages <span class="op">=</span> [</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">key</span><span class="op">:</span> <span class="st">"en"</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"English"</span><span class="op">,</span> <span class="dt">locale</span><span class="op">:</span> <span class="st">'en-US'</span> }<span class="op">,</span></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">key</span><span class="op">:</span> <span class="st">"fr"</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"Fran√ßais"</span><span class="op">,</span> <span class="dt">locale</span><span class="op">:</span> <span class="st">'fr-FR'</span> }</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>defaultLangKey <span class="op">=</span> {</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> name <span class="op">=</span> <span class="st">"lang"</span><span class="op">;</span></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> list <span class="op">=</span> languages<span class="op">.</span><span class="fu">map</span>((d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">key</span>)<span class="op">;</span></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> defaultKey <span class="op">=</span> <span class="st">"en"</span><span class="op">;</span></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> queryParam <span class="op">=</span> <span class="cf">await</span> Lang<span class="op">.</span><span class="fu">getParamFromList</span>({ name<span class="op">,</span> list })<span class="op">;</span></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> queryParam <span class="op">??</span> defaultKey<span class="op">;</span></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>_lang <span class="op">=</span> Lang<span class="op">.</span><span class="fu">lg</span>(masterLanguage<span class="op">.</span><span class="at">key</span>)</span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>globalSelection <span class="op">=</span> {</span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> {</span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>    <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Sub-Saharan Africa"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Afrique subsaharienne"</span>})<span class="op">,</span></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>    <span class="dt">labelGeneral</span><span class="op">:</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Africa"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Afrique"</span>})<span class="op">,</span></span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-3-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-3-2" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-3-3" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-3-4" data-nodetype="declaration"></div></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb4" data-startfrom="93" data-source-offset="-30"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line 92"><span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>adminRegions <span class="op">=</span> {</span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> {</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>    <span class="dt">labels</span><span class="op">:</span> {</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>      <span class="dt">admin0</span><span class="op">:</span> <span class="fu">_lang</span>(vulnerability_translations<span class="op">.</span><span class="at">country</span>)<span class="op">,</span></span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>      <span class="dt">admin1</span><span class="op">:</span> <span class="fu">_lang</span>(vulnerability_translations<span class="op">.</span><span class="at">region</span>)<span class="op">,</span></span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>      <span class="dt">admin2</span><span class="op">:</span> <span class="fu">_lang</span>(vulnerability_translations<span class="op">.</span><span class="at">subregion</span>)</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a><span class="co">// Get current admin selections as reactive object - now using shared state</span></span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>adminSelections <span class="op">=</span> ({</span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>  <span class="dt">selectAdmin0</span><span class="op">:</span> sharedAdmin0<span class="op">,</span></span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>  <span class="dt">selectAdmin1</span><span class="op">:</span> sharedAdmin1<span class="op">,</span></span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>  <span class="dt">selectAdmin2</span><span class="op">:</span> sharedAdmin2</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-4-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-4-2" data-nodetype="declaration"></div></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb5" data-startfrom="138" data-source-offset="-123"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line 137"><span id="cb5-138"><a href="#cb5-138" aria-hidden="true" tabindex="-1"></a>mutable dataCache <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()</span>
<span id="cb5-139"><a href="#cb5-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-140"><a href="#cb5-140" aria-hidden="true" tabindex="-1"></a><span class="co">// Load S3 configuration</span></span>
<span id="cb5-141"><a href="#cb5-141" aria-hidden="true" tabindex="-1"></a>s3Config <span class="op">=</span> <span class="cf">await</span> <span class="fu">FileAttachment</span>(</span>
<span id="cb5-142"><a href="#cb5-142" aria-hidden="true" tabindex="-1"></a>    <span class="st">"/data/vulnerability_notebook/S3_data.json"</span><span class="op">,</span></span>
<span id="cb5-143"><a href="#cb5-143" aria-hidden="true" tabindex="-1"></a>)<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb5-144"><a href="#cb5-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-145"><a href="#cb5-145" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb5-146"><a href="#cb5-146" aria-hidden="true" tabindex="-1"></a><span class="co"> * Load data with caching to avoid redundant loads</span></span>
<span id="cb5-147"><a href="#cb5-147" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb5-148"><a href="#cb5-148" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{string}</span><span class="co"> key - Unique cache key for this data</span></span>
<span id="cb5-149"><a href="#cb5-149" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{Function}</span><span class="co"> loader - Async function that returns the data to cache</span></span>
<span id="cb5-150"><a href="#cb5-150" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@returns</span><span class="co"> {Promise&lt;*&gt;} Cached data if available, otherwise loaded data</span></span>
<span id="cb5-151"><a href="#cb5-151" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb5-152"><a href="#cb5-152" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">loadDataWithCache</span>(key<span class="op">,</span> loader) {</span>
<span id="cb5-153"><a href="#cb5-153" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (dataCache<span class="op">.</span><span class="fu">has</span>(key)) {</span>
<span id="cb5-154"><a href="#cb5-154" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dataCache<span class="op">.</span><span class="fu">get</span>(key)<span class="op">;</span></span>
<span id="cb5-155"><a href="#cb5-155" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-156"><a href="#cb5-156" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-157"><a href="#cb5-157" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb5-158"><a href="#cb5-158" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> startTime <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb5-159"><a href="#cb5-159" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-160"><a href="#cb5-160" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> <span class="fu">loader</span>()<span class="op">;</span></span>
<span id="cb5-161"><a href="#cb5-161" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-162"><a href="#cb5-162" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> loadTime <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>() <span class="op">-</span> startTime<span class="op">;</span></span>
<span id="cb5-163"><a href="#cb5-163" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-164"><a href="#cb5-164" aria-hidden="true" tabindex="-1"></a>    dataCache<span class="op">.</span><span class="fu">set</span>(key<span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb5-165"><a href="#cb5-165" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data<span class="op">;</span></span>
<span id="cb5-166"><a href="#cb5-166" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb5-167"><a href="#cb5-167" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="vs">`Error loading </span><span class="sc">${</span>key<span class="sc">}</span><span class="vs">:`</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb5-168"><a href="#cb5-168" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb5-169"><a href="#cb5-169" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-170"><a href="#cb5-170" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-171"><a href="#cb5-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-172"><a href="#cb5-172" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb5-173"><a href="#cb5-173" aria-hidden="true" tabindex="-1"></a><span class="co"> * Create DuckDB connection with exposure data parquet file loaded as a view</span></span>
<span id="cb5-174"><a href="#cb5-174" aria-hidden="true" tabindex="-1"></a><span class="co"> * Uses caching to avoid redundant connections</span></span>
<span id="cb5-175"><a href="#cb5-175" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb5-176"><a href="#cb5-176" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@returns</span><span class="co"> {Promise</span><span class="kw">&lt;Object</span><span class="ot">|null</span><span class="kw">&gt;</span><span class="co">} DuckDB client with exposure_data view, or null on failure</span></span>
<span id="cb5-177"><a href="#cb5-177" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb5-178"><a href="#cb5-178" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">createExposureDB</span>() {</span>
<span id="cb5-179"><a href="#cb5-179" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">loadDataWithCache</span>(<span class="st">'exposureDB'</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb5-180"><a href="#cb5-180" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb5-181"><a href="#cb5-181" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> parquetUrl <span class="op">=</span> <span class="cf">await</span> <span class="fu">FileAttachment</span>(</span>
<span id="cb5-182"><a href="#cb5-182" aria-hidden="true" tabindex="-1"></a>        <span class="st">"/data/vulnerability_notebook/notebook_exposure.parquet"</span><span class="op">,</span></span>
<span id="cb5-183"><a href="#cb5-183" aria-hidden="true" tabindex="-1"></a>      )<span class="op">.</span><span class="fu">url</span>()<span class="op">;</span></span>
<span id="cb5-184"><a href="#cb5-184" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> db <span class="op">=</span> <span class="cf">await</span> DuckDBClient<span class="op">.</span><span class="fu">of</span>()<span class="op">;</span></span>
<span id="cb5-185"><a href="#cb5-185" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> db<span class="op">.</span><span class="fu">query</span>(<span class="vs">`</span></span>
<span id="cb5-186"><a href="#cb5-186" aria-hidden="true" tabindex="-1"></a><span class="vs">        CREATE OR REPLACE VIEW exposure_data AS</span></span>
<span id="cb5-187"><a href="#cb5-187" aria-hidden="true" tabindex="-1"></a><span class="vs">        SELECT * FROM read_parquet('</span><span class="sc">${</span>parquetUrl<span class="sc">}</span><span class="vs">')</span></span>
<span id="cb5-188"><a href="#cb5-188" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span>)<span class="op">;</span></span>
<span id="cb5-189"><a href="#cb5-189" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> db<span class="op">;</span></span>
<span id="cb5-190"><a href="#cb5-190" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb5-191"><a href="#cb5-191" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Failed to create DuckDB connection for exposure data:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb5-192"><a href="#cb5-192" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb5-193"><a href="#cb5-193" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-194"><a href="#cb5-194" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb5-195"><a href="#cb5-195" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-5-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-5-2" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-5-3" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-5-4" data-nodetype="declaration"></div></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb6" data-startfrom="167" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line 166"><span id="cb6-167"><a href="#cb6-167" aria-hidden="true" tabindex="-1"></a><span class="co">// Cached boundary data loading</span></span>
<span id="cb6-168"><a href="#cb6-168" aria-hidden="true" tabindex="-1"></a>boundaries <span class="op">=</span> {</span>
<span id="cb6-169"><a href="#cb6-169" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">loadDataWithCache</span>(<span class="st">'boundaries'</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb6-170"><a href="#cb6-170" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb6-171"><a href="#cb6-171" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> input0 <span class="op">=</span> <span class="cf">await</span> <span class="fu">FileAttachment</span>(<span class="st">"/data/shared/atlas_gaul_a0_africa_simple-vlowres.topojson"</span>)<span class="op">.</span><span class="fu">json</span>()</span>
<span id="cb6-172"><a href="#cb6-172" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> input1 <span class="op">=</span> <span class="cf">await</span> <span class="fu">FileAttachment</span>(<span class="st">"/data/shared/atlas_gaul_a1_africa_simple-vlowres.topojson"</span>)<span class="op">.</span><span class="fu">json</span>()</span>
<span id="cb6-173"><a href="#cb6-173" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> input2 <span class="op">=</span> <span class="cf">await</span> <span class="fu">FileAttachment</span>(<span class="st">"/data/shared/atlas_gaul_a2_africa_simple-lowres.topojson"</span>)<span class="op">.</span><span class="fu">json</span>()</span>
<span id="cb6-174"><a href="#cb6-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-175"><a href="#cb6-175" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> geo <span class="op">=</span> {</span>
<span id="cb6-176"><a href="#cb6-176" aria-hidden="true" tabindex="-1"></a>        <span class="dt">admin0</span><span class="op">:</span> {</span>
<span id="cb6-177"><a href="#cb6-177" aria-hidden="true" tabindex="-1"></a>          <span class="op">...</span>topojson<span class="op">.</span><span class="fu">feature</span>(input0<span class="op">,</span> input0<span class="op">.</span><span class="at">objects</span>[<span class="st">"atlas_gaul24_a0_africa"</span>])<span class="op">,</span></span>
<span id="cb6-178"><a href="#cb6-178" aria-hidden="true" tabindex="-1"></a>          <span class="dt">features</span><span class="op">:</span> topojson<span class="op">.</span><span class="fu">feature</span>(input0<span class="op">,</span> input0<span class="op">.</span><span class="at">objects</span>[<span class="st">"atlas_gaul24_a0_africa"</span>])<span class="op">.</span><span class="at">features</span></span>
<span id="cb6-179"><a href="#cb6-179" aria-hidden="true" tabindex="-1"></a>        }<span class="op">,</span></span>
<span id="cb6-180"><a href="#cb6-180" aria-hidden="true" tabindex="-1"></a>        <span class="dt">admin1</span><span class="op">:</span> {</span>
<span id="cb6-181"><a href="#cb6-181" aria-hidden="true" tabindex="-1"></a>          <span class="op">...</span>topojson<span class="op">.</span><span class="fu">feature</span>(input1<span class="op">,</span> input1<span class="op">.</span><span class="at">objects</span>[<span class="st">"atlas_gaul24_a1_africa"</span>])<span class="op">,</span></span>
<span id="cb6-182"><a href="#cb6-182" aria-hidden="true" tabindex="-1"></a>          <span class="dt">features</span><span class="op">:</span> topojson<span class="op">.</span><span class="fu">feature</span>(input1<span class="op">,</span> input1<span class="op">.</span><span class="at">objects</span>[<span class="st">"atlas_gaul24_a1_africa"</span>])<span class="op">.</span><span class="at">features</span></span>
<span id="cb6-183"><a href="#cb6-183" aria-hidden="true" tabindex="-1"></a>        }<span class="op">,</span></span>
<span id="cb6-184"><a href="#cb6-184" aria-hidden="true" tabindex="-1"></a>        <span class="dt">admin2</span><span class="op">:</span> {</span>
<span id="cb6-185"><a href="#cb6-185" aria-hidden="true" tabindex="-1"></a>          <span class="op">...</span>topojson<span class="op">.</span><span class="fu">feature</span>(input2<span class="op">,</span> input2<span class="op">.</span><span class="at">objects</span>[<span class="st">"atlas_gaul_a2_africa_simple-lowres"</span>])<span class="op">,</span></span>
<span id="cb6-186"><a href="#cb6-186" aria-hidden="true" tabindex="-1"></a>          <span class="dt">features</span><span class="op">:</span> topojson<span class="op">.</span><span class="fu">feature</span>(input2<span class="op">,</span> input2<span class="op">.</span><span class="at">objects</span>[<span class="st">"atlas_gaul_a2_africa_simple-lowres"</span>])<span class="op">.</span><span class="at">features</span></span>
<span id="cb6-187"><a href="#cb6-187" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb6-188"><a href="#cb6-188" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb6-189"><a href="#cb6-189" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb6-190"><a href="#cb6-190" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> geo</span>
<span id="cb6-191"><a href="#cb6-191" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb6-192"><a href="#cb6-192" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Failed to load boundary data:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb6-193"><a href="#cb6-193" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Return empty structure to prevent crashes</span></span>
<span id="cb6-194"><a href="#cb6-194" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> {</span>
<span id="cb6-195"><a href="#cb6-195" aria-hidden="true" tabindex="-1"></a>        <span class="dt">admin0</span><span class="op">:</span> { <span class="dt">features</span><span class="op">:</span> [] }<span class="op">,</span></span>
<span id="cb6-196"><a href="#cb6-196" aria-hidden="true" tabindex="-1"></a>        <span class="dt">admin1</span><span class="op">:</span> { <span class="dt">features</span><span class="op">:</span> [] }<span class="op">,</span></span>
<span id="cb6-197"><a href="#cb6-197" aria-hidden="true" tabindex="-1"></a>        <span class="dt">admin2</span><span class="op">:</span> { <span class="dt">features</span><span class="op">:</span> [] }</span>
<span id="cb6-198"><a href="#cb6-198" aria-hidden="true" tabindex="-1"></a>      }<span class="op">;</span></span>
<span id="cb6-199"><a href="#cb6-199" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-200"><a href="#cb6-200" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb6-201"><a href="#cb6-201" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-6" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb7" data-startfrom="0" data-source-offset="-0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -1"><span id="cb7-0"><a href="#cb7-0" aria-hidden="true" tabindex="-1"></a>dataAdmin0 <span class="op">=</span> {</span>
<span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> data <span class="op">=</span> boundaries<span class="op">.</span><span class="at">admin0</span><span class="op">.</span><span class="at">features</span><span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// add a blank value and sort alphabetically</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> [<span class="kw">null</span><span class="op">,</span> <span class="op">...</span>data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin0_name</span>)]<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> {</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="dt">label</span><span class="op">:</span> d <span class="op">==</span> <span class="kw">null</span> <span class="op">?</span> globalSelection<span class="op">.</span><span class="at">label</span> <span class="op">:</span> d<span class="op">,</span> <span class="dt">value</span><span class="op">:</span> d}</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> {</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Keep null/blank value at the top</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (a<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="kw">null</span>) <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (b<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="kw">null</span>) <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sort others alphabetically by label</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a<span class="op">.</span><span class="at">label</span><span class="op">.</span><span class="fu">localeCompare</span>(b<span class="op">.</span><span class="at">label</span>)<span class="op">;</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>dataAdmin1 <span class="op">=</span> {</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// admin 1, filter by 0 - using shared state</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> data<span class="op">;</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (sharedAdmin0 <span class="op">&amp;&amp;</span> sharedAdmin0 <span class="op">!==</span> <span class="st">"SSA"</span>) {</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Filter by selected country</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> boundaries<span class="op">.</span><span class="at">admin1</span><span class="op">.</span><span class="at">features</span><span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span>)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin0_name</span> <span class="op">==</span> sharedAdmin0)<span class="op">;</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// If no country selected or SSA selected, show empty (just null option)</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">// add blank value and sort alphabetically</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> [<span class="kw">null</span><span class="op">,</span> <span class="op">...</span>data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin1_name</span>)]<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> {</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="dt">label</span><span class="op">:</span> d<span class="op">,</span> <span class="dt">value</span><span class="op">:</span> d}</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> {</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Keep null/blank value at the top</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (a<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="kw">null</span>) <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (b<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="kw">null</span>) <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sort others alphabetically by label</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a<span class="op">.</span><span class="at">label</span><span class="op">.</span><span class="fu">localeCompare</span>(b<span class="op">.</span><span class="at">label</span>)<span class="op">;</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>dataAdmin2 <span class="op">=</span> {</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> data<span class="op">;</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (sharedAdmin0 <span class="op">&amp;&amp;</span> sharedAdmin0 <span class="op">!==</span> <span class="st">"SSA"</span> <span class="op">&amp;&amp;</span> sharedAdmin1) {</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Filter by selected country and region</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> boundaries<span class="op">.</span><span class="at">admin2</span><span class="op">.</span><span class="at">features</span><span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span>)</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin0_name</span> <span class="op">==</span> sharedAdmin0 <span class="op">&amp;&amp;</span> d<span class="op">.</span><span class="at">admin1_name</span> <span class="op">==</span> sharedAdmin1)<span class="op">;</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">// If no country or region selected, show empty (just null option)</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>  <span class="co">// add blank value and sort alphabetically</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> [<span class="kw">null</span><span class="op">,</span> <span class="op">...</span>data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin2_name</span>)]<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> {</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="dt">label</span><span class="op">:</span> d<span class="op">,</span> <span class="dt">value</span><span class="op">:</span> d}</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> {</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Keep null/blank value at the top</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (a<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="kw">null</span>) <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (b<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="kw">null</span>) <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sort others alphabetically by label</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a<span class="op">.</span><span class="at">label</span><span class="op">.</span><span class="fu">localeCompare</span>(b<span class="op">.</span><span class="at">label</span>)<span class="op">;</span></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-7-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-7-2" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-7-3" data-nodetype="declaration"></div></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb8" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb8--1"><a href="#cb8--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Bidirectional synchronization: Update shared state when ANY section's selectors change</span></span>
<span id="cb8-0"><a href="#cb8-0" aria-hidden="true" tabindex="-1"></a><span class="co">// This reactive cell monitors all section admin selectors and updates shared state when any change</span></span>
<span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// The underscore prefix ensures this cell doesn't display output in the notebook</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Updated to handle cascading: when admin0 changes, admin1 and admin2 reset; when admin1 changes, admin2 resets</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>_adminUpdate <span class="op">=</span> {</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check exposure section selectors first (has priority)</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (selectAdmin0<span class="op">?.</span><span class="at">value</span> <span class="op">!==</span> sharedAdmin0) {</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Admin0 changed - reset admin1 and admin2</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateSharedAdminSelections</span>(selectAdmin0<span class="op">?.</span><span class="at">value</span> <span class="op">||</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (selectAdmin1<span class="op">?.</span><span class="at">value</span> <span class="op">!==</span> sharedAdmin1) {</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Admin1 changed - reset admin2</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateSharedAdminSelections</span>(sharedAdmin0<span class="op">,</span> selectAdmin1<span class="op">?.</span><span class="at">value</span> <span class="op">||</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (selectAdmin2<span class="op">?.</span><span class="at">value</span> <span class="op">!==</span> sharedAdmin2) {</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Admin2 changed</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateSharedAdminSelections</span>(sharedAdmin0<span class="op">,</span> sharedAdmin1<span class="op">,</span> selectAdmin2<span class="op">?.</span><span class="at">value</span> <span class="op">||</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check sensitivity section selectors</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> (sensitivityAdmin0<span class="op">?.</span><span class="at">value</span> <span class="op">!==</span> sharedAdmin0) {</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateSharedAdminSelections</span>(sensitivityAdmin0<span class="op">?.</span><span class="at">value</span> <span class="op">||</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (sensitivityAdmin1<span class="op">?.</span><span class="at">value</span> <span class="op">!==</span> sharedAdmin1) {</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateSharedAdminSelections</span>(sharedAdmin0<span class="op">,</span> sensitivityAdmin1<span class="op">?.</span><span class="at">value</span> <span class="op">||</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (sensitivityAdmin2<span class="op">?.</span><span class="at">value</span> <span class="op">!==</span> sharedAdmin2) {</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateSharedAdminSelections</span>(sharedAdmin0<span class="op">,</span> sharedAdmin1<span class="op">,</span> sensitivityAdmin2<span class="op">?.</span><span class="at">value</span> <span class="op">||</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check adaptive capacity section selectors</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> (adaptiveCapacityAdmin0<span class="op">?.</span><span class="at">value</span> <span class="op">!==</span> sharedAdmin0) {</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateSharedAdminSelections</span>(adaptiveCapacityAdmin0<span class="op">?.</span><span class="at">value</span> <span class="op">||</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (adaptiveCapacityAdmin1<span class="op">?.</span><span class="at">value</span> <span class="op">!==</span> sharedAdmin1) {</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateSharedAdminSelections</span>(sharedAdmin0<span class="op">,</span> adaptiveCapacityAdmin1<span class="op">?.</span><span class="at">value</span> <span class="op">||</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (adaptiveCapacityAdmin2<span class="op">?.</span><span class="at">value</span> <span class="op">!==</span> sharedAdmin2) {</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateSharedAdminSelections</span>(sharedAdmin0<span class="op">,</span> sharedAdmin1<span class="op">,</span> adaptiveCapacityAdmin2<span class="op">?.</span><span class="at">value</span> <span class="op">||</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check composite section selectors</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> (compositeAdmin0<span class="op">?.</span><span class="at">value</span> <span class="op">!==</span> sharedAdmin0) {</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateSharedAdminSelections</span>(compositeAdmin0<span class="op">?.</span><span class="at">value</span> <span class="op">||</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (compositeAdmin1<span class="op">?.</span><span class="at">value</span> <span class="op">!==</span> sharedAdmin1) {</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateSharedAdminSelections</span>(sharedAdmin0<span class="op">,</span> compositeAdmin1<span class="op">?.</span><span class="at">value</span> <span class="op">||</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (compositeAdmin2<span class="op">?.</span><span class="at">value</span> <span class="op">!==</span> sharedAdmin2) {</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateSharedAdminSelections</span>(sharedAdmin0<span class="op">,</span> sharedAdmin1<span class="op">,</span> compositeAdmin2<span class="op">?.</span><span class="at">value</span> <span class="op">||</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-8" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb9" data-startfrom="0" data-source-offset="-0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -1"><span id="cb9-0"><a href="#cb9-0" aria-hidden="true" tabindex="-1"></a>sensitivityDataAdmin0 <span class="op">=</span> {</span>
<span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> data <span class="op">=</span> boundaries<span class="op">.</span><span class="at">admin0</span><span class="op">.</span><span class="at">features</span><span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// add a blank value and sort alphabetically</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> [<span class="kw">null</span><span class="op">,</span> <span class="op">...</span>data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin0_name</span>)]<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> {</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="dt">label</span><span class="op">:</span> d <span class="op">==</span> <span class="kw">null</span> <span class="op">?</span> globalSelection<span class="op">.</span><span class="at">label</span> <span class="op">:</span> d<span class="op">,</span> <span class="dt">value</span><span class="op">:</span> d <span class="op">||</span> <span class="st">"SSA"</span>}</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> {</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Keep null/blank value at the top</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (a<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="st">"SSA"</span>) <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (b<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="st">"SSA"</span>) <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sort others alphabetically by label</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a<span class="op">.</span><span class="at">label</span><span class="op">.</span><span class="fu">localeCompare</span>(b<span class="op">.</span><span class="at">label</span>)<span class="op">;</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>sensitivityDataAdmin1 <span class="op">=</span> {</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// admin 1, filter by 0 </span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> data <span class="op">=</span> boundaries<span class="op">.</span><span class="at">admin1</span><span class="op">.</span><span class="at">features</span><span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span>)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin0_name</span> <span class="op">==</span> sensitivityAdmin0<span class="op">?.</span><span class="at">value</span>)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">// add blank value and sort alphabetically</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> [<span class="kw">null</span><span class="op">,</span> <span class="op">...</span>data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin1_name</span>)]<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> {</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="dt">label</span><span class="op">:</span> d<span class="op">,</span> <span class="dt">value</span><span class="op">:</span> d}</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> {</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Keep null/blank value at the top</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (a<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="kw">null</span>) <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (b<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="kw">null</span>) <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sort others alphabetically by label</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a<span class="op">.</span><span class="at">label</span><span class="op">.</span><span class="fu">localeCompare</span>(b<span class="op">.</span><span class="at">label</span>)<span class="op">;</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>sensitivityDataAdmin2 <span class="op">=</span> {</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> data <span class="op">=</span> boundaries<span class="op">.</span><span class="at">admin2</span><span class="op">.</span><span class="at">features</span><span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span>)</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin0_name</span> <span class="op">==</span> sensitivityAdmin0<span class="op">?.</span><span class="at">value</span> <span class="op">&amp;&amp;</span> d<span class="op">.</span><span class="at">admin1_name</span> <span class="op">==</span> sensitivityAdmin1<span class="op">?.</span><span class="at">value</span>)</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">// add blank value and sort alphabetically</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> [<span class="kw">null</span><span class="op">,</span> <span class="op">...</span>data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin2_name</span>)]<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> {</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="dt">label</span><span class="op">:</span> d<span class="op">,</span> <span class="dt">value</span><span class="op">:</span> d}</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> {</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Keep null/blank value at the top</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (a<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="kw">null</span>) <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (b<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="kw">null</span>) <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sort others alphabetically by label</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a<span class="op">.</span><span class="at">label</span><span class="op">.</span><span class="fu">localeCompare</span>(b<span class="op">.</span><span class="at">label</span>)<span class="op">;</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-9-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-9-2" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-9-3" data-nodetype="declaration"></div></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb10" data-startfrom="0" data-source-offset="-0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -1"><span id="cb10-0"><a href="#cb10-0" aria-hidden="true" tabindex="-1"></a>compositeDataAdmin0 <span class="op">=</span> {</span>
<span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> data <span class="op">=</span> boundaries<span class="op">.</span><span class="at">admin0</span><span class="op">.</span><span class="at">features</span><span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// add a blank value and sort alphabetically</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> [<span class="kw">null</span><span class="op">,</span> <span class="op">...</span>data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin0_name</span>)]<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> {</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="dt">label</span><span class="op">:</span> d <span class="op">==</span> <span class="kw">null</span> <span class="op">?</span> globalSelection<span class="op">.</span><span class="at">label</span> <span class="op">:</span> d<span class="op">,</span> <span class="dt">value</span><span class="op">:</span> d <span class="op">||</span> <span class="st">"SSA"</span>}</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> {</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Keep null/blank value at the top</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (a<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="st">"SSA"</span>) <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (b<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="st">"SSA"</span>) <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sort others alphabetically by label</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a<span class="op">.</span><span class="at">label</span><span class="op">.</span><span class="fu">localeCompare</span>(b<span class="op">.</span><span class="at">label</span>)<span class="op">;</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>compositeDataAdmin1 <span class="op">=</span> {</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// admin 1, filter by 0 </span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> data <span class="op">=</span> boundaries<span class="op">.</span><span class="at">admin1</span><span class="op">.</span><span class="at">features</span><span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span>)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Note: compositeAdmin0 will be available when this function is called from composite section</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">// add blank value and sort alphabetically</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> [<span class="kw">null</span><span class="op">,</span> <span class="op">...</span>data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin1_name</span>)]<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> {</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="dt">label</span><span class="op">:</span> d<span class="op">,</span> <span class="dt">value</span><span class="op">:</span> d}</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> {</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Keep null/blank value at the top</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (a<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="kw">null</span>) <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (b<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="kw">null</span>) <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sort others alphabetically by label</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a<span class="op">.</span><span class="at">label</span><span class="op">.</span><span class="fu">localeCompare</span>(b<span class="op">.</span><span class="at">label</span>)<span class="op">;</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>compositeDataAdmin2 <span class="op">=</span> {</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> data <span class="op">=</span> boundaries<span class="op">.</span><span class="at">admin2</span><span class="op">.</span><span class="at">features</span><span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span>)</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Note: compositeAdmin0 and compositeAdmin1 will be available when this function is called from composite section</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">// add blank value and sort alphabetically</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> [<span class="kw">null</span><span class="op">,</span> <span class="op">...</span>data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin2_name</span>)]<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> {</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="dt">label</span><span class="op">:</span> d<span class="op">,</span> <span class="dt">value</span><span class="op">:</span> d}</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> {</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Keep null/blank value at the top</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (a<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="kw">null</span>) <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (b<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="kw">null</span>) <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sort others alphabetically by label</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a<span class="op">.</span><span class="at">label</span><span class="op">.</span><span class="fu">localeCompare</span>(b<span class="op">.</span><span class="at">label</span>)<span class="op">;</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-10-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-10-2" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-10-3" data-nodetype="declaration"></div></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb11" data-startfrom="0" data-source-offset="-0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -1"><span id="cb11-0"><a href="#cb11-0" aria-hidden="true" tabindex="-1"></a>adaptiveCapacityDataAdmin0 <span class="op">=</span> {</span>
<span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> data <span class="op">=</span> boundaries<span class="op">.</span><span class="at">admin0</span><span class="op">.</span><span class="at">features</span><span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// add a blank value and sort alphabetically</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> [<span class="kw">null</span><span class="op">,</span> <span class="op">...</span>data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin0_name</span>)]<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> {</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>   <span class="cf">return</span> {<span class="dt">label</span><span class="op">:</span> d <span class="op">==</span> <span class="kw">null</span> <span class="op">?</span> globalSelection<span class="op">.</span><span class="at">label</span> <span class="op">:</span> d<span class="op">,</span> <span class="dt">value</span><span class="op">:</span> d <span class="op">||</span> <span class="st">"SSA"</span>}</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> {</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Keep null/blank value at the top</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (a<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="st">"SSA"</span>) <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (b<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="st">"SSA"</span>) <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sort others alphabetically by label</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a<span class="op">.</span><span class="at">label</span><span class="op">.</span><span class="fu">localeCompare</span>(b<span class="op">.</span><span class="at">label</span>)<span class="op">;</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>adaptiveCapacityDataAdmin1 <span class="op">=</span> {</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// admin 1, filter by 0 </span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> data <span class="op">=</span> boundaries<span class="op">.</span><span class="at">admin1</span><span class="op">.</span><span class="at">features</span><span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span>)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin0_name</span> <span class="op">==</span> adaptiveCapacityAdmin0<span class="op">?.</span><span class="at">value</span>)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">// add blank value and sort alphabetically</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> [<span class="kw">null</span><span class="op">,</span> <span class="op">...</span>data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin1_name</span>)]<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> {</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="dt">label</span><span class="op">:</span> d<span class="op">,</span> <span class="dt">value</span><span class="op">:</span> d}</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> {</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Keep null/blank value at the top</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (a<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="kw">null</span>) <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (b<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="kw">null</span>) <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sort others alphabetically by label</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a<span class="op">.</span><span class="at">label</span><span class="op">.</span><span class="fu">localeCompare</span>(b<span class="op">.</span><span class="at">label</span>)<span class="op">;</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>adaptiveCapacityDataAdmin2 <span class="op">=</span> {</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> data <span class="op">=</span> boundaries<span class="op">.</span><span class="at">admin2</span><span class="op">.</span><span class="at">features</span><span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span>)</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin0_name</span> <span class="op">==</span> adaptiveCapacityAdmin0<span class="op">?.</span><span class="at">value</span> <span class="op">&amp;&amp;</span> d<span class="op">.</span><span class="at">admin1_name</span> <span class="op">==</span> adaptiveCapacityAdmin1<span class="op">?.</span><span class="at">value</span>)</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">// add blank value and sort alphabetically</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> [<span class="kw">null</span><span class="op">,</span> <span class="op">...</span>data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin2_name</span>)]<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> {</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="dt">label</span><span class="op">:</span> d<span class="op">,</span> <span class="dt">value</span><span class="op">:</span> d}</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> {</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Keep null/blank value at the top</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (a<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="kw">null</span>) <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (b<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="kw">null</span>) <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sort others alphabetically by label</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a<span class="op">.</span><span class="at">label</span><span class="op">.</span><span class="fu">localeCompare</span>(b<span class="op">.</span><span class="at">label</span>)<span class="op">;</span></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-11-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-11-2" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-11-3" data-nodetype="declaration"></div></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb12" data-startfrom="19" data-source-offset="-853"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line 18"><span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">bindTabularToGeo</span>({</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  data <span class="op">=</span> []<span class="op">,</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  dataBindColumn <span class="op">=</span> <span class="st">"dataBindColumn"</span><span class="op">,</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  geoData <span class="op">=</span> []<span class="op">,</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>  geoDataBindColumn <span class="op">=</span> <span class="st">"geoDataBindColumn"</span><span class="op">,</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>}) {</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> index <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>(data<span class="op">.</span><span class="fu">map</span>((d) <span class="kw">=&gt;</span> [d[dataBindColumn]<span class="op">,</span> d]))<span class="op">;</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> geojson <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(geoData))<span class="op">;</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">const</span> f <span class="kw">of</span> geojson<span class="op">.</span><span class="at">features</span>) {</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    f<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">data</span> <span class="op">=</span> index<span class="op">.</span><span class="fu">get</span>(f<span class="op">.</span><span class="at">properties</span>[geoDataBindColumn])<span class="op">;</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> geojson<span class="op">;</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a><span class="co"> * Get the most granular admin selection from admin level selectors</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{Object}</span><span class="co"> admin0 - Admin0 selector object with .value property</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{Object}</span><span class="co"> admin1 - Admin1 selector object with .value property</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{Object}</span><span class="co"> admin2 - Admin2 selector object with .value property</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{string}</span><span class="co"> globalLabel - Default label when no selection is made (default: "Sub-Saharan Africa")</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@returns</span><span class="co"> {string} The most specific admin level selected, or globalLabel if none selected</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@example</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a><span class="co"> * getAdminSelection(selectAdmin0, selectAdmin1, selectAdmin2)</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">getAdminSelection</span>(admin0<span class="op">,</span> admin1<span class="op">,</span> admin2<span class="op">,</span> globalLabel <span class="op">=</span> <span class="st">"Sub-Saharan Africa"</span>) {</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> a0 <span class="op">=</span> admin0<span class="op">?.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> a1 <span class="op">=</span> admin1<span class="op">?.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> a2 <span class="op">=</span> admin2<span class="op">?.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> a2 <span class="op">?</span> a2 <span class="op">:</span> a1 <span class="op">?</span> a1 <span class="op">:</span> a0 <span class="op">?</span> a0 <span class="op">:</span> globalLabel<span class="op">;</span></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a><span class="co">// Convenience wrappers for backward compatibility</span></span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">getExposureAdminSelection</span>() {</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">getAdminSelection</span>(selectAdmin0<span class="op">,</span> selectAdmin1<span class="op">,</span> selectAdmin2)<span class="op">;</span></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">getSensitivityAdminSelection</span>() {</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">getAdminSelection</span>(sensitivityAdmin0<span class="op">,</span> sensitivityAdmin1<span class="op">,</span> sensitivityAdmin2)<span class="op">;</span></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-12-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-12-2" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-12-3" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-12-4" data-nodetype="declaration"></div></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb13" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb13--1"><a href="#cb13--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Formatting utilities</span></span>
<span id="cb13-0"><a href="#cb13-0" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"> * Format number as compact currency (e.g., "$1.2M")</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>formatNumCompactShort <span class="op">=</span> <span class="kw">new</span> <span class="bu">Intl</span><span class="op">.</span><span class="fu">NumberFormat</span>(<span class="st">"en-US"</span><span class="op">,</span> {</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">notation</span><span class="op">:</span> <span class="st">"compact"</span><span class="op">,</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">compactDisplay</span><span class="op">:</span> <span class="st">"short"</span><span class="op">,</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> <span class="st">"currency"</span><span class="op">,</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">currency</span><span class="op">:</span> <span class="st">"USD"</span><span class="op">,</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>})<span class="op">.</span><span class="at">format</span><span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-13" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb14" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb14--1"><a href="#cb14--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Color scales and themes</span></span>
<span id="cb14-0"><a href="#cb14-0" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"> * Color scale definitions for visualizations</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>colorScales <span class="op">=</span> {</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> {</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">range</span><span class="op">:</span> {</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">green</span><span class="op">:</span> [<span class="st">'#E4F5D0'</span><span class="op">,</span> <span class="st">'#015023'</span>]<span class="op">,</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">blue</span><span class="op">:</span> [<span class="st">'#E8F2FF'</span><span class="op">,</span> <span class="st">'#003E6B'</span>]<span class="op">,</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">brown</span><span class="op">:</span> [<span class="st">'#FFFDE5'</span><span class="op">,</span> <span class="st">'#A87B00'</span>]<span class="op">,</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">yellowGreen</span><span class="op">:</span> [<span class="st">'#216729'</span><span class="op">,</span> <span class="st">'#F7D732'</span>]<span class="op">,</span> <span class="co">// Reversed: green (low/good) to yellow (high/bad)</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">orangeRed</span><span class="op">:</span> [<span class="st">'#F4BB21'</span><span class="op">,</span> <span class="st">'#EC5A47'</span>]<span class="op">,</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">redOrange</span><span class="op">:</span> [<span class="st">'#FEE0D2'</span><span class="op">,</span> <span class="st">'#CB4335'</span>]<span class="op">,</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">vulnerability</span><span class="op">:</span> [<span class="st">'#2E8B57'</span><span class="op">,</span> <span class="st">'#FFD700'</span><span class="op">,</span> <span class="st">'#FF6347'</span>]<span class="op">,</span> <span class="co">// Low, Medium, High</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">adaptive</span><span class="op">:</span> [<span class="st">'#FF6B6B'</span><span class="op">,</span> <span class="st">'#4ECDC4'</span><span class="op">,</span> <span class="st">'#45B7D1'</span>] <span class="co">// Poor, Fair, Good</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unknown</span><span class="op">:</span> <span class="st">"#f0f0f0"</span><span class="op">,</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">noData</span><span class="op">:</span> <span class="st">"#f0f0f0"</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-14" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb15" data-startfrom="1" data-source-offset="-26"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>intDollarUnit <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>intDollarYear<span class="sc">}</span><span class="vs"> USD`</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>intDollarYear <span class="op">=</span> <span class="dv">2015</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co"> * Value of Production (VoP) note configuration</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>vopNote <span class="op">=</span> {</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> {</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">caption</span><span class="op">:</span> <span class="fu">_lang</span>(vulnerability_translations<span class="op">.</span><span class="at">vopNoteCaption</span>)<span class="op">,</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">blurb</span><span class="op">:</span> <span class="fu">_lang</span>(vulnerability_translations<span class="op">.</span><span class="at">vopNoteBlurb</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-15-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-15-2" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-15-3" data-nodetype="declaration"></div></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb16" data-startfrom="6" data-source-offset="-208"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line 5"><span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">createLoadingState</span>(message <span class="op">=</span> <span class="kw">null</span>) {</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">`</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div style="</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="vs">      display: flex;</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="vs">      align-items: center;</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="vs">      justify-content: center;</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="vs">      padding: 40px;</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="vs">      color: #6b7280;</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="vs">      font-style: italic;</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="vs">    "&gt;</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div style="margin-right: 12px;"&gt;</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class="spinner" style="</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="vs">          width: 20px;</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="vs">          height: 20px;</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: 2px solid #e5e7eb;</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-top: 2px solid #3b82f6;</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 50%;</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="vs">          animation: spin 1s linear infinite;</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="vs">        "&gt;&lt;/div&gt;</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span>message <span class="op">||</span> <span class="fu">_lang</span>(vulnerability_translations<span class="op">.</span><span class="at">loading</span>)<span class="sc">}</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;/div&gt;</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;style&gt;</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a><span class="vs">      @keyframes spin {</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a><span class="vs">        0% { transform: rotate(0deg); }</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a><span class="vs">        100% { transform: rotate(360deg); }</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;/style&gt;</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span><span class="op">;</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a><span class="co"> * Create a "no data available" state UI component</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{string|null}</span><span class="co"> message - Optional message (defaults to translation)</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@returns</span><span class="co"> {HTMLElement} HTML element with no-data display</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">createNoDataState</span>(message <span class="op">=</span> <span class="kw">null</span>) {</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">`</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div style="</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a><span class="vs">      display: flex;</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a><span class="vs">      align-items: center;</span></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a><span class="vs">      justify-content: center;</span></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a><span class="vs">      padding: 40px;</span></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a><span class="vs">      background: #f9fafb;</span></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a><span class="vs">      border: 2px dashed #d1d5db;</span></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a><span class="vs">      border-radius: 8px;</span></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a><span class="vs">      color: #6b7280;</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a><span class="vs">      text-align: center;</span></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a><span class="vs">      margin-top: 16px;</span></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a><span class="vs">    "&gt;</span></span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div&gt;</span></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div style="margin-bottom: 8px; font-size: 18px;"&gt;üìä&lt;/div&gt;</span></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div&gt;</span><span class="sc">${</span>message <span class="op">||</span> <span class="fu">_lang</span>(vulnerability_translations<span class="op">.</span><span class="at">no_data_available</span>)<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;/div&gt;</span></span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span><span class="op">;</span></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-16-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-16-2" data-nodetype="declaration"></div></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb17" data-startfrom="14" data-source-offset="-528"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line 13"><span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">generateInsight</span>(template<span class="op">,</span> replacements) {</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> Lang<span class="op">.</span><span class="fu">reduceReplaceTemplateItems</span>(template<span class="op">,</span> replacements)<span class="op">;</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="co"> * Create a styled insight display component from text or HTML</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="co"> * Handles both plain text (with paragraph splitting) and HTML elements</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{string|HTMLElement}</span><span class="co"> insight - Insight text or HTML element to display</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@returns</span><span class="co"> {HTMLElement} Styled HTML element with insight content</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">createInsightDisplay</span>(insight) {</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Handle case where insight is already an HTML element (from htl.html)</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="kw">typeof</span> insight <span class="op">!==</span> <span class="st">"string"</span>) {</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// If it's already an HTML element, just wrap it in the standard display</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">`</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div style="</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a><span class="vs">        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a><span class="vs">        color: white;</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a><span class="vs">        padding: 20px;</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a><span class="vs">        border-radius: 10px;</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a><span class="vs">        margin: 16px 0;</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a><span class="vs">        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a><span class="vs">      "&gt;</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;h4 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;"&gt;</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span><span class="fu">_lang</span>(vulnerability_translations<span class="op">.</span><span class="at">quick_insights</span>)<span class="sc">}</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/h4&gt;</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div style="margin: 0; font-size: 18px; line-height: 1.5; opacity: 0.95;"&gt;</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>insight<span class="sc">}</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Split insight into paragraphs based on double newlines and process each</span></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> paragraphs <span class="op">=</span> insight<span class="op">.</span><span class="fu">split</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)<span class="op">.</span><span class="fu">filter</span>((p) <span class="kw">=&gt;</span> p<span class="op">.</span><span class="fu">trim</span>()<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create HTML elements using htl.html for proper rendering</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> paragraphElements <span class="op">=</span> paragraphs</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>((paragraph) <span class="kw">=&gt;</span> {</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Handle special formatting for section headers</span></span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (paragraph<span class="op">.</span><span class="fu">startsWith</span>(<span class="st">"üìç Selected Group:"</span>)) {</span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> content <span class="op">=</span> paragraph<span class="op">.</span><span class="fu">replace</span>(<span class="st">"üìç Selected Group:"</span><span class="op">,</span> <span class="st">""</span>)<span class="op">.</span><span class="fu">trim</span>()<span class="op">;</span></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">`&lt;div style="</span></span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a><span class="vs">        background: rgba(255, 255, 255, 0.15);</span></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a><span class="vs">        padding: 12px;</span></span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a><span class="vs">        border-radius: 8px;</span></span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a><span class="vs">        margin-bottom: 16px;</span></span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a><span class="vs">        border-left: 4px solid #ffd700;</span></span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a><span class="vs">      "&gt;</span></span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div style="font-weight: bold; margin-bottom: 8px;"&gt;üìç Selected Group&lt;/div&gt;</span></span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div style="font-size: 16px;"&gt;</span><span class="sc">${</span>content<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (paragraph<span class="op">.</span><span class="fu">startsWith</span>(<span class="st">"Overall Population Analysis:"</span>)) {</span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> content <span class="op">=</span> paragraph</span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">replace</span>(<span class="st">"Overall Population Analysis:"</span><span class="op">,</span> <span class="st">""</span>)</span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">trim</span>()<span class="op">;</span></span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">`&lt;div style="</span></span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a><span class="vs">        border-top: 1px solid rgba(255, 255, 255, 0.3);</span></span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a><span class="vs">        padding-top: 16px;</span></span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a><span class="vs">        margin-bottom: 16px;</span></span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a><span class="vs">      "&gt;</span></span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div style="font-weight: bold; margin-bottom: 12px;"&gt;Overall Population Analysis&lt;/div&gt;</span></span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div style="font-size: 16px; line-height: 1.6;"&gt;</span><span class="sc">${</span>content<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (paragraph <span class="op">===</span> <span class="st">"---"</span>) {</span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Skip separator lines</span></span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Regular paragraphs</span></span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">`&lt;p style="margin: 0 0 12px 0; font-size: 16px; line-height: 1.6; opacity: 0.95;"&gt;</span><span class="sc">${</span>paragraph<span class="sc">}</span><span class="vs">&lt;/p&gt;`</span><span class="op">;</span></span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>((p) <span class="kw">=&gt;</span> p <span class="op">!==</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">`</span></span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div style="</span></span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a><span class="vs">      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);</span></span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a><span class="vs">      color: white;</span></span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a><span class="vs">      padding: 20px;</span></span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a><span class="vs">      border-radius: 10px;</span></span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a><span class="vs">      margin: 16px 0;</span></span>
<span id="cb17-96"><a href="#cb17-96" aria-hidden="true" tabindex="-1"></a><span class="vs">      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);</span></span>
<span id="cb17-97"><a href="#cb17-97" aria-hidden="true" tabindex="-1"></a><span class="vs">    "&gt;</span></span>
<span id="cb17-98"><a href="#cb17-98" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;h4 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;"&gt;</span></span>
<span id="cb17-99"><a href="#cb17-99" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span><span class="fu">_lang</span>(vulnerability_translations<span class="op">.</span><span class="at">quick_insights</span>)<span class="sc">}</span></span>
<span id="cb17-100"><a href="#cb17-100" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/h4&gt;</span></span>
<span id="cb17-101"><a href="#cb17-101" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div style="margin: 0;"&gt;</span></span>
<span id="cb17-102"><a href="#cb17-102" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span>paragraphElements<span class="sc">}</span></span>
<span id="cb17-103"><a href="#cb17-103" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb17-104"><a href="#cb17-104" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;/div&gt;</span></span>
<span id="cb17-105"><a href="#cb17-105" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span><span class="op">;</span></span>
<span id="cb17-106"><a href="#cb17-106" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-17-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-17-2" data-nodetype="declaration"></div></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb18" data-startfrom="1" data-source-offset="-35"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>nbTitle <span class="op">=</span> <span class="fu">_lang</span>(vulnerability_translations<span class="op">.</span><span class="at">notebook_title</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="fu">atlasHero</span>(nbTitle<span class="op">,</span> hero_url)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-18-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-18-2" data-nodetype="expression"></div></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb19" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb19--1"><a href="#cb19--1" aria-hidden="true" tabindex="-1"></a>overview <span class="op">=</span> <span class="fu">_lang</span>(vulnerability_translations<span class="op">.</span><span class="at">notebook_overview</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-19" data-nodetype="declaration"></div></div></div><section id="overview" class="level1"><h1><span><span id="ojs-element-id-1"></span></span></h1><p><span><span id="ojs-element-id-2"></span></span></p><p><span><span id="ojs-element-id-3"></span></span></p><hr><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb20" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb20--1"><a href="#cb20--1" aria-hidden="true" tabindex="-1"></a>exposureQuestion <span class="op">=</span> <span class="fu">_lang</span>(vulnerability_translations<span class="op">.</span><span class="at">exposure_question</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-20" data-nodetype="declaration"></div></div></div></section><section id="exposure" class="level1"><h1><span><span id="ojs-element-id-4"></span></span></h1><p><span><span id="ojs-element-id-5"></span></span></p><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb21" data-startfrom="1" data-source-offset="-72"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>viewof selectAdmin0 <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">select</span>(dataAdmin0<span class="op">,</span> {</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> adminRegions<span class="op">.</span><span class="at">labels</span><span class="op">.</span><span class="at">admin0</span><span class="op">,</span> </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">format</span><span class="op">:</span> x <span class="kw">=&gt;</span> x<span class="op">.</span><span class="at">label</span><span class="op">,</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> dataAdmin0<span class="op">.</span><span class="fu">find</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value</span> <span class="op">===</span> sharedAdmin0) <span class="op">||</span> (dataAdmin0<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> dataAdmin0[<span class="dv">0</span>] <span class="op">:</span> <span class="kw">null</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>viewof selectAdmin1 <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">select</span>(dataAdmin1<span class="op">,</span> {</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> adminRegions<span class="op">.</span><span class="at">labels</span><span class="op">.</span><span class="at">admin1</span><span class="op">,</span> </span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">format</span><span class="op">:</span> x <span class="kw">=&gt;</span> x<span class="op">.</span><span class="at">label</span><span class="op">,</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> dataAdmin1<span class="op">.</span><span class="fu">find</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value</span> <span class="op">===</span> sharedAdmin1) <span class="op">||</span> (dataAdmin1<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> dataAdmin1[<span class="dv">0</span>] <span class="op">:</span> <span class="kw">null</span>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>viewof selectAdmin2 <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">select</span>(dataAdmin2<span class="op">,</span> {</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> adminRegions<span class="op">.</span><span class="at">labels</span><span class="op">.</span><span class="at">admin2</span><span class="op">,</span> </span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">format</span><span class="op">:</span> x <span class="kw">=&gt;</span> x<span class="op">.</span><span class="at">label</span><span class="op">,</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> dataAdmin2<span class="op">.</span><span class="fu">find</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value</span> <span class="op">===</span> sharedAdmin2) <span class="op">||</span> (dataAdmin2<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> dataAdmin2[<span class="dv">0</span>] <span class="op">:</span> <span class="kw">null</span>)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-21-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-21-2" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-21-3" data-nodetype="declaration"></div></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb22" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb22--1"><a href="#cb22--1" aria-hidden="true" tabindex="-1"></a>exposureControlsForm <span class="op">=</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">`</span></span>
<span id="cb22-0"><a href="#cb22-0" aria-hidden="true" tabindex="-1"></a><span class="vs">&lt;div style="</span></span>
<span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="vs">  background: #f8fafc;</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="vs">  border: 2px solid #e2e8f0;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="vs">  border-radius: 12px;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="vs">  padding: 24px;</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="vs">  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="vs">  margin: 16px 0;</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="vs">"&gt;</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;h3 style="margin: 0 0 20px 0; color: #2d3748; font-size: 1.1rem; font-weight: 600;"&gt;</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="vs">    </span><span class="sc">${</span><span class="fu">_lang</span>(vulnerability_translations<span class="op">.</span><span class="at">geographic_selection</span>)<span class="sc">}</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;/h3&gt;</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;div style="</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="vs">    display: flex;</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="vs">    align-items: flex-start;</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="vs">    gap: 20px;</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="vs">    flex-wrap: wrap;</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="vs">    justify-content: space-between;</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="vs">  " class="form-inputs-container"&gt;</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div style="flex: 1; min-width: 180px; max-width: 100%;"&gt;</span><span class="sc">${</span>viewof selectAdmin0<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div style="flex: 1; min-width: 180px; max-width: 100%;"&gt;</span><span class="sc">${</span>viewof selectAdmin1<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div style="flex: 1; min-width: 180px; max-width: 100%;"&gt;</span><span class="sc">${</span>viewof selectAdmin2<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;/div&gt;</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="vs">&lt;/div&gt;</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-22" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb23" data-startfrom="1" data-source-offset="-44"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>exposureDb <span class="op">=</span> <span class="cf">await</span> <span class="fu">createExposureDB</span>() <span class="co">// Use cached loading</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>exposureData <span class="op">=</span> {</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>exposureDb) <span class="cf">return</span> []<span class="op">;</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> query <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="vs">      SELECT *</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="vs">      FROM exposure_data</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="vs">      WHERE hazard = 'any'</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cf">await</span> exposureDb<span class="op">.</span><span class="fu">query</span>(query)<span class="op">;</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> []<span class="op">;</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-23-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-23-2" data-nodetype="declaration"></div></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb24" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb24--1"><a href="#cb24--1" aria-hidden="true" tabindex="-1"></a><span class="co">// grab tabular data for choropleth</span></span>
<span id="cb24-0"><a href="#cb24-0" aria-hidden="true" tabindex="-1"></a>dataGeoImpact <span class="op">=</span> {</span>
<span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check if exposureData exists and is an array before processing</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>exposureData <span class="op">||</span> <span class="op">!</span><span class="bu">Array</span><span class="op">.</span><span class="fu">isArray</span>(exposureData)) {</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> []<span class="op">;</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// get data for choropleth map based on choice</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> dataSource <span class="op">=</span> exposureData<span class="op">;</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> filteredData<span class="op">;</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// select different data based on admin selections using shared state</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (sharedAdmin1) {</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    filteredData <span class="op">=</span> dataSource<span class="op">.</span><span class="fu">filter</span>((d) <span class="kw">=&gt;</span> {</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> d<span class="op">.</span><span class="at">admin0_name</span> <span class="op">==</span> sharedAdmin0</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;&amp;</span> d<span class="op">.</span><span class="at">admin1_name</span> <span class="op">==</span> sharedAdmin1</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;&amp;</span> d<span class="op">.</span><span class="at">admin2_name</span> <span class="co">// always non-null</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (sharedAdmin0) {</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// admin0 is selected, with no admin1</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// get all admin1 data for selected admin0</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    filteredData <span class="op">=</span> dataSource<span class="op">.</span><span class="fu">filter</span>((d) <span class="kw">=&gt;</span> {</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> d<span class="op">.</span><span class="at">admin0_name</span> <span class="op">==</span> sharedAdmin0</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;&amp;</span> d<span class="op">.</span><span class="at">admin1_name</span> <span class="co">// always non-null </span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;&amp;</span> <span class="op">!</span>d<span class="op">.</span><span class="at">admin2_name</span> <span class="co">// always null</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// end case: admin0 is not selected</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// get all admin0 data</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>    filteredData <span class="op">=</span> dataSource<span class="op">.</span><span class="fu">filter</span>((d) <span class="kw">=&gt;</span> {</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="op">!</span>d<span class="op">.</span><span class="at">admin1_name</span> <span class="co">// always null </span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;&amp;</span> <span class="op">!</span>d<span class="op">.</span><span class="at">admin2_name</span> <span class="co">// always null</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Aggregate data by summing values for each administrative region</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (filteredData<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) <span class="cf">return</span> []<span class="op">;</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Determine grouping key based on admin level</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Handle null values explicitly to avoid "null" strings in keys</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> groupKey<span class="op">;</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (sharedAdmin1) {</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Group by admin2</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>    groupKey <span class="op">=</span> d <span class="kw">=&gt;</span> <span class="vs">`</span><span class="sc">${</span>d<span class="op">.</span><span class="at">admin0_name</span> <span class="op">||</span> <span class="st">'NULL'</span><span class="sc">}</span><span class="vs">|</span><span class="sc">${</span>d<span class="op">.</span><span class="at">admin1_name</span> <span class="op">||</span> <span class="st">'NULL'</span><span class="sc">}</span><span class="vs">|</span><span class="sc">${</span>d<span class="op">.</span><span class="at">admin2_name</span> <span class="op">||</span> <span class="st">'NULL'</span><span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (sharedAdmin0) {</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Group by admin1</span></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>    groupKey <span class="op">=</span> d <span class="kw">=&gt;</span> <span class="vs">`</span><span class="sc">${</span>d<span class="op">.</span><span class="at">admin0_name</span> <span class="op">||</span> <span class="st">'NULL'</span><span class="sc">}</span><span class="vs">|</span><span class="sc">${</span>d<span class="op">.</span><span class="at">admin1_name</span> <span class="op">||</span> <span class="st">'NULL'</span><span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Group by admin0</span></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>    groupKey <span class="op">=</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin0_name</span> <span class="op">||</span> <span class="st">'NULL'</span><span class="op">;</span></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> groupedData <span class="op">=</span> d3<span class="op">.</span><span class="fu">group</span>(filteredData<span class="op">,</span> groupKey)<span class="op">;</span></span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(groupedData<span class="op">.</span><span class="fu">entries</span>())<span class="op">.</span><span class="fu">map</span>(([key<span class="op">,</span> values]) <span class="kw">=&gt;</span> {</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Parse the key back to get admin names</span></span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> admin0_name<span class="op">,</span> admin1_name<span class="op">,</span> admin2_name<span class="op">;</span></span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (sharedAdmin1) {</span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>      [admin0_name<span class="op">,</span> admin1_name<span class="op">,</span> admin2_name] <span class="op">=</span> key<span class="op">.</span><span class="fu">split</span>(<span class="st">"|"</span>)<span class="op">;</span></span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (sharedAdmin0) {</span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>      [admin0_name<span class="op">,</span> admin1_name] <span class="op">=</span> key<span class="op">.</span><span class="fu">split</span>(<span class="st">"|"</span>)<span class="op">;</span></span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>      admin0_name <span class="op">=</span> key<span class="op">;</span></span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sum up all exposure values for this region</span></span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> totalValue <span class="op">=</span> d3<span class="op">.</span><span class="fu">sum</span>(values<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value</span> <span class="op">||</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a>      admin0_name<span class="op">,</span></span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a>      <span class="dt">admin1_name</span><span class="op">:</span> admin1_name <span class="op">||</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a>      <span class="dt">admin2_name</span><span class="op">:</span> admin2_name <span class="op">||</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a>      <span class="dt">value</span><span class="op">:</span> totalValue</span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-24" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb25" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb25--1"><a href="#cb25--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Geographic data binding</span></span>
<span id="cb25-0"><a href="#cb25-0" aria-hidden="true" tabindex="-1"></a>exposureMapData <span class="op">=</span> {</span>
<span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>dataGeoImpact <span class="op">||</span> dataGeoImpact<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> { <span class="dt">features</span><span class="op">:</span> [] }<span class="op">;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check if boundaries exist before accessing properties</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>boundaries) {</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> { <span class="dt">features</span><span class="op">:</span> [] }<span class="op">;</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Determine which admin level to show</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>sharedAdmin0) {</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Show admin0 level</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>boundaries<span class="op">.</span><span class="at">admin0</span> <span class="op">||</span> <span class="op">!</span>boundaries<span class="op">.</span><span class="at">admin0</span><span class="op">.</span><span class="at">features</span>) {</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> { <span class="dt">features</span><span class="op">:</span> [] }<span class="op">;</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">bindTabularToGeo</span>({</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">data</span><span class="op">:</span> dataGeoImpact<span class="op">,</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">dataBindColumn</span><span class="op">:</span> <span class="st">"admin0_name"</span><span class="op">,</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>      <span class="dt">geoData</span><span class="op">:</span> boundaries<span class="op">.</span><span class="at">admin0</span><span class="op">,</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>      <span class="dt">geoDataBindColumn</span><span class="op">:</span> <span class="st">"admin0_name"</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="op">!</span>sharedAdmin1) {</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Show admin1 level within selected admin0</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>boundaries<span class="op">.</span><span class="at">admin1</span> <span class="op">||</span> <span class="op">!</span>boundaries<span class="op">.</span><span class="at">admin1</span><span class="op">.</span><span class="at">features</span>) {</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> { <span class="dt">features</span><span class="op">:</span> [] }<span class="op">;</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> dataGeoImpact<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> ({</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>d<span class="op">,</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>      <span class="dt">a1_a0</span><span class="op">:</span> [d<span class="op">.</span><span class="at">admin1_name</span><span class="op">,</span> d<span class="op">.</span><span class="at">admin0_name</span>]<span class="op">.</span><span class="fu">join</span>(<span class="st">"_"</span>)</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> geoData <span class="op">=</span> {</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>boundaries<span class="op">.</span><span class="at">admin1</span><span class="op">,</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>      <span class="dt">features</span><span class="op">:</span> boundaries<span class="op">.</span><span class="at">admin1</span><span class="op">.</span><span class="at">features</span><span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>        d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">admin0_name</span> <span class="op">===</span> sharedAdmin0</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">bindTabularToGeo</span>({</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>      <span class="dt">data</span><span class="op">:</span> data<span class="op">,</span></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>      <span class="dt">dataBindColumn</span><span class="op">:</span> <span class="st">"admin1_name"</span><span class="op">,</span></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>      <span class="dt">geoData</span><span class="op">:</span> geoData<span class="op">,</span></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>      <span class="dt">geoDataBindColumn</span><span class="op">:</span> <span class="st">"admin1_name"</span></span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Show admin2 level within selected admin1</span></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>boundaries<span class="op">.</span><span class="at">admin2</span> <span class="op">||</span> <span class="op">!</span>boundaries<span class="op">.</span><span class="at">admin2</span><span class="op">.</span><span class="at">features</span>) {</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> { <span class="dt">features</span><span class="op">:</span> [] }<span class="op">;</span></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> dataGeoImpact<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> ({</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>d<span class="op">,</span></span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>      <span class="dt">a2_a1_a0</span><span class="op">:</span> [d<span class="op">.</span><span class="at">admin2_name</span><span class="op">,</span> d<span class="op">.</span><span class="at">admin1_name</span><span class="op">,</span> d<span class="op">.</span><span class="at">admin0_name</span>]<span class="op">.</span><span class="fu">join</span>(<span class="st">"_"</span>)</span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> geoData <span class="op">=</span> {</span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>boundaries<span class="op">.</span><span class="at">admin2</span><span class="op">,</span></span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>      <span class="dt">features</span><span class="op">:</span> boundaries<span class="op">.</span><span class="at">admin2</span><span class="op">.</span><span class="at">features</span><span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> </span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>        d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">admin1_name</span> <span class="op">===</span> sharedAdmin1 <span class="op">&amp;&amp;</span></span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a>        d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">admin0_name</span> <span class="op">===</span> sharedAdmin0</span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">bindTabularToGeo</span>({</span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a>      <span class="dt">data</span><span class="op">:</span> data<span class="op">,</span></span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>      <span class="dt">dataBindColumn</span><span class="op">:</span> <span class="st">"admin2_name"</span><span class="op">,</span></span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>      <span class="dt">geoData</span><span class="op">:</span> geoData<span class="op">,</span></span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a>      <span class="dt">geoDataBindColumn</span><span class="op">:</span> <span class="st">"admin2_name"</span></span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-25" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb26" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb26--1"><a href="#cb26--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Visualization with proper loading/no-data states</span></span>
<span id="cb26-0"><a href="#cb26-0" aria-hidden="true" tabindex="-1"></a>exposureChoroplethMap <span class="op">=</span> {</span>
<span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Show loading spinner only if data is still loading (null/undefined)</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (exposureData <span class="op">===</span> <span class="kw">null</span> <span class="op">||</span> exposureData <span class="op">===</span> <span class="kw">undefined</span>) {</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">createLoadingState</span>(<span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Loading exposure data..."</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Chargement des donn√©es d'exposition..."</span>}))<span class="op">;</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// If data is loaded but empty, or map data is empty, show no data state</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>exposureData <span class="op">||</span> exposureData<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span> <span class="op">||</span> <span class="op">!</span>exposureMapData <span class="op">||</span> <span class="op">!</span>exposureMapData<span class="op">.</span><span class="at">features</span> <span class="op">||</span> exposureMapData<span class="op">.</span><span class="at">features</span><span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">createNoDataState</span>(<span class="fu">_lang</span>(vulnerability_translations<span class="op">.</span><span class="at">no_data_available</span>))<span class="op">;</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> data <span class="op">=</span> exposureMapData<span class="op">;</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> plot <span class="op">=</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> mapWidth<span class="op">,</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">height</span><span class="op">:</span> mapHeight<span class="op">,</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">caption</span><span class="op">:</span> vopNote<span class="op">.</span><span class="at">caption</span><span class="op">,</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">projection</span><span class="op">:</span> {</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">"azimuthal-equal-area"</span><span class="op">,</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> data</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>      <span class="dt">legend</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span><span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"VoP"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"VoP"</span>})<span class="sc">}</span><span class="vs"> (</span><span class="sc">${</span>intDollarUnit<span class="sc">}</span><span class="vs">)`</span><span class="op">,</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>      <span class="dt">range</span><span class="op">:</span> colorScales<span class="op">.</span><span class="at">range</span><span class="op">.</span><span class="at">yellowGreen</span><span class="op">,</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>      <span class="dt">unknown</span><span class="op">:</span> colorScales<span class="op">.</span><span class="at">unknown</span><span class="op">,</span></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>      <span class="dt">tickFormat</span><span class="op">:</span> formatNumCompactShort<span class="op">,</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Base geography - no tooltip here</span></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">geo</span>(data<span class="op">.</span><span class="at">features</span><span class="op">,</span> {</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> d <span class="kw">=&gt;</span> {</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> dataColumn <span class="op">=</span> <span class="st">'value'</span>     </span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> fillValue <span class="op">=</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">data</span> <span class="op">?</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">data</span>[dataColumn] <span class="op">:</span> <span class="kw">null</span><span class="op">;</span> <span class="co">// handle missing data</span></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> fillValue</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>        }<span class="op">,</span></span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stroke</span><span class="op">:</span> <span class="st">"#fff"</span><span class="op">,</span></span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>        <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span></span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Highlight selected admin2 region</span></span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">geo</span>(</span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>        sharedAdmin2</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>          <span class="op">?</span> data<span class="op">.</span><span class="at">features</span><span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">admin2_name</span> <span class="op">===</span> sharedAdmin2)</span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>          <span class="op">:</span> []<span class="op">,</span> </span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stroke</span><span class="op">:</span> <span class="st">"#333"</span><span class="op">,</span></span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>          <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">1.5</span></span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>      )<span class="op">,</span></span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Interactive pointer</span></span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">geo</span>(data<span class="op">,</span> Plot<span class="op">.</span><span class="fu">pointer</span>(</span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a>        Plot<span class="op">.</span><span class="fu">centroid</span>({</span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stroke</span><span class="op">:</span> <span class="st">"#333"</span><span class="op">,</span></span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a>        <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">1.5</span><span class="op">,</span></span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a>      })))<span class="op">,</span></span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Tooltip using the exact working pattern</span></span>
<span id="cb26-61"><a href="#cb26-61" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">tip</span>(</span>
<span id="cb26-62"><a href="#cb26-62" aria-hidden="true" tabindex="-1"></a>        data<span class="op">.</span><span class="at">features</span><span class="op">,</span></span>
<span id="cb26-63"><a href="#cb26-63" aria-hidden="true" tabindex="-1"></a>        Plot<span class="op">.</span><span class="fu">pointer</span>(</span>
<span id="cb26-64"><a href="#cb26-64" aria-hidden="true" tabindex="-1"></a>          Plot<span class="op">.</span><span class="fu">centroid</span>({</span>
<span id="cb26-65"><a href="#cb26-65" aria-hidden="true" tabindex="-1"></a>            <span class="dt">channels</span><span class="op">:</span> {</span>
<span id="cb26-66"><a href="#cb26-66" aria-hidden="true" tabindex="-1"></a>              <span class="dt">country</span><span class="op">:</span> {</span>
<span id="cb26-67"><a href="#cb26-67" aria-hidden="true" tabindex="-1"></a>                <span class="dt">label</span><span class="op">:</span> <span class="st">"Country"</span><span class="op">,</span></span>
<span id="cb26-68"><a href="#cb26-68" aria-hidden="true" tabindex="-1"></a>                <span class="dt">value</span><span class="op">:</span> (d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">admin0_name</span></span>
<span id="cb26-69"><a href="#cb26-69" aria-hidden="true" tabindex="-1"></a>              }<span class="op">,</span></span>
<span id="cb26-70"><a href="#cb26-70" aria-hidden="true" tabindex="-1"></a>              <span class="dt">name</span><span class="op">:</span> {</span>
<span id="cb26-71"><a href="#cb26-71" aria-hidden="true" tabindex="-1"></a>                <span class="dt">label</span><span class="op">:</span> <span class="st">"Region"</span><span class="op">,</span></span>
<span id="cb26-72"><a href="#cb26-72" aria-hidden="true" tabindex="-1"></a>                <span class="dt">value</span><span class="op">:</span> (d) <span class="kw">=&gt;</span> {</span>
<span id="cb26-73"><a href="#cb26-73" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">if</span> (d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">admin2_name</span>) {</span>
<span id="cb26-74"><a href="#cb26-74" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> <span class="vs">`</span><span class="sc">${</span>d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">admin2_name</span><span class="sc">}</span><span class="vs">, </span><span class="sc">${</span>d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">admin1_name</span><span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb26-75"><a href="#cb26-75" aria-hidden="true" tabindex="-1"></a>                  } <span class="cf">else</span> <span class="cf">if</span> (d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">admin1_name</span>) {</span>
<span id="cb26-76"><a href="#cb26-76" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">admin1_name</span><span class="op">;</span></span>
<span id="cb26-77"><a href="#cb26-77" aria-hidden="true" tabindex="-1"></a>                  } <span class="cf">else</span> {</span>
<span id="cb26-78"><a href="#cb26-78" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">admin0_name</span><span class="op">;</span></span>
<span id="cb26-79"><a href="#cb26-79" aria-hidden="true" tabindex="-1"></a>                  }</span>
<span id="cb26-80"><a href="#cb26-80" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb26-81"><a href="#cb26-81" aria-hidden="true" tabindex="-1"></a>              }<span class="op">,</span></span>
<span id="cb26-82"><a href="#cb26-82" aria-hidden="true" tabindex="-1"></a>              <span class="dt">data</span><span class="op">:</span> {</span>
<span id="cb26-83"><a href="#cb26-83" aria-hidden="true" tabindex="-1"></a>                <span class="dt">label</span><span class="op">:</span> <span class="st">"VoP"</span><span class="op">,</span></span>
<span id="cb26-84"><a href="#cb26-84" aria-hidden="true" tabindex="-1"></a>                <span class="dt">value</span><span class="op">:</span> (d) <span class="kw">=&gt;</span> {</span>
<span id="cb26-85"><a href="#cb26-85" aria-hidden="true" tabindex="-1"></a>                  <span class="kw">const</span> dataColumn <span class="op">=</span> <span class="st">'value'</span></span>
<span id="cb26-86"><a href="#cb26-86" aria-hidden="true" tabindex="-1"></a>                  <span class="kw">const</span> data <span class="op">=</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">data</span> <span class="op">?</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">data</span>[dataColumn] <span class="op">:</span> <span class="kw">undefined</span></span>
<span id="cb26-87"><a href="#cb26-87" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">return</span> data</span>
<span id="cb26-88"><a href="#cb26-88" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb26-89"><a href="#cb26-89" aria-hidden="true" tabindex="-1"></a>              }</span>
<span id="cb26-90"><a href="#cb26-90" aria-hidden="true" tabindex="-1"></a>            }<span class="op">,</span></span>
<span id="cb26-91"><a href="#cb26-91" aria-hidden="true" tabindex="-1"></a>            <span class="dt">format</span><span class="op">:</span> {</span>
<span id="cb26-92"><a href="#cb26-92" aria-hidden="true" tabindex="-1"></a>              <span class="dt">country</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb26-93"><a href="#cb26-93" aria-hidden="true" tabindex="-1"></a>              <span class="dt">name</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb26-94"><a href="#cb26-94" aria-hidden="true" tabindex="-1"></a>              <span class="dt">data</span><span class="op">:</span> (d) <span class="kw">=&gt;</span> d <span class="op">?</span> <span class="fu">formatNumCompactShort</span>(d) <span class="op">:</span> <span class="st">"No data"</span></span>
<span id="cb26-95"><a href="#cb26-95" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb26-96"><a href="#cb26-96" aria-hidden="true" tabindex="-1"></a>          })</span>
<span id="cb26-97"><a href="#cb26-97" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb26-98"><a href="#cb26-98" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb26-99"><a href="#cb26-99" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb26-100"><a href="#cb26-100" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb26-101"><a href="#cb26-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-102"><a href="#cb26-102" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">`</span></span>
<span id="cb26-103"><a href="#cb26-103" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;!--   &lt;div style=" --&gt;</span></span>
<span id="cb26-104"><a href="#cb26-104" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;!--     border: 1px solid #e5e7eb; --&gt;</span></span>
<span id="cb26-105"><a href="#cb26-105" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;!--     border-radius: 8px; --&gt;</span></span>
<span id="cb26-106"><a href="#cb26-106" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;!--   padding: 20px; --&gt;</span></span>
<span id="cb26-107"><a href="#cb26-107" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;!--   background-color: #fff; --&gt;</span></span>
<span id="cb26-108"><a href="#cb26-108" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;!--   box-shadow: 0 2px 4px rgba(0,0,0,0.1); --&gt;</span></span>
<span id="cb26-109"><a href="#cb26-109" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;!--     margin: 16px 0; --&gt;</span></span>
<span id="cb26-110"><a href="#cb26-110" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;!-- "&gt; --&gt;</span></span>
<span id="cb26-111"><a href="#cb26-111" aria-hidden="true" tabindex="-1"></a><span class="vs">    </span><span class="sc">${</span>plot<span class="sc">}</span></span>
<span id="cb26-112"><a href="#cb26-112" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;!-- &lt;/div&gt; --&gt;</span></span>
<span id="cb26-113"><a href="#cb26-113" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span><span class="op">;</span></span>
<span id="cb26-114"><a href="#cb26-114" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-26" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb27" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb27--1"><a href="#cb27--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Download functionality</span></span>
<span id="cb27-0"><a href="#cb27-0" aria-hidden="true" tabindex="-1"></a>exposureDownloadButton <span class="op">=</span> {</span>
<span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>dataGeoImpact <span class="op">||</span> dataGeoImpact<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">``</span><span class="op">;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">downloadButton</span>(</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    dataGeoImpact<span class="op">,</span> </span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="vs">`exposure_data_</span><span class="sc">${</span><span class="fu">getExposureAdminSelection</span>()<span class="op">.</span><span class="fu">replace</span>(<span class="ss">/</span><span class="sc">\s+</span><span class="ss">/g</span><span class="op">,</span> <span class="st">'_'</span>)<span class="sc">}</span><span class="vs">_all_hazard_types`</span><span class="op">,</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">_lang</span>(vulnerability_translations<span class="op">.</span><span class="at">download_data</span>)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-27" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb28" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb28--1"><a href="#cb28--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Dynamic insights</span></span>
<span id="cb28-0"><a href="#cb28-0" aria-hidden="true" tabindex="-1"></a>exposureInsights <span class="op">=</span> {</span>
<span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>dataGeoImpact <span class="op">||</span> dataGeoImpact<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">createNoDataState</span>()<span class="op">;</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Calculate total exposure value</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> totalValue <span class="op">=</span> d3<span class="op">.</span><span class="fu">sum</span>(dataGeoImpact<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value</span> <span class="op">||</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> region <span class="op">=</span> <span class="fu">getExposureAdminSelection</span>()<span class="op">;</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> hazardLabel <span class="op">=</span> <span class="st">"Any"</span><span class="op">;</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Get top 3 most exposed commodities</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> topCommodities <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (exposureData <span class="op">&amp;&amp;</span> exposureData<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Filter data based on current admin selection</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> filteredCommodityData <span class="op">=</span> exposureData<span class="op">;</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (sharedAdmin1) {</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>      filteredCommodityData <span class="op">=</span> exposureData<span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> </span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>        d<span class="op">.</span><span class="at">admin0_name</span> <span class="op">===</span> sharedAdmin0 <span class="op">&amp;&amp;</span> </span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>        d<span class="op">.</span><span class="at">admin1_name</span> <span class="op">===</span> sharedAdmin1 <span class="op">&amp;&amp;</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>        d<span class="op">.</span><span class="at">admin2_name</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>      )<span class="op">;</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (sharedAdmin0) {</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>      filteredCommodityData <span class="op">=</span> exposureData<span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> </span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>        d<span class="op">.</span><span class="at">admin0_name</span> <span class="op">===</span> sharedAdmin0 <span class="op">&amp;&amp;</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>        d<span class="op">.</span><span class="at">admin1_name</span> <span class="op">&amp;&amp;</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">!</span>d<span class="op">.</span><span class="at">admin2_name</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>      )<span class="op">;</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>      filteredCommodityData <span class="op">=</span> exposureData<span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> </span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">!</span>d<span class="op">.</span><span class="at">admin1_name</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>d<span class="op">.</span><span class="at">admin2_name</span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>      )<span class="op">;</span></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Group by commodity and sum values</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> commodityGroups <span class="op">=</span> d3<span class="op">.</span><span class="fu">group</span>(filteredCommodityData<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">crop</span>)<span class="op">;</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> commodityTotals <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(commodityGroups<span class="op">.</span><span class="fu">entries</span>())<span class="op">.</span><span class="fu">map</span>(([crop<span class="op">,</span> values]) <span class="kw">=&gt;</span> ({</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>      <span class="dt">crop</span><span class="op">:</span> crop<span class="op">,</span></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>      <span class="dt">totalValue</span><span class="op">:</span> d3<span class="op">.</span><span class="fu">sum</span>(values<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value</span> <span class="op">||</span> <span class="dv">0</span>)</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sort by total value and get top 3</span></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>    topCommodities <span class="op">=</span> commodityTotals</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> b<span class="op">.</span><span class="at">totalValue</span> <span class="op">-</span> a<span class="op">.</span><span class="at">totalValue</span>)</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">3</span>)</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">totalValue</span> <span class="op">&gt;</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Format currency without the "2015 USD" prefix</span></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> formatCleanCurrency <span class="op">=</span> (number) <span class="kw">=&gt;</span> {</span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">new</span> <span class="bu">Intl</span><span class="op">.</span><span class="fu">NumberFormat</span>(<span class="st">"en-US"</span><span class="op">,</span> {</span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>      <span class="dt">notation</span><span class="op">:</span> <span class="st">"compact"</span><span class="op">,</span></span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>      <span class="dt">compactDisplay</span><span class="op">:</span> <span class="st">"short"</span><span class="op">,</span></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>      <span class="dt">style</span><span class="op">:</span> <span class="st">"currency"</span><span class="op">,</span></span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a>      <span class="dt">currency</span><span class="op">:</span> <span class="st">"USD"</span><span class="op">,</span></span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">format</span>(number)<span class="op">;</span></span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> template <span class="op">=</span> <span class="fu">_lang</span>(vulnerability_translations<span class="op">.</span><span class="at">exposure_insight_template</span>)<span class="op">;</span></span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> replacements <span class="op">=</span> [</span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">name</span><span class="op">:</span> <span class="st">"region"</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> region }<span class="op">,</span></span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">name</span><span class="op">:</span> <span class="st">"amount"</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="fu">formatCleanCurrency</span>(totalValue) }</span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">;</span></span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> insight <span class="op">=</span> <span class="fu">generateInsight</span>(template<span class="op">,</span> replacements)<span class="op">;</span></span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add top commodities insight if available</span></span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> commoditiesInsight <span class="op">=</span> <span class="st">""</span><span class="op">;</span></span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (topCommodities<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create dynamic text with specific commodity names</span></span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> commodityNames <span class="op">=</span> topCommodities</span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">crop</span><span class="op">.</span><span class="fu">replace</span>(<span class="ss">/-/g</span><span class="op">,</span> <span class="st">' '</span>))</span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">join</span>(<span class="st">", "</span>)<span class="op">;</span></span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> commoditiesText <span class="op">=</span> <span class="fu">_lang</span>({</span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a>      <span class="dt">en</span><span class="op">:</span> <span class="vs">` The top 3 most exposed commodities are:`</span><span class="op">,</span></span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fr</span><span class="op">:</span> <span class="vs">` Les 3 produits les plus expos√©s sont:`</span></span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Combine insight text with commodities list as HTML using proper htl.html syntax</span></span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> fullInsight <span class="op">=</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">`</span></span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span>insight<span class="sc">}${</span>commoditiesText<span class="sc">}</span></span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;ol&gt;</span></span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span>topCommodities<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">`&lt;li&gt;</span><span class="sc">${</span>d<span class="op">.</span><span class="at">crop</span><span class="op">.</span><span class="fu">replace</span>(<span class="ss">/-/g</span><span class="op">,</span> <span class="st">' '</span>)<span class="sc">}</span><span class="vs"> (</span><span class="sc">${</span><span class="fu">formatCleanCurrency</span>(d<span class="op">.</span><span class="at">totalValue</span>)<span class="sc">}</span><span class="vs">)&lt;/li&gt;`</span>)<span class="sc">}</span></span>
<span id="cb28-84"><a href="#cb28-84" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/ol&gt;</span></span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">createInsightDisplay</span>(fullInsight)<span class="op">;</span></span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">createInsightDisplay</span>(insight)<span class="op">;</span></span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-28" data-nodetype="declaration"></div></div></div><hr><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb29" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb29--1"><a href="#cb29--1" aria-hidden="true" tabindex="-1"></a>sensitivityQuestion <span class="op">=</span> <span class="fu">_lang</span>(vulnerability_translations<span class="op">.</span><span class="at">sensitivity_question</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-29" data-nodetype="declaration"></div></div></div></section><section id="sensitivity" class="level1"><h1><span><span id="ojs-element-id-6"></span></span></h1><p><span><span id="ojs-element-id-7"></span></span></p><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb30" data-startfrom="1" data-source-offset="-55"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>viewof sensitivityAdmin0 <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">select</span>(dataAdmin0<span class="op">,</span> {</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> adminRegions<span class="op">.</span><span class="at">labels</span><span class="op">.</span><span class="at">admin0</span><span class="op">,</span> </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">format</span><span class="op">:</span> x <span class="kw">=&gt;</span> x<span class="op">.</span><span class="at">label</span><span class="op">,</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> dataAdmin0<span class="op">.</span><span class="fu">find</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value</span> <span class="op">===</span> sharedAdmin0) <span class="op">||</span> (dataAdmin0<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> dataAdmin0[<span class="dv">0</span>] <span class="op">:</span> <span class="kw">null</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>viewof sensitivityAdmin1 <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">select</span>(dataAdmin1<span class="op">,</span> {</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> adminRegions<span class="op">.</span><span class="at">labels</span><span class="op">.</span><span class="at">admin1</span><span class="op">,</span> </span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">format</span><span class="op">:</span> x <span class="kw">=&gt;</span> x<span class="op">.</span><span class="at">label</span><span class="op">,</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> dataAdmin1<span class="op">.</span><span class="fu">find</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value</span> <span class="op">===</span> sharedAdmin1) <span class="op">||</span> (dataAdmin1<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> dataAdmin1[<span class="dv">0</span>] <span class="op">:</span> <span class="kw">null</span>)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>viewof sensitivityAdmin2 <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">select</span>(dataAdmin2<span class="op">,</span> {</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> adminRegions<span class="op">.</span><span class="at">labels</span><span class="op">.</span><span class="at">admin2</span><span class="op">,</span> </span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">format</span><span class="op">:</span> x <span class="kw">=&gt;</span> x<span class="op">.</span><span class="at">label</span><span class="op">,</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> dataAdmin2<span class="op">.</span><span class="fu">find</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value</span> <span class="op">===</span> sharedAdmin2) <span class="op">||</span> (dataAdmin2<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> dataAdmin2[<span class="dv">0</span>] <span class="op">:</span> <span class="kw">null</span>)</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-30-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-30-2" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-30-3" data-nodetype="declaration"></div></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb31" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb31--1"><a href="#cb31--1" aria-hidden="true" tabindex="-1"></a>sensitivityControlsForm <span class="op">=</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">`</span></span>
<span id="cb31-0"><a href="#cb31-0" aria-hidden="true" tabindex="-1"></a><span class="vs">&lt;div style="</span></span>
<span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="vs">  background: #f8fafc;</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="vs">  border: 2px solid #e2e8f0;</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="vs">  border-radius: 12px;</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="vs">  padding: 24px;</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="vs">  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="vs">  margin: 16px 0;</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="vs">"&gt;</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;h3 style="margin: 0 0 20px 0; color: #2d3748; font-size: 1.1rem; font-weight: 600;"&gt;</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="vs">    </span><span class="sc">${</span><span class="fu">_lang</span>(vulnerability_translations<span class="op">.</span><span class="at">geographic_selection</span>)<span class="sc">}</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;/h3&gt;</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;div style="</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="vs">    display: flex;</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="vs">    align-items: flex-start;</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="vs">    gap: 20px;</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="vs">    flex-wrap: wrap;</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="vs">    justify-content: space-between;</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="vs">  " class="form-inputs-container"&gt;</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div style="flex: 1; min-width: 180px; max-width: 100%;"&gt;</span><span class="sc">${</span>viewof sensitivityAdmin0<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div style="flex: 1; min-width: 180px; max-width: 100%;"&gt;</span><span class="sc">${</span>viewof sensitivityAdmin1<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div style="flex: 1; min-width: 180px; max-width: 100%;"&gt;</span><span class="sc">${</span>viewof sensitivityAdmin2<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;/div&gt;</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a><span class="vs">&lt;/div&gt;</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-31" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb32" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb32--1"><a href="#cb32--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Load icicle metadata and data with caching</span></span>
<span id="cb32-0"><a href="#cb32-0" aria-hidden="true" tabindex="-1"></a>icicleKeys <span class="op">=</span> <span class="cf">await</span> <span class="fu">loadDataWithCache</span>(<span class="st">"icicleKeys"</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="cf">await</span> <span class="fu">FileAttachment</span>(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"/data/vulnerability_notebook/vulnerability_iciclekeys.json"</span><span class="op">,</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  )<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-32" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb33" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb33--1"><a href="#cb33--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Load data with caching - using parquet via DuckDB</span></span>
<span id="cb33-0"><a href="#cb33-0" aria-hidden="true" tabindex="-1"></a>csv_raw <span class="op">=</span> <span class="cf">await</span> <span class="fu">loadDataWithCache</span>(<span class="st">"sensitivityData"</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> db <span class="op">=</span> <span class="cf">await</span> DuckDBClient<span class="op">.</span><span class="fu">of</span>({</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vulnerability_icicle</span><span class="op">:</span> <span class="fu">FileAttachment</span>(</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>      <span class="st">"/data/vulnerability_notebook/vulnerability_icicledata_updated.parquet"</span><span class="op">,</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    )<span class="op">,</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">query</span>(<span class="st">"SELECT * FROM vulnerability_icicle"</span>)<span class="op">;</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Convert to the expected format: array of arrays [admin0, admin1, admin2, path, value]</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// The parquet should have columns: admin0_name, admin1_name, admin2_name, path, value</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> data</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>((d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">path</span> <span class="op">!=</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> d<span class="op">.</span><span class="at">path</span> <span class="op">!==</span> <span class="st">""</span>)</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>((d) <span class="kw">=&gt;</span> {</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Convert null values to "NA" string to match CSV format</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> admin0 <span class="op">=</span> d<span class="op">.</span><span class="at">admin0_name</span> <span class="op">||</span> <span class="st">"SSA"</span><span class="op">;</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> admin1 <span class="op">=</span> d<span class="op">.</span><span class="at">admin1_name</span> <span class="op">||</span> <span class="st">"NA"</span><span class="op">;</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> admin2 <span class="op">=</span> d<span class="op">.</span><span class="at">admin2_name</span> <span class="op">||</span> <span class="st">"NA"</span><span class="op">;</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> [admin0<span class="op">,</span> admin1<span class="op">,</span> admin2<span class="op">,</span> d<span class="op">.</span><span class="at">path</span><span class="op">,</span> d<span class="op">.</span><span class="at">value</span> <span class="op">||</span> <span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-33" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb34" data-startfrom="0" data-source-offset="-0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -1"><span id="cb34-0"><a href="#cb34-0" aria-hidden="true" tabindex="-1"></a>breadcrumbWidth <span class="op">=</span> <span class="dv">200</span><span class="op">;</span></span>
<span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>breadcrumbHeight <span class="op">=</span> <span class="dv">35</span><span class="op">;</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>targetHeight <span class="op">=</span> <span class="dv">425</span><span class="op">;</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>height <span class="op">=</span> narrow <span class="op">?</span> narrowHeight <span class="op">:</span> targetHeight<span class="op">;</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>narrowHeight <span class="op">=</span> <span class="dv">600</span><span class="op">;</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>narrow <span class="op">=</span> width <span class="op">&lt;=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>segmentX <span class="op">=</span> (d) <span class="kw">=&gt;</span> (narrow <span class="op">?</span> d<span class="op">.</span><span class="at">y0</span> <span class="op">:</span> d<span class="op">.</span><span class="at">x0</span>)<span class="op">;</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>segmentY <span class="op">=</span> (d) <span class="kw">=&gt;</span> (narrow <span class="op">?</span> d<span class="op">.</span><span class="at">x0</span> <span class="op">:</span> d<span class="op">.</span><span class="at">y0</span>)<span class="op">;</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>segmentWidth <span class="op">=</span> (d) <span class="kw">=&gt;</span> (narrow <span class="op">?</span> d<span class="op">.</span><span class="at">y1</span> <span class="op">-</span> d<span class="op">.</span><span class="at">y0</span> <span class="op">:</span> d<span class="op">.</span><span class="at">x1</span> <span class="op">-</span> d<span class="op">.</span><span class="at">x0</span>)<span class="op">;</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>segmentHeight <span class="op">=</span> (d) <span class="kw">=&gt;</span> (narrow <span class="op">?</span> d<span class="op">.</span><span class="at">x1</span> <span class="op">-</span> d<span class="op">.</span><span class="at">x0</span> <span class="op">:</span> d<span class="op">.</span><span class="at">y1</span> <span class="op">-</span> d<span class="op">.</span><span class="at">y0</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-34-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-34-2" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-34-3" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-34-4" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-34-5" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-34-6" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-34-7" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-34-8" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-34-9" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-34-10" data-nodetype="declaration"></div></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb35" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb35--1"><a href="#cb35--1" aria-hidden="true" tabindex="-1"></a>partition <span class="op">=</span> (data<span class="op">,</span> order <span class="op">=</span> <span class="kw">null</span>) <span class="kw">=&gt;</span></span>
<span id="cb35-0"><a href="#cb35-0" aria-hidden="true" tabindex="-1"></a>  d3</span>
<span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">partition</span>()</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">padding</span>(<span class="dv">1</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">size</span>(narrow <span class="op">?</span> [height<span class="op">,</span> width] <span class="op">:</span> [width<span class="op">,</span> height])(</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    d3</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">hierarchy</span>(data)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">sum</span>((d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> {</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (order) {</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>          <span class="co">// Look up indices, fallback to 999 if not defined</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> (order[a<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">name</span>] <span class="op">??</span> <span class="dv">999</span>) <span class="op">-</span> (order[b<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">name</span>] <span class="op">??</span> <span class="dv">999</span>)<span class="op">;</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> b<span class="op">.</span><span class="at">value</span> <span class="op">-</span> a<span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-35" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb36" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb36--1"><a href="#cb36--1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">buildHierarchy</span>(csv) {</span>
<span id="cb36-0"><a href="#cb36-0" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Helper function that transforms the given CSV into a hierarchical format.</span></span>
<span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Skip the population level and start directly with demographic categories</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> <span class="bu">root</span> <span class="op">=</span> { <span class="dt">name</span><span class="op">:</span> <span class="st">"root"</span><span class="op">,</span> <span class="dt">children</span><span class="op">:</span> [] }<span class="op">;</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> csv<span class="op">.</span><span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> sequence <span class="op">=</span> csv[i][<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> size <span class="op">=</span> <span class="op">+</span>csv[i][<span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Skip invalid rows</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>sequence <span class="op">||</span> <span class="pp">isNaN</span>(size)) {</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> parts <span class="op">=</span> sequence<span class="op">.</span><span class="fu">split</span>(<span class="st">"_"</span>)<span class="op">;</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> currentNode <span class="op">=</span> <span class="bu">root</span><span class="op">;</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Skip the first part (population) and start from the second part</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> j <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> j <span class="op">&lt;</span> parts<span class="op">.</span><span class="at">length</span><span class="op">;</span> j<span class="op">++</span>) {</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> children <span class="op">=</span> currentNode[<span class="st">"children"</span>]<span class="op">;</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> nodeName <span class="op">=</span> parts[j]<span class="op">;</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> childNode <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> foundChild <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Search for existing child with the same name</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (<span class="kw">let</span> k <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> k <span class="op">&lt;</span> children<span class="op">.</span><span class="at">length</span><span class="op">;</span> k<span class="op">++</span>) {</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (children[k][<span class="st">"name"</span>] <span class="op">===</span> nodeName) {</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>          childNode <span class="op">=</span> children[k]<span class="op">;</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>          foundChild <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span><span class="op">;</span></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>      <span class="co">// If not found, create a new child node</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>foundChild) {</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>        childNode <span class="op">=</span> { <span class="dt">name</span><span class="op">:</span> nodeName<span class="op">,</span> <span class="dt">children</span><span class="op">:</span> [] }<span class="op">;</span></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>        children<span class="op">.</span><span class="fu">push</span>(childNode)<span class="op">;</span></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>      currentNode <span class="op">=</span> childNode<span class="op">;</span></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>      <span class="co">// If it's the last part of the sequence, create a leaf node</span></span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (j <span class="op">===</span> parts<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>) {</span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>        childNode<span class="op">.</span><span class="at">value</span> <span class="op">=</span> size<span class="op">;</span></span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">root</span><span class="op">;</span></span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-36" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb37" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb37--1"><a href="#cb37--1" aria-hidden="true" tabindex="-1"></a>csv <span class="op">=</span> {</span>
<span id="cb37-0"><a href="#cb37-0" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check if csv_raw exists and is an array before processing</span></span>
<span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>csv_raw <span class="op">||</span> <span class="op">!</span><span class="bu">Array</span><span class="op">.</span><span class="fu">isArray</span>(csv_raw) <span class="op">||</span> csv_raw<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> []<span class="op">;</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>sensitivityAdmin0<span class="op">.</span><span class="at">value</span>) {</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// No admin selection - use SSA data</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> csv_raw</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>        (item) <span class="kw">=&gt;</span> item <span class="op">&amp;&amp;</span> item[<span class="dv">0</span>] <span class="op">===</span> <span class="st">"SSA"</span> <span class="op">&amp;&amp;</span> item[<span class="dv">1</span>] <span class="op">===</span> <span class="st">"NA"</span> <span class="op">&amp;&amp;</span> item[<span class="dv">2</span>] <span class="op">===</span> <span class="st">"NA"</span> <span class="op">&amp;&amp;</span> item[<span class="dv">3</span>]</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">map</span>((item) <span class="kw">=&gt;</span> [item[<span class="dv">3</span>]<span class="op">,</span> item[<span class="dv">4</span>]])<span class="op">;</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="op">!</span>sensitivityAdmin1<span class="op">.</span><span class="at">value</span>) {</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> csv_raw</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>        (item) <span class="kw">=&gt;</span> item <span class="op">&amp;&amp;</span> item[<span class="dv">0</span>] <span class="op">===</span> sensitivityAdmin0<span class="op">.</span><span class="at">value</span> <span class="op">&amp;&amp;</span> item[<span class="dv">1</span>] <span class="op">===</span> <span class="st">"NA"</span> <span class="op">&amp;&amp;</span> item[<span class="dv">2</span>] <span class="op">===</span> <span class="st">"NA"</span> <span class="op">&amp;&amp;</span> item[<span class="dv">3</span>]</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">map</span>((item) <span class="kw">=&gt;</span> [item[<span class="dv">3</span>]<span class="op">,</span> item[<span class="dv">4</span>]])<span class="op">;</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (sensitivityAdmin1<span class="op">.</span><span class="at">value</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>sensitivityAdmin2<span class="op">.</span><span class="at">value</span>) {</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> csv_raw</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>        (item) <span class="kw">=&gt;</span> item <span class="op">&amp;&amp;</span> item[<span class="dv">0</span>] <span class="op">===</span> sensitivityAdmin0<span class="op">.</span><span class="at">value</span> <span class="op">&amp;&amp;</span> item[<span class="dv">1</span>] <span class="op">===</span> sensitivityAdmin1<span class="op">.</span><span class="at">value</span> <span class="op">&amp;&amp;</span> item[<span class="dv">2</span>] <span class="op">===</span> <span class="st">"NA"</span> <span class="op">&amp;&amp;</span> item[<span class="dv">3</span>]</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">map</span>((item) <span class="kw">=&gt;</span> [item[<span class="dv">3</span>]<span class="op">,</span> item[<span class="dv">4</span>]])<span class="op">;</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (sensitivityAdmin1<span class="op">.</span><span class="at">value</span> <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> sensitivityAdmin2<span class="op">.</span><span class="at">value</span> <span class="op">!==</span> <span class="kw">null</span>) {</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> csv_raw</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>        (item) <span class="kw">=&gt;</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>          item <span class="op">&amp;&amp;</span> item[<span class="dv">0</span>] <span class="op">===</span> sensitivityAdmin0<span class="op">.</span><span class="at">value</span> <span class="op">&amp;&amp;</span> item[<span class="dv">1</span>] <span class="op">===</span> sensitivityAdmin1<span class="op">.</span><span class="at">value</span> <span class="op">&amp;&amp;</span> item[<span class="dv">2</span>] <span class="op">===</span> sensitivityAdmin2<span class="op">.</span><span class="at">value</span> <span class="op">&amp;&amp;</span> item[<span class="dv">3</span>]</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">map</span>((item) <span class="kw">=&gt;</span> [item[<span class="dv">3</span>]<span class="op">,</span> item[<span class="dv">4</span>]])<span class="op">;</span></span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> []<span class="op">;</span></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-37" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb38" data-startfrom="0" data-source-offset="-0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -1"><span id="cb38-0"><a href="#cb38-0" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> <span class="fu">buildHierarchy</span>(csv)</span>
<span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Create percentage table for insights</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>icicle_pct_table <span class="op">=</span> {</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>csv <span class="op">||</span> csv<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) <span class="cf">return</span> []<span class="op">;</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// A little function to basically calculate the same thing as the breadcrumb but for all the admin region.</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// This is what users should see if going to a tabular view and also what they should download. It is much easier to understand and work with.</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> summarize_icicle <span class="op">=</span> (csv<span class="op">,</span> icicle_keys <span class="op">=</span> <span class="kw">null</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> rows <span class="op">=</span> csv<span class="op">.</span><span class="fu">map</span>(([key<span class="op">,</span> val]) <span class="kw">=&gt;</span> ({</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">parts</span><span class="op">:</span> key<span class="op">.</span><span class="fu">split</span>(<span class="st">"_"</span>)<span class="op">.</span><span class="fu">slice</span>(<span class="dv">1</span>)<span class="op">,</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">value</span><span class="op">:</span> <span class="op">+</span>val</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> total <span class="op">=</span> d3<span class="op">.</span><span class="fu">sum</span>(rows<span class="op">,</span> (d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> maxDepth <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(<span class="op">...</span>rows<span class="op">.</span><span class="fu">map</span>((r) <span class="kw">=&gt;</span> r<span class="op">.</span><span class="at">parts</span><span class="op">.</span><span class="at">length</span>))<span class="op">;</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> levelNames <span class="op">=</span> icicle_keys</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>      <span class="op">?</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">keys</span>(icicle_keys)</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>      <span class="op">:</span> [<span class="op">...</span><span class="bu">Array</span>(maxDepth)<span class="op">.</span><span class="fu">keys</span>()]<span class="op">.</span><span class="fu">map</span>((i) <span class="kw">=&gt;</span> <span class="vs">`level</span><span class="sc">${</span>i <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> lookupName <span class="op">=</span> (dim<span class="op">,</span> key) <span class="kw">=&gt;</span> {</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>icicle_keys) <span class="cf">return</span> key<span class="op">;</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> icicle_keys[dim]<span class="op">?.</span>[key]<span class="op">?.</span>[<span class="dv">0</span>] <span class="op">??</span> key<span class="op">;</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> genderTotals <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>    rows<span class="op">.</span><span class="fu">forEach</span>((r) <span class="kw">=&gt;</span> {</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> gender <span class="op">=</span> r<span class="op">.</span><span class="at">parts</span>[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>      genderTotals[gender] <span class="op">=</span> (genderTotals[gender] <span class="op">||</span> <span class="dv">0</span>) <span class="op">+</span> r<span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Recursive helper</span></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> recurse <span class="op">=</span> (rows<span class="op">,</span> depth <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> prefix <span class="op">=</span> []) <span class="kw">=&gt;</span> {</span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>rows<span class="op">.</span><span class="at">length</span>) <span class="cf">return</span> []<span class="op">;</span></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (depth <span class="op">&gt;=</span> maxDepth) <span class="cf">return</span> []<span class="op">;</span></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> d3</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">rollups</span>(</span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>          rows<span class="op">,</span></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>          (v) <span class="kw">=&gt;</span> d3<span class="op">.</span><span class="fu">sum</span>(v<span class="op">,</span> (d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value</span>)<span class="op">,</span></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>          (d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">parts</span>[depth]</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">flatMap</span>(([k<span class="op">,</span> sum]) <span class="kw">=&gt;</span> {</span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> current <span class="op">=</span> [<span class="op">...</span>prefix<span class="op">,</span> k]<span class="op">;</span></span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> rowObj <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>          levelNames<span class="op">.</span><span class="fu">forEach</span>((col<span class="op">,</span> i) <span class="kw">=&gt;</span> {</span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a>            rowObj[col] <span class="op">=</span> current[i] <span class="op">?</span> <span class="fu">lookupName</span>(col<span class="op">,</span> current[i]) <span class="op">:</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a>          })<span class="op">;</span></span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a>          rowObj<span class="op">.</span><span class="at">pct_total</span> <span class="op">=</span> (<span class="dv">100</span> <span class="op">*</span> sum) <span class="op">/</span> total<span class="op">;</span></span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a>          <span class="co">// pct relative to gender</span></span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> genderKey <span class="op">=</span> prefix[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (genderKey <span class="op">&amp;&amp;</span> genderTotals[genderKey]) {</span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a>            rowObj<span class="op">.</span><span class="at">pct_of_gender</span> <span class="op">=</span> (<span class="dv">100</span> <span class="op">*</span> sum) <span class="op">/</span> genderTotals[genderKey]<span class="op">;</span></span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> [</span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>            rowObj<span class="op">,</span></span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>            <span class="op">...</span><span class="fu">recurse</span>(</span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a>              rows<span class="op">.</span><span class="fu">filter</span>((r) <span class="kw">=&gt;</span> r<span class="op">.</span><span class="at">parts</span>[depth] <span class="op">===</span> k)<span class="op">,</span></span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a>              depth <span class="op">+</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>              current</span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a>          ]<span class="op">;</span></span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">recurse</span>(rows)<span class="op">;</span></span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">summarize_icicle</span>(csv<span class="op">,</span> icicleKeys)<span class="op">;</span></span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a><span class="co">// Create insight data structure</span></span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a>icicle_insight <span class="op">=</span> {</span>
<span id="cb38-73"><a href="#cb38-73" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>icicle_pct_table <span class="op">||</span> icicle_pct_table<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) <span class="cf">return</span> {}<span class="op">;</span></span>
<span id="cb38-74"><a href="#cb38-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-75"><a href="#cb38-75" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> round <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb38-76"><a href="#cb38-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-77"><a href="#cb38-77" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Only sum leaf-level rows (most specific combinations) to avoid double-counting</span></span>
<span id="cb38-78"><a href="#cb38-78" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> leafRows <span class="op">=</span> icicle_pct_table<span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">gender</span> <span class="op">&amp;&amp;</span> d<span class="op">.</span><span class="at">poverty</span> <span class="op">&amp;&amp;</span> d<span class="op">.</span><span class="at">education</span>)<span class="op">;</span></span>
<span id="cb38-79"><a href="#cb38-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-80"><a href="#cb38-80" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> sum <span class="op">=</span> (filter) <span class="kw">=&gt;</span></span>
<span id="cb38-81"><a href="#cb38-81" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span>d3</span>
<span id="cb38-82"><a href="#cb38-82" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">sum</span>(leafRows<span class="op">.</span><span class="fu">filter</span>(filter)<span class="op">,</span> (d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">pct_of_gender</span>) <span class="co">// Total as % of gender not total pop</span></span>
<span id="cb38-83"><a href="#cb38-83" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">toFixed</span>(round)<span class="op">;</span></span>
<span id="cb38-84"><a href="#cb38-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-85"><a href="#cb38-85" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Helper function to find single value</span></span>
<span id="cb38-86"><a href="#cb38-86" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> find <span class="op">=</span> (filter) <span class="kw">=&gt;</span></span>
<span id="cb38-87"><a href="#cb38-87" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span>(icicle_pct_table<span class="op">.</span><span class="fu">find</span>(filter)<span class="op">?.</span><span class="at">pct_total</span> <span class="op">||</span> <span class="dv">0</span>)<span class="op">.</span><span class="fu">toFixed</span>(round)<span class="op">;</span></span>
<span id="cb38-88"><a href="#cb38-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-89"><a href="#cb38-89" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> {</span>
<span id="cb38-90"><a href="#cb38-90" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Total population by gender</span></span>
<span id="cb38-91"><a href="#cb38-91" aria-hidden="true" tabindex="-1"></a>    <span class="dt">male</span><span class="op">:</span> <span class="op">+</span>d3<span class="op">.</span><span class="fu">sum</span>(leafRows<span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">gender</span> <span class="op">===</span> <span class="st">"male"</span>)<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">pct_total</span>)<span class="op">.</span><span class="fu">toFixed</span>(round)<span class="op">,</span></span>
<span id="cb38-92"><a href="#cb38-92" aria-hidden="true" tabindex="-1"></a>    <span class="dt">female</span><span class="op">:</span> <span class="op">+</span>d3<span class="op">.</span><span class="fu">sum</span>(leafRows<span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">gender</span> <span class="op">===</span> <span class="st">"female"</span>)<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">pct_total</span>)<span class="op">.</span><span class="fu">toFixed</span>(round)<span class="op">,</span></span>
<span id="cb38-93"><a href="#cb38-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-94"><a href="#cb38-94" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Education levels by gender (using pct_of_gender)</span></span>
<span id="cb38-95"><a href="#cb38-95" aria-hidden="true" tabindex="-1"></a>    <span class="dt">sec_edu_m</span><span class="op">:</span> <span class="fu">sum</span>((d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">gender</span> <span class="op">===</span> <span class="st">"male"</span> <span class="op">&amp;&amp;</span> d<span class="op">.</span><span class="at">education</span> <span class="op">===</span> <span class="st">"primary"</span>)<span class="op">,</span></span>
<span id="cb38-96"><a href="#cb38-96" aria-hidden="true" tabindex="-1"></a>    <span class="dt">sec_edu_f</span><span class="op">:</span> <span class="fu">sum</span>((d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">gender</span> <span class="op">===</span> <span class="st">"female"</span> <span class="op">&amp;&amp;</span> d<span class="op">.</span><span class="at">education</span> <span class="op">===</span> <span class="st">"primary"</span>)<span class="op">,</span></span>
<span id="cb38-97"><a href="#cb38-97" aria-hidden="true" tabindex="-1"></a>    <span class="dt">no_edu_m</span><span class="op">:</span> <span class="fu">sum</span>((d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">gender</span> <span class="op">===</span> <span class="st">"male"</span> <span class="op">&amp;&amp;</span> d<span class="op">.</span><span class="at">education</span> <span class="op">===</span> <span class="st">"noprimary"</span>)<span class="op">,</span></span>
<span id="cb38-98"><a href="#cb38-98" aria-hidden="true" tabindex="-1"></a>    <span class="dt">no_edu_f</span><span class="op">:</span> <span class="fu">sum</span>((d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">gender</span> <span class="op">===</span> <span class="st">"female"</span> <span class="op">&amp;&amp;</span> d<span class="op">.</span><span class="at">education</span> <span class="op">===</span> <span class="st">"noprimary"</span>)<span class="op">,</span></span>
<span id="cb38-99"><a href="#cb38-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-100"><a href="#cb38-100" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Poverty levels by gender (using pct_of_gender)</span></span>
<span id="cb38-101"><a href="#cb38-101" aria-hidden="true" tabindex="-1"></a>    <span class="dt">high_poverty_m</span><span class="op">:</span> <span class="fu">sum</span>((d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">gender</span> <span class="op">===</span> <span class="st">"male"</span> <span class="op">&amp;&amp;</span> d<span class="op">.</span><span class="at">poverty</span> <span class="op">===</span> <span class="st">"high"</span>)<span class="op">,</span></span>
<span id="cb38-102"><a href="#cb38-102" aria-hidden="true" tabindex="-1"></a>    <span class="dt">high_poverty_f</span><span class="op">:</span> <span class="fu">sum</span>((d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">gender</span> <span class="op">===</span> <span class="st">"female"</span> <span class="op">&amp;&amp;</span> d<span class="op">.</span><span class="at">poverty</span> <span class="op">===</span> <span class="st">"high"</span>)<span class="op">,</span></span>
<span id="cb38-103"><a href="#cb38-103" aria-hidden="true" tabindex="-1"></a>    <span class="dt">low_poverty_m</span><span class="op">:</span> <span class="fu">sum</span>((d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">gender</span> <span class="op">===</span> <span class="st">"male"</span> <span class="op">&amp;&amp;</span> d<span class="op">.</span><span class="at">poverty</span> <span class="op">===</span> <span class="st">"low"</span>)<span class="op">,</span></span>
<span id="cb38-104"><a href="#cb38-104" aria-hidden="true" tabindex="-1"></a>    <span class="dt">low_poverty_f</span><span class="op">:</span> <span class="fu">sum</span>((d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">gender</span> <span class="op">===</span> <span class="st">"female"</span> <span class="op">&amp;&amp;</span> d<span class="op">.</span><span class="at">poverty</span> <span class="op">===</span> <span class="st">"low"</span>)<span class="op">,</span></span>
<span id="cb38-105"><a href="#cb38-105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-106"><a href="#cb38-106" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Most vulnerable group (high poverty + no education)</span></span>
<span id="cb38-107"><a href="#cb38-107" aria-hidden="true" tabindex="-1"></a>    <span class="dt">most_vuln_m</span><span class="op">:</span> <span class="fu">find</span>(</span>
<span id="cb38-108"><a href="#cb38-108" aria-hidden="true" tabindex="-1"></a>      (d) <span class="kw">=&gt;</span></span>
<span id="cb38-109"><a href="#cb38-109" aria-hidden="true" tabindex="-1"></a>        d<span class="op">.</span><span class="at">gender</span> <span class="op">===</span> <span class="st">"male"</span> <span class="op">&amp;&amp;</span></span>
<span id="cb38-110"><a href="#cb38-110" aria-hidden="true" tabindex="-1"></a>        d<span class="op">.</span><span class="at">poverty</span> <span class="op">===</span> <span class="st">"high"</span> <span class="op">&amp;&amp;</span></span>
<span id="cb38-111"><a href="#cb38-111" aria-hidden="true" tabindex="-1"></a>        d<span class="op">.</span><span class="at">education</span> <span class="op">===</span> <span class="st">"noprimary"</span></span>
<span id="cb38-112"><a href="#cb38-112" aria-hidden="true" tabindex="-1"></a>    )<span class="op">,</span></span>
<span id="cb38-113"><a href="#cb38-113" aria-hidden="true" tabindex="-1"></a>    <span class="dt">most_vuln_f</span><span class="op">:</span> <span class="fu">find</span>(</span>
<span id="cb38-114"><a href="#cb38-114" aria-hidden="true" tabindex="-1"></a>      (d) <span class="kw">=&gt;</span></span>
<span id="cb38-115"><a href="#cb38-115" aria-hidden="true" tabindex="-1"></a>        d<span class="op">.</span><span class="at">gender</span> <span class="op">===</span> <span class="st">"female"</span> <span class="op">&amp;&amp;</span></span>
<span id="cb38-116"><a href="#cb38-116" aria-hidden="true" tabindex="-1"></a>        d<span class="op">.</span><span class="at">poverty</span> <span class="op">===</span> <span class="st">"high"</span> <span class="op">&amp;&amp;</span></span>
<span id="cb38-117"><a href="#cb38-117" aria-hidden="true" tabindex="-1"></a>        d<span class="op">.</span><span class="at">education</span> <span class="op">===</span> <span class="st">"noprimary"</span></span>
<span id="cb38-118"><a href="#cb38-118" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb38-119"><a href="#cb38-119" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb38-120"><a href="#cb38-120" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-38-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-38-2" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-38-3" data-nodetype="declaration"></div></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb39" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb39--1"><a href="#cb39--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Generate a string that describes the points of a breadcrumb SVG polygon.</span></span>
<span id="cb39-0"><a href="#cb39-0" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">breadcrumbPoints</span>(d<span class="op">,</span> i) {</span>
<span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> tipWidth <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> points <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  points<span class="op">.</span><span class="fu">push</span>(<span class="st">"0,0"</span>)<span class="op">;</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  points<span class="op">.</span><span class="fu">push</span>(<span class="vs">`</span><span class="sc">${</span>breadcrumbWidth<span class="sc">}</span><span class="vs">,0`</span>)<span class="op">;</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  points<span class="op">.</span><span class="fu">push</span>(<span class="vs">`</span><span class="sc">${</span>breadcrumbWidth <span class="op">+</span> tipWidth<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>breadcrumbHeight <span class="op">/</span> <span class="dv">2</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  points<span class="op">.</span><span class="fu">push</span>(<span class="vs">`</span><span class="sc">${</span>breadcrumbWidth<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>breadcrumbHeight<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  points<span class="op">.</span><span class="fu">push</span>(<span class="vs">`0,</span><span class="sc">${</span>breadcrumbHeight<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (i <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Leftmost breadcrumb; don't include 6th vertex.</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    points<span class="op">.</span><span class="fu">push</span>(<span class="vs">`</span><span class="sc">${</span>tipWidth<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>breadcrumbHeight <span class="op">/</span> <span class="dv">2</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> points<span class="op">.</span><span class="fu">join</span>(<span class="st">" "</span>)<span class="op">;</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-39" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb40" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb40--1"><a href="#cb40--1" aria-hidden="true" tabindex="-1"></a>alias <span class="op">=</span> {</span>
<span id="cb40-0"><a href="#cb40-0" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> flat_alias <span class="op">=</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">fromEntries</span>(</span>
<span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Object</span><span class="op">.</span><span class="fu">values</span>(icicleKeys)<span class="op">.</span><span class="fu">flatMap</span>((obj) <span class="kw">=&gt;</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>      <span class="bu">Object</span><span class="op">.</span><span class="fu">entries</span>(obj)<span class="op">.</span><span class="fu">map</span>(([k<span class="op">,</span> v]) <span class="kw">=&gt;</span> [k<span class="op">,</span> v[<span class="dv">0</span>]])</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  flat_alias<span class="op">.</span><span class="at">population</span> <span class="op">=</span> <span class="st">"Total Population"</span><span class="op">;</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> flat_alias<span class="op">;</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-40" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb41" data-startfrom="0" data-source-offset="-0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -1"><span id="cb41-0"><a href="#cb41-0" aria-hidden="true" tabindex="-1"></a>icicle_dict <span class="op">=</span> <span class="kw">new</span> <span class="bu">Object</span>({</span>
<span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>  <span class="dt">gender0</span><span class="op">:</span> { <span class="dt">en</span><span class="op">:</span> <span class="st">"Male"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">""</span> }<span class="op">,</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">gender1</span><span class="op">:</span> { <span class="dt">en</span><span class="op">:</span> <span class="st">"Female"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">""</span> }<span class="op">,</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">poverty1</span><span class="op">:</span> { <span class="dt">en</span><span class="op">:</span> <span class="st">"Low Poverty"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">""</span> }<span class="op">,</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">poverty2</span><span class="op">:</span> { <span class="dt">en</span><span class="op">:</span> <span class="st">"Moderate Poverty"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">""</span> }<span class="op">,</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">poverty3</span><span class="op">:</span> { <span class="dt">en</span><span class="op">:</span> <span class="st">"High Poverty"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">""</span> }<span class="op">,</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">education3</span><span class="op">:</span> { <span class="dt">en</span><span class="op">:</span> <span class="st">"Secondary Education"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">""</span> }<span class="op">,</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">education2</span><span class="op">:</span> { <span class="dt">en</span><span class="op">:</span> <span class="st">"Primary Education"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">""</span> }<span class="op">,</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">education1</span><span class="op">:</span> { <span class="dt">en</span><span class="op">:</span> <span class="st">"No Primary Education"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">""</span> }<span class="op">,</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>icicle_color <span class="op">=</span> d3</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">scaleOrdinal</span>()</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">domain</span>([</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"population"</span><span class="op">,</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gender1"</span><span class="op">,</span> <span class="co">// female</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gender0"</span><span class="op">,</span> <span class="co">// male</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"poverty1"</span><span class="op">,</span> <span class="co">// low poverty = good // </span><span class="al">TODO</span><span class="co">: Check the directionality of this in preprocess code</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"poverty2"</span><span class="op">,</span> <span class="co">// mid. poverty = mid</span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"poverty3"</span><span class="op">,</span> <span class="co">// high poverty = bad</span></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"education3"</span><span class="op">,</span> <span class="co">// high edu. = good</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"education2"</span><span class="op">,</span> <span class="co">// mid. edu. = mid</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"education1"</span><span class="op">,</span> <span class="co">// low edu = bad</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>  ])</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">range</span>([</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#a4a4a4"</span><span class="op">,</span> <span class="co">// population - removed</span></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#59CD90"</span><span class="op">,</span> <span class="co">// female - #59CD90</span></span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#A491D3"</span><span class="op">,</span> <span class="co">// male</span></span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#f4bb21"</span><span class="op">,</span> <span class="co">// low poverty = good</span></span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#fc8a34"</span><span class="op">,</span> <span class="co">// mid. poverty = mid</span></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#ec5a47"</span><span class="op">,</span> <span class="co">// high poverty = bad</span></span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#f4bb21"</span><span class="op">,</span> <span class="co">// high edu = good</span></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#fc8a34"</span><span class="op">,</span> <span class="co">// mid. edu = mid</span></span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#ec5a47"</span><span class="op">,</span> <span class="co">// low edu = bad</span></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>  ])<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-41-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-41-2" data-nodetype="declaration"></div></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb42" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb42--1"><a href="#cb42--1" aria-hidden="true" tabindex="-1"></a>breadcrumb <span class="op">=</span> {</span>
<span id="cb42-0"><a href="#cb42-0" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Only show breadcrumb if there's a sequence to display</span></span>
<span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">// if (!icicle.sequence || icicle.sequence.length === 0) {</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">//   return htl.html`&lt;div style="height: ${breadcrumbHeight}px;"&gt;&lt;/div&gt;`;</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// }</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> renderBreadcrumb <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> svg <span class="op">=</span> d3</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">create</span>(<span class="st">"svg"</span>)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"viewBox"</span><span class="op">,</span> <span class="vs">`0 0 </span><span class="sc">${</span>breadcrumbWidth <span class="op">*</span> <span class="fl">4.75</span><span class="sc">}</span><span class="vs"> </span><span class="sc">${</span>breadcrumbHeight<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">style</span>(<span class="st">"font"</span><span class="op">,</span> <span class="st">"13px sans-serif"</span>)</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">style</span>(<span class="st">"margin"</span><span class="op">,</span> <span class="st">"2px"</span>)</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">style</span>(<span class="st">"display"</span><span class="op">,</span> <span class="st">"block"</span>)<span class="op">;</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> g <span class="op">=</span> svg</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"g"</span>)</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">data</span>(icicle<span class="op">.</span><span class="at">sequence</span>)</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">join</span>(<span class="st">"g"</span>)</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> (d<span class="op">,</span> i) <span class="kw">=&gt;</span> <span class="vs">`translate(</span><span class="sc">${</span>i <span class="op">*</span> breadcrumbWidth<span class="sc">}</span><span class="vs">, 0)`</span>)<span class="op">;</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>    g<span class="op">.</span><span class="fu">append</span>(<span class="st">"polygon"</span>)</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"points"</span><span class="op">,</span> breadcrumbPoints)</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> (d) <span class="kw">=&gt;</span> {</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">icicle_color</span>(d<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">name</span>)</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> <span class="st">"white"</span>)<span class="op">;</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>    g<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)</span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> (breadcrumbWidth <span class="op">+</span> <span class="dv">10</span>) <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> <span class="dv">15</span>)</span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"dy"</span><span class="op">,</span> <span class="st">"0.35em"</span>)</span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"middle"</span>)</span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> <span class="st">"white"</span>)</span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"font-size"</span><span class="op">,</span> <span class="st">"12px"</span>)</span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">text</span>((d) <span class="kw">=&gt;</span> {</span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> name <span class="op">=</span> d<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">name</span><span class="op">;</span></span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">_lang</span>(icicle_dict[name])<span class="op">;</span></span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Default fallback - capitalize and replace underscores</span></span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">// return name.charAt(0).toUpperCase() + name.slice(1).replace(/_/g, ' ');</span></span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Always show percentage at the end of breadcrumb when there's a sequence</span></span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (icicle<span class="op">.</span><span class="at">sequence</span> <span class="op">&amp;&amp;</span> icicle<span class="op">.</span><span class="at">sequence</span><span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> percentage <span class="op">=</span> <span class="bu">Number</span>(icicle<span class="op">.</span><span class="at">percentage</span>) <span class="op">||</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a>      svg</span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)</span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">text</span>(percentage <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> percentage<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>) <span class="op">+</span> <span class="st">"%"</span> <span class="op">:</span> <span class="st">""</span>)</span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> (icicle<span class="op">.</span><span class="at">sequence</span><span class="op">.</span><span class="at">length</span> <span class="op">+</span> <span class="fl">0.25</span>) <span class="op">*</span> breadcrumbWidth)</span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> breadcrumbHeight <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"dy"</span><span class="op">,</span> <span class="st">"0.35em"</span>)</span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"middle"</span>)</span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"font-size"</span><span class="op">,</span> <span class="st">"12px"</span>)</span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> <span class="st">"black"</span>)</span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"font-weight"</span><span class="op">,</span> <span class="st">"bold"</span>)<span class="op">;</span></span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> svg<span class="op">.</span><span class="fu">node</span>()<span class="op">;</span></span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">`</span></span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true" tabindex="-1"></a><span class="vs">&lt;div style="height: </span><span class="sc">${</span>breadcrumbHeight <span class="op">+</span> <span class="dv">3</span><span class="sc">}</span><span class="vs">px; overflow: hidden;"&gt;</span></span>
<span id="cb42-59"><a href="#cb42-59" aria-hidden="true" tabindex="-1"></a><span class="vs">    </span><span class="sc">${</span>icicle<span class="op">.</span><span class="at">sequence</span> <span class="op">&amp;&amp;</span> icicle<span class="op">.</span><span class="at">sequence</span><span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> </span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true" tabindex="-1"></a>      <span class="op">?</span> <span class="fu">renderBreadcrumb</span>(icicle<span class="op">.</span><span class="at">sequence</span>)</span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true" tabindex="-1"></a>      <span class="op">:</span> <span class="st">""</span><span class="sc">}</span></span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;/div&gt;</span></span>
<span id="cb42-63"><a href="#cb42-63" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span><span class="op">;</span></span>
<span id="cb42-64"><a href="#cb42-64" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-42" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb43" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb43--1"><a href="#cb43--1" aria-hidden="true" tabindex="-1"></a>viewof icicle <span class="op">=</span> {</span>
<span id="cb43-0"><a href="#cb43-0" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Show loading spinner only if data is still loading (null/undefined)</span></span>
<span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (csv_raw <span class="op">===</span> <span class="kw">null</span> <span class="op">||</span> csv_raw <span class="op">===</span> <span class="kw">undefined</span> <span class="op">||</span> icicleKeys <span class="op">===</span> <span class="kw">null</span> <span class="op">||</span> icicleKeys <span class="op">===</span> <span class="kw">undefined</span>) {</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> loading <span class="op">=</span> <span class="fu">createLoadingState</span>(<span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Loading sensitivity data..."</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Chargement des donn√©es de sensibilit√©..."</span>}))<span class="op">;</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> element <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">'div'</span>)<span class="op">;</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    element<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> loading<span class="op">.</span><span class="at">outerHTML</span><span class="op">;</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    element<span class="op">.</span><span class="at">value</span> <span class="op">=</span> { <span class="dt">sequence</span><span class="op">:</span> []<span class="op">,</span> <span class="dt">percentage</span><span class="op">:</span> <span class="fl">0.0</span> }<span class="op">;</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> element<span class="op">;</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// If data is loaded but empty, show no data state</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>csv_raw <span class="op">||</span> csv_raw<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span> <span class="op">||</span> <span class="op">!</span>icicleKeys) {</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> noData <span class="op">=</span> <span class="fu">createNoDataState</span>(<span class="fu">_lang</span>(vulnerability_translations<span class="op">.</span><span class="at">no_data_available</span>))<span class="op">;</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> element <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">'div'</span>)<span class="op">;</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    element<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> noData<span class="op">.</span><span class="at">outerHTML</span><span class="op">;</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    element<span class="op">.</span><span class="at">value</span> <span class="op">=</span> { <span class="dt">sequence</span><span class="op">:</span> []<span class="op">,</span> <span class="dt">percentage</span><span class="op">:</span> <span class="fl">0.0</span> }<span class="op">;</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> element<span class="op">;</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> layerLabels <span class="op">=</span> [<span class="st">"Gender"</span><span class="op">,</span> <span class="st">"Poverty"</span><span class="op">,</span> <span class="st">"Education"</span>]<span class="op">;</span> <span class="co">// adjust as needed</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> gutter <span class="op">=</span> <span class="dv">80</span><span class="op">;</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> order <span class="op">=</span> {</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set the order of the rectanges for icicle chart worse -&gt; better</span></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">poverty1</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">poverty2</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">poverty3</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">education1</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>    <span class="dt">education2</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">education3</span><span class="op">:</span> <span class="dv">2</span></span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> <span class="bu">root</span> <span class="op">=</span> <span class="fu">partition</span>(data<span class="op">,</span> order)<span class="op">;</span></span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> frozen <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> frozenSequence <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>  <span class="co">// const padding = 10;</span></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> svg <span class="op">=</span> d3<span class="op">.</span><span class="fu">create</span>(<span class="st">"svg"</span>)<span class="op">;</span></span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Make this into a view, so that the currently hovered sequence is available to the breadcrumb</span></span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> element <span class="op">=</span> svg<span class="op">.</span><span class="fu">node</span>()<span class="op">;</span></span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>  element<span class="op">.</span><span class="at">value</span> <span class="op">=</span> { <span class="dt">sequence</span><span class="op">:</span> []<span class="op">,</span> <span class="dt">percentage</span><span class="op">:</span> <span class="fl">0.0</span> }<span class="op">;</span></span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>  svg</span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"viewBox"</span><span class="op">,</span> <span class="vs">`0 0 </span><span class="sc">${</span>width <span class="op">+</span> gutter<span class="sc">}</span><span class="vs"> </span><span class="sc">${</span>height<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"font"</span><span class="op">,</span> <span class="st">"12px sans-serif"</span>)<span class="op">;</span></span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> plot <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="vs">`translate(</span><span class="sc">${</span>gutter<span class="sc">}</span><span class="vs">,0)`</span>)<span class="op">;</span></span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a>  plot</span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">append</span>(<span class="st">"rect"</span>)</span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> width)</span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> height)</span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> <span class="st">"none"</span>)<span class="op">;</span></span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> segment <span class="op">=</span> plot</span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)</span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> (d) <span class="kw">=&gt;</span></span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a>      narrow <span class="op">?</span> <span class="vs">`translate(</span><span class="sc">${</span><span class="op">-</span><span class="bu">root</span><span class="op">.</span><span class="at">y1</span><span class="sc">}</span><span class="vs">, 40)`</span> <span class="op">:</span> <span class="vs">`translate(0, </span><span class="sc">${</span><span class="op">-</span><span class="bu">root</span><span class="op">.</span><span class="at">y1</span> <span class="op">+</span> <span class="dv">40</span><span class="sc">}</span><span class="vs">)`</span></span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"rect"</span>)</span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>(</span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a>      <span class="bu">root</span><span class="op">.</span><span class="fu">descendants</span>()<span class="op">.</span><span class="fu">filter</span>((d) <span class="kw">=&gt;</span> {</span>
<span id="cb43-62"><a href="#cb43-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> d<span class="op">.</span><span class="at">depth</span><span class="op">;</span></span>
<span id="cb43-63"><a href="#cb43-63" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb43-64"><a href="#cb43-64" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-65"><a href="#cb43-65" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">join</span>(<span class="st">"rect"</span>)</span>
<span id="cb43-66"><a href="#cb43-66" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> (d) <span class="kw">=&gt;</span> <span class="fu">icicle_color</span>(d<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">name</span>))</span>
<span id="cb43-67"><a href="#cb43-67" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> segmentX)</span>
<span id="cb43-68"><a href="#cb43-68" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> segmentY)</span>
<span id="cb43-69"><a href="#cb43-69" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> segmentWidth)</span>
<span id="cb43-70"><a href="#cb43-70" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> segmentHeight)</span>
<span id="cb43-71"><a href="#cb43-71" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">on</span>(<span class="st">"mouseenter"</span><span class="op">,</span> (<span class="bu">event</span><span class="op">,</span> d) <span class="kw">=&gt;</span> {</span>
<span id="cb43-72"><a href="#cb43-72" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (frozen) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb43-73"><a href="#cb43-73" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Get the ancestors of the current segment, minus the root</span></span>
<span id="cb43-74"><a href="#cb43-74" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> sequence <span class="op">=</span> d<span class="op">.</span><span class="fu">ancestors</span>()<span class="op">.</span><span class="fu">reverse</span>()<span class="op">.</span><span class="fu">slice</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb43-75"><a href="#cb43-75" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Highlight the ancestors</span></span>
<span id="cb43-76"><a href="#cb43-76" aria-hidden="true" tabindex="-1"></a>      segment<span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill-opacity"</span><span class="op">,</span> (node) <span class="kw">=&gt;</span></span>
<span id="cb43-77"><a href="#cb43-77" aria-hidden="true" tabindex="-1"></a>        sequence<span class="op">.</span><span class="fu">indexOf</span>(node) <span class="op">&gt;=</span> <span class="dv">0</span> <span class="op">?</span> <span class="fl">1.0</span> <span class="op">:</span> <span class="fl">0.3</span></span>
<span id="cb43-78"><a href="#cb43-78" aria-hidden="true" tabindex="-1"></a>      )<span class="op">;</span></span>
<span id="cb43-79"><a href="#cb43-79" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> percentage <span class="op">=</span> (<span class="dv">100</span> <span class="op">*</span> (d<span class="op">.</span><span class="at">value</span> <span class="op">/</span> <span class="bu">root</span><span class="op">.</span><span class="at">value</span>))<span class="op">.</span><span class="fu">toPrecision</span>(<span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb43-80"><a href="#cb43-80" aria-hidden="true" tabindex="-1"></a>      element<span class="op">.</span><span class="at">value</span> <span class="op">=</span> { sequence<span class="op">,</span> percentage }<span class="op">;</span></span>
<span id="cb43-81"><a href="#cb43-81" aria-hidden="true" tabindex="-1"></a>      element<span class="op">.</span><span class="fu">dispatchEvent</span>(<span class="kw">new</span> <span class="bu">CustomEvent</span>(<span class="st">"input"</span>))<span class="op">;</span></span>
<span id="cb43-82"><a href="#cb43-82" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb43-83"><a href="#cb43-83" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">on</span>(<span class="st">"click"</span><span class="op">,</span> (<span class="bu">event</span><span class="op">,</span> d) <span class="kw">=&gt;</span> {</span>
<span id="cb43-84"><a href="#cb43-84" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (frozen) {</span>
<span id="cb43-85"><a href="#cb43-85" aria-hidden="true" tabindex="-1"></a>        frozen <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb43-86"><a href="#cb43-86" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb43-87"><a href="#cb43-87" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb43-88"><a href="#cb43-88" aria-hidden="true" tabindex="-1"></a>        frozen <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb43-89"><a href="#cb43-89" aria-hidden="true" tabindex="-1"></a>        frozenSequence <span class="op">=</span> d<span class="op">.</span><span class="fu">ancestors</span>()<span class="op">.</span><span class="fu">reverse</span>()<span class="op">.</span><span class="fu">slice</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb43-90"><a href="#cb43-90" aria-hidden="true" tabindex="-1"></a>        segment<span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill-opacity"</span><span class="op">,</span> (node) <span class="kw">=&gt;</span></span>
<span id="cb43-91"><a href="#cb43-91" aria-hidden="true" tabindex="-1"></a>          frozenSequence<span class="op">.</span><span class="fu">indexOf</span>(node) <span class="op">&gt;=</span> <span class="dv">0</span> <span class="op">?</span> <span class="fl">1.0</span> <span class="op">:</span> <span class="fl">0.3</span></span>
<span id="cb43-92"><a href="#cb43-92" aria-hidden="true" tabindex="-1"></a>        )<span class="op">;</span></span>
<span id="cb43-93"><a href="#cb43-93" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> percentage <span class="op">=</span> (<span class="dv">100</span> <span class="op">*</span> (d<span class="op">.</span><span class="at">value</span> <span class="op">/</span> <span class="bu">root</span><span class="op">.</span><span class="at">value</span>))<span class="op">.</span><span class="fu">toPrecision</span>(<span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb43-94"><a href="#cb43-94" aria-hidden="true" tabindex="-1"></a>        element<span class="op">.</span><span class="at">value</span> <span class="op">=</span> { <span class="dt">sequence</span><span class="op">:</span> frozenSequence<span class="op">,</span> percentage }<span class="op">;</span></span>
<span id="cb43-95"><a href="#cb43-95" aria-hidden="true" tabindex="-1"></a>        element<span class="op">.</span><span class="fu">dispatchEvent</span>(<span class="kw">new</span> <span class="bu">CustomEvent</span>(<span class="st">"input"</span>))<span class="op">;</span></span>
<span id="cb43-96"><a href="#cb43-96" aria-hidden="true" tabindex="-1"></a>        <span class="bu">event</span><span class="op">.</span><span class="fu">stopPropagation</span>()<span class="op">;</span> <span class="co">// prevent svg click from firing</span></span>
<span id="cb43-97"><a href="#cb43-97" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb43-98"><a href="#cb43-98" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb43-99"><a href="#cb43-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-100"><a href="#cb43-100" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add sidebar text</span></span>
<span id="cb43-101"><a href="#cb43-101" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> depthNodes <span class="op">=</span> d3</span>
<span id="cb43-102"><a href="#cb43-102" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">rollups</span>(</span>
<span id="cb43-103"><a href="#cb43-103" aria-hidden="true" tabindex="-1"></a>      <span class="bu">root</span><span class="op">.</span><span class="fu">descendants</span>()<span class="op">.</span><span class="fu">filter</span>((d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">depth</span>)<span class="op">,</span></span>
<span id="cb43-104"><a href="#cb43-104" aria-hidden="true" tabindex="-1"></a>      (v) <span class="kw">=&gt;</span> v[<span class="dv">0</span>]<span class="op">,</span> <span class="co">// representative node per depth</span></span>
<span id="cb43-105"><a href="#cb43-105" aria-hidden="true" tabindex="-1"></a>      (d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">depth</span></span>
<span id="cb43-106"><a href="#cb43-106" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-107"><a href="#cb43-107" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> d3<span class="op">.</span><span class="fu">ascending</span>(a[<span class="dv">0</span>]<span class="op">,</span> b[<span class="dv">0</span>]))<span class="op">;</span> <span class="co">// sort by depth asc</span></span>
<span id="cb43-108"><a href="#cb43-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-109"><a href="#cb43-109" aria-hidden="true" tabindex="-1"></a>  plot</span>
<span id="cb43-110"><a href="#cb43-110" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)</span>
<span id="cb43-111"><a href="#cb43-111" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> (d) <span class="kw">=&gt;</span></span>
<span id="cb43-112"><a href="#cb43-112" aria-hidden="true" tabindex="-1"></a>      narrow <span class="op">?</span> <span class="vs">`translate(</span><span class="sc">${</span><span class="op">-</span><span class="bu">root</span><span class="op">.</span><span class="at">y1</span><span class="sc">}</span><span class="vs">, 40)`</span> <span class="op">:</span> <span class="vs">`translate(0, </span><span class="sc">${</span><span class="op">-</span><span class="bu">root</span><span class="op">.</span><span class="at">y1</span> <span class="op">+</span> <span class="dv">40</span><span class="sc">}</span><span class="vs">)`</span></span>
<span id="cb43-113"><a href="#cb43-113" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-114"><a href="#cb43-114" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"text.layer-label"</span>)</span>
<span id="cb43-115"><a href="#cb43-115" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>(</span>
<span id="cb43-116"><a href="#cb43-116" aria-hidden="true" tabindex="-1"></a>      depthNodes<span class="op">.</span><span class="fu">map</span>(([depth<span class="op">,</span> rep]) <span class="kw">=&gt;</span> ({</span>
<span id="cb43-117"><a href="#cb43-117" aria-hidden="true" tabindex="-1"></a>        depth<span class="op">,</span></span>
<span id="cb43-118"><a href="#cb43-118" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="fu">segmentY</span>(rep) <span class="op">+</span> <span class="fu">segmentHeight</span>(rep) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb43-119"><a href="#cb43-119" aria-hidden="true" tabindex="-1"></a>      }))</span>
<span id="cb43-120"><a href="#cb43-120" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-121"><a href="#cb43-121" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">join</span>(<span class="st">"text"</span>)</span>
<span id="cb43-122"><a href="#cb43-122" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span> <span class="st">"layer-label"</span>)</span>
<span id="cb43-123"><a href="#cb43-123" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> <span class="op">-</span><span class="dv">12</span>) <span class="co">// left of the icicle area (inside gutter)</span></span>
<span id="cb43-124"><a href="#cb43-124" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> (d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">y</span>)</span>
<span id="cb43-125"><a href="#cb43-125" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"dy"</span><span class="op">,</span> <span class="st">"0.35em"</span>)</span>
<span id="cb43-126"><a href="#cb43-126" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"end"</span>)</span>
<span id="cb43-127"><a href="#cb43-127" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"font-size"</span><span class="op">,</span> <span class="st">"12px"</span>)</span>
<span id="cb43-128"><a href="#cb43-128" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"font-weight"</span><span class="op">,</span> <span class="st">"600"</span>)</span>
<span id="cb43-129"><a href="#cb43-129" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">text</span>((d) <span class="kw">=&gt;</span> layerLabels[d<span class="op">.</span><span class="at">depth</span> <span class="op">-</span> <span class="dv">1</span>] <span class="op">??</span> <span class="vs">`Layer </span><span class="sc">${</span>d<span class="op">.</span><span class="at">depth</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb43-130"><a href="#cb43-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-131"><a href="#cb43-131" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add percentage labels to each segment</span></span>
<span id="cb43-132"><a href="#cb43-132" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> labels <span class="op">=</span> plot</span>
<span id="cb43-133"><a href="#cb43-133" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)</span>
<span id="cb43-134"><a href="#cb43-134" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> (d) <span class="kw">=&gt;</span></span>
<span id="cb43-135"><a href="#cb43-135" aria-hidden="true" tabindex="-1"></a>      narrow <span class="op">?</span> <span class="vs">`translate(</span><span class="sc">${</span><span class="op">-</span><span class="bu">root</span><span class="op">.</span><span class="at">y1</span><span class="sc">}</span><span class="vs">, 40)`</span> <span class="op">:</span> <span class="vs">`translate(0, </span><span class="sc">${</span><span class="op">-</span><span class="bu">root</span><span class="op">.</span><span class="at">y1</span> <span class="op">+</span> <span class="dv">40</span><span class="sc">}</span><span class="vs">)`</span></span>
<span id="cb43-136"><a href="#cb43-136" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-137"><a href="#cb43-137" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"text"</span>)</span>
<span id="cb43-138"><a href="#cb43-138" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>(</span>
<span id="cb43-139"><a href="#cb43-139" aria-hidden="true" tabindex="-1"></a>      <span class="bu">root</span><span class="op">.</span><span class="fu">descendants</span>()<span class="op">.</span><span class="fu">filter</span>((d) <span class="kw">=&gt;</span> {</span>
<span id="cb43-140"><a href="#cb43-140" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> d<span class="op">.</span><span class="at">depth</span> <span class="op">&amp;&amp;</span> d<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">name</span> <span class="op">!==</span> <span class="st">"population"</span><span class="op">;</span></span>
<span id="cb43-141"><a href="#cb43-141" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb43-142"><a href="#cb43-142" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-143"><a href="#cb43-143" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">join</span>(<span class="st">"text"</span>)</span>
<span id="cb43-144"><a href="#cb43-144" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> (d) <span class="kw">=&gt;</span> <span class="fu">segmentX</span>(d) <span class="op">+</span> <span class="fu">segmentWidth</span>(d) <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb43-145"><a href="#cb43-145" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> (d) <span class="kw">=&gt;</span> <span class="fu">segmentY</span>(d) <span class="op">+</span> <span class="fu">segmentHeight</span>(d) <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb43-146"><a href="#cb43-146" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"dy"</span><span class="op">,</span> <span class="st">"0.35em"</span>)</span>
<span id="cb43-147"><a href="#cb43-147" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"middle"</span>)</span>
<span id="cb43-148"><a href="#cb43-148" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"font-size"</span><span class="op">,</span> <span class="st">"12px"</span>)</span>
<span id="cb43-149"><a href="#cb43-149" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"font-weight"</span><span class="op">,</span> <span class="st">"bold"</span>)</span>
<span id="cb43-150"><a href="#cb43-150" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> (d) <span class="kw">=&gt;</span> {</span>
<span id="cb43-151"><a href="#cb43-151" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Use contrasting colors for text based on background</span></span>
<span id="cb43-152"><a href="#cb43-152" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> bgColor <span class="op">=</span> <span class="fu">icicle_color</span>(d<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">name</span>)<span class="op">;</span></span>
<span id="cb43-153"><a href="#cb43-153" aria-hidden="true" tabindex="-1"></a>      <span class="co">// For dark colors, use white text; for light colors, use black text</span></span>
<span id="cb43-154"><a href="#cb43-154" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Updated to match new gender colors: #A491D3 (purple), #D0F0DE (light green)</span></span>
<span id="cb43-155"><a href="#cb43-155" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (</span>
<span id="cb43-156"><a href="#cb43-156" aria-hidden="true" tabindex="-1"></a>        bgColor <span class="op">===</span> <span class="st">"#A491D3"</span> <span class="op">||</span></span>
<span id="cb43-157"><a href="#cb43-157" aria-hidden="true" tabindex="-1"></a>        bgColor <span class="op">===</span> <span class="st">"#ec5a47"</span> <span class="op">||</span></span>
<span id="cb43-158"><a href="#cb43-158" aria-hidden="true" tabindex="-1"></a>        bgColor <span class="op">===</span> <span class="st">"#fc8a34"</span></span>
<span id="cb43-159"><a href="#cb43-159" aria-hidden="true" tabindex="-1"></a>      ) {</span>
<span id="cb43-160"><a href="#cb43-160" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"white"</span><span class="op">;</span></span>
<span id="cb43-161"><a href="#cb43-161" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb43-162"><a href="#cb43-162" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"black"</span><span class="op">;</span></span>
<span id="cb43-163"><a href="#cb43-163" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb43-164"><a href="#cb43-164" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb43-165"><a href="#cb43-165" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"pointer-events"</span><span class="op">,</span> <span class="st">"none"</span>) <span class="co">// Prevent text from interfering with mouse events</span></span>
<span id="cb43-166"><a href="#cb43-166" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">text</span>((d) <span class="kw">=&gt;</span> {</span>
<span id="cb43-167"><a href="#cb43-167" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> dataObj <span class="op">=</span> d<span class="op">?.</span><span class="at">data</span><span class="op">;</span></span>
<span id="cb43-168"><a href="#cb43-168" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> genderName <span class="op">=</span> dataObj<span class="op">.</span><span class="at">name</span><span class="op">.</span><span class="fu">startsWith</span>(<span class="st">"gender"</span>) <span class="op">?</span> <span class="fu">_lang</span>(icicle_dict[dataObj<span class="op">.</span><span class="at">name</span>]) <span class="op">:</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb43-169"><a href="#cb43-169" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> gender_str <span class="op">=</span> genderName <span class="op">?</span> genderName <span class="op">+</span> <span class="st">" - "</span> <span class="op">:</span> <span class="st">""</span></span>
<span id="cb43-170"><a href="#cb43-170" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> percentage <span class="op">=</span> (<span class="dv">100</span> <span class="op">*</span> (d<span class="op">.</span><span class="at">value</span> <span class="op">/</span> <span class="bu">root</span><span class="op">.</span><span class="at">value</span>))<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb43-171"><a href="#cb43-171" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Only show percentage if the segment is large enough to display text</span></span>
<span id="cb43-172"><a href="#cb43-172" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="fu">segmentWidth</span>(d) <span class="op">&gt;</span> <span class="dv">30</span> <span class="op">&amp;&amp;</span> <span class="fu">segmentHeight</span>(d) <span class="op">&gt;</span> <span class="dv">15</span></span>
<span id="cb43-173"><a href="#cb43-173" aria-hidden="true" tabindex="-1"></a>        <span class="op">?</span> <span class="vs">`</span><span class="sc">${</span>gender_str <span class="op">+</span> percentage<span class="sc">}</span><span class="vs">%`</span></span>
<span id="cb43-174"><a href="#cb43-174" aria-hidden="true" tabindex="-1"></a>        <span class="op">:</span> <span class="st">""</span><span class="op">;</span></span>
<span id="cb43-175"><a href="#cb43-175" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb43-176"><a href="#cb43-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-177"><a href="#cb43-177" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> mouseLeaveHandler <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb43-178"><a href="#cb43-178" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (frozen) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb43-179"><a href="#cb43-179" aria-hidden="true" tabindex="-1"></a>    segment<span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill-opacity"</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb43-180"><a href="#cb43-180" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update the value of this view</span></span>
<span id="cb43-181"><a href="#cb43-181" aria-hidden="true" tabindex="-1"></a>    element<span class="op">.</span><span class="at">value</span> <span class="op">=</span> { <span class="dt">sequence</span><span class="op">:</span> []<span class="op">,</span> <span class="dt">percentage</span><span class="op">:</span> <span class="fl">0.0</span> }<span class="op">;</span></span>
<span id="cb43-182"><a href="#cb43-182" aria-hidden="true" tabindex="-1"></a>    element<span class="op">.</span><span class="fu">dispatchEvent</span>(<span class="kw">new</span> <span class="bu">CustomEvent</span>(<span class="st">"input"</span>))<span class="op">;</span></span>
<span id="cb43-183"><a href="#cb43-183" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb43-184"><a href="#cb43-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-185"><a href="#cb43-185" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> clickHandler <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb43-186"><a href="#cb43-186" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (frozen) {</span>
<span id="cb43-187"><a href="#cb43-187" aria-hidden="true" tabindex="-1"></a>      frozen <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb43-188"><a href="#cb43-188" aria-hidden="true" tabindex="-1"></a>      frozenSequence <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb43-189"><a href="#cb43-189" aria-hidden="true" tabindex="-1"></a>      segment<span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill-opacity"</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb43-190"><a href="#cb43-190" aria-hidden="true" tabindex="-1"></a>      element<span class="op">.</span><span class="at">value</span> <span class="op">=</span> { <span class="dt">sequence</span><span class="op">:</span> []<span class="op">,</span> <span class="dt">percentage</span><span class="op">:</span> <span class="fl">0.0</span> }<span class="op">;</span></span>
<span id="cb43-191"><a href="#cb43-191" aria-hidden="true" tabindex="-1"></a>      element<span class="op">.</span><span class="fu">dispatchEvent</span>(<span class="kw">new</span> <span class="bu">CustomEvent</span>(<span class="st">"input"</span>))<span class="op">;</span></span>
<span id="cb43-192"><a href="#cb43-192" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb43-193"><a href="#cb43-193" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb43-194"><a href="#cb43-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-195"><a href="#cb43-195" aria-hidden="true" tabindex="-1"></a>  plot<span class="op">.</span><span class="fu">on</span>(<span class="st">"mouseleave"</span><span class="op">,</span> mouseLeaveHandler)<span class="op">;</span></span>
<span id="cb43-196"><a href="#cb43-196" aria-hidden="true" tabindex="-1"></a>  plot<span class="op">.</span><span class="fu">on</span>(<span class="st">"click"</span><span class="op">,</span> clickHandler)<span class="op">;</span></span>
<span id="cb43-197"><a href="#cb43-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-198"><a href="#cb43-198" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add disposal mechanism to clean up event listeners</span></span>
<span id="cb43-199"><a href="#cb43-199" aria-hidden="true" tabindex="-1"></a>  <span class="co">// This prevents memory leaks when the cell is re-evaluated</span></span>
<span id="cb43-200"><a href="#cb43-200" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (element<span class="op">.</span><span class="at">dispose</span>) {</span>
<span id="cb43-201"><a href="#cb43-201" aria-hidden="true" tabindex="-1"></a>    element<span class="op">.</span><span class="fu">dispose</span>()<span class="op">;</span></span>
<span id="cb43-202"><a href="#cb43-202" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-203"><a href="#cb43-203" aria-hidden="true" tabindex="-1"></a>  element<span class="op">.</span><span class="at">dispose</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb43-204"><a href="#cb43-204" aria-hidden="true" tabindex="-1"></a>    plot<span class="op">.</span><span class="fu">on</span>(<span class="st">"mouseleave"</span><span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb43-205"><a href="#cb43-205" aria-hidden="true" tabindex="-1"></a>    plot<span class="op">.</span><span class="fu">on</span>(<span class="st">"click"</span><span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb43-206"><a href="#cb43-206" aria-hidden="true" tabindex="-1"></a>    segment<span class="op">.</span><span class="fu">on</span>(<span class="st">"mouseenter"</span><span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb43-207"><a href="#cb43-207" aria-hidden="true" tabindex="-1"></a>    segment<span class="op">.</span><span class="fu">on</span>(<span class="st">"click"</span><span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb43-208"><a href="#cb43-208" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb43-209"><a href="#cb43-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-210"><a href="#cb43-210" aria-hidden="true" tabindex="-1"></a>  <span class="co">// add legend</span></span>
<span id="cb43-211"><a href="#cb43-211" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> colorScale <span class="op">=</span> d3</span>
<span id="cb43-212"><a href="#cb43-212" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">scaleOrdinal</span>()</span>
<span id="cb43-213"><a href="#cb43-213" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">domain</span>([<span class="st">"Better"</span><span class="op">,</span> <span class="st">"Moderate"</span><span class="op">,</span> <span class="st">"Worse"</span>])</span>
<span id="cb43-214"><a href="#cb43-214" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">range</span>([<span class="st">"#F4BB21"</span><span class="op">,</span> <span class="st">"#FC8A34"</span><span class="op">,</span> <span class="st">"#EC5A47"</span>])<span class="op">;</span></span>
<span id="cb43-215"><a href="#cb43-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-216"><a href="#cb43-216" aria-hidden="true" tabindex="-1"></a>  svg</span>
<span id="cb43-217"><a href="#cb43-217" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">append</span>(<span class="st">"rect"</span>)</span>
<span id="cb43-218"><a href="#cb43-218" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb43-219"><a href="#cb43-219" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> <span class="dv">5</span>)</span>
<span id="cb43-220"><a href="#cb43-220" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"rx"</span><span class="op">,</span> <span class="dv">10</span>) <span class="co">// Add rounded corners</span></span>
<span id="cb43-221"><a href="#cb43-221" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"ry"</span><span class="op">,</span> <span class="dv">10</span>) <span class="co">// Add rounded corners</span></span>
<span id="cb43-222"><a href="#cb43-222" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> <span class="dv">300</span>) <span class="co">// Adjust the width to fit the legend</span></span>
<span id="cb43-223"><a href="#cb43-223" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> <span class="dv">30</span>) <span class="co">// Adjust the height to fit the legend</span></span>
<span id="cb43-224"><a href="#cb43-224" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> <span class="st">"#fff"</span>)<span class="op">;</span></span>
<span id="cb43-225"><a href="#cb43-225" aria-hidden="true" tabindex="-1"></a>  <span class="co">// .attr("stroke", "black");</span></span>
<span id="cb43-226"><a href="#cb43-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-227"><a href="#cb43-227" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> legend <span class="op">=</span> svg</span>
<span id="cb43-228"><a href="#cb43-228" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">selectAll</span>(<span class="st">".legend"</span>)</span>
<span id="cb43-229"><a href="#cb43-229" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>(colorScale<span class="op">.</span><span class="fu">domain</span>())</span>
<span id="cb43-230"><a href="#cb43-230" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">enter</span>()</span>
<span id="cb43-231"><a href="#cb43-231" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)</span>
<span id="cb43-232"><a href="#cb43-232" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span> <span class="st">"legend"</span>)</span>
<span id="cb43-233"><a href="#cb43-233" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="kw">function</span> (d<span class="op">,</span> i) {</span>
<span id="cb43-234"><a href="#cb43-234" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="st">"translate("</span> <span class="op">+</span> (i <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> <span class="dv">25</span>) <span class="op">+</span> <span class="st">",11)"</span><span class="op">;</span></span>
<span id="cb43-235"><a href="#cb43-235" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb43-236"><a href="#cb43-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-237"><a href="#cb43-237" aria-hidden="true" tabindex="-1"></a>  legend</span>
<span id="cb43-238"><a href="#cb43-238" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">append</span>(<span class="st">"rect"</span>)</span>
<span id="cb43-239"><a href="#cb43-239" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> <span class="dv">0</span>)</span>
<span id="cb43-240"><a href="#cb43-240" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> <span class="dv">18</span>)</span>
<span id="cb43-241"><a href="#cb43-241" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> <span class="dv">18</span>)</span>
<span id="cb43-242"><a href="#cb43-242" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"fill"</span><span class="op">,</span> colorScale)<span class="op">;</span></span>
<span id="cb43-243"><a href="#cb43-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-244"><a href="#cb43-244" aria-hidden="true" tabindex="-1"></a>  legend</span>
<span id="cb43-245"><a href="#cb43-245" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)</span>
<span id="cb43-246"><a href="#cb43-246" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> <span class="dv">24</span>)</span>
<span id="cb43-247"><a href="#cb43-247" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> <span class="dv">9</span>)</span>
<span id="cb43-248"><a href="#cb43-248" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"dy"</span><span class="op">,</span> <span class="st">".35em"</span>)</span>
<span id="cb43-249"><a href="#cb43-249" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">text</span>(<span class="kw">function</span> (d) {</span>
<span id="cb43-250"><a href="#cb43-250" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> d<span class="op">;</span></span>
<span id="cb43-251"><a href="#cb43-251" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb43-252"><a href="#cb43-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-253"><a href="#cb43-253" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> element<span class="op">;</span></span>
<span id="cb43-254"><a href="#cb43-254" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-43" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb44" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb44--1"><a href="#cb44--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Download functionality</span></span>
<span id="cb44-0"><a href="#cb44-0" aria-hidden="true" tabindex="-1"></a>sensitivityDownloadButton <span class="op">=</span> {</span>
<span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>icicle_pct_table <span class="op">||</span> icicle_pct_table<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">``</span><span class="op">;</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">downloadButton</span>(</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    icicle_pct_table<span class="op">,</span> </span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="vs">`sensitivity_data_</span><span class="sc">${</span><span class="fu">getSensitivityAdminSelection</span>()<span class="op">.</span><span class="fu">replace</span>(<span class="ss">/</span><span class="sc">\s+</span><span class="ss">/g</span><span class="op">,</span> <span class="st">'_'</span>)<span class="sc">}</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">_lang</span>(vulnerability_translations<span class="op">.</span><span class="at">download_data</span>)</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-44" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb45" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb45--1"><a href="#cb45--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Dynamic insights - reactive to icicle selection</span></span>
<span id="cb45-0"><a href="#cb45-0" aria-hidden="true" tabindex="-1"></a>sensitivityInsights <span class="op">=</span> {</span>
<span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>data <span class="op">||</span> data<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span> <span class="op">||</span> <span class="op">!</span>csv <span class="op">||</span> csv<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span> <span class="op">||</span> <span class="op">!</span>icicle_insight) {</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">createNoDataState</span>()<span class="op">;</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> region <span class="op">=</span> <span class="fu">getSensitivityAdminSelection</span>()<span class="op">;</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> insight <span class="op">=</span> icicle_insight<span class="op">;</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Generate default insights (always shown)</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> totalMale <span class="op">=</span> insight<span class="op">.</span><span class="at">male</span><span class="op">;</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> totalFemale <span class="op">=</span> insight<span class="op">.</span><span class="at">female</span><span class="op">;</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> mostVulnTotal <span class="op">=</span> (insight<span class="op">.</span><span class="at">most_vuln_m</span> <span class="op">+</span> insight<span class="op">.</span><span class="at">most_vuln_f</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> femalePct <span class="op">=</span> insight<span class="op">.</span><span class="at">most_vuln_f</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> malePct <span class="op">=</span> insight<span class="op">.</span><span class="at">most_vuln_m</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Education comparison</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> noEduMale <span class="op">=</span> insight<span class="op">.</span><span class="at">no_edu_m</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> noEduFemale <span class="op">=</span> insight<span class="op">.</span><span class="at">no_edu_f</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Poverty comparison  </span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> highPovMale <span class="op">=</span> insight<span class="op">.</span><span class="at">high_poverty_m</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> highPovFemale <span class="op">=</span> insight<span class="op">.</span><span class="at">high_poverty_f</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Structure the default insights as separate parts for better HTML rendering</span></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> defaultInsightParts <span class="op">=</span> [</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>    <span class="vs">`In </span><span class="sc">${</span>region<span class="sc">}</span><span class="vs">, men represent </span><span class="sc">${</span>totalMale<span class="sc">}</span><span class="vs">% and women represent </span><span class="sc">${</span>totalFemale<span class="sc">}</span><span class="vs">% of the population.`</span><span class="op">,</span></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>    <span class="vs">`Among the most vulnerable group (high poverty + no primary education), </span><span class="sc">${</span>femalePct<span class="sc">}</span><span class="vs">% are female and </span><span class="sc">${</span>malePct<span class="sc">}</span><span class="vs">% are male.`</span><span class="op">,</span></span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>    <span class="vs">`Education gap: </span><span class="sc">${</span>noEduFemale<span class="sc">}</span><span class="vs">% of women vs </span><span class="sc">${</span>noEduMale<span class="sc">}</span><span class="vs">% of men have no primary education.`</span><span class="op">,</span></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>    <span class="vs">`Poverty gap: </span><span class="sc">${</span>highPovFemale<span class="sc">}</span><span class="vs">% of women vs </span><span class="sc">${</span>highPovMale<span class="sc">}</span><span class="vs">% of men live in high poverty areas.`</span></span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">;</span></span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> defaultInsightText <span class="op">=</span> defaultInsightParts<span class="op">.</span><span class="fu">join</span>(<span class="st">'</span><span class="sc">\n\n</span><span class="st">'</span>)<span class="op">;</span></span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">createInsightDisplay</span>(defaultInsightText)<span class="op">;</span></span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-45" data-nodetype="declaration"></div></div></div><hr><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb46" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb46--1"><a href="#cb46--1" aria-hidden="true" tabindex="-1"></a>adaptiveCapacityQuestion <span class="op">=</span> <span class="fu">_lang</span>(</span>
<span id="cb46-0"><a href="#cb46-0" aria-hidden="true" tabindex="-1"></a>  vulnerability_translations<span class="op">.</span><span class="at">adaptive_capacity_question</span><span class="op">,</span></span>
<span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-46" data-nodetype="declaration"></div></div></div></section><section id="adaptive-capacity" class="level1"><h1><span><span id="ojs-element-id-8"></span></span></h1><p><span><span id="ojs-element-id-9"></span></span></p><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb47" data-startfrom="1" data-source-offset="-61"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>viewof adaptiveCapacityAdmin0 <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">select</span>(dataAdmin0<span class="op">,</span> {</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> adminRegions<span class="op">.</span><span class="at">labels</span><span class="op">.</span><span class="at">admin0</span><span class="op">,</span> </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">format</span><span class="op">:</span> x <span class="kw">=&gt;</span> x<span class="op">.</span><span class="at">label</span><span class="op">,</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> dataAdmin0<span class="op">.</span><span class="fu">find</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value</span> <span class="op">===</span> sharedAdmin0) <span class="op">||</span> (dataAdmin0<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> dataAdmin0[<span class="dv">0</span>] <span class="op">:</span> <span class="kw">null</span>)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>viewof adaptiveCapacityAdmin1 <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">select</span>(dataAdmin1<span class="op">,</span> {</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> adminRegions<span class="op">.</span><span class="at">labels</span><span class="op">.</span><span class="at">admin1</span><span class="op">,</span> </span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">format</span><span class="op">:</span> x <span class="kw">=&gt;</span> x<span class="op">.</span><span class="at">label</span><span class="op">,</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> dataAdmin1<span class="op">.</span><span class="fu">find</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value</span> <span class="op">===</span> sharedAdmin1) <span class="op">||</span> (dataAdmin1<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> dataAdmin1[<span class="dv">0</span>] <span class="op">:</span> <span class="kw">null</span>)</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>viewof adaptiveCapacityAdmin2 <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">select</span>(dataAdmin2<span class="op">,</span> {</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> adminRegions<span class="op">.</span><span class="at">labels</span><span class="op">.</span><span class="at">admin2</span><span class="op">,</span> </span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">format</span><span class="op">:</span> x <span class="kw">=&gt;</span> x<span class="op">.</span><span class="at">label</span><span class="op">,</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> dataAdmin2<span class="op">.</span><span class="fu">find</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value</span> <span class="op">===</span> sharedAdmin2) <span class="op">||</span> (dataAdmin2<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> dataAdmin2[<span class="dv">0</span>] <span class="op">:</span> <span class="kw">null</span>)</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-47-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-47-2" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-47-3" data-nodetype="declaration"></div></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb48" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb48--1"><a href="#cb48--1" aria-hidden="true" tabindex="-1"></a>adaptiveCapacityControlsForm <span class="op">=</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">`</span></span>
<span id="cb48-0"><a href="#cb48-0" aria-hidden="true" tabindex="-1"></a><span class="vs">&lt;div style="</span></span>
<span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="vs">  background: #f8fafc;</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="vs">  border: 2px solid #e2e8f0;</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="vs">  border-radius: 12px;</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="vs">  padding: 24px;</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="vs">  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="vs">  margin: 16px 0;</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="vs">"&gt;</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;h3 style="margin: 0 0 20px 0; color: #2d3748; font-size: 1.1rem; font-weight: 600;"&gt;</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="vs">    </span><span class="sc">${</span><span class="fu">_lang</span>(vulnerability_translations<span class="op">.</span><span class="at">geographic_selection</span>)<span class="sc">}</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;/h3&gt;</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;div style="</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="vs">    display: flex;</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a><span class="vs">    align-items: flex-start;</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="vs">    gap: 20px;</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a><span class="vs">    flex-wrap: wrap;</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a><span class="vs">    justify-content: space-between;</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a><span class="vs">  " class="form-inputs-container"&gt;</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div style="flex: 1; min-width: 180px; max-width: 100%;"&gt;</span><span class="sc">${</span>viewof adaptiveCapacityAdmin0<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div style="flex: 1; min-width: 180px; max-width: 100%;"&gt;</span><span class="sc">${</span>viewof adaptiveCapacityAdmin1<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div style="flex: 1; min-width: 180px; max-width: 100%;"&gt;</span><span class="sc">${</span>viewof adaptiveCapacityAdmin2<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;/div&gt;</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a><span class="vs">&lt;/div&gt;</span></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-48" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb49" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb49--1"><a href="#cb49--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Load data with caching - using parquet via DuckDB</span></span>
<span id="cb49-0"><a href="#cb49-0" aria-hidden="true" tabindex="-1"></a>adaptiveCapacityRawData <span class="op">=</span> <span class="cf">await</span> <span class="fu">loadDataWithCache</span>(</span>
<span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>  <span class="st">"adaptiveCapacityData"</span><span class="op">,</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> db <span class="op">=</span> <span class="cf">await</span> DuckDBClient<span class="op">.</span><span class="fu">of</span>({</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">enabling_vars</span><span class="op">:</span> <span class="fu">FileAttachment</span>(</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"/data/vulnerability_notebook/enabling_vars.parquet"</span><span class="op">,</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>      )<span class="op">,</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">query</span>(<span class="st">"SELECT * FROM enabling_vars"</span>)<span class="op">;</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data<span class="op">;</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-49" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb50" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb50--1"><a href="#cb50--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Load metadata with caching</span></span>
<span id="cb50-0"><a href="#cb50-0" aria-hidden="true" tabindex="-1"></a>adaptiveCapacityMetadata <span class="op">=</span> <span class="cf">await</span> <span class="fu">loadDataWithCache</span>(</span>
<span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>  <span class="st">"adaptiveCapacityMetadata"</span><span class="op">,</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cf">await</span> <span class="fu">FileAttachment</span>(</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">"/data/vulnerability_notebook/enabling_vars_metadata.json"</span><span class="op">,</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    )<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-50" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb51" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb51--1"><a href="#cb51--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Process the new normalized data structure</span></span>
<span id="cb51-0"><a href="#cb51-0" aria-hidden="true" tabindex="-1"></a>adaptiveCapacityData <span class="op">=</span> {</span>
<span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>adaptiveCapacityRawData <span class="op">||</span> <span class="op">!</span><span class="bu">Array</span><span class="op">.</span><span class="fu">isArray</span>(adaptiveCapacityRawData)) {</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"adaptiveCapacityRawData is not valid:"</span><span class="op">,</span> adaptiveCapacityRawData)<span class="op">;</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> []<span class="op">;</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> adaptiveCapacityRawData<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> ({</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span>d<span class="op">,</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use the new normalized columns directly (0-1 scale, high = good)</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">pct_electric_norm</span><span class="op">:</span> d<span class="op">.</span><span class="at">pct_electric_norm</span><span class="op">,</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">pct_piped_water_norm</span><span class="op">:</span> d<span class="op">.</span><span class="at">pct_piped_water_norm</span><span class="op">,</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">min_to_cities_norm</span><span class="op">:</span> d<span class="op">.</span><span class="at">min_to_cities_norm</span><span class="op">,</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">conflict_density_norm</span><span class="op">:</span> d<span class="op">.</span><span class="at">conflict_density_norm</span><span class="op">,</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">pct_cellphone_norm</span><span class="op">:</span> d<span class="op">.</span><span class="at">pct_cellphone_norm</span><span class="op">,</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Keep original values for tooltips</span></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">pct_electric</span><span class="op">:</span> d<span class="op">.</span><span class="at">pct_electric</span><span class="op">,</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">pct_piped_water</span><span class="op">:</span> d<span class="op">.</span><span class="at">pct_piped_water</span><span class="op">,</span></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">min_to_cities</span><span class="op">:</span> d<span class="op">.</span><span class="at">min_to_cities</span><span class="op">,</span></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">conflict_density</span><span class="op">:</span> d<span class="op">.</span><span class="at">conflict_density</span><span class="op">,</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">pct_cellphone</span><span class="op">:</span> d<span class="op">.</span><span class="at">pct_cellphone</span></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-51" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb52" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb52--1"><a href="#cb52--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Get current admin selections (same variable names as sensitivity section)</span></span>
<span id="cb52-0"><a href="#cb52-0" aria-hidden="true" tabindex="-1"></a>adaptiveCapacityAdminSelections <span class="op">=</span> {</span>
<span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> {</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">selectAdmin0</span><span class="op">:</span> adaptiveCapacityAdmin0<span class="op">?.</span><span class="at">value</span> <span class="op">||</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">selectAdmin1</span><span class="op">:</span> adaptiveCapacityAdmin1<span class="op">?.</span><span class="at">value</span> <span class="op">||</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">selectAdmin2</span><span class="op">:</span> adaptiveCapacityAdmin2<span class="op">?.</span><span class="at">value</span> <span class="op">||</span> <span class="kw">null</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-52" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb53" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb53--1"><a href="#cb53--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Filter data based on admin selections (same pattern as sensitivity)</span></span>
<span id="cb53-0"><a href="#cb53-0" aria-hidden="true" tabindex="-1"></a>filteredAdaptiveCapacityData <span class="op">=</span> {</span>
<span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> selections <span class="op">=</span> adaptiveCapacityAdminSelections<span class="op">;</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>adaptiveCapacityData <span class="op">||</span> adaptiveCapacityData<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"adaptiveCapacityData is empty or undefined"</span>)<span class="op">;</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> []<span class="op">;</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> data <span class="op">=</span> adaptiveCapacityData<span class="op">;</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>selections<span class="op">.</span><span class="at">selectAdmin0</span>) {</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>      data <span class="op">=</span>  data<span class="op">.</span><span class="fu">filter</span>((d) <span class="kw">=&gt;</span> (d<span class="op">.</span><span class="at">admin0_name</span> <span class="op">===</span> <span class="st">"SSA"</span> <span class="op">||</span> <span class="op">!</span>d<span class="op">.</span><span class="at">admin0_name</span>)) <span class="co">// Select just SSA data &amp; do not show regional avg</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="op">!</span>selections<span class="op">.</span><span class="at">selectAdmin1</span>) {</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>      data <span class="op">=</span>  data<span class="op">.</span><span class="fu">filter</span>((d) <span class="kw">=&gt;</span> (d<span class="op">.</span><span class="at">admin0_name</span> <span class="op">===</span> selections<span class="op">.</span><span class="at">selectAdmin0</span>))</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (selections<span class="op">.</span><span class="at">selectAdmin1</span>  <span class="op">&amp;&amp;</span> <span class="op">!</span>selections<span class="op">.</span><span class="at">selectAdmin2</span>) {</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>      data <span class="op">=</span>  data<span class="op">.</span><span class="fu">filter</span>((d)<span class="kw">=&gt;</span> (d<span class="op">.</span><span class="at">admin0_name</span> <span class="op">===</span> selections<span class="op">.</span><span class="at">selectAdmin0</span> <span class="op">&amp;&amp;</span> d<span class="op">.</span><span class="at">admin1_name</span> <span class="op">===</span> selections<span class="op">.</span><span class="at">selectAdmin1</span>))</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (selections<span class="op">.</span><span class="at">selectAdmin1</span> <span class="op">&amp;&amp;</span> selections<span class="op">.</span><span class="at">selectAdmin2</span>) {</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>      data <span class="op">=</span>  data<span class="op">.</span><span class="fu">filter</span>((d) <span class="kw">=&gt;</span> (d<span class="op">.</span><span class="at">admin0_name</span> <span class="op">===</span> selections<span class="op">.</span><span class="at">selectAdmin0</span> <span class="op">&amp;&amp;</span> d<span class="op">.</span><span class="at">admin1_name</span> <span class="op">===</span> selections<span class="op">.</span><span class="at">selectAdmin1</span> <span class="op">&amp;&amp;</span> d<span class="op">.</span><span class="at">admin2_name</span> <span class="op">===</span> selections<span class="op">.</span><span class="at">selectAdmin2</span>))</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a> <span class="cf">return</span> data</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-53" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb54" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb54--1"><a href="#cb54--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Helper function to get current region name (uses shared utility)</span></span>
<span id="cb54-0"><a href="#cb54-0" aria-hidden="true" tabindex="-1"></a>getAdaptiveCapacityRegion <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">getAdminSelection</span>(</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    adaptiveCapacityAdmin0<span class="op">,</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    adaptiveCapacityAdmin1<span class="op">,</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    adaptiveCapacityAdmin2</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-54" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb55" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb55--1"><a href="#cb55--1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb55-0"><a href="#cb55-0" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check if adaptiveCapacityRawData exists and is an array before processing</span></span>
<span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>adaptiveCapacityRawData <span class="op">||</span> <span class="op">!</span><span class="bu">Array</span><span class="op">.</span><span class="fu">isArray</span>(adaptiveCapacityRawData)) {</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">createNoDataState</span>()<span class="op">;</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> data <span class="op">=</span> adaptiveCapacityRawData<span class="op">;</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> selections <span class="op">=</span> adaptiveCapacityAdminSelections<span class="op">;</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> isSSA <span class="op">=</span> selections<span class="op">.</span><span class="at">selectAdmin0</span> <span class="op">===</span> <span class="st">"SSA"</span> <span class="op">||</span> <span class="op">!</span>selections<span class="op">.</span><span class="at">selectAdmin0</span><span class="op">;</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Data for the blue bar - the lowest selected region</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> region_data <span class="op">=</span> data<span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    (d) <span class="kw">=&gt;</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>      d<span class="op">.</span><span class="at">admin0_name</span> <span class="op">===</span> (selections<span class="op">.</span><span class="at">selectAdmin0</span> <span class="op">||</span> <span class="st">"SSA"</span>) <span class="op">&amp;&amp;</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>      d<span class="op">.</span><span class="at">admin1_name</span> <span class="op">===</span> selections<span class="op">.</span><span class="at">selectAdmin1</span> <span class="op">&amp;&amp;</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>      d<span class="op">.</span><span class="at">admin2_name</span> <span class="op">===</span> selections<span class="op">.</span><span class="at">selectAdmin2</span><span class="op">,</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> region_name <span class="op">=</span> <span class="fu">getAdaptiveCapacityRegion</span>()<span class="op">;</span></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Data for the grey bar which is the parent</span></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">// eg. region = AGO so parent = SSA or region = nairobi so parent = kenya</span></span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> parent_data <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> parent_name <span class="op">=</span> <span class="st">""</span><span class="op">;</span></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>selections<span class="op">.</span><span class="at">selectAdmin0</span>) {</span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Top-level (SSA selected so no parent data is returned)</span></span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>    parent_data <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="op">!</span>selections<span class="op">.</span><span class="at">selectAdmin1</span>) {</span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// admin0 selected but no admin1 so parent = SSA</span></span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>    parent_data <span class="op">=</span> data<span class="op">.</span><span class="fu">filter</span>((d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin0_name</span> <span class="op">===</span> <span class="st">"SSA"</span>)<span class="op">;</span></span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>    parent_name <span class="op">=</span> <span class="st">"SSA"</span><span class="op">;</span></span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="op">!</span>selections<span class="op">.</span><span class="at">selectAdmin2</span>) {</span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// admin1 selected but no admin2 so parent = admin0 selection</span></span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a>    parent_data <span class="op">=</span> data<span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a>      (d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin0_name</span> <span class="op">===</span> selections<span class="op">.</span><span class="at">selectAdmin0</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>d<span class="op">.</span><span class="at">admin1_name</span><span class="op">,</span></span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a>    parent_name <span class="op">=</span> selections<span class="op">.</span><span class="at">selectAdmin0</span><span class="op">;</span></span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">// admin2 selected so parent = admin1 selected</span></span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true" tabindex="-1"></a>    parent_data <span class="op">=</span> data<span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb55-39"><a href="#cb55-39" aria-hidden="true" tabindex="-1"></a>      (d) <span class="kw">=&gt;</span></span>
<span id="cb55-40"><a href="#cb55-40" aria-hidden="true" tabindex="-1"></a>        d<span class="op">.</span><span class="at">admin0_name</span> <span class="op">===</span> selections<span class="op">.</span><span class="at">selectAdmin0</span> <span class="op">&amp;&amp;</span></span>
<span id="cb55-41"><a href="#cb55-41" aria-hidden="true" tabindex="-1"></a>        d<span class="op">.</span><span class="at">admin1_name</span> <span class="op">===</span> selections<span class="op">.</span><span class="at">selectAdmin1</span> <span class="op">&amp;&amp;</span></span>
<span id="cb55-42"><a href="#cb55-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">!</span>d<span class="op">.</span><span class="at">admin2_name</span><span class="op">,</span></span>
<span id="cb55-43"><a href="#cb55-43" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb55-44"><a href="#cb55-44" aria-hidden="true" tabindex="-1"></a>    parent_name <span class="op">=</span> selections<span class="op">.</span><span class="at">selectAdmin1</span><span class="op">;</span></span>
<span id="cb55-45"><a href="#cb55-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb55-46"><a href="#cb55-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-47"><a href="#cb55-47" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Define the indicators to display using new normalized data structure</span></span>
<span id="cb55-48"><a href="#cb55-48" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> indicators <span class="op">=</span> [</span>
<span id="cb55-49"><a href="#cb55-49" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb55-50"><a href="#cb55-50" aria-hidden="true" tabindex="-1"></a>      <span class="dt">key</span><span class="op">:</span> <span class="st">"pct_electric_norm"</span><span class="op">,</span></span>
<span id="cb55-51"><a href="#cb55-51" aria-hidden="true" tabindex="-1"></a>      <span class="dt">rawKey</span><span class="op">:</span> <span class="st">"pct_electric"</span><span class="op">,</span></span>
<span id="cb55-52"><a href="#cb55-52" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({ <span class="dt">en</span><span class="op">:</span> <span class="st">"Electricity Access"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Acc√®s √† l'√©lectricit√©"</span> })<span class="op">,</span></span>
<span id="cb55-53"><a href="#cb55-53" aria-hidden="true" tabindex="-1"></a>      <span class="dt">unit</span><span class="op">:</span> <span class="st">"%"</span><span class="op">,</span></span>
<span id="cb55-54"><a href="#cb55-54" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb55-55"><a href="#cb55-55" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb55-56"><a href="#cb55-56" aria-hidden="true" tabindex="-1"></a>      <span class="dt">key</span><span class="op">:</span> <span class="st">"pct_piped_water_norm"</span><span class="op">,</span></span>
<span id="cb55-57"><a href="#cb55-57" aria-hidden="true" tabindex="-1"></a>      <span class="dt">rawKey</span><span class="op">:</span> <span class="st">"pct_piped_water"</span><span class="op">,</span></span>
<span id="cb55-58"><a href="#cb55-58" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({ <span class="dt">en</span><span class="op">:</span> <span class="st">"Piped Water Access"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Acc√®s √† l'eau courante"</span> })<span class="op">,</span></span>
<span id="cb55-59"><a href="#cb55-59" aria-hidden="true" tabindex="-1"></a>      <span class="dt">unit</span><span class="op">:</span> <span class="st">"%"</span><span class="op">,</span></span>
<span id="cb55-60"><a href="#cb55-60" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb55-61"><a href="#cb55-61" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb55-62"><a href="#cb55-62" aria-hidden="true" tabindex="-1"></a>      <span class="dt">key</span><span class="op">:</span> <span class="st">"min_to_cities_norm"</span><span class="op">,</span></span>
<span id="cb55-63"><a href="#cb55-63" aria-hidden="true" tabindex="-1"></a>      <span class="dt">rawKey</span><span class="op">:</span> <span class="st">"min_to_cities"</span><span class="op">,</span></span>
<span id="cb55-64"><a href="#cb55-64" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({</span>
<span id="cb55-65"><a href="#cb55-65" aria-hidden="true" tabindex="-1"></a>        <span class="dt">en</span><span class="op">:</span> <span class="st">"Distance to Market"</span><span class="op">,</span></span>
<span id="cb55-66"><a href="#cb55-66" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fr</span><span class="op">:</span> <span class="st">"Temps de trajet vers les villes"</span><span class="op">,</span></span>
<span id="cb55-67"><a href="#cb55-67" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb55-68"><a href="#cb55-68" aria-hidden="true" tabindex="-1"></a>      <span class="dt">unit</span><span class="op">:</span> <span class="st">" min."</span><span class="op">,</span></span>
<span id="cb55-69"><a href="#cb55-69" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb55-70"><a href="#cb55-70" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb55-71"><a href="#cb55-71" aria-hidden="true" tabindex="-1"></a>      <span class="dt">key</span><span class="op">:</span> <span class="st">"pct_cellphone_norm"</span><span class="op">,</span></span>
<span id="cb55-72"><a href="#cb55-72" aria-hidden="true" tabindex="-1"></a>      <span class="dt">rawKey</span><span class="op">:</span> <span class="st">"pct_cellphone"</span><span class="op">,</span></span>
<span id="cb55-73"><a href="#cb55-73" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({</span>
<span id="cb55-74"><a href="#cb55-74" aria-hidden="true" tabindex="-1"></a>        <span class="dt">en</span><span class="op">:</span> <span class="st">"Cellphone Access"</span><span class="op">,</span></span>
<span id="cb55-75"><a href="#cb55-75" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fr</span><span class="op">:</span> <span class="st">"Acc√®s au t√©l√©phone portable"</span><span class="op">,</span></span>
<span id="cb55-76"><a href="#cb55-76" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb55-77"><a href="#cb55-77" aria-hidden="true" tabindex="-1"></a>      <span class="dt">unit</span><span class="op">:</span> <span class="st">"%"</span><span class="op">,</span></span>
<span id="cb55-78"><a href="#cb55-78" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb55-79"><a href="#cb55-79" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb55-80"><a href="#cb55-80" aria-hidden="true" tabindex="-1"></a>      <span class="dt">key</span><span class="op">:</span> <span class="st">"conflict_density_norm"</span><span class="op">,</span></span>
<span id="cb55-81"><a href="#cb55-81" aria-hidden="true" tabindex="-1"></a>      <span class="dt">rawKey</span><span class="op">:</span> <span class="st">"conflict_density"</span><span class="op">,</span></span>
<span id="cb55-82"><a href="#cb55-82" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({ <span class="dt">en</span><span class="op">:</span> <span class="st">"Lack of Conflict"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Densit√© de conflit"</span> })<span class="op">,</span></span>
<span id="cb55-83"><a href="#cb55-83" aria-hidden="true" tabindex="-1"></a>      <span class="dt">unit</span><span class="op">:</span> <span class="st">" count/km¬≤"</span><span class="op">,</span></span>
<span id="cb55-84"><a href="#cb55-84" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb55-85"><a href="#cb55-85" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">;</span></span>
<span id="cb55-86"><a href="#cb55-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-87"><a href="#cb55-87" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> chartData <span class="op">=</span> indicators<span class="op">.</span><span class="fu">map</span>((indicator) <span class="kw">=&gt;</span> {</span>
<span id="cb55-88"><a href="#cb55-88" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get normalized value (0-1 scale, high = good)</span></span>
<span id="cb55-89"><a href="#cb55-89" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check if region_data has elements before accessing [0]</span></span>
<span id="cb55-90"><a href="#cb55-90" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> region_normalizedValue <span class="op">=</span> region_data<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> </span>
<span id="cb55-91"><a href="#cb55-91" aria-hidden="true" tabindex="-1"></a>      <span class="op">?</span> (region_data[<span class="dv">0</span>]<span class="op">?.</span>[indicator<span class="op">.</span><span class="at">key</span>] <span class="op">||</span> <span class="kw">null</span>)</span>
<span id="cb55-92"><a href="#cb55-92" aria-hidden="true" tabindex="-1"></a>      <span class="op">:</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb55-93"><a href="#cb55-93" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> parent_normalizedValue <span class="op">=</span> parent_data<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb55-94"><a href="#cb55-94" aria-hidden="true" tabindex="-1"></a>      <span class="op">?</span> (parent_data[<span class="dv">0</span>]<span class="op">?.</span>[indicator<span class="op">.</span><span class="at">key</span>] <span class="op">||</span> <span class="kw">null</span>)</span>
<span id="cb55-95"><a href="#cb55-95" aria-hidden="true" tabindex="-1"></a>      <span class="op">:</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb55-96"><a href="#cb55-96" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get original value for tooltips</span></span>
<span id="cb55-97"><a href="#cb55-97" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> region_rawValue <span class="op">=</span> region_data<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb55-98"><a href="#cb55-98" aria-hidden="true" tabindex="-1"></a>      <span class="op">?</span> (region_data[<span class="dv">0</span>]<span class="op">?.</span>[indicator<span class="op">.</span><span class="at">rawKey</span>] <span class="op">||</span> <span class="kw">null</span>)</span>
<span id="cb55-99"><a href="#cb55-99" aria-hidden="true" tabindex="-1"></a>      <span class="op">:</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb55-100"><a href="#cb55-100" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> parent_rawValue <span class="op">=</span> parent_data<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb55-101"><a href="#cb55-101" aria-hidden="true" tabindex="-1"></a>      <span class="op">?</span> (parent_data[<span class="dv">0</span>]<span class="op">?.</span>[indicator<span class="op">.</span><span class="at">rawKey</span>] <span class="op">||</span> <span class="kw">null</span>)</span>
<span id="cb55-102"><a href="#cb55-102" aria-hidden="true" tabindex="-1"></a>      <span class="op">:</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb55-103"><a href="#cb55-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-104"><a href="#cb55-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb55-105"><a href="#cb55-105" aria-hidden="true" tabindex="-1"></a>      <span class="dt">indicator</span><span class="op">:</span> indicator<span class="op">.</span><span class="at">label</span><span class="op">,</span></span>
<span id="cb55-106"><a href="#cb55-106" aria-hidden="true" tabindex="-1"></a>      region_normalizedValue<span class="op">,</span> <span class="co">// Use normalized value for chart</span></span>
<span id="cb55-107"><a href="#cb55-107" aria-hidden="true" tabindex="-1"></a>      region_rawValue<span class="op">,</span> <span class="co">// Keep original for tooltips</span></span>
<span id="cb55-108"><a href="#cb55-108" aria-hidden="true" tabindex="-1"></a>      parent_normalizedValue<span class="op">,</span></span>
<span id="cb55-109"><a href="#cb55-109" aria-hidden="true" tabindex="-1"></a>      parent_rawValue<span class="op">,</span></span>
<span id="cb55-110"><a href="#cb55-110" aria-hidden="true" tabindex="-1"></a>      <span class="dt">unit</span><span class="op">:</span> indicator<span class="op">.</span><span class="at">unit</span><span class="op">,</span></span>
<span id="cb55-111"><a href="#cb55-111" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb55-112"><a href="#cb55-112" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb55-113"><a href="#cb55-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-114"><a href="#cb55-114" aria-hidden="true" tabindex="-1"></a>  <span class="co">// const sortedData = chartData.sort((a, b) =&gt; b.value - a.value);</span></span>
<span id="cb55-115"><a href="#cb55-115" aria-hidden="true" tabindex="-1"></a>  <span class="co">// sort alphabetically so consistent between selections to allow easy comparisons</span></span>
<span id="cb55-116"><a href="#cb55-116" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> sortedData <span class="op">=</span> chartData<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> a<span class="op">.</span><span class="at">indicator</span><span class="op">.</span><span class="fu">localeCompare</span>(b<span class="op">.</span><span class="at">indicator</span>))<span class="op">;</span></span>
<span id="cb55-117"><a href="#cb55-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-118"><a href="#cb55-118" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> maxValue <span class="op">=</span> <span class="fl">1.0</span><span class="op">;</span> <span class="co">// Technically some values pass this, but in general this should be max</span></span>
<span id="cb55-119"><a href="#cb55-119" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-120"><a href="#cb55-120" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> plot_channels <span class="op">=</span> {</span>
<span id="cb55-121"><a href="#cb55-121" aria-hidden="true" tabindex="-1"></a>    [<span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>region_name<span class="sc">}</span><span class="vs"> Value`</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Valeur de la r√©gion s√©lectionn√©e"</span>})]<span class="op">:</span></span>
<span id="cb55-122"><a href="#cb55-122" aria-hidden="true" tabindex="-1"></a>      d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">region_rawValue</span> <span class="op">==</span> <span class="kw">null</span></span>
<span id="cb55-123"><a href="#cb55-123" aria-hidden="true" tabindex="-1"></a>        <span class="op">?</span> <span class="kw">null</span> <span class="co">// 0 is meaningful so this stays null</span></span>
<span id="cb55-124"><a href="#cb55-124" aria-hidden="true" tabindex="-1"></a>        <span class="op">:</span> <span class="bu">Number</span>(d<span class="op">.</span><span class="at">region_rawValue</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>) <span class="op">+</span> (d<span class="op">.</span><span class="at">unit</span> <span class="op">||</span> <span class="st">""</span>)</span>
<span id="cb55-125"><a href="#cb55-125" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb55-126"><a href="#cb55-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-127"><a href="#cb55-127" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>isSSA) {</span>
<span id="cb55-128"><a href="#cb55-128" aria-hidden="true" tabindex="-1"></a>    plot_channels[<span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>parent_name<span class="sc">}</span><span class="vs"> Value`</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Moyenne r√©gionale"</span>})] <span class="op">=</span></span>
<span id="cb55-129"><a href="#cb55-129" aria-hidden="true" tabindex="-1"></a>      d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">parent_rawValue</span> <span class="op">==</span> <span class="kw">null</span></span>
<span id="cb55-130"><a href="#cb55-130" aria-hidden="true" tabindex="-1"></a>        <span class="op">?</span> <span class="kw">null</span> <span class="co">// 0 is meaningful so this stays null</span></span>
<span id="cb55-131"><a href="#cb55-131" aria-hidden="true" tabindex="-1"></a>        <span class="op">:</span> <span class="bu">Number</span>(d<span class="op">.</span><span class="at">parent_rawValue</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>) <span class="op">+</span> (d<span class="op">.</span><span class="at">unit</span> <span class="op">||</span> <span class="st">""</span>)</span>
<span id="cb55-132"><a href="#cb55-132" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb55-133"><a href="#cb55-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-134"><a href="#cb55-134" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> plot <span class="op">=</span>  Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb55-135"><a href="#cb55-135" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">1000</span><span class="op">,</span> <span class="co">// Full width</span></span>
<span id="cb55-136"><a href="#cb55-136" aria-hidden="true" tabindex="-1"></a>    <span class="dt">height</span><span class="op">:</span> <span class="dv">400</span><span class="op">,</span></span>
<span id="cb55-137"><a href="#cb55-137" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginLeft</span><span class="op">:</span> <span class="dv">160</span><span class="op">,</span> <span class="co">// Reduced for better space utilization</span></span>
<span id="cb55-138"><a href="#cb55-138" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginRight</span><span class="op">:</span> <span class="dv">40</span><span class="op">,</span> <span class="co">// Reduced for better space utilization</span></span>
<span id="cb55-139"><a href="#cb55-139" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginTop</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span> <span class="co">// Reduced white space</span></span>
<span id="cb55-140"><a href="#cb55-140" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginBottom</span><span class="op">:</span> <span class="dv">40</span><span class="op">,</span> <span class="co">// Reduced white space</span></span>
<span id="cb55-141"><a href="#cb55-141" aria-hidden="true" tabindex="-1"></a>    <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb55-142"><a href="#cb55-142" aria-hidden="true" tabindex="-1"></a>      <span class="dt">legend</span><span class="op">:</span> <span class="op">!</span>isSSA<span class="op">,</span> <span class="co">// Only show legend if not SSA</span></span>
<span id="cb55-143"><a href="#cb55-143" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [</span>
<span id="cb55-144"><a href="#cb55-144" aria-hidden="true" tabindex="-1"></a>        <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>region_name<span class="sc">}</span><span class="vs"> Value`</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>region_name<span class="sc">}</span><span class="vs"> Value`</span>})<span class="op">,</span></span>
<span id="cb55-145"><a href="#cb55-145" aria-hidden="true" tabindex="-1"></a>        <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>parent_name<span class="sc">}</span><span class="vs"> Value`</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Moyenne r√©gionale"</span>})</span>
<span id="cb55-146"><a href="#cb55-146" aria-hidden="true" tabindex="-1"></a>      ]<span class="op">,</span></span>
<span id="cb55-147"><a href="#cb55-147" aria-hidden="true" tabindex="-1"></a>      <span class="dt">range</span><span class="op">:</span> [<span class="st">"#4a90e2"</span><span class="op">,</span> <span class="st">"#e5e5e5"</span>]</span>
<span id="cb55-148"><a href="#cb55-148" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb55-149"><a href="#cb55-149" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> {</span>
<span id="cb55-150"><a href="#cb55-150" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Ability to Adapt"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Niveau de performance"</span>})<span class="op">,</span></span>
<span id="cb55-151"><a href="#cb55-151" aria-hidden="true" tabindex="-1"></a>      <span class="dt">labelAnchor</span><span class="op">:</span> <span class="st">"center"</span><span class="op">,</span></span>
<span id="cb55-152"><a href="#cb55-152" aria-hidden="true" tabindex="-1"></a>      <span class="dt">labelOffset</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span></span>
<span id="cb55-153"><a href="#cb55-153" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> maxValue]<span class="op">,</span> <span class="co">// Normalized scale 0-1</span></span>
<span id="cb55-154"><a href="#cb55-154" aria-hidden="true" tabindex="-1"></a>      <span class="dt">tickFormat</span><span class="op">:</span> (d) <span class="kw">=&gt;</span> (d <span class="op">===</span> <span class="dv">0</span> <span class="op">?</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Low"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Faible"</span>}) <span class="op">:</span> d <span class="op">===</span> <span class="dv">1</span> <span class="op">?</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"High"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"√âlev√©"</span>}) <span class="op">:</span> <span class="st">""</span>)<span class="op">,</span></span>
<span id="cb55-155"><a href="#cb55-155" aria-hidden="true" tabindex="-1"></a>      <span class="dt">ticks</span><span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="fl">0.5</span><span class="op">,</span> <span class="fl">1.0</span>]<span class="op">,</span></span>
<span id="cb55-156"><a href="#cb55-156" aria-hidden="true" tabindex="-1"></a>      <span class="dt">tickSize</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb55-157"><a href="#cb55-157" aria-hidden="true" tabindex="-1"></a>      <span class="dt">labelFontSize</span><span class="op">:</span> <span class="dv">12</span><span class="op">,</span></span>
<span id="cb55-158"><a href="#cb55-158" aria-hidden="true" tabindex="-1"></a>      <span class="dt">labelFontWeight</span><span class="op">:</span> <span class="st">"600"</span></span>
<span id="cb55-159"><a href="#cb55-159" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb55-160"><a href="#cb55-160" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> {</span>
<span id="cb55-161"><a href="#cb55-161" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span> <span class="co">// Remove y-axis label to save space</span></span>
<span id="cb55-162"><a href="#cb55-162" aria-hidden="true" tabindex="-1"></a>      <span class="dt">tickSize</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb55-163"><a href="#cb55-163" aria-hidden="true" tabindex="-1"></a>      <span class="dt">grid</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb55-164"><a href="#cb55-164" aria-hidden="true" tabindex="-1"></a>      <span class="co">// domain: sortedData.map(d =&gt; d.indicator) // Only show indicators with data</span></span>
<span id="cb55-165"><a href="#cb55-165" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb55-166"><a href="#cb55-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-167"><a href="#cb55-167" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb55-168"><a href="#cb55-168" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Regional average bars (light gray background) - full width</span></span>
<span id="cb55-169"><a href="#cb55-169" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">barX</span>(sortedData<span class="op">,</span> {</span>
<span id="cb55-170"><a href="#cb55-170" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"parent_normalizedValue"</span><span class="op">,</span></span>
<span id="cb55-171"><a href="#cb55-171" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"indicator"</span><span class="op">,</span></span>
<span id="cb55-172"><a href="#cb55-172" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"#e5e5e5"</span><span class="op">,</span></span>
<span id="cb55-173"><a href="#cb55-173" aria-hidden="true" tabindex="-1"></a>        <span class="dt">opacity</span><span class="op">:</span> <span class="fl">0.7</span></span>
<span id="cb55-174"><a href="#cb55-174" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb55-175"><a href="#cb55-175" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb55-176"><a href="#cb55-176" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Actual value bars (blue bars) - narrower using inset</span></span>
<span id="cb55-177"><a href="#cb55-177" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb55-178"><a href="#cb55-178" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">barX</span>(sortedData<span class="op">,</span> {</span>
<span id="cb55-179"><a href="#cb55-179" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"region_normalizedValue"</span><span class="op">,</span> </span>
<span id="cb55-180"><a href="#cb55-180" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"indicator"</span><span class="op">,</span></span>
<span id="cb55-181"><a href="#cb55-181" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"#4a90e2"</span><span class="op">,</span></span>
<span id="cb55-182"><a href="#cb55-182" aria-hidden="true" tabindex="-1"></a>        <span class="dt">insetTop</span><span class="op">:</span> <span class="dv">15</span><span class="op">,</span> <span class="co">// Make bars narrower</span></span>
<span id="cb55-183"><a href="#cb55-183" aria-hidden="true" tabindex="-1"></a>        <span class="dt">insetBottom</span><span class="op">:</span> <span class="dv">15</span><span class="op">,</span> </span>
<span id="cb55-184"><a href="#cb55-184" aria-hidden="true" tabindex="-1"></a>        <span class="dt">channels</span><span class="op">:</span> plot_channels<span class="op">,</span></span>
<span id="cb55-185"><a href="#cb55-185" aria-hidden="true" tabindex="-1"></a>        <span class="dt">tip</span><span class="op">:</span> {</span>
<span id="cb55-186"><a href="#cb55-186" aria-hidden="true" tabindex="-1"></a>          <span class="dt">anchor</span><span class="op">:</span> <span class="st">"top"</span><span class="op">,</span> <span class="co">// Position above the blue bar</span></span>
<span id="cb55-187"><a href="#cb55-187" aria-hidden="true" tabindex="-1"></a>          <span class="dt">dy</span><span class="op">:</span> <span class="op">-</span><span class="dv">10</span><span class="op">,</span> <span class="co">// Offset upward</span></span>
<span id="cb55-188"><a href="#cb55-188" aria-hidden="true" tabindex="-1"></a>          <span class="dt">format</span><span class="op">:</span> {</span>
<span id="cb55-189"><a href="#cb55-189" aria-hidden="true" tabindex="-1"></a>            <span class="dt">x</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb55-190"><a href="#cb55-190" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb55-191"><a href="#cb55-191" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb55-192"><a href="#cb55-192" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb55-193"><a href="#cb55-193" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb55-194"><a href="#cb55-194" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb55-195"><a href="#cb55-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-196"><a href="#cb55-196" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> plot<span class="op">;</span></span>
<span id="cb55-197"><a href="#cb55-197" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-55" data-nodetype="expression"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb56" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb56--1"><a href="#cb56--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Download functionality</span></span>
<span id="cb56-0"><a href="#cb56-0" aria-hidden="true" tabindex="-1"></a>adaptiveCapacityDownloadButton <span class="op">=</span> {</span>
<span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>filteredAdaptiveCapacityData <span class="op">||</span> filteredAdaptiveCapacityData<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">``</span><span class="op">;</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> region <span class="op">=</span> <span class="fu">getAdaptiveCapacityRegion</span>()<span class="op">;</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">downloadButton</span>(</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    filteredAdaptiveCapacityData<span class="op">,</span> </span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    <span class="vs">`adaptive_capacity_data_</span><span class="sc">${</span>region<span class="op">.</span><span class="fu">replace</span>(<span class="ss">/</span><span class="sc">\s+</span><span class="ss">/g</span><span class="op">,</span> <span class="st">'_'</span>)<span class="sc">}</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">_lang</span>(vulnerability_translations<span class="op">.</span><span class="at">download_data</span>)</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-56" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb57" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb57--1"><a href="#cb57--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Dynamic Insights following wireframe template</span></span>
<span id="cb57-0"><a href="#cb57-0" aria-hidden="true" tabindex="-1"></a>adaptiveCapacityInsights <span class="op">=</span> {</span>
<span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>filteredAdaptiveCapacityData <span class="op">||</span> filteredAdaptiveCapacityData<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">createNoDataState</span>()<span class="op">;</span> <span class="co">// Use same function as exposure</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> data <span class="op">=</span> filteredAdaptiveCapacityData[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> region <span class="op">=</span> <span class="fu">getAdaptiveCapacityRegion</span>()<span class="op">;</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Helper function to determine threshold level</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> getThresholdLevel <span class="op">=</span> (value<span class="op">,</span> thresholds<span class="op">,</span> isInverse <span class="op">=</span> <span class="kw">false</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (isInverse) {</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>      <span class="co">// For inverse indicators (lower is better)</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (value <span class="op">&lt;=</span> thresholds<span class="op">.</span><span class="at">low</span>[<span class="dv">0</span>]) <span class="cf">return</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"high"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"√©lev√©"</span>})<span class="op">;</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (value <span class="op">&lt;=</span> thresholds<span class="op">.</span><span class="at">mid</span>[<span class="dv">0</span>]) <span class="cf">return</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"moderate"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"mod√©r√©"</span>})<span class="op">;</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"low"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"faible"</span>})<span class="op">;</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>      <span class="co">// For normal indicators (higher is better)</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (value <span class="op">&gt;=</span> thresholds<span class="op">.</span><span class="at">high</span>[<span class="dv">0</span>]) <span class="cf">return</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"high"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"√©lev√©"</span>})<span class="op">;</span></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (value <span class="op">&gt;=</span> thresholds<span class="op">.</span><span class="at">mid</span>[<span class="dv">0</span>]) <span class="cf">return</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"moderate"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"mod√©r√©"</span>})<span class="op">;</span></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"low"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"faible"</span>})<span class="op">;</span></span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create indicators using new normalized data structure</span></span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> indicators <span class="op">=</span> [</span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>      <span class="dt">key</span><span class="op">:</span> <span class="st">"pct_electric_norm"</span><span class="op">,</span></span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>      <span class="dt">originalKey</span><span class="op">:</span> <span class="st">"pct_electric"</span><span class="op">,</span></span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Electricity Access"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Acc√®s √† l'√©lectricit√©"</span>})<span class="op">,</span></span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>      <span class="dt">originalValue</span><span class="op">:</span> data<span class="op">.</span><span class="at">pct_electric</span><span class="op">,</span></span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>      <span class="dt">normalizedValue</span><span class="op">:</span> data<span class="op">.</span><span class="at">pct_electric_norm</span><span class="op">,</span></span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>      <span class="dt">unit</span><span class="op">:</span> <span class="st">"%"</span></span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>      <span class="dt">key</span><span class="op">:</span> <span class="st">"pct_piped_water_norm"</span><span class="op">,</span></span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a>      <span class="dt">originalKey</span><span class="op">:</span> <span class="st">"pct_piped_water"</span><span class="op">,</span> </span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Piped Water Access"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Acc√®s √† l'eau courante"</span>})<span class="op">,</span></span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a>      <span class="dt">originalValue</span><span class="op">:</span> data<span class="op">.</span><span class="at">pct_piped_water</span><span class="op">,</span></span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a>      <span class="dt">normalizedValue</span><span class="op">:</span> data<span class="op">.</span><span class="at">pct_piped_water_norm</span><span class="op">,</span></span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a>      <span class="dt">unit</span><span class="op">:</span> <span class="st">"%"</span></span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb57-42"><a href="#cb57-42" aria-hidden="true" tabindex="-1"></a>      <span class="dt">key</span><span class="op">:</span> <span class="st">"min_to_cities_norm"</span><span class="op">,</span></span>
<span id="cb57-43"><a href="#cb57-43" aria-hidden="true" tabindex="-1"></a>      <span class="dt">originalKey</span><span class="op">:</span> <span class="st">"min_to_cities"</span><span class="op">,</span></span>
<span id="cb57-44"><a href="#cb57-44" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Travel Time to Cities"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Temps de trajet vers les villes"</span>})<span class="op">,</span></span>
<span id="cb57-45"><a href="#cb57-45" aria-hidden="true" tabindex="-1"></a>      <span class="dt">originalValue</span><span class="op">:</span> data<span class="op">.</span><span class="at">min_to_cities</span><span class="op">,</span></span>
<span id="cb57-46"><a href="#cb57-46" aria-hidden="true" tabindex="-1"></a>      <span class="dt">normalizedValue</span><span class="op">:</span> data<span class="op">.</span><span class="at">min_to_cities_norm</span><span class="op">,</span></span>
<span id="cb57-47"><a href="#cb57-47" aria-hidden="true" tabindex="-1"></a>      <span class="dt">unit</span><span class="op">:</span> <span class="st">" min"</span></span>
<span id="cb57-48"><a href="#cb57-48" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb57-49"><a href="#cb57-49" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb57-50"><a href="#cb57-50" aria-hidden="true" tabindex="-1"></a>      <span class="dt">key</span><span class="op">:</span> <span class="st">"pct_cellphone_norm"</span><span class="op">,</span></span>
<span id="cb57-51"><a href="#cb57-51" aria-hidden="true" tabindex="-1"></a>      <span class="dt">originalKey</span><span class="op">:</span> <span class="st">"pct_cellphone"</span><span class="op">,</span></span>
<span id="cb57-52"><a href="#cb57-52" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Cellphone Access"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Acc√®s au t√©l√©phone portable"</span>})<span class="op">,</span></span>
<span id="cb57-53"><a href="#cb57-53" aria-hidden="true" tabindex="-1"></a>      <span class="dt">originalValue</span><span class="op">:</span> data<span class="op">.</span><span class="at">pct_cellphone</span><span class="op">,</span></span>
<span id="cb57-54"><a href="#cb57-54" aria-hidden="true" tabindex="-1"></a>      <span class="dt">normalizedValue</span><span class="op">:</span> data<span class="op">.</span><span class="at">pct_cellphone_norm</span><span class="op">,</span></span>
<span id="cb57-55"><a href="#cb57-55" aria-hidden="true" tabindex="-1"></a>      <span class="dt">unit</span><span class="op">:</span> <span class="st">"%"</span></span>
<span id="cb57-56"><a href="#cb57-56" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb57-57"><a href="#cb57-57" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb57-58"><a href="#cb57-58" aria-hidden="true" tabindex="-1"></a>      <span class="dt">key</span><span class="op">:</span> <span class="st">"conflict_density_norm"</span><span class="op">,</span></span>
<span id="cb57-59"><a href="#cb57-59" aria-hidden="true" tabindex="-1"></a>      <span class="dt">originalKey</span><span class="op">:</span> <span class="st">"conflict_density"</span><span class="op">,</span></span>
<span id="cb57-60"><a href="#cb57-60" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Conflict Density"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Densit√© de conflit"</span>})<span class="op">,</span></span>
<span id="cb57-61"><a href="#cb57-61" aria-hidden="true" tabindex="-1"></a>      <span class="dt">originalValue</span><span class="op">:</span> data<span class="op">.</span><span class="at">conflict_density</span><span class="op">,</span></span>
<span id="cb57-62"><a href="#cb57-62" aria-hidden="true" tabindex="-1"></a>      <span class="dt">normalizedValue</span><span class="op">:</span> data<span class="op">.</span><span class="at">conflict_density_norm</span><span class="op">,</span></span>
<span id="cb57-63"><a href="#cb57-63" aria-hidden="true" tabindex="-1"></a>      <span class="dt">unit</span><span class="op">:</span> <span class="st">" count/km¬≤"</span></span>
<span id="cb57-64"><a href="#cb57-64" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb57-65"><a href="#cb57-65" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">;</span></span>
<span id="cb57-66"><a href="#cb57-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-67"><a href="#cb57-67" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Format indicators with performance levels based on normalized values</span></span>
<span id="cb57-68"><a href="#cb57-68" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> thresholdIndicators <span class="op">=</span> indicators<span class="op">.</span><span class="fu">map</span>(indicator <span class="kw">=&gt;</span> {</span>
<span id="cb57-69"><a href="#cb57-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> normalizedValue <span class="op">=</span> <span class="kw">typeof</span> indicator<span class="op">.</span><span class="at">normalizedValue</span> <span class="op">===</span> <span class="st">'number'</span> <span class="op">?</span> indicator<span class="op">.</span><span class="at">normalizedValue</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb57-70"><a href="#cb57-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> originalValue <span class="op">=</span> <span class="kw">typeof</span> indicator<span class="op">.</span><span class="at">originalValue</span> <span class="op">===</span> <span class="st">'number'</span> <span class="op">?</span> indicator<span class="op">.</span><span class="at">originalValue</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb57-71"><a href="#cb57-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-72"><a href="#cb57-72" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Determine performance level based on normalized value (0-1 scale)</span></span>
<span id="cb57-73"><a href="#cb57-73" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> level<span class="op">;</span></span>
<span id="cb57-74"><a href="#cb57-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (normalizedValue <span class="op">&gt;=</span> <span class="fl">0.8</span>) {</span>
<span id="cb57-75"><a href="#cb57-75" aria-hidden="true" tabindex="-1"></a>      level <span class="op">=</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"high"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"√©lev√©"</span>})<span class="op">;</span></span>
<span id="cb57-76"><a href="#cb57-76" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (normalizedValue <span class="op">&gt;=</span> <span class="fl">0.5</span>) {</span>
<span id="cb57-77"><a href="#cb57-77" aria-hidden="true" tabindex="-1"></a>      level <span class="op">=</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"moderate"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"mod√©r√©"</span>})<span class="op">;</span></span>
<span id="cb57-78"><a href="#cb57-78" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb57-79"><a href="#cb57-79" aria-hidden="true" tabindex="-1"></a>      level <span class="op">=</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"low"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"faible"</span>})<span class="op">;</span></span>
<span id="cb57-80"><a href="#cb57-80" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb57-81"><a href="#cb57-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-82"><a href="#cb57-82" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> numValue <span class="op">=</span> <span class="bu">Number</span>(originalValue) <span class="op">||</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb57-83"><a href="#cb57-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> formattedValue <span class="op">=</span> numValue <span class="op">&lt;</span> <span class="dv">1</span> <span class="op">?</span> numValue<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>) <span class="op">:</span> numValue<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb57-84"><a href="#cb57-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span><span class="sc">${</span>indicator<span class="op">.</span><span class="at">label</span><span class="sc">}</span><span class="vs">: </span><span class="sc">${</span>formattedValue<span class="sc">}${</span>indicator<span class="op">.</span><span class="at">unit</span><span class="sc">}</span><span class="vs"> (</span><span class="sc">${</span>level<span class="sc">}</span><span class="vs">)`</span><span class="op">;</span></span>
<span id="cb57-85"><a href="#cb57-85" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb57-86"><a href="#cb57-86" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-87"><a href="#cb57-87" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Identify limiting factors based on the exact format specified</span></span>
<span id="cb57-88"><a href="#cb57-88" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> limitingFactors <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb57-89"><a href="#cb57-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-90"><a href="#cb57-90" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check each indicator for limiting factors using normalized values</span></span>
<span id="cb57-91"><a href="#cb57-91" aria-hidden="true" tabindex="-1"></a>  indicators<span class="op">.</span><span class="fu">forEach</span>(indicator <span class="kw">=&gt;</span> {</span>
<span id="cb57-92"><a href="#cb57-92" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> normalizedValue <span class="op">=</span> <span class="kw">typeof</span> indicator<span class="op">.</span><span class="at">normalizedValue</span> <span class="op">===</span> <span class="st">'number'</span> <span class="op">?</span> indicator<span class="op">.</span><span class="at">normalizedValue</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb57-93"><a href="#cb57-93" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> originalValue <span class="op">=</span> <span class="kw">typeof</span> indicator<span class="op">.</span><span class="at">originalValue</span> <span class="op">===</span> <span class="st">'number'</span> <span class="op">?</span> indicator<span class="op">.</span><span class="at">originalValue</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb57-94"><a href="#cb57-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-95"><a href="#cb57-95" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Determine if this is a limiting factor (low performance)</span></span>
<span id="cb57-96"><a href="#cb57-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (normalizedValue <span class="op">&lt;</span> <span class="fl">0.5</span>) {</span>
<span id="cb57-97"><a href="#cb57-97" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> numValue <span class="op">=</span> <span class="bu">Number</span>(originalValue) <span class="op">||</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb57-98"><a href="#cb57-98" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> formattedValue<span class="op">;</span></span>
<span id="cb57-99"><a href="#cb57-99" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (indicator<span class="op">.</span><span class="at">originalKey</span> <span class="op">===</span> <span class="st">"pct_electric"</span>) {</span>
<span id="cb57-100"><a href="#cb57-100" aria-hidden="true" tabindex="-1"></a>        formattedValue <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>numValue<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>)<span class="sc">}</span><span class="vs">%`</span><span class="op">;</span></span>
<span id="cb57-101"><a href="#cb57-101" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (indicator<span class="op">.</span><span class="at">originalKey</span> <span class="op">===</span> <span class="st">"min_to_cities"</span>) {</span>
<span id="cb57-102"><a href="#cb57-102" aria-hidden="true" tabindex="-1"></a>        formattedValue <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>numValue<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">0</span>)<span class="sc">}</span><span class="vs"> min`</span><span class="op">;</span></span>
<span id="cb57-103"><a href="#cb57-103" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (indicator<span class="op">.</span><span class="at">originalKey</span> <span class="op">===</span> <span class="st">"inet_d_kbps"</span>) {</span>
<span id="cb57-104"><a href="#cb57-104" aria-hidden="true" tabindex="-1"></a>        formattedValue <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>(numValue<span class="op">/</span><span class="dv">1000</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>)<span class="sc">}</span><span class="vs"> Mbps`</span><span class="op">;</span></span>
<span id="cb57-105"><a href="#cb57-105" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (indicator<span class="op">.</span><span class="at">originalKey</span> <span class="op">===</span> <span class="st">"pct_piped_water"</span>) {</span>
<span id="cb57-106"><a href="#cb57-106" aria-hidden="true" tabindex="-1"></a>        formattedValue <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>numValue<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">0</span>)<span class="sc">}</span><span class="vs">%`</span><span class="op">;</span></span>
<span id="cb57-107"><a href="#cb57-107" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (indicator<span class="op">.</span><span class="at">originalKey</span> <span class="op">===</span> <span class="st">"pct_cellphone"</span>) {</span>
<span id="cb57-108"><a href="#cb57-108" aria-hidden="true" tabindex="-1"></a>        formattedValue <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>numValue<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">0</span>)<span class="sc">}</span><span class="vs">%`</span><span class="op">;</span></span>
<span id="cb57-109"><a href="#cb57-109" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (indicator<span class="op">.</span><span class="at">originalKey</span> <span class="op">===</span> <span class="st">"conflict_density"</span>) {</span>
<span id="cb57-110"><a href="#cb57-110" aria-hidden="true" tabindex="-1"></a>        formattedValue <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>(numValue <span class="op">*</span> <span class="dv">1000</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>)<span class="sc">}</span><span class="vs"> per 1000 km¬≤`</span><span class="op">;</span></span>
<span id="cb57-111"><a href="#cb57-111" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb57-112"><a href="#cb57-112" aria-hidden="true" tabindex="-1"></a>        formattedValue <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>numValue<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>)<span class="sc">}${</span>indicator<span class="op">.</span><span class="at">unit</span><span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb57-113"><a href="#cb57-113" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb57-114"><a href="#cb57-114" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb57-115"><a href="#cb57-115" aria-hidden="true" tabindex="-1"></a>      limitingFactors<span class="op">.</span><span class="fu">push</span>(<span class="vs">`</span><span class="sc">${</span>indicator<span class="op">.</span><span class="at">label</span><span class="sc">}</span><span class="vs"> (</span><span class="sc">${</span>formattedValue<span class="sc">}</span><span class="vs">)`</span>)<span class="op">;</span></span>
<span id="cb57-116"><a href="#cb57-116" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb57-117"><a href="#cb57-117" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb57-118"><a href="#cb57-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-119"><a href="#cb57-119" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-120"><a href="#cb57-120" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Generate insight text in the exact format specified</span></span>
<span id="cb57-121"><a href="#cb57-121" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> limitationLevel <span class="op">=</span> limitingFactors<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">2</span> <span class="op">?</span> </span>
<span id="cb57-122"><a href="#cb57-122" aria-hidden="true" tabindex="-1"></a>    <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"significantly limited"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"significativement limit√©e"</span>}) <span class="op">:</span></span>
<span id="cb57-123"><a href="#cb57-123" aria-hidden="true" tabindex="-1"></a>    limitingFactors<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> </span>
<span id="cb57-124"><a href="#cb57-124" aria-hidden="true" tabindex="-1"></a>    <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"limited"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"limit√©e"</span>}) <span class="op">:</span></span>
<span id="cb57-125"><a href="#cb57-125" aria-hidden="true" tabindex="-1"></a>    <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"strong"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"forte"</span>})<span class="op">;</span></span>
<span id="cb57-126"><a href="#cb57-126" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-127"><a href="#cb57-127" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Format factors as HTML list</span></span>
<span id="cb57-128"><a href="#cb57-128" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> factorsList <span class="op">=</span> limitingFactors<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> </span>
<span id="cb57-129"><a href="#cb57-129" aria-hidden="true" tabindex="-1"></a>    limitingFactors<span class="op">.</span><span class="fu">map</span>(factor <span class="kw">=&gt;</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">`&lt;li&gt;</span><span class="sc">${</span>factor<span class="sc">}</span><span class="vs">&lt;/li&gt;`</span>) <span class="op">:</span></span>
<span id="cb57-130"><a href="#cb57-130" aria-hidden="true" tabindex="-1"></a>    [htl<span class="op">.</span><span class="fu">html</span><span class="vs">`&lt;li&gt;</span><span class="sc">${</span><span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Strong infrastructure and services"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Infrastructure et services solides"</span>})<span class="sc">}</span><span class="vs">&lt;/li&gt;`</span>]<span class="op">;</span></span>
<span id="cb57-131"><a href="#cb57-131" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-132"><a href="#cb57-132" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> recommendation <span class="op">=</span> limitingFactors<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span></span>
<span id="cb57-133"><a href="#cb57-133" aria-hidden="true" tabindex="-1"></a>    <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Addressing these can improve resilience."</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Traiter ces probl√®mes peut am√©liorer la r√©silience."</span>}) <span class="op">:</span></span>
<span id="cb57-134"><a href="#cb57-134" aria-hidden="true" tabindex="-1"></a>    <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Continue strengthening these systems."</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Continuer √† renforcer ces syst√®mes."</span>})<span class="op">;</span></span>
<span id="cb57-135"><a href="#cb57-135" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-136"><a href="#cb57-136" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> insight <span class="op">=</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">`&lt;div&gt;</span></span>
<span id="cb57-137"><a href="#cb57-137" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;p&gt;</span><span class="sc">${</span><span class="fu">_lang</span>({</span>
<span id="cb57-138"><a href="#cb57-138" aria-hidden="true" tabindex="-1"></a>      <span class="dt">en</span><span class="op">:</span> <span class="vs">`In </span><span class="sc">${</span>region<span class="sc">}</span><span class="vs">, adaptive capacity is </span><span class="sc">${</span>limitationLevel<span class="sc">}</span><span class="vs"> by:`</span><span class="op">,</span></span>
<span id="cb57-139"><a href="#cb57-139" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fr</span><span class="op">:</span> <span class="vs">`En </span><span class="sc">${</span>region<span class="sc">}</span><span class="vs">, la capacit√© d'adaptation est </span><span class="sc">${</span>limitationLevel<span class="sc">}</span><span class="vs"> par :`</span></span>
<span id="cb57-140"><a href="#cb57-140" aria-hidden="true" tabindex="-1"></a>    })<span class="sc">}</span><span class="vs">&lt;/p&gt;</span></span>
<span id="cb57-141"><a href="#cb57-141" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;ul&gt;</span><span class="sc">${</span>factorsList<span class="sc">}</span><span class="vs">&lt;/ul&gt;</span></span>
<span id="cb57-142"><a href="#cb57-142" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;p&gt;</span><span class="sc">${</span>recommendation<span class="sc">}</span><span class="vs">&lt;/p&gt;</span></span>
<span id="cb57-143"><a href="#cb57-143" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb57-144"><a href="#cb57-144" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-145"><a href="#cb57-145" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">createInsightDisplay</span>(insight)<span class="op">;</span></span>
<span id="cb57-146"><a href="#cb57-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-147"><a href="#cb57-147" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-57" data-nodetype="declaration"></div></div></div><hr><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb58" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb58--1"><a href="#cb58--1" aria-hidden="true" tabindex="-1"></a>compositeQuestion <span class="op">=</span> <span class="fu">_lang</span>(vulnerability_translations<span class="op">.</span><span class="at">composite_question</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-58" data-nodetype="declaration"></div></div></div></section><section id="composite-index" class="level1"><h1><span><span id="ojs-element-id-10"></span></span></h1><p><span><span id="ojs-element-id-11"></span></span></p><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb59" data-startfrom="1" data-source-offset="-53"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>viewof compositeAdmin0 <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">select</span>(dataAdmin0<span class="op">,</span> {</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> adminRegions<span class="op">.</span><span class="at">labels</span><span class="op">.</span><span class="at">admin0</span><span class="op">,</span> </span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">format</span><span class="op">:</span> x <span class="kw">=&gt;</span> x<span class="op">.</span><span class="at">label</span><span class="op">,</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> dataAdmin0<span class="op">.</span><span class="fu">find</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value</span> <span class="op">===</span> sharedAdmin0) <span class="op">||</span> (dataAdmin0<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> dataAdmin0[<span class="dv">0</span>] <span class="op">:</span> <span class="kw">null</span>)</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>viewof compositeAdmin1 <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">select</span>(dataAdmin1<span class="op">,</span> {</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> adminRegions<span class="op">.</span><span class="at">labels</span><span class="op">.</span><span class="at">admin1</span><span class="op">,</span> </span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">format</span><span class="op">:</span> x <span class="kw">=&gt;</span> x<span class="op">.</span><span class="at">label</span><span class="op">,</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> dataAdmin1<span class="op">.</span><span class="fu">find</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value</span> <span class="op">===</span> sharedAdmin1) <span class="op">||</span> (dataAdmin1<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> dataAdmin1[<span class="dv">0</span>] <span class="op">:</span> <span class="kw">null</span>)</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>})  </span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>viewof compositeAdmin2 <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">select</span>(dataAdmin2<span class="op">,</span> {</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> adminRegions<span class="op">.</span><span class="at">labels</span><span class="op">.</span><span class="at">admin2</span><span class="op">,</span> </span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">format</span><span class="op">:</span> x <span class="kw">=&gt;</span> x<span class="op">.</span><span class="at">label</span><span class="op">,</span></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> dataAdmin2<span class="op">.</span><span class="fu">find</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value</span> <span class="op">===</span> sharedAdmin2) <span class="op">||</span> (dataAdmin2<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> dataAdmin2[<span class="dv">0</span>] <span class="op">:</span> <span class="kw">null</span>)</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a><span class="co">// Component selection</span></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>viewof compositeSelectedComponent <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">select</span>(</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>  [</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">value</span><span class="op">:</span> <span class="st">"composite"</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Composite Vulnerability"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Vuln√©rabilit√© Composite"</span>}) }<span class="op">,</span></span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">value</span><span class="op">:</span> <span class="st">"exposure"</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Exposure"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Exposition"</span>}) }<span class="op">,</span></span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">value</span><span class="op">:</span> <span class="st">"sensitivity"</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Sensitivity"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Sensibilit√©"</span>}) }<span class="op">,</span></span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">value</span><span class="op">:</span> <span class="st">"adaptive_capacity"</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Adaptive Capacity"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Capacit√© d'Adaptation"</span>}) }</span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">,</span></span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Component Selection"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"S√©lection de Composant"</span>})<span class="op">,</span></span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">format</span><span class="op">:</span> x <span class="kw">=&gt;</span> x<span class="op">.</span><span class="at">label</span><span class="op">,</span></span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a>    <span class="dt">value</span><span class="op">:</span> { <span class="dt">value</span><span class="op">:</span> <span class="st">"composite"</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Composite Vulnerability"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Vuln√©rabilit√© Composite"</span>}) }</span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-59-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-59-2" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-59-3" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-59-4" data-nodetype="declaration"></div></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb60" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb60--1"><a href="#cb60--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Controls form with exact same HTML structure</span></span>
<span id="cb60-0"><a href="#cb60-0" aria-hidden="true" tabindex="-1"></a>compositeControlsForm <span class="op">=</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">`</span></span>
<span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="vs">&lt;div style="</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="vs">  background: #f8fafc;</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="vs">  border: 2px solid #e2e8f0;</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="vs">  border-radius: 12px;</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="vs">  padding: 24px;</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="vs">  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="vs">  margin: 16px 0;</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="vs">"&gt;</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;h3 style="margin: 0 0 20px 0; color: #2d3748; font-size: 1.1rem; font-weight: 600;"&gt;</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a><span class="vs">    </span><span class="sc">${</span><span class="fu">_lang</span>(vulnerability_translations<span class="op">.</span><span class="at">geographic_selection</span>)<span class="sc">}</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;/h3&gt;</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;div style="</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a><span class="vs">    display: flex;</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a><span class="vs">    align-items: flex-start;</span></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a><span class="vs">    gap: 20px;</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a><span class="vs">    flex-wrap: wrap;</span></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a><span class="vs">    justify-content: space-between;</span></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a><span class="vs">  " class="form-inputs-container"&gt;</span></span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div style="flex: 1; min-width: 180px; max-width: 100%;"&gt;</span><span class="sc">${</span>viewof compositeAdmin0<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div style="flex: 1; min-width: 180px; max-width: 100%;"&gt;</span><span class="sc">${</span>viewof compositeAdmin1<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div style="flex: 1; min-width: 180px; max-width: 100%;"&gt;</span><span class="sc">${</span>viewof compositeAdmin2<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;/div&gt;</span></span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;div style="margin-top: 16px;"&gt;</span></span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div style="flex: 1; min-width: 200px; max-width: 100%;"&gt;</span><span class="sc">${</span>viewof compositeSelectedComponent<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;/div&gt;</span></span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a><span class="vs">&lt;/div&gt;</span></span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-60" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb61" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb61--1"><a href="#cb61--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Keep metadata as JSON (small file, 4KB)</span></span>
<span id="cb61-0"><a href="#cb61-0" aria-hidden="true" tabindex="-1"></a>sensitivityMetadata <span class="op">=</span> <span class="cf">await</span> <span class="fu">loadDataWithCache</span>(</span>
<span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>  <span class="st">"compositeUrgencyMetadata"</span><span class="op">,</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cf">await</span> <span class="fu">FileAttachment</span>(</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">"/data/vulnerability_notebook/urgency_metadata.json"</span><span class="op">,</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    )<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-61" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb62" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb62--1"><a href="#cb62--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Reuse cached boundary data (already loaded in shared)</span></span>
<span id="cb62-0"><a href="#cb62-0" aria-hidden="true" tabindex="-1"></a>compositeMapBoundaries <span class="op">=</span> boundaries<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-62" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb63" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb63--1"><a href="#cb63--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Get current admin selections using shared state</span></span>
<span id="cb63-0"><a href="#cb63-0" aria-hidden="true" tabindex="-1"></a>compositeAdminSelections <span class="op">=</span> {</span>
<span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> {</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">selectAdmin0</span><span class="op">:</span> compositeAdmin0<span class="op">?.</span><span class="at">value</span> <span class="op">||</span> sharedAdmin0 <span class="op">||</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">selectAdmin1</span><span class="op">:</span> compositeAdmin1<span class="op">?.</span><span class="at">value</span> <span class="op">||</span> sharedAdmin1 <span class="op">||</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">selectAdmin2</span><span class="op">:</span> compositeAdmin2<span class="op">?.</span><span class="at">value</span> <span class="op">||</span> sharedAdmin2 <span class="op">||</span> <span class="kw">null</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-63" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb64" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb64--1"><a href="#cb64--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Database connection for index calculations</span></span>
<span id="cb64-0"><a href="#cb64-0" aria-hidden="true" tabindex="-1"></a>index_db <span class="op">=</span> DuckDBClient<span class="op">.</span><span class="fu">of</span>({</span>
<span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>  <span class="dt">exposure</span><span class="op">:</span> <span class="fu">FileAttachment</span>(</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"/data/vulnerability_notebook/notebook_exposure.parquet"</span><span class="op">,</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  )<span class="op">,</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">urgency</span><span class="op">:</span> <span class="fu">FileAttachment</span>(<span class="st">"/data/vulnerability_notebook/urgency_index.parquet"</span>)<span class="op">,</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">enabling</span><span class="op">:</span> <span class="fu">FileAttachment</span>(</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"/data/vulnerability_notebook/enabling_vars.parquet"</span><span class="op">,</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>  )<span class="op">,</span> <span class="co">// AKA adaptive capacity</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-64" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb65" data-startfrom="7" data-source-offset="-308"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line 6"><span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">computeIndex</span>(row) {</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> normValues <span class="op">=</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">entries</span>(row)</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>      ([key<span class="op">,</span> value]) <span class="kw">=&gt;</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>        key<span class="op">.</span><span class="fu">endsWith</span>(<span class="st">"_norm"</span>) <span class="op">&amp;&amp;</span> <span class="kw">typeof</span> value <span class="op">===</span> <span class="st">"number"</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="pp">isNaN</span>(value)<span class="op">,</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(([<span class="op">,</span> value]) <span class="kw">=&gt;</span> value)<span class="op">;</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (normValues<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> sum <span class="op">=</span> normValues<span class="op">.</span><span class="fu">reduce</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> a <span class="op">+</span> b<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> sum <span class="op">/</span> normValues<span class="op">.</span><span class="at">length</span><span class="op">;</span></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a><span class="co"> * Generate SQL WHERE clause for admin level filtering</span></span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a><span class="co"> * Returns clause to filter by admin0 (country level) or admin1 (region level) based on selection</span></span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{string|null}</span><span class="co"> country_sel - Selected country code (or "SSA" for all countries)</span></span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{string|null}</span><span class="co"> admin1_sel - Selected admin1 region (currently unused but kept for consistency)</span></span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@returns</span><span class="co"> {string} SQL WHERE clause fragment</span></span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a>whereAdminNull <span class="op">=</span> (country_sel<span class="op">,</span> admin1_sel) <span class="kw">=&gt;</span> {</span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">// If all countries selected (SSA) or no selection, return country-level data (admin1_name IS NULL)</span></span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Otherwise, return region-level data (admin1_name IS NOT NULL)</span></span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (country_sel <span class="op">==</span> <span class="st">"SSA"</span> <span class="op">||</span> <span class="op">!</span>country_sel) {</span>
<span id="cb65-33"><a href="#cb65-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`AND admin1_name IS NULL`</span><span class="op">;</span></span>
<span id="cb65-34"><a href="#cb65-34" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb65-35"><a href="#cb65-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`AND admin1_name IS NOT NULL`</span><span class="op">;</span></span>
<span id="cb65-36"><a href="#cb65-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb65-37"><a href="#cb65-37" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-65-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-65-2" data-nodetype="declaration"></div></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb66" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb66--1"><a href="#cb66--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate exposure index</span></span>
<span id="cb66-0"><a href="#cb66-0" aria-hidden="true" tabindex="-1"></a>exposure_index <span class="op">=</span> {</span>
<span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check if index_db is available before querying</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>index_db) {</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"index_db is not available"</span>)<span class="op">;</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> []<span class="op">;</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cf">await</span> index_db<span class="op">.</span><span class="fu">query</span>(<span class="vs">`</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="vs">      WITH raw_exposure AS (</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a><span class="vs">          SELECT </span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a><span class="vs">            admin0_name, </span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a><span class="vs">            admin1_name, </span></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a><span class="vs">            SUM(value) AS total_exposure</span></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a><span class="vs">          FROM exposure</span></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a><span class="vs">          WHERE admin2_name IS NULL</span></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a><span class="vs">            </span><span class="sc">${</span><span class="fu">whereAdminNull</span>(compositeAdmin0<span class="op">.</span><span class="at">value</span><span class="op">,</span> compositeAdmin1<span class="op">.</span><span class="at">value</span>)<span class="sc">}</span></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a><span class="vs">          GROUP BY admin0_name, admin1_name</span></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a><span class="vs">        ),</span></span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a><span class="vs">        stats AS (</span></span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a><span class="vs">          SELECT</span></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a><span class="vs">            MIN(total_exposure) AS exposure_min,</span></span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a><span class="vs">            MAX(total_exposure) AS exposure_max</span></span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a><span class="vs">          FROM raw_exposure</span></span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a><span class="vs">          WHERE ISFINITE(total_exposure)</span></span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a><span class="vs">        )</span></span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a><span class="vs">        SELECT </span></span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a><span class="vs">          r.admin0_name,</span></span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a><span class="vs">          r.admin1_name,</span></span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a><span class="vs">          r.total_exposure,</span></span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a><span class="vs">          -- Min-max normalize exposure</span></span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a><span class="vs">          (r.total_exposure - s.exposure_min) / NULLIF(s.exposure_max - s.exposure_min, 0) AS exposure_norm</span></span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a><span class="vs">        FROM raw_exposure r</span></span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a><span class="vs">        CROSS JOIN stats s</span></span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a><span class="vs">        WHERE ISFINITE(r.total_exposure)</span></span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a><span class="vs">        ORDER BY r.total_exposure DESC;</span></span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span>)<span class="op">;</span></span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Failed to calculate exposure index:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> []<span class="op">;</span></span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-41"><a href="#cb66-41" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-66" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb67" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb67--1"><a href="#cb67--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate enabling index (adaptive capacity)</span></span>
<span id="cb67-0"><a href="#cb67-0" aria-hidden="true" tabindex="-1"></a>enabling_index <span class="op">=</span> {</span>
<span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check if index_db is available before querying</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>index_db) {</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"index_db is not available"</span>)<span class="op">;</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> []<span class="op">;</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> resp <span class="op">=</span> <span class="cf">await</span> index_db<span class="op">.</span><span class="fu">query</span>(<span class="vs">`</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a><span class="vs">SELECT *</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a><span class="vs">FROM enabling</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a><span class="vs">WHERE admin0_name != 'SSA'</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a><span class="sc">${</span><span class="fu">whereAdminNull</span>(compositeAdmin0<span class="op">.</span><span class="at">value</span><span class="op">,</span> compositeAdmin1<span class="op">.</span><span class="at">value</span>)<span class="sc">}</span></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> resp<span class="op">.</span><span class="fu">map</span>((row) <span class="kw">=&gt;</span> ({</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>row<span class="op">,</span></span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">enabling_index</span><span class="op">:</span> <span class="fu">computeIndex</span>(row)</span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Failed to calculate enabling index:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> []<span class="op">;</span></span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-67" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb68" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb68--1"><a href="#cb68--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate urgency index</span></span>
<span id="cb68-0"><a href="#cb68-0" aria-hidden="true" tabindex="-1"></a><span class="co">// Index is based on exposure and sensitivity</span></span>
<span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>urgency_index <span class="op">=</span> {</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check if index_db is available before querying</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>index_db) {</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"index_db is not available"</span>)<span class="op">;</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> []<span class="op">;</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> gender <span class="op">=</span> <span class="st">"total"</span><span class="op">;</span> <span class="co">//</span><span class="al">NOTE</span><span class="co">: Keeping this as an option in case future updates want gender specific index</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// sensitivity data</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> sensitivityData <span class="op">=</span> <span class="cf">await</span> index_db<span class="op">.</span><span class="fu">query</span>(<span class="vs">`</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a><span class="vs">SELECT *</span></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a><span class="vs">FROM urgency</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a><span class="vs">WHERE admin0_name != 'SSA'</span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a><span class="vs">AND gender = '</span><span class="sc">${</span>gender<span class="sc">}</span><span class="vs">'</span></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a><span class="sc">${</span><span class="fu">whereAdminNull</span>(compositeAdmin0<span class="op">.</span><span class="at">value</span><span class="op">,</span> compositeAdmin1<span class="op">.</span><span class="at">value</span>)<span class="sc">}</span></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check if exposure_index exists and is an array before using</span></span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> exposureMap <span class="op">=</span> (exposure_index <span class="op">&amp;&amp;</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">isArray</span>(exposure_index))</span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>      <span class="op">?</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">fromEntries</span>(</span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>          exposure_index<span class="op">.</span><span class="fu">map</span>((d) <span class="kw">=&gt;</span> {</span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>            <span class="kw">const</span> a0 <span class="op">=</span> d<span class="op">.</span><span class="at">admin0_name</span><span class="op">;</span></span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>            <span class="kw">const</span> a1 <span class="op">=</span> d<span class="op">.</span><span class="at">admin1_name</span><span class="op">;</span></span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>            <span class="kw">const</span> key <span class="op">=</span> a1 <span class="op">?</span> <span class="vs">`</span><span class="sc">${</span>a0<span class="sc">}</span><span class="vs">||</span><span class="sc">${</span>a1<span class="sc">}</span><span class="vs">`</span> <span class="op">:</span> a0<span class="op">;</span> <span class="co">// use both if admin1 exists, else just admin0</span></span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [key<span class="op">,</span> d<span class="op">.</span><span class="at">exposure_norm</span>]<span class="op">;</span></span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a>          })</span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true" tabindex="-1"></a>      <span class="op">:</span> {}<span class="op">;</span></span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// merge into urgencyData</span></span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> merged <span class="op">=</span> sensitivityData<span class="op">.</span><span class="fu">map</span>((d) <span class="kw">=&gt;</span> {</span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> a0 <span class="op">=</span> d<span class="op">.</span><span class="at">admin0_name</span><span class="op">;</span></span>
<span id="cb68-34"><a href="#cb68-34" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> a1 <span class="op">=</span> d<span class="op">.</span><span class="at">admin1_name</span><span class="op">;</span></span>
<span id="cb68-35"><a href="#cb68-35" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> key <span class="op">=</span> a1 <span class="op">?</span> <span class="vs">`</span><span class="sc">${</span>a0<span class="sc">}</span><span class="vs">||</span><span class="sc">${</span>a1<span class="sc">}</span><span class="vs">`</span> <span class="op">:</span> a0<span class="op">;</span></span>
<span id="cb68-36"><a href="#cb68-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-37"><a href="#cb68-37" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> {</span>
<span id="cb68-38"><a href="#cb68-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span>d<span class="op">,</span></span>
<span id="cb68-39"><a href="#cb68-39" aria-hidden="true" tabindex="-1"></a>        <span class="dt">exposure_norm</span><span class="op">:</span> exposureMap[key] <span class="op">??</span> <span class="kw">null</span></span>
<span id="cb68-40"><a href="#cb68-40" aria-hidden="true" tabindex="-1"></a>      }<span class="op">;</span></span>
<span id="cb68-41"><a href="#cb68-41" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb68-42"><a href="#cb68-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-43"><a href="#cb68-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> merged<span class="op">.</span><span class="fu">map</span>((row) <span class="kw">=&gt;</span> ({</span>
<span id="cb68-44"><a href="#cb68-44" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>row<span class="op">,</span></span>
<span id="cb68-45"><a href="#cb68-45" aria-hidden="true" tabindex="-1"></a>      <span class="dt">urgency_index</span><span class="op">:</span> <span class="fu">computeIndex</span>(row)</span>
<span id="cb68-46"><a href="#cb68-46" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb68-47"><a href="#cb68-47" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb68-48"><a href="#cb68-48" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Failed to calculate urgency index:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb68-49"><a href="#cb68-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> []<span class="op">;</span></span>
<span id="cb68-50"><a href="#cb68-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb68-51"><a href="#cb68-51" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-68" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb69" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb69--1"><a href="#cb69--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate vulnerability index (AKA composite index with ND-gain Methodology)</span></span>
<span id="cb69-0"><a href="#cb69-0" aria-hidden="true" tabindex="-1"></a>vulnerabilityIndex <span class="op">=</span> {</span>
<span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> key <span class="op">=</span> (r) <span class="kw">=&gt;</span> <span class="vs">`</span><span class="sc">${</span>r<span class="op">.</span><span class="at">admin0_name</span><span class="sc">}</span><span class="vs">|</span><span class="sc">${</span>r<span class="op">.</span><span class="at">admin1_name</span><span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> toMap <span class="op">=</span> (arr<span class="op">,</span> k<span class="op">,</span> v) <span class="kw">=&gt;</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">fromEntries</span>(arr<span class="op">.</span><span class="fu">map</span>((r) <span class="kw">=&gt;</span> [<span class="fu">k</span>(r)<span class="op">,</span> <span class="fu">v</span>(r)]))<span class="op">;</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> uMap <span class="op">=</span> <span class="fu">toMap</span>(urgency_index<span class="op">,</span> key<span class="op">,</span> (r) <span class="kw">=&gt;</span> r<span class="op">.</span><span class="at">urgency_index</span>)<span class="op">;</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> enMap <span class="op">=</span> <span class="fu">toMap</span>(enabling_index<span class="op">,</span> key<span class="op">,</span> (r) <span class="kw">=&gt;</span> r<span class="op">.</span><span class="at">enabling_index</span>)<span class="op">;</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> allKeys <span class="op">=</span> <span class="kw">new</span> <span class="bu">Set</span>([<span class="op">...</span><span class="bu">Object</span><span class="op">.</span><span class="fu">keys</span>(enMap)<span class="op">,</span> <span class="op">...</span><span class="bu">Object</span><span class="op">.</span><span class="fu">keys</span>(uMap)])<span class="op">;</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> merged <span class="op">=</span> [<span class="op">...</span>allKeys]<span class="op">.</span><span class="fu">map</span>((k) <span class="kw">=&gt;</span> {</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> [admin0_name<span class="op">,</span> admin1_name] <span class="op">=</span> k<span class="op">.</span><span class="fu">split</span>(<span class="st">"|"</span>)<span class="op">;</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> en <span class="op">=</span> enMap[k]<span class="op">,</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>      u <span class="op">=</span> uMap[k]<span class="op">;</span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>      admin0_name<span class="op">,</span></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>      admin1_name<span class="op">,</span></span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">enabling_index</span><span class="op">:</span> en <span class="op">??</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">urgency_index</span><span class="op">:</span> u <span class="op">??</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">vulnerability</span><span class="op">:</span></span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">typeof</span> en <span class="op">===</span> <span class="st">"number"</span> <span class="op">&amp;&amp;</span> <span class="kw">typeof</span> u <span class="op">===</span> <span class="st">"number"</span></span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>          <span class="op">?</span> <span class="dv">100</span> <span class="op">-</span> (en <span class="op">-</span> u <span class="op">+</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">50</span></span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>          <span class="op">:</span> <span class="kw">null</span></span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> merged<span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">vulnerability</span> <span class="op">!==</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-69" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb70" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb70--1"><a href="#cb70--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Updated vulnerability index calculation using the Observable approach</span></span>
<span id="cb70-0"><a href="#cb70-0" aria-hidden="true" tabindex="-1"></a>componentIndicesPerRegion <span class="op">=</span> {</span>
<span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check if vulnerabilityIndex exists and is valid before processing</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>vulnerabilityIndex <span class="op">||</span> <span class="op">!</span><span class="bu">Array</span><span class="op">.</span><span class="fu">isArray</span>(vulnerabilityIndex) <span class="op">||</span> vulnerabilityIndex<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> { <span class="dt">scores</span><span class="op">:</span> {}<span class="op">,</span> <span class="dt">adminLevel</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span> <span class="dt">regions</span><span class="op">:</span> [] }<span class="op">;</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> selections <span class="op">=</span> compositeAdminSelections<span class="op">;</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> isNull <span class="op">=</span> (val) <span class="kw">=&gt;</span> val <span class="op">===</span> <span class="kw">null</span> <span class="op">||</span> val <span class="op">===</span> <span class="kw">undefined</span> <span class="op">||</span> val <span class="op">===</span> <span class="st">""</span> <span class="op">||</span> val <span class="op">===</span> <span class="st">"</span><span class="sc">\\</span><span class="st">N"</span><span class="op">;</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Determine admin level and get unique regions</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> adminLevel<span class="op">,</span> regions<span class="op">;</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>selections<span class="op">.</span><span class="at">selectAdmin0</span> <span class="op">||</span> selections<span class="op">.</span><span class="at">selectAdmin0</span> <span class="op">===</span> <span class="st">"SSA"</span>) {</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Show all countries (admin0 level)</span></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>    adminLevel <span class="op">=</span> <span class="st">"admin0_name"</span><span class="op">;</span></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>    regions <span class="op">=</span> [<span class="op">...</span><span class="kw">new</span> <span class="bu">Set</span>(vulnerabilityIndex<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin0_name</span>)<span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> d))]<span class="op">;</span></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="op">!</span>selections<span class="op">.</span><span class="at">selectAdmin1</span>) {</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Show admin1 within selected country</span></span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>    adminLevel <span class="op">=</span> <span class="st">"admin1_name"</span><span class="op">;</span></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>    regions <span class="op">=</span> [<span class="op">...</span><span class="kw">new</span> <span class="bu">Set</span>(vulnerabilityIndex</span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin0_name</span> <span class="op">===</span> selections<span class="op">.</span><span class="at">selectAdmin0</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="fu">isNull</span>(d<span class="op">.</span><span class="at">admin1_name</span>))</span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin1_name</span>))]<span class="op">;</span></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="op">!</span>selections<span class="op">.</span><span class="at">selectAdmin2</span>) {</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Show admin2 within selected admin1</span></span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>    adminLevel <span class="op">=</span> <span class="st">"admin2_name"</span><span class="op">;</span></span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a>    regions <span class="op">=</span> [<span class="op">...</span><span class="kw">new</span> <span class="bu">Set</span>(vulnerabilityIndex</span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin0_name</span> <span class="op">===</span> selections<span class="op">.</span><span class="at">selectAdmin0</span> <span class="op">&amp;&amp;</span> </span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>                   d<span class="op">.</span><span class="at">admin1_name</span> <span class="op">===</span> selections<span class="op">.</span><span class="at">selectAdmin1</span> <span class="op">&amp;&amp;</span> </span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a>                   <span class="op">!</span><span class="fu">isNull</span>(d<span class="op">.</span><span class="at">admin2_name</span>))</span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">admin2_name</span>))]<span class="op">;</span></span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Single admin2 selected</span></span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a>    adminLevel <span class="op">=</span> <span class="st">"admin2_name"</span><span class="op">;</span></span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a>    regions <span class="op">=</span> [selections<span class="op">.</span><span class="at">selectAdmin2</span>]<span class="op">;</span></span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Calculate scores for each region using the new vulnerability index</span></span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> regionScores <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-38"><a href="#cb70-38" aria-hidden="true" tabindex="-1"></a>  regions<span class="op">.</span><span class="fu">forEach</span>(region <span class="kw">=&gt;</span> {</span>
<span id="cb70-39"><a href="#cb70-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Find vulnerability data for this region</span></span>
<span id="cb70-40"><a href="#cb70-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> vulnData <span class="op">=</span> vulnerabilityIndex<span class="op">.</span><span class="fu">find</span>(d <span class="kw">=&gt;</span> d[adminLevel] <span class="op">===</span> region)<span class="op">;</span></span>
<span id="cb70-41"><a href="#cb70-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-42"><a href="#cb70-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (vulnData) {</span>
<span id="cb70-43"><a href="#cb70-43" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Convert vulnerability score (0-100) to 0-1 scale for consistency</span></span>
<span id="cb70-44"><a href="#cb70-44" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> compositeScore <span class="op">=</span> vulnData<span class="op">.</span><span class="at">vulnerability</span> <span class="op">?</span> vulnData<span class="op">.</span><span class="at">vulnerability</span> <span class="op">/</span> <span class="dv">100</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb70-45"><a href="#cb70-45" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> enablingScore <span class="op">=</span> vulnData<span class="op">.</span><span class="at">enabling_index</span> <span class="op">||</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb70-46"><a href="#cb70-46" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> urgencyScore <span class="op">=</span> vulnData<span class="op">.</span><span class="at">urgency_index</span> <span class="op">||</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb70-47"><a href="#cb70-47" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb70-48"><a href="#cb70-48" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Urgency index represents sensitivity (population density, education, poverty)</span></span>
<span id="cb70-49"><a href="#cb70-49" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Exposure is separate and comes from exposure data</span></span>
<span id="cb70-50"><a href="#cb70-50" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> sensitivityScore <span class="op">=</span> urgencyScore<span class="op">;</span> <span class="co">// Urgency index IS sensitivity</span></span>
<span id="cb70-51"><a href="#cb70-51" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb70-52"><a href="#cb70-52" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Get exposure score from exposure data (with null check)</span></span>
<span id="cb70-53"><a href="#cb70-53" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> exposureData <span class="op">=</span> (exposure_index <span class="op">&amp;&amp;</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">isArray</span>(exposure_index))</span>
<span id="cb70-54"><a href="#cb70-54" aria-hidden="true" tabindex="-1"></a>        <span class="op">?</span> exposure_index<span class="op">.</span><span class="fu">find</span>(d <span class="kw">=&gt;</span> d[adminLevel] <span class="op">===</span> region)</span>
<span id="cb70-55"><a href="#cb70-55" aria-hidden="true" tabindex="-1"></a>        <span class="op">:</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb70-56"><a href="#cb70-56" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> exposureScore <span class="op">=</span> exposureData <span class="op">?</span> exposureData<span class="op">.</span><span class="at">exposure_norm</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb70-57"><a href="#cb70-57" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb70-58"><a href="#cb70-58" aria-hidden="true" tabindex="-1"></a>      <span class="co">// FIXED: Adaptive capacity should be HIGH when enabling is HIGH (not inverted)</span></span>
<span id="cb70-59"><a href="#cb70-59" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Countries with high enabling factors have HIGH adaptive capacity (good thing)</span></span>
<span id="cb70-60"><a href="#cb70-60" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> adaptiveScore <span class="op">=</span> enablingScore<span class="op">;</span> <span class="co">// High enabling = high adaptive capacity</span></span>
<span id="cb70-61"><a href="#cb70-61" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb70-62"><a href="#cb70-62" aria-hidden="true" tabindex="-1"></a>      regionScores[region] <span class="op">=</span> {</span>
<span id="cb70-63"><a href="#cb70-63" aria-hidden="true" tabindex="-1"></a>        <span class="dt">exposure</span><span class="op">:</span> exposureScore<span class="op">,</span></span>
<span id="cb70-64"><a href="#cb70-64" aria-hidden="true" tabindex="-1"></a>        <span class="dt">sensitivity</span><span class="op">:</span> sensitivityScore<span class="op">,</span></span>
<span id="cb70-65"><a href="#cb70-65" aria-hidden="true" tabindex="-1"></a>        <span class="dt">adaptive_capacity</span><span class="op">:</span> adaptiveScore<span class="op">,</span></span>
<span id="cb70-66"><a href="#cb70-66" aria-hidden="true" tabindex="-1"></a>        <span class="dt">composite</span><span class="op">:</span> compositeScore<span class="op">,</span></span>
<span id="cb70-67"><a href="#cb70-67" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Include raw values for reference</span></span>
<span id="cb70-68"><a href="#cb70-68" aria-hidden="true" tabindex="-1"></a>        <span class="dt">enabling_index</span><span class="op">:</span> enablingScore<span class="op">,</span></span>
<span id="cb70-69"><a href="#cb70-69" aria-hidden="true" tabindex="-1"></a>        <span class="dt">urgency_index</span><span class="op">:</span> urgencyScore<span class="op">,</span></span>
<span id="cb70-70"><a href="#cb70-70" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vulnerability_score</span><span class="op">:</span> vulnData<span class="op">.</span><span class="at">vulnerability</span></span>
<span id="cb70-71"><a href="#cb70-71" aria-hidden="true" tabindex="-1"></a>      }<span class="op">;</span></span>
<span id="cb70-72"><a href="#cb70-72" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb70-73"><a href="#cb70-73" aria-hidden="true" tabindex="-1"></a>      <span class="co">// No data available for this region</span></span>
<span id="cb70-74"><a href="#cb70-74" aria-hidden="true" tabindex="-1"></a>      regionScores[region] <span class="op">=</span> { <span class="co">// All null as a default of 0 could be interpreted as a score rather than missing</span></span>
<span id="cb70-75"><a href="#cb70-75" aria-hidden="true" tabindex="-1"></a>        <span class="dt">exposure</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb70-76"><a href="#cb70-76" aria-hidden="true" tabindex="-1"></a>        <span class="dt">sensitivity</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb70-77"><a href="#cb70-77" aria-hidden="true" tabindex="-1"></a>        <span class="dt">adaptive_capacity</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb70-78"><a href="#cb70-78" aria-hidden="true" tabindex="-1"></a>        <span class="dt">composite</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb70-79"><a href="#cb70-79" aria-hidden="true" tabindex="-1"></a>        <span class="dt">enabling_index</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb70-80"><a href="#cb70-80" aria-hidden="true" tabindex="-1"></a>        <span class="dt">urgency_index</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb70-81"><a href="#cb70-81" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vulnerability_score</span><span class="op">:</span> <span class="kw">null</span></span>
<span id="cb70-82"><a href="#cb70-82" aria-hidden="true" tabindex="-1"></a>      }<span class="op">;</span></span>
<span id="cb70-83"><a href="#cb70-83" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-84"><a href="#cb70-84" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb70-85"><a href="#cb70-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-86"><a href="#cb70-86" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> { </span>
<span id="cb70-87"><a href="#cb70-87" aria-hidden="true" tabindex="-1"></a>    <span class="dt">scores</span><span class="op">:</span> regionScores<span class="op">,</span> </span>
<span id="cb70-88"><a href="#cb70-88" aria-hidden="true" tabindex="-1"></a>    <span class="dt">adminLevel</span><span class="op">:</span> adminLevel<span class="op">,</span></span>
<span id="cb70-89"><a href="#cb70-89" aria-hidden="true" tabindex="-1"></a>    <span class="dt">regions</span><span class="op">:</span> regions</span>
<span id="cb70-90"><a href="#cb70-90" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb70-91"><a href="#cb70-91" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-70" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb71" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb71--1"><a href="#cb71--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Small Multiples/Faceted Maps Visualization with proper loading/no-data states</span></span>
<span id="cb71-0"><a href="#cb71-0" aria-hidden="true" tabindex="-1"></a>compositeVulnerabilityMaps <span class="op">=</span> {</span>
<span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Show loading spinner only if data is still loading (null/undefined)</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ([exposure_index<span class="op">,</span> enabling_index<span class="op">,</span> urgency_index<span class="op">,</span> sensitivityMetadata]<span class="op">.</span><span class="fu">some</span>((d) <span class="kw">=&gt;</span> d <span class="op">===</span> <span class="kw">null</span> <span class="op">||</span> d <span class="op">===</span> <span class="kw">undefined</span>)) {</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">createLoadingState</span>(</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Loading composite vulnerability data..."</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Chargement des donn√©es de vuln√©rabilit√© composite..."</span>})</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// // If data is loaded but empty or processing failed, show no data state</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>    [exposure_index<span class="op">,</span> enabling_index<span class="op">,</span> urgency_index<span class="op">,</span> sensitivityMetadata<span class="op">,</span> componentIndicesPerRegion]</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">some</span>((d) <span class="kw">=&gt;</span> <span class="op">!</span>d) <span class="op">||</span> <span class="op">!</span>componentIndicesPerRegion<span class="op">?.</span><span class="at">scores</span></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>  ) {</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">createNoDataState</span>(<span class="fu">_lang</span>(vulnerability_translations<span class="op">.</span><span class="at">no_data_available</span>))<span class="op">;</span></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { scores<span class="op">,</span> adminLevel } <span class="op">=</span> componentIndicesPerRegion<span class="op">;</span></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> selections <span class="op">=</span> compositeAdminSelections<span class="op">;</span></span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Get the appropriate boundary level</span></span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> boundaries<span class="op">;</span></span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (adminLevel <span class="op">===</span> <span class="st">"admin0_name"</span>) {</span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a>    boundaries <span class="op">=</span> compositeMapBoundaries<span class="op">.</span><span class="at">admin0</span><span class="op">;</span></span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (adminLevel <span class="op">===</span> <span class="st">"admin1_name"</span>) {</span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a>    boundaries <span class="op">=</span> {</span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>compositeMapBoundaries<span class="op">.</span><span class="at">admin1</span><span class="op">,</span></span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a>      <span class="dt">features</span><span class="op">:</span> compositeMapBoundaries<span class="op">.</span><span class="at">admin1</span><span class="op">.</span><span class="at">features</span><span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a>        d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">admin0_name</span> <span class="op">===</span> selections<span class="op">.</span><span class="at">selectAdmin0</span></span>
<span id="cb71-28"><a href="#cb71-28" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb71-29"><a href="#cb71-29" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb71-30"><a href="#cb71-30" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb71-31"><a href="#cb71-31" aria-hidden="true" tabindex="-1"></a>    boundaries <span class="op">=</span> {</span>
<span id="cb71-32"><a href="#cb71-32" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>compositeMapBoundaries<span class="op">.</span><span class="at">admin2</span><span class="op">,</span></span>
<span id="cb71-33"><a href="#cb71-33" aria-hidden="true" tabindex="-1"></a>      <span class="dt">features</span><span class="op">:</span> compositeMapBoundaries<span class="op">.</span><span class="at">admin2</span><span class="op">.</span><span class="at">features</span><span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb71-34"><a href="#cb71-34" aria-hidden="true" tabindex="-1"></a>        d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">admin0_name</span> <span class="op">===</span> selections<span class="op">.</span><span class="at">selectAdmin0</span> <span class="op">&amp;&amp;</span> </span>
<span id="cb71-35"><a href="#cb71-35" aria-hidden="true" tabindex="-1"></a>            d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">admin1_name</span> <span class="op">===</span> selections<span class="op">.</span><span class="at">selectAdmin1</span></span>
<span id="cb71-36"><a href="#cb71-36" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb71-37"><a href="#cb71-37" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb71-38"><a href="#cb71-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb71-39"><a href="#cb71-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-40"><a href="#cb71-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Define the components to show based on selection</span></span>
<span id="cb71-41"><a href="#cb71-41" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> showAllComponents <span class="op">=</span> compositeSelectedComponent<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="st">"composite"</span><span class="op">;</span></span>
<span id="cb71-42"><a href="#cb71-42" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> components <span class="op">=</span> showAllComponents <span class="op">?</span> [</span>
<span id="cb71-43"><a href="#cb71-43" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">key</span><span class="op">:</span> <span class="st">"composite"</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Composite"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Composite"</span>})<span class="op">,</span> <span class="dt">scheme</span><span class="op">:</span> <span class="st">"Reds"</span><span class="op">,</span> <span class="dt">isComposite</span><span class="op">:</span> <span class="kw">true</span> }<span class="op">,</span></span>
<span id="cb71-44"><a href="#cb71-44" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">key</span><span class="op">:</span> <span class="st">"exposure"</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Exposure"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Exposition"</span>})<span class="op">,</span> <span class="dt">scheme</span><span class="op">:</span> <span class="st">"Oranges"</span><span class="op">,</span> <span class="dt">isComposite</span><span class="op">:</span> <span class="kw">false</span> }<span class="op">,</span></span>
<span id="cb71-45"><a href="#cb71-45" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">key</span><span class="op">:</span> <span class="st">"sensitivity"</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Sensitivity"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Sensibilit√©"</span>})<span class="op">,</span> <span class="dt">scheme</span><span class="op">:</span> <span class="st">"Purples"</span><span class="op">,</span> <span class="dt">isComposite</span><span class="op">:</span> <span class="kw">false</span> }<span class="op">,</span></span>
<span id="cb71-46"><a href="#cb71-46" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">key</span><span class="op">:</span> <span class="st">"adaptive_capacity"</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Adaptive Capacity"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Capacit√© d'Adaptation"</span>})<span class="op">,</span> <span class="dt">scheme</span><span class="op">:</span> <span class="st">"Greens"</span><span class="op">,</span> <span class="dt">isComposite</span><span class="op">:</span> <span class="kw">false</span> }</span>
<span id="cb71-47"><a href="#cb71-47" aria-hidden="true" tabindex="-1"></a>  ] <span class="op">:</span> [{</span>
<span id="cb71-48"><a href="#cb71-48" aria-hidden="true" tabindex="-1"></a>    <span class="dt">key</span><span class="op">:</span> compositeSelectedComponent<span class="op">.</span><span class="at">value</span><span class="op">,</span></span>
<span id="cb71-49"><a href="#cb71-49" aria-hidden="true" tabindex="-1"></a>    <span class="dt">label</span><span class="op">:</span> compositeSelectedComponent<span class="op">.</span><span class="at">label</span><span class="op">,</span></span>
<span id="cb71-50"><a href="#cb71-50" aria-hidden="true" tabindex="-1"></a>    <span class="dt">scheme</span><span class="op">:</span> <span class="st">"Reds"</span><span class="op">,</span></span>
<span id="cb71-51"><a href="#cb71-51" aria-hidden="true" tabindex="-1"></a>    <span class="dt">isComposite</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb71-52"><a href="#cb71-52" aria-hidden="true" tabindex="-1"></a>  }]<span class="op">;</span></span>
<span id="cb71-53"><a href="#cb71-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-54"><a href="#cb71-54" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Calculate subplot dimensions - use full width</span></span>
<span id="cb71-55"><a href="#cb71-55" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> totalWidth <span class="op">=</span> <span class="dv">1000</span><span class="op">;</span> <span class="co">// Increased width for better coverage</span></span>
<span id="cb71-56"><a href="#cb71-56" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> totalHeight <span class="op">=</span> showAllComponents <span class="op">?</span> <span class="dv">600</span> <span class="op">:</span> <span class="dv">300</span><span class="op">;</span></span>
<span id="cb71-57"><a href="#cb71-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-58"><a href="#cb71-58" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create individual maps for each component</span></span>
<span id="cb71-59"><a href="#cb71-59" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> maps <span class="op">=</span> components<span class="op">.</span><span class="fu">map</span>((component<span class="op">,</span> index) <span class="kw">=&gt;</span> {</span>
<span id="cb71-60"><a href="#cb71-60" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create features for this component</span></span>
<span id="cb71-61"><a href="#cb71-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> componentFeatures <span class="op">=</span> boundaries<span class="op">.</span><span class="at">features</span><span class="op">.</span><span class="fu">map</span>(feature <span class="kw">=&gt;</span> {</span>
<span id="cb71-62"><a href="#cb71-62" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Get the correct region name based on admin level</span></span>
<span id="cb71-63"><a href="#cb71-63" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> regionName<span class="op">;</span></span>
<span id="cb71-64"><a href="#cb71-64" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (adminLevel <span class="op">===</span> <span class="st">"admin0_name"</span>) {</span>
<span id="cb71-65"><a href="#cb71-65" aria-hidden="true" tabindex="-1"></a>        regionName <span class="op">=</span> feature<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">admin0_name</span><span class="op">;</span></span>
<span id="cb71-66"><a href="#cb71-66" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (adminLevel <span class="op">===</span> <span class="st">"admin1_name"</span>) {</span>
<span id="cb71-67"><a href="#cb71-67" aria-hidden="true" tabindex="-1"></a>        regionName <span class="op">=</span> feature<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">admin1_name</span><span class="op">;</span></span>
<span id="cb71-68"><a href="#cb71-68" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (adminLevel <span class="op">===</span> <span class="st">"admin2_name"</span>) {</span>
<span id="cb71-69"><a href="#cb71-69" aria-hidden="true" tabindex="-1"></a>        regionName <span class="op">=</span> feature<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">admin2_name</span><span class="op">;</span></span>
<span id="cb71-70"><a href="#cb71-70" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb71-71"><a href="#cb71-71" aria-hidden="true" tabindex="-1"></a>        regionName <span class="op">=</span> feature<span class="op">.</span><span class="at">properties</span>[adminLevel]<span class="op">;</span></span>
<span id="cb71-72"><a href="#cb71-72" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb71-73"><a href="#cb71-73" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb71-74"><a href="#cb71-74" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> regionScores <span class="op">=</span> scores[regionName] <span class="op">||</span> { </span>
<span id="cb71-75"><a href="#cb71-75" aria-hidden="true" tabindex="-1"></a>        <span class="dt">exposure</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">sensitivity</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">adaptive_capacity</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">composite</span><span class="op">:</span> <span class="dv">0</span> </span>
<span id="cb71-76"><a href="#cb71-76" aria-hidden="true" tabindex="-1"></a>      }<span class="op">;</span></span>
<span id="cb71-77"><a href="#cb71-77" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb71-78"><a href="#cb71-78" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> {</span>
<span id="cb71-79"><a href="#cb71-79" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span>feature<span class="op">,</span></span>
<span id="cb71-80"><a href="#cb71-80" aria-hidden="true" tabindex="-1"></a>        <span class="dt">properties</span><span class="op">:</span> {</span>
<span id="cb71-81"><a href="#cb71-81" aria-hidden="true" tabindex="-1"></a>          <span class="op">...</span>feature<span class="op">.</span><span class="at">properties</span><span class="op">,</span></span>
<span id="cb71-82"><a href="#cb71-82" aria-hidden="true" tabindex="-1"></a>          <span class="dt">vulnerability</span><span class="op">:</span> regionScores[component<span class="op">.</span><span class="at">key</span>] <span class="op">||</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb71-83"><a href="#cb71-83" aria-hidden="true" tabindex="-1"></a>          <span class="dt">regionName</span><span class="op">:</span> regionName<span class="op">,</span></span>
<span id="cb71-84"><a href="#cb71-84" aria-hidden="true" tabindex="-1"></a>          <span class="co">// Add individual scores as properties for easier tooltip access</span></span>
<span id="cb71-85"><a href="#cb71-85" aria-hidden="true" tabindex="-1"></a>          <span class="dt">exposureScore</span><span class="op">:</span> regionScores<span class="op">.</span><span class="at">exposure</span> <span class="op">||</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb71-86"><a href="#cb71-86" aria-hidden="true" tabindex="-1"></a>          <span class="dt">sensitivityScore</span><span class="op">:</span> regionScores<span class="op">.</span><span class="at">sensitivity</span> <span class="op">||</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb71-87"><a href="#cb71-87" aria-hidden="true" tabindex="-1"></a>          <span class="dt">adaptiveCapacityScore</span><span class="op">:</span> regionScores<span class="op">.</span><span class="at">adaptive_capacity</span> <span class="op">||</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb71-88"><a href="#cb71-88" aria-hidden="true" tabindex="-1"></a>          <span class="dt">compositeScore</span><span class="op">:</span> regionScores<span class="op">.</span><span class="at">composite</span> <span class="op">||</span> <span class="dv">0</span></span>
<span id="cb71-89"><a href="#cb71-89" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb71-90"><a href="#cb71-90" aria-hidden="true" tabindex="-1"></a>      }<span class="op">;</span></span>
<span id="cb71-91"><a href="#cb71-91" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb71-92"><a href="#cb71-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-93"><a href="#cb71-93" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Calculate dynamic domain for this component's data</span></span>
<span id="cb71-94"><a href="#cb71-94" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> validValues <span class="op">=</span> componentFeatures</span>
<span id="cb71-95"><a href="#cb71-95" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">vulnerability</span>)</span>
<span id="cb71-96"><a href="#cb71-96" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(v <span class="kw">=&gt;</span> v <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> v <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="pp">isNaN</span>(v))<span class="op">;</span></span>
<span id="cb71-97"><a href="#cb71-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-98"><a href="#cb71-98" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> minValue <span class="op">=</span> validValues<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(<span class="op">...</span>validValues) <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb71-99"><a href="#cb71-99" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> maxValue <span class="op">=</span> validValues<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(<span class="op">...</span>validValues) <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb71-100"><a href="#cb71-100" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-101"><a href="#cb71-101" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Ensure we have a valid range</span></span>
<span id="cb71-102"><a href="#cb71-102" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> domainMin <span class="op">=</span> minValue<span class="op">;</span></span>
<span id="cb71-103"><a href="#cb71-103" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> domainMax <span class="op">=</span> maxValue <span class="op">&gt;</span> minValue <span class="op">?</span> maxValue <span class="op">:</span> minValue <span class="op">+</span> <span class="fl">0.1</span><span class="op">;</span></span>
<span id="cb71-104"><a href="#cb71-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-105"><a href="#cb71-105" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Calculate map dimensions based on component type</span></span>
<span id="cb71-106"><a href="#cb71-106" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> mapWidth <span class="op">=</span> component<span class="op">.</span><span class="at">isComposite</span> <span class="op">?</span> <span class="dv">1000</span> <span class="op">:</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>(<span class="dv">1000</span> <span class="op">/</span> <span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb71-107"><a href="#cb71-107" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> mapHeight <span class="op">=</span> component<span class="op">.</span><span class="at">isComposite</span> <span class="op">?</span> <span class="dv">300</span> <span class="op">:</span> <span class="dv">250</span><span class="op">;</span></span>
<span id="cb71-108"><a href="#cb71-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-109"><a href="#cb71-109" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Color scheme based on component</span></span>
<span id="cb71-110"><a href="#cb71-110" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> colorRange<span class="op">;</span></span>
<span id="cb71-111"><a href="#cb71-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (component<span class="op">.</span><span class="at">key</span> <span class="op">===</span> <span class="st">"adaptive_capacity"</span>) {</span>
<span id="cb71-112"><a href="#cb71-112" aria-hidden="true" tabindex="-1"></a>      colorRange <span class="op">=</span> [<span class="st">"#F7D732"</span><span class="op">,</span> <span class="st">"#216729"</span>]<span class="op">;</span> <span class="co">// Red (low/bad) to Green (high/good) - high adaptive capacity is good</span></span>
<span id="cb71-113"><a href="#cb71-113" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb71-114"><a href="#cb71-114" aria-hidden="true" tabindex="-1"></a>      colorRange <span class="op">=</span> [<span class="st">"#F4BB21"</span><span class="op">,</span> <span class="st">"#EC5A47"</span>]<span class="op">;</span> <span class="co">// Yellow (low) to Red (high) for other components</span></span>
<span id="cb71-115"><a href="#cb71-115" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb71-116"><a href="#cb71-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-117"><a href="#cb71-117" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb71-118"><a href="#cb71-118" aria-hidden="true" tabindex="-1"></a>      <span class="dt">width</span><span class="op">:</span> mapWidth<span class="op">,</span></span>
<span id="cb71-119"><a href="#cb71-119" aria-hidden="true" tabindex="-1"></a>      <span class="dt">height</span><span class="op">:</span> mapHeight<span class="op">,</span></span>
<span id="cb71-120"><a href="#cb71-120" aria-hidden="true" tabindex="-1"></a>      <span class="dt">projection</span><span class="op">:</span> {</span>
<span id="cb71-121"><a href="#cb71-121" aria-hidden="true" tabindex="-1"></a>        <span class="dt">type</span><span class="op">:</span> <span class="st">"azimuthal-equal-area"</span><span class="op">,</span></span>
<span id="cb71-122"><a href="#cb71-122" aria-hidden="true" tabindex="-1"></a>        <span class="dt">domain</span><span class="op">:</span> { <span class="dt">type</span><span class="op">:</span> <span class="st">"FeatureCollection"</span><span class="op">,</span> <span class="dt">features</span><span class="op">:</span> componentFeatures }</span>
<span id="cb71-123"><a href="#cb71-123" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb71-124"><a href="#cb71-124" aria-hidden="true" tabindex="-1"></a>      <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb71-125"><a href="#cb71-125" aria-hidden="true" tabindex="-1"></a>        <span class="dt">type</span><span class="op">:</span> <span class="st">"linear"</span><span class="op">,</span></span>
<span id="cb71-126"><a href="#cb71-126" aria-hidden="true" tabindex="-1"></a>        <span class="dt">range</span><span class="op">:</span> colorRange<span class="op">,</span></span>
<span id="cb71-127"><a href="#cb71-127" aria-hidden="true" tabindex="-1"></a>        <span class="dt">domain</span><span class="op">:</span> [domainMin<span class="op">,</span> domainMax]<span class="op">,</span> <span class="co">// Dynamic domain based on actual data</span></span>
<span id="cb71-128"><a href="#cb71-128" aria-hidden="true" tabindex="-1"></a>        <span class="dt">legend</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> <span class="co">// Enable legends on all maps</span></span>
<span id="cb71-129"><a href="#cb71-129" aria-hidden="true" tabindex="-1"></a>        <span class="dt">label</span><span class="op">:</span> component<span class="op">.</span><span class="at">key</span> <span class="op">===</span> <span class="st">"adaptive_capacity"</span> <span class="op">?</span> </span>
<span id="cb71-130"><a href="#cb71-130" aria-hidden="true" tabindex="-1"></a>          <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Adaptive Capacity (Higher = Better)"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Capacit√© d'Adaptation"</span>}) <span class="op">:</span> </span>
<span id="cb71-131"><a href="#cb71-131" aria-hidden="true" tabindex="-1"></a>          component<span class="op">.</span><span class="at">key</span> <span class="op">===</span> <span class="st">"exposure"</span> <span class="op">?</span> </span>
<span id="cb71-132"><a href="#cb71-132" aria-hidden="true" tabindex="-1"></a>            <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Climate Exposure (Higher = Worse)"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Exposition Climatique"</span>}) <span class="op">:</span></span>
<span id="cb71-133"><a href="#cb71-133" aria-hidden="true" tabindex="-1"></a>          component<span class="op">.</span><span class="at">key</span> <span class="op">===</span> <span class="st">"sensitivity"</span> <span class="op">?</span> </span>
<span id="cb71-134"><a href="#cb71-134" aria-hidden="true" tabindex="-1"></a>            <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Population Sensitivity (Higher = Worse)"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Sensibilit√© de la Population"</span>}) <span class="op">:</span></span>
<span id="cb71-135"><a href="#cb71-135" aria-hidden="true" tabindex="-1"></a>            <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Composite Vulnerability (Higher = Worse)"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Vuln√©rabilit√© Composite"</span>})</span>
<span id="cb71-136"><a href="#cb71-136" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb71-137"><a href="#cb71-137" aria-hidden="true" tabindex="-1"></a>      <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb71-138"><a href="#cb71-138" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Geographic boundaries with vulnerability coloring - no tooltip here</span></span>
<span id="cb71-139"><a href="#cb71-139" aria-hidden="true" tabindex="-1"></a>        Plot<span class="op">.</span><span class="fu">geo</span>(componentFeatures<span class="op">,</span> {</span>
<span id="cb71-140"><a href="#cb71-140" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fill</span><span class="op">:</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">vulnerability</span><span class="op">,</span></span>
<span id="cb71-141"><a href="#cb71-141" aria-hidden="true" tabindex="-1"></a>          <span class="dt">stroke</span><span class="op">:</span> <span class="st">"#fff"</span><span class="op">,</span></span>
<span id="cb71-142"><a href="#cb71-142" aria-hidden="true" tabindex="-1"></a>          <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span></span>
<span id="cb71-143"><a href="#cb71-143" aria-hidden="true" tabindex="-1"></a>        })<span class="op">,</span></span>
<span id="cb71-144"><a href="#cb71-144" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb71-145"><a href="#cb71-145" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Interactive pointer</span></span>
<span id="cb71-146"><a href="#cb71-146" aria-hidden="true" tabindex="-1"></a>        Plot<span class="op">.</span><span class="fu">geo</span>(componentFeatures<span class="op">,</span> Plot<span class="op">.</span><span class="fu">pointer</span>(</span>
<span id="cb71-147"><a href="#cb71-147" aria-hidden="true" tabindex="-1"></a>          Plot<span class="op">.</span><span class="fu">centroid</span>({</span>
<span id="cb71-148"><a href="#cb71-148" aria-hidden="true" tabindex="-1"></a>            <span class="dt">stroke</span><span class="op">:</span> <span class="st">"#333"</span><span class="op">,</span></span>
<span id="cb71-149"><a href="#cb71-149" aria-hidden="true" tabindex="-1"></a>            <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">1.5</span><span class="op">,</span></span>
<span id="cb71-150"><a href="#cb71-150" aria-hidden="true" tabindex="-1"></a>          })</span>
<span id="cb71-151"><a href="#cb71-151" aria-hidden="true" tabindex="-1"></a>        ))<span class="op">,</span></span>
<span id="cb71-152"><a href="#cb71-152" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb71-153"><a href="#cb71-153" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Tooltip using the exact working pattern from exposure section</span></span>
<span id="cb71-154"><a href="#cb71-154" aria-hidden="true" tabindex="-1"></a>        Plot<span class="op">.</span><span class="fu">tip</span>(</span>
<span id="cb71-155"><a href="#cb71-155" aria-hidden="true" tabindex="-1"></a>          componentFeatures<span class="op">,</span></span>
<span id="cb71-156"><a href="#cb71-156" aria-hidden="true" tabindex="-1"></a>          Plot<span class="op">.</span><span class="fu">pointer</span>(</span>
<span id="cb71-157"><a href="#cb71-157" aria-hidden="true" tabindex="-1"></a>            Plot<span class="op">.</span><span class="fu">centroid</span>({</span>
<span id="cb71-158"><a href="#cb71-158" aria-hidden="true" tabindex="-1"></a>              <span class="dt">channels</span><span class="op">:</span> {</span>
<span id="cb71-159"><a href="#cb71-159" aria-hidden="true" tabindex="-1"></a>                <span class="dt">country</span><span class="op">:</span> {</span>
<span id="cb71-160"><a href="#cb71-160" aria-hidden="true" tabindex="-1"></a>                  <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Country"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Pays"</span>})<span class="op">,</span></span>
<span id="cb71-161"><a href="#cb71-161" aria-hidden="true" tabindex="-1"></a>                  <span class="dt">value</span><span class="op">:</span> (d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">admin0_name</span> <span class="op">||</span> <span class="st">"Unknown"</span></span>
<span id="cb71-162"><a href="#cb71-162" aria-hidden="true" tabindex="-1"></a>                }<span class="op">,</span></span>
<span id="cb71-163"><a href="#cb71-163" aria-hidden="true" tabindex="-1"></a>                <span class="dt">region</span><span class="op">:</span> {</span>
<span id="cb71-164"><a href="#cb71-164" aria-hidden="true" tabindex="-1"></a>                  <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Region"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"R√©gion"</span>})<span class="op">,</span></span>
<span id="cb71-165"><a href="#cb71-165" aria-hidden="true" tabindex="-1"></a>                  <span class="dt">value</span><span class="op">:</span> (d) <span class="kw">=&gt;</span> {</span>
<span id="cb71-166"><a href="#cb71-166" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> (d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">admin2_name</span>) {</span>
<span id="cb71-167"><a href="#cb71-167" aria-hidden="true" tabindex="-1"></a>                      <span class="cf">return</span> <span class="vs">`</span><span class="sc">${</span>d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">admin2_name</span><span class="sc">}</span><span class="vs">, </span><span class="sc">${</span>d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">admin1_name</span><span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb71-168"><a href="#cb71-168" aria-hidden="true" tabindex="-1"></a>                    } <span class="cf">else</span> <span class="cf">if</span> (d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">admin1_name</span>) {</span>
<span id="cb71-169"><a href="#cb71-169" aria-hidden="true" tabindex="-1"></a>                      <span class="cf">return</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">admin1_name</span><span class="op">;</span></span>
<span id="cb71-170"><a href="#cb71-170" aria-hidden="true" tabindex="-1"></a>                    } <span class="cf">else</span> {</span>
<span id="cb71-171"><a href="#cb71-171" aria-hidden="true" tabindex="-1"></a>                      <span class="cf">return</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">admin0_name</span><span class="op">;</span></span>
<span id="cb71-172"><a href="#cb71-172" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb71-173"><a href="#cb71-173" aria-hidden="true" tabindex="-1"></a>                  }</span>
<span id="cb71-174"><a href="#cb71-174" aria-hidden="true" tabindex="-1"></a>                }<span class="op">,</span></span>
<span id="cb71-175"><a href="#cb71-175" aria-hidden="true" tabindex="-1"></a>                <span class="dt">component</span><span class="op">:</span> {</span>
<span id="cb71-176"><a href="#cb71-176" aria-hidden="true" tabindex="-1"></a>                  <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Component"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Composant"</span>})<span class="op">,</span></span>
<span id="cb71-177"><a href="#cb71-177" aria-hidden="true" tabindex="-1"></a>                  <span class="dt">value</span><span class="op">:</span> component<span class="op">.</span><span class="at">label</span></span>
<span id="cb71-178"><a href="#cb71-178" aria-hidden="true" tabindex="-1"></a>                }<span class="op">,</span></span>
<span id="cb71-179"><a href="#cb71-179" aria-hidden="true" tabindex="-1"></a>                <span class="dt">score</span><span class="op">:</span> {</span>
<span id="cb71-180"><a href="#cb71-180" aria-hidden="true" tabindex="-1"></a>                  <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Score"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Score"</span>})<span class="op">,</span></span>
<span id="cb71-181"><a href="#cb71-181" aria-hidden="true" tabindex="-1"></a>                  <span class="dt">value</span><span class="op">:</span> (d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">vulnerability</span> <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">vulnerability</span> <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">?</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">vulnerability</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>) <span class="op">:</span> <span class="st">"No data"</span></span>
<span id="cb71-182"><a href="#cb71-182" aria-hidden="true" tabindex="-1"></a>                }<span class="op">,</span></span>
<span id="cb71-183"><a href="#cb71-183" aria-hidden="true" tabindex="-1"></a>                <span class="op">...</span>(component<span class="op">.</span><span class="at">key</span> <span class="op">===</span> <span class="st">"composite"</span> <span class="op">?</span> {</span>
<span id="cb71-184"><a href="#cb71-184" aria-hidden="true" tabindex="-1"></a>                  <span class="dt">exposure</span><span class="op">:</span> {</span>
<span id="cb71-185"><a href="#cb71-185" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Exposure"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Exposition"</span>})<span class="op">,</span></span>
<span id="cb71-186"><a href="#cb71-186" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">value</span><span class="op">:</span> (d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">exposureScore</span> <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">exposureScore</span> <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">?</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">exposureScore</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>) <span class="op">:</span> <span class="st">"No data"</span></span>
<span id="cb71-187"><a href="#cb71-187" aria-hidden="true" tabindex="-1"></a>                  }<span class="op">,</span></span>
<span id="cb71-188"><a href="#cb71-188" aria-hidden="true" tabindex="-1"></a>                  <span class="dt">sensitivity</span><span class="op">:</span> {</span>
<span id="cb71-189"><a href="#cb71-189" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Sensitivity"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Sensibilit√©"</span>})<span class="op">,</span></span>
<span id="cb71-190"><a href="#cb71-190" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">value</span><span class="op">:</span> (d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">sensitivityScore</span> <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">sensitivityScore</span> <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">?</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">sensitivityScore</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>) <span class="op">:</span> <span class="st">"No data"</span></span>
<span id="cb71-191"><a href="#cb71-191" aria-hidden="true" tabindex="-1"></a>                  }<span class="op">,</span></span>
<span id="cb71-192"><a href="#cb71-192" aria-hidden="true" tabindex="-1"></a>                  <span class="dt">adaptiveCapacity</span><span class="op">:</span> {</span>
<span id="cb71-193"><a href="#cb71-193" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">label</span><span class="op">:</span> <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Adaptive Capacity"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Capacit√© d'Adaptation"</span>})<span class="op">,</span></span>
<span id="cb71-194"><a href="#cb71-194" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">value</span><span class="op">:</span> (d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">adaptiveCapacityScore</span> <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">adaptiveCapacityScore</span> <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">?</span> d<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">adaptiveCapacityScore</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>) <span class="op">:</span> <span class="st">"No data"</span></span>
<span id="cb71-195"><a href="#cb71-195" aria-hidden="true" tabindex="-1"></a>                  }</span>
<span id="cb71-196"><a href="#cb71-196" aria-hidden="true" tabindex="-1"></a>                } <span class="op">:</span> {})</span>
<span id="cb71-197"><a href="#cb71-197" aria-hidden="true" tabindex="-1"></a>              }</span>
<span id="cb71-198"><a href="#cb71-198" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb71-199"><a href="#cb71-199" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb71-200"><a href="#cb71-200" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb71-201"><a href="#cb71-201" aria-hidden="true" tabindex="-1"></a>      ]</span>
<span id="cb71-202"><a href="#cb71-202" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb71-203"><a href="#cb71-203" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb71-204"><a href="#cb71-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-205"><a href="#cb71-205" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Individual legends are now integrated with each map</span></span>
<span id="cb71-206"><a href="#cb71-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-207"><a href="#cb71-207" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Separate composite and component maps</span></span>
<span id="cb71-208"><a href="#cb71-208" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> compositeMap <span class="op">=</span> showAllComponents <span class="op">?</span> maps[<span class="dv">0</span>] <span class="op">:</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb71-209"><a href="#cb71-209" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> componentMaps <span class="op">=</span> showAllComponents <span class="op">?</span> maps<span class="op">.</span><span class="fu">slice</span>(<span class="dv">1</span>) <span class="op">:</span> maps<span class="op">;</span></span>
<span id="cb71-210"><a href="#cb71-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-211"><a href="#cb71-211" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Return maps in a custom layout with labels and external legend</span></span>
<span id="cb71-212"><a href="#cb71-212" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">`</span></span>
<span id="cb71-213"><a href="#cb71-213" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div style="</span></span>
<span id="cb71-214"><a href="#cb71-214" aria-hidden="true" tabindex="-1"></a><span class="vs">      display: flex;</span></span>
<span id="cb71-215"><a href="#cb71-215" aria-hidden="true" tabindex="-1"></a><span class="vs">      flex-direction: column;</span></span>
<span id="cb71-216"><a href="#cb71-216" aria-hidden="true" tabindex="-1"></a><span class="vs">      align-items: center;</span></span>
<span id="cb71-217"><a href="#cb71-217" aria-hidden="true" tabindex="-1"></a><span class="vs">      gap: 20px;</span></span>
<span id="cb71-218"><a href="#cb71-218" aria-hidden="true" tabindex="-1"></a><span class="vs">      width: 100%;</span></span>
<span id="cb71-219"><a href="#cb71-219" aria-hidden="true" tabindex="-1"></a><span class="vs">      max-width: 100%;</span></span>
<span id="cb71-220"><a href="#cb71-220" aria-hidden="true" tabindex="-1"></a><span class="vs">      padding: 16px;</span></span>
<span id="cb71-221"><a href="#cb71-221" aria-hidden="true" tabindex="-1"></a><span class="vs">      background: white;</span></span>
<span id="cb71-222"><a href="#cb71-222" aria-hidden="true" tabindex="-1"></a><span class="vs">      border-radius: 8px;</span></span>
<span id="cb71-223"><a href="#cb71-223" aria-hidden="true" tabindex="-1"></a><span class="vs">    "&gt;</span></span>
<span id="cb71-224"><a href="#cb71-224" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;!-- Individual legends are now integrated with each map --&gt;</span></span>
<span id="cb71-225"><a href="#cb71-225" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span></span>
<span id="cb71-226"><a href="#cb71-226" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span>showAllComponents <span class="op">?</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">`</span></span>
<span id="cb71-227"><a href="#cb71-227" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;!-- Composite map - full width with legend --&gt;</span></span>
<span id="cb71-228"><a href="#cb71-228" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div style="</span></span>
<span id="cb71-229"><a href="#cb71-229" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb71-230"><a href="#cb71-230" aria-hidden="true" tabindex="-1"></a><span class="vs">          flex-direction: column;</span></span>
<span id="cb71-231"><a href="#cb71-231" aria-hidden="true" tabindex="-1"></a><span class="vs">          align-items: center;</span></span>
<span id="cb71-232"><a href="#cb71-232" aria-hidden="true" tabindex="-1"></a><span class="vs">          width: 100%;</span></span>
<span id="cb71-233"><a href="#cb71-233" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-bottom: 20px;</span></span>
<span id="cb71-234"><a href="#cb71-234" aria-hidden="true" tabindex="-1"></a><span class="vs">        "&gt;</span></span>
<span id="cb71-235"><a href="#cb71-235" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div&gt;</span><span class="sc">${</span>compositeMap<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb71-236"><a href="#cb71-236" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb71-237"><a href="#cb71-237" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span></span>
<span id="cb71-238"><a href="#cb71-238" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;!-- Component maps - 3 in a row with legends --&gt;</span></span>
<span id="cb71-239"><a href="#cb71-239" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div style="</span></span>
<span id="cb71-240"><a href="#cb71-240" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: grid;</span></span>
<span id="cb71-241"><a href="#cb71-241" aria-hidden="true" tabindex="-1"></a><span class="vs">          grid-template-columns: 1fr 1fr 1fr;</span></span>
<span id="cb71-242"><a href="#cb71-242" aria-hidden="true" tabindex="-1"></a><span class="vs">          gap: 16px;</span></span>
<span id="cb71-243"><a href="#cb71-243" aria-hidden="true" tabindex="-1"></a><span class="vs">          width: 100%;</span></span>
<span id="cb71-244"><a href="#cb71-244" aria-hidden="true" tabindex="-1"></a><span class="vs">          overflow: visible;</span></span>
<span id="cb71-245"><a href="#cb71-245" aria-hidden="true" tabindex="-1"></a><span class="vs">        "&gt;</span></span>
<span id="cb71-246"><a href="#cb71-246" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>componentMaps<span class="op">.</span><span class="fu">map</span>((map<span class="op">,</span> index) <span class="kw">=&gt;</span> {</span>
<span id="cb71-247"><a href="#cb71-247" aria-hidden="true" tabindex="-1"></a>            <span class="kw">const</span> mapSvg <span class="op">=</span> map<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">'svg:nth-of-type(2)'</span>)<span class="op">;</span> <span class="co">// Map is the second svg of the figure. Might change</span></span>
<span id="cb71-248"><a href="#cb71-248" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (mapSvg) mapSvg<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">"overflow"</span><span class="op">,</span> <span class="st">"visible"</span>)<span class="op">;</span></span>
<span id="cb71-249"><a href="#cb71-249" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb71-250"><a href="#cb71-250" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">`</span></span>
<span id="cb71-251"><a href="#cb71-251" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;div style="display: flex; flex-direction: column; align-items: center;"&gt;</span></span>
<span id="cb71-252"><a href="#cb71-252" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;div style="overflow: visible;"&gt;</span><span class="sc">${</span>map<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb71-253"><a href="#cb71-253" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;/div&gt;</span></span>
<span id="cb71-254"><a href="#cb71-254" aria-hidden="true" tabindex="-1"></a><span class="vs">            `</span><span class="op">;</span></span>
<span id="cb71-255"><a href="#cb71-255" aria-hidden="true" tabindex="-1"></a>          })<span class="sc">}</span></span>
<span id="cb71-256"><a href="#cb71-256" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb71-257"><a href="#cb71-257" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span> <span class="op">:</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">`</span></span>
<span id="cb71-258"><a href="#cb71-258" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;!-- Single component map with legend --&gt;</span></span>
<span id="cb71-259"><a href="#cb71-259" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div style="</span></span>
<span id="cb71-260"><a href="#cb71-260" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb71-261"><a href="#cb71-261" aria-hidden="true" tabindex="-1"></a><span class="vs">          flex-direction: column;</span></span>
<span id="cb71-262"><a href="#cb71-262" aria-hidden="true" tabindex="-1"></a><span class="vs">          align-items: center;</span></span>
<span id="cb71-263"><a href="#cb71-263" aria-hidden="true" tabindex="-1"></a><span class="vs">          width: 100%;</span></span>
<span id="cb71-264"><a href="#cb71-264" aria-hidden="true" tabindex="-1"></a><span class="vs">        "&gt;</span></span>
<span id="cb71-265"><a href="#cb71-265" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div&gt;</span><span class="sc">${</span>componentMaps[<span class="dv">0</span>]<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb71-266"><a href="#cb71-266" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb71-267"><a href="#cb71-267" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span><span class="sc">}</span></span>
<span id="cb71-268"><a href="#cb71-268" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;/div&gt;</span></span>
<span id="cb71-269"><a href="#cb71-269" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span><span class="op">;</span></span>
<span id="cb71-270"><a href="#cb71-270" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-71" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb72" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb72--1"><a href="#cb72--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Dynamic Insights following wireframe template</span></span>
<span id="cb72-0"><a href="#cb72-0" aria-hidden="true" tabindex="-1"></a>compositeVulnerabilityInsights <span class="op">=</span> {</span>
<span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>componentIndicesPerRegion <span class="op">||</span> <span class="op">!</span>componentIndicesPerRegion<span class="op">.</span><span class="at">scores</span>) {</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">createNoDataState</span>()<span class="op">;</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> selections <span class="op">=</span> compositeAdminSelections<span class="op">;</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { scores<span class="op">,</span> adminLevel } <span class="op">=</span> componentIndicesPerRegion<span class="op">;</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Get region name for insight</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> regionName<span class="op">;</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>selections<span class="op">.</span><span class="at">selectAdmin0</span> <span class="op">||</span> selections<span class="op">.</span><span class="at">selectAdmin0</span> <span class="op">===</span> <span class="st">"SSA"</span>) {</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>    regionName <span class="op">=</span> <span class="st">"Sub-Saharan Africa"</span><span class="op">;</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="op">!</span>selections<span class="op">.</span><span class="at">selectAdmin1</span>) {</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>    regionName <span class="op">=</span> selections<span class="op">.</span><span class="at">selectAdmin0</span><span class="op">;</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="op">!</span>selections<span class="op">.</span><span class="at">selectAdmin2</span>) {</span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>    regionName <span class="op">=</span> selections<span class="op">.</span><span class="at">selectAdmin1</span><span class="op">;</span></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>    regionName <span class="op">=</span> selections<span class="op">.</span><span class="at">selectAdmin2</span><span class="op">;</span></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Calculate average scores across all regions for this level</span></span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> regions <span class="op">=</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">keys</span>(scores)<span class="op">;</span></span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> avgScores <span class="op">=</span> {</span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">composite</span><span class="op">:</span> d3<span class="op">.</span><span class="fu">mean</span>(regions<span class="op">,</span> r <span class="kw">=&gt;</span> scores[r]<span class="op">.</span><span class="at">composite</span>) <span class="op">||</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">exposure</span><span class="op">:</span> d3<span class="op">.</span><span class="fu">mean</span>(regions<span class="op">,</span> r <span class="kw">=&gt;</span> scores[r]<span class="op">.</span><span class="at">exposure</span>) <span class="op">||</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">sensitivity</span><span class="op">:</span> d3<span class="op">.</span><span class="fu">mean</span>(regions<span class="op">,</span> r <span class="kw">=&gt;</span> scores[r]<span class="op">.</span><span class="at">sensitivity</span>) <span class="op">||</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">adaptive_capacity</span><span class="op">:</span> d3<span class="op">.</span><span class="fu">mean</span>(regions<span class="op">,</span> r <span class="kw">=&gt;</span> scores[r]<span class="op">.</span><span class="at">adaptive_capacity</span>) <span class="op">||</span> <span class="dv">0</span></span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Determine vulnerability level</span></span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> vulnLevel <span class="op">=</span> avgScores<span class="op">.</span><span class="at">composite</span> <span class="op">&gt;</span> <span class="fl">0.7</span> <span class="op">?</span> </span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"high"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"√©lev√©"</span>}) <span class="op">:</span> </span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true" tabindex="-1"></a>    avgScores<span class="op">.</span><span class="at">composite</span> <span class="op">&gt;</span> <span class="fl">0.4</span> <span class="op">?</span> </span>
<span id="cb72-33"><a href="#cb72-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"moderate"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"mod√©r√©"</span>}) <span class="op">:</span> </span>
<span id="cb72-34"><a href="#cb72-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"low"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"faible"</span>})<span class="op">;</span></span>
<span id="cb72-35"><a href="#cb72-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-36"><a href="#cb72-36" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Identify main drivers</span></span>
<span id="cb72-37"><a href="#cb72-37" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> drivers <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb72-38"><a href="#cb72-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (avgScores<span class="op">.</span><span class="at">exposure</span> <span class="op">&gt;</span> <span class="fl">0.6</span>) drivers<span class="op">.</span><span class="fu">push</span>(<span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"high exposure"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"exposition √©lev√©e"</span>}))<span class="op">;</span></span>
<span id="cb72-39"><a href="#cb72-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (avgScores<span class="op">.</span><span class="at">sensitivity</span> <span class="op">&gt;</span> <span class="fl">0.6</span>) drivers<span class="op">.</span><span class="fu">push</span>(<span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"high sensitivity"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"sensibilit√© √©lev√©e"</span>}))<span class="op">;</span>  </span>
<span id="cb72-40"><a href="#cb72-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (avgScores<span class="op">.</span><span class="at">adaptive_capacity</span> <span class="op">&lt;</span> <span class="fl">0.4</span>) drivers<span class="op">.</span><span class="fu">push</span>(<span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"limited adaptive capacity"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"capacit√© d'adaptation limit√©e"</span>}))<span class="op">;</span> <span class="co">// LOW adaptive capacity is bad</span></span>
<span id="cb72-41"><a href="#cb72-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-42"><a href="#cb72-42" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Recommendations based on highest scoring components</span></span>
<span id="cb72-43"><a href="#cb72-43" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> recommendations <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb72-44"><a href="#cb72-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (avgScores<span class="op">.</span><span class="at">exposure</span> <span class="op">===</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(avgScores<span class="op">.</span><span class="at">exposure</span><span class="op">,</span> avgScores<span class="op">.</span><span class="at">sensitivity</span><span class="op">,</span> avgScores<span class="op">.</span><span class="at">adaptive_capacity</span>)) {</span>
<span id="cb72-45"><a href="#cb72-45" aria-hidden="true" tabindex="-1"></a>    recommendations<span class="op">.</span><span class="fu">push</span>(</span>
<span id="cb72-46"><a href="#cb72-46" aria-hidden="true" tabindex="-1"></a>      <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"climate hazard preparedness"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"pr√©paration aux dangers climatiques"</span>})<span class="op">,</span></span>
<span id="cb72-47"><a href="#cb72-47" aria-hidden="true" tabindex="-1"></a>      <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"resilient infrastructure"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"infrastructure r√©siliente"</span>})</span>
<span id="cb72-48"><a href="#cb72-48" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb72-49"><a href="#cb72-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb72-50"><a href="#cb72-50" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (avgScores<span class="op">.</span><span class="at">sensitivity</span> <span class="op">&gt;</span> <span class="fl">0.5</span>) {</span>
<span id="cb72-51"><a href="#cb72-51" aria-hidden="true" tabindex="-1"></a>    recommendations<span class="op">.</span><span class="fu">push</span>(</span>
<span id="cb72-52"><a href="#cb72-52" aria-hidden="true" tabindex="-1"></a>      <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"education access"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"acc√®s √† l'√©ducation"</span>})<span class="op">,</span></span>
<span id="cb72-53"><a href="#cb72-53" aria-hidden="true" tabindex="-1"></a>      <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"poverty reduction programs"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"programmes de r√©duction de la pauvret√©"</span>})</span>
<span id="cb72-54"><a href="#cb72-54" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb72-55"><a href="#cb72-55" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb72-56"><a href="#cb72-56" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (avgScores<span class="op">.</span><span class="at">adaptive_capacity</span> <span class="op">&lt;</span> <span class="fl">0.5</span>) { <span class="co">// LOW adaptive capacity needs improvement</span></span>
<span id="cb72-57"><a href="#cb72-57" aria-hidden="true" tabindex="-1"></a>    recommendations<span class="op">.</span><span class="fu">push</span>(</span>
<span id="cb72-58"><a href="#cb72-58" aria-hidden="true" tabindex="-1"></a>      <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"connectivity improvements"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"am√©liorations de la connectivit√©"</span>})<span class="op">,</span></span>
<span id="cb72-59"><a href="#cb72-59" aria-hidden="true" tabindex="-1"></a>      <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"institutional strengthening"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"renforcement institutionnel"</span>})</span>
<span id="cb72-60"><a href="#cb72-60" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb72-61"><a href="#cb72-61" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb72-62"><a href="#cb72-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-63"><a href="#cb72-63" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> driversText <span class="op">=</span> drivers<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> </span>
<span id="cb72-64"><a href="#cb72-64" aria-hidden="true" tabindex="-1"></a>    drivers<span class="op">.</span><span class="fu">join</span>(<span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">" combined with "</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">" combin√© avec "</span>})) <span class="op">:</span> </span>
<span id="cb72-65"><a href="#cb72-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"multiple factors"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"facteurs multiples"</span>})<span class="op">;</span></span>
<span id="cb72-66"><a href="#cb72-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-67"><a href="#cb72-67" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> recommendationsText <span class="op">=</span> recommendations<span class="op">.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">.</span><span class="fu">join</span>(<span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">" and "</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">" et "</span>})) <span class="op">||</span> </span>
<span id="cb72-68"><a href="#cb72-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"comprehensive interventions"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"interventions compl√®tes"</span>})<span class="op">;</span></span>
<span id="cb72-69"><a href="#cb72-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-70"><a href="#cb72-70" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create component scores as list items</span></span>
<span id="cb72-71"><a href="#cb72-71" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> componentScores <span class="op">=</span> [</span>
<span id="cb72-72"><a href="#cb72-72" aria-hidden="true" tabindex="-1"></a>    htl<span class="op">.</span><span class="fu">html</span><span class="vs">`&lt;li&gt;&lt;strong&gt;</span><span class="sc">${</span><span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Exposure"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Exposition"</span>})<span class="sc">}</span><span class="vs">&lt;/strong&gt;: </span><span class="sc">${</span>(avgScores<span class="op">.</span><span class="at">exposure</span> <span class="op">||</span> <span class="dv">0</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs">&lt;/li&gt;`</span><span class="op">,</span></span>
<span id="cb72-73"><a href="#cb72-73" aria-hidden="true" tabindex="-1"></a>    htl<span class="op">.</span><span class="fu">html</span><span class="vs">`&lt;li&gt;&lt;strong&gt;</span><span class="sc">${</span><span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Sensitivity"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Sensibilit√©"</span>})<span class="sc">}</span><span class="vs">&lt;/strong&gt;: </span><span class="sc">${</span>(avgScores<span class="op">.</span><span class="at">sensitivity</span> <span class="op">||</span> <span class="dv">0</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs">&lt;/li&gt;`</span><span class="op">,</span></span>
<span id="cb72-74"><a href="#cb72-74" aria-hidden="true" tabindex="-1"></a>    htl<span class="op">.</span><span class="fu">html</span><span class="vs">`&lt;li&gt;&lt;strong&gt;</span><span class="sc">${</span><span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Adaptive Capacity"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Capacit√© d'adaptation"</span>})<span class="sc">}</span><span class="vs">&lt;/strong&gt;: </span><span class="sc">${</span>(avgScores<span class="op">.</span><span class="at">adaptive_capacity</span> <span class="op">||</span> <span class="dv">0</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs">&lt;/li&gt;`</span></span>
<span id="cb72-75"><a href="#cb72-75" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">;</span></span>
<span id="cb72-76"><a href="#cb72-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-77"><a href="#cb72-77" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> insight <span class="op">=</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">`&lt;div&gt;</span></span>
<span id="cb72-78"><a href="#cb72-78" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;p&gt;</span><span class="sc">${</span><span class="fu">_lang</span>({</span>
<span id="cb72-79"><a href="#cb72-79" aria-hidden="true" tabindex="-1"></a>      <span class="dt">en</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>regionName<span class="sc">}</span><span class="vs"> has a </span><span class="sc">${</span>vulnLevel<span class="sc">}</span><span class="vs"> vulnerability score of </span><span class="sc">${</span>(avgScores<span class="op">.</span><span class="at">composite</span> <span class="op">||</span> <span class="dv">0</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs">.`</span><span class="op">,</span></span>
<span id="cb72-80"><a href="#cb72-80" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fr</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>regionName<span class="sc">}</span><span class="vs"> a un score de vuln√©rabilit√© </span><span class="sc">${</span>vulnLevel<span class="sc">}</span><span class="vs"> de </span><span class="sc">${</span>(avgScores<span class="op">.</span><span class="at">composite</span> <span class="op">||</span> <span class="dv">0</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs">.`</span></span>
<span id="cb72-81"><a href="#cb72-81" aria-hidden="true" tabindex="-1"></a>    })<span class="sc">}</span><span class="vs">&lt;/p&gt;</span></span>
<span id="cb72-82"><a href="#cb72-82" aria-hidden="true" tabindex="-1"></a><span class="vs">    </span></span>
<span id="cb72-83"><a href="#cb72-83" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;ul&gt;</span><span class="sc">${</span>componentScores<span class="sc">}</span><span class="vs">&lt;/ul&gt;</span></span>
<span id="cb72-84"><a href="#cb72-84" aria-hidden="true" tabindex="-1"></a><span class="vs">    </span></span>
<span id="cb72-85"><a href="#cb72-85" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;p&gt;</span><span class="sc">${</span><span class="fu">_lang</span>({</span>
<span id="cb72-86"><a href="#cb72-86" aria-hidden="true" tabindex="-1"></a>      <span class="dt">en</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>driversText<span class="sc">}</span><span class="vs"> driving vulnerability. Strengthening </span><span class="sc">${</span>recommendationsText<span class="sc">}</span><span class="vs"> could reduce future risks.`</span><span class="op">,</span></span>
<span id="cb72-87"><a href="#cb72-87" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fr</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>driversText<span class="sc">}</span><span class="vs"> g√©n√®rent la vuln√©rabilit√©. Renforcer </span><span class="sc">${</span>recommendationsText<span class="sc">}</span><span class="vs"> pourrait r√©duire les risques futurs.`</span></span>
<span id="cb72-88"><a href="#cb72-88" aria-hidden="true" tabindex="-1"></a>    })<span class="sc">}</span><span class="vs">&lt;/p&gt;</span></span>
<span id="cb72-89"><a href="#cb72-89" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb72-90"><a href="#cb72-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-91"><a href="#cb72-91" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">createInsightDisplay</span>(insight)<span class="op">;</span></span>
<span id="cb72-92"><a href="#cb72-92" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-72" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb73" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb73--1"><a href="#cb73--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Create download dataset with all composite index and sub-indices</span></span>
<span id="cb73-0"><a href="#cb73-0" aria-hidden="true" tabindex="-1"></a>compositeDownloadData <span class="op">=</span> {</span>
<span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>componentIndicesPerRegion <span class="op">||</span> <span class="op">!</span>componentIndicesPerRegion<span class="op">.</span><span class="at">scores</span>) <span class="cf">return</span> []<span class="op">;</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { scores<span class="op">,</span> adminLevel } <span class="op">=</span> componentIndicesPerRegion<span class="op">;</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> regions <span class="op">=</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">keys</span>(scores)<span class="op">;</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> regions<span class="op">.</span><span class="fu">map</span>(region <span class="kw">=&gt;</span> {</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> regionScores <span class="op">=</span> scores[region]<span class="op">;</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>      [<span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Region"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"R√©gion"</span>})]<span class="op">:</span> region<span class="op">,</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>      [<span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Composite Vulnerability Score"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Score de Vuln√©rabilit√© Composite"</span>})]<span class="op">:</span> regionScores<span class="op">.</span><span class="at">composite</span> <span class="op">?</span> regionScores<span class="op">.</span><span class="at">composite</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>) <span class="op">:</span> <span class="st">"N/A"</span><span class="op">,</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>      [<span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Exposure Score"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Score d'Exposition"</span>})]<span class="op">:</span> regionScores<span class="op">.</span><span class="at">exposure</span> <span class="op">?</span> regionScores<span class="op">.</span><span class="at">exposure</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>) <span class="op">:</span> <span class="st">"N/A"</span><span class="op">,</span></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>      [<span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Sensitivity Score"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Score de Sensibilit√©"</span>})]<span class="op">:</span> regionScores<span class="op">.</span><span class="at">sensitivity</span> <span class="op">?</span> regionScores<span class="op">.</span><span class="at">sensitivity</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>) <span class="op">:</span> <span class="st">"N/A"</span><span class="op">,</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>      [<span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Adaptive Capacity Score"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Score de Capacit√© d'Adaptation"</span>})]<span class="op">:</span> regionScores<span class="op">.</span><span class="at">adaptive_capacity</span> <span class="op">?</span> regionScores<span class="op">.</span><span class="at">adaptive_capacity</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>) <span class="op">:</span> <span class="st">"N/A"</span><span class="op">,</span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>      [<span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Enabling Index"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Indice d'Enabling"</span>})]<span class="op">:</span> regionScores<span class="op">.</span><span class="at">enabling_index</span> <span class="op">?</span> regionScores<span class="op">.</span><span class="at">enabling_index</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>) <span class="op">:</span> <span class="st">"N/A"</span><span class="op">,</span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>      [<span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Urgency Index"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Indice d'Urgence"</span>})]<span class="op">:</span> regionScores<span class="op">.</span><span class="at">urgency_index</span> <span class="op">?</span> regionScores<span class="op">.</span><span class="at">urgency_index</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>) <span class="op">:</span> <span class="st">"N/A"</span><span class="op">,</span></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>      [<span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Raw Vulnerability Score"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Score de Vuln√©rabilit√© Brut"</span>})]<span class="op">:</span> regionScores<span class="op">.</span><span class="at">vulnerability_score</span> <span class="op">||</span> <span class="st">"N/A"</span></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-73" data-nodetype="declaration"></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb74" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb74--1"><a href="#cb74--1" aria-hidden="true" tabindex="-1"></a><span class="co">// Download button for composite index data</span></span>
<span id="cb74-0"><a href="#cb74-0" aria-hidden="true" tabindex="-1"></a>viewof compositeDownloadButton <span class="op">=</span> {</span>
<span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>compositeDownloadData <span class="op">||</span> compositeDownloadData<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">`&lt;p&gt;</span><span class="sc">${</span><span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"No data available for download"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Aucune donn√©e disponible pour le t√©l√©chargement"</span>})<span class="sc">}</span><span class="vs">&lt;/p&gt;`</span><span class="op">;</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> region <span class="op">=</span> compositeSelectedComponent<span class="op">.</span><span class="at">value</span> <span class="op">===</span> <span class="st">"composite"</span> <span class="op">?</span> </span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"All_Regions"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"Toutes_Les_R√©gions"</span>}) <span class="op">:</span> </span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>    compositeSelectedComponent<span class="op">.</span><span class="at">label</span><span class="op">.</span><span class="fu">replace</span>(<span class="ss">/</span><span class="sc">\s+</span><span class="ss">/g</span><span class="op">,</span> <span class="st">'_'</span>)<span class="op">;</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">downloadButton</span>(</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>    compositeDownloadData<span class="op">,</span> </span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>    <span class="vs">`composite_vulnerability_data_</span><span class="sc">${</span>region<span class="sc">}</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">_lang</span>({<span class="dt">en</span><span class="op">:</span> <span class="st">"Download Composite Index Data"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"T√©l√©charger les Donn√©es de l'Indice Composite"</span>})</span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-74" data-nodetype="declaration"></div></div></div><div style="margin-top:32px"></div><section id="langvulnerability_translations.composite_insights_title" class="level2"><h2 data-anchor-id="langvulnerability_translations.composite_insights_title"><span><span id="ojs-element-id-12"></span></span></h2><p><span><span id="ojs-element-id-13"></span></span></p><hr></section></section><section id="appendix" class="level1"><h1><span><span id="ojs-element-id-14"></span></span></h1><div class="cell"><details open="" class="code-fold hidden"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb75" data-startfrom="4" data-source-offset="-52"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line 3"><span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>toc_bottom <span class="op">=</span> {</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Wait for DOM to be ready</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>  masterLanguage <span class="co">//</span><span class="al">HACK</span><span class="co">: Refresh when lang changes... not sure why not already happening...</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> <span class="kw">new</span> <span class="bu">Promise</span>(resolve <span class="kw">=&gt;</span> <span class="pp">setTimeout</span>(resolve<span class="op">,</span> <span class="dv">100</span>))<span class="op">;</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">atlasTOC</span>({</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">skip</span><span class="op">:</span> [<span class="st">'notebook-title'</span><span class="op">,</span> <span class="st">'appendix'</span><span class="op">,</span> <span class="st">'source-code'</span>]<span class="op">,</span> <span class="co">// heading ids to skip</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">heading</span><span class="op">:</span> <span class="vs">`&lt;b&gt;In This Notebook&lt;/b&gt;`</span><span class="op">,</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">selector</span><span class="op">:</span> <span class="st">"h1,h2"</span><span class="op">,</span> <span class="co">// Selectors to include (e.g., "h1,h2,h3")</span></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>htl<span class="op">.</span><span class="fu">html</span><span class="vs">`</span></span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class='floating-toc'&gt;</span></span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span>toc_bottom<span class="sc">}</span></span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></details><div class="cell-output cell-output-display"><div><div id="ojs-cell-75-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-75-2" data-nodetype="expression"></div></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb76" data-startfrom="-1" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset:source-line -2"><span id="cb76--1"><a href="#cb76--1" aria-hidden="true" tabindex="-1"></a><span class="co">// About this notebook</span></span>
<span id="cb76-0"><a href="#cb76-0" aria-hidden="true" tabindex="-1"></a>aboutSection <span class="op">=</span> htl<span class="op">.</span><span class="fu">html</span><span class="vs">`</span></span>
<span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;div style="</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="vs">    background: #f8fafc;</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="vs">    border: 1px solid #e2e8f0;</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="vs">    border-radius: 8px;</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a><span class="vs">    padding: 24px;</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a><span class="vs">    margin: 24px 0;</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a><span class="vs">  "&gt;</span></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;h3 style="margin: 0 0 16px 0; color: #2d3748;"&gt;</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span><span class="fu">_lang</span>({ <span class="dt">en</span><span class="op">:</span> <span class="st">"About This Notebook"</span><span class="op">,</span> <span class="dt">fr</span><span class="op">:</span> <span class="st">"√Ä propos de ce carnet"</span> })<span class="sc">}</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;/h3&gt;</span></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;p style="margin: 0 0 12px 0; line-height: 1.6;"&gt;</span></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span><span class="fu">_lang</span>({</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">en</span><span class="op">:</span> <span class="st">"This vulnerability assessment notebook helps you understand climate vulnerability through three key dimensions: exposure to climate hazards, sensitivity of populations, and adaptive capacity of communities."</span><span class="op">,</span></span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fr</span><span class="op">:</span> <span class="st">"Ce carnet d'√©valuation de la vuln√©rabilit√© vous aide √† comprendre la vuln√©rabilit√© climatique √† travers trois dimensions cl√©s : l'exposition aux dangers climatiques, la sensibilit√© des populations et la capacit√© d'adaptation des communaut√©s."</span><span class="op">,</span></span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>      })<span class="sc">}</span></span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;/p&gt;</span></span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;p style="margin: 0 0 12px 0; line-height: 1.6;"&gt;</span></span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span><span class="fu">_lang</span>({</span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">en</span><span class="op">:</span> <span class="st">"The notebook uses interactive visualizations to explore vulnerability patterns across Sub-Saharan Africa, with data that can be filtered by administrative regions and demographic characteristics."</span><span class="op">,</span></span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fr</span><span class="op">:</span> <span class="st">"Le carnet utilise des visualisations interactives pour explorer les sch√©mas de vuln√©rabilit√© √† travers l'Afrique subsaharienne, avec des donn√©es qui peuvent √™tre filtr√©es par r√©gions administratives et caract√©ristiques d√©mographiques."</span><span class="op">,</span></span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>      })<span class="sc">}</span></span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;/p&gt;</span></span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;p style="margin: 0; line-height: 1.6; font-size: 14px; color: #6b7280;"&gt;</span></span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span><span class="fu">_lang</span>({</span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a>        <span class="dt">en</span><span class="op">:</span> <span class="st">"For questions or feedback about this notebook, please contact the Adaptation Atlas team."</span><span class="op">,</span></span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fr</span><span class="op">:</span> <span class="st">"Pour des questions ou commentaires sur ce carnet, veuillez contacter l'√©quipe de l'Atlas d'adaptation."</span><span class="op">,</span></span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a>      })<span class="sc">}</span></span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;/p&gt;</span></span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;/div&gt;</span></span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span><span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div id="ojs-cell-76" data-nodetype="declaration"></div></div></div></section><section id="source-code" class="level1 hidden"><h1 class="hidden">Source code</h1><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb77" data-startfrom="1" data-source-offset="-40"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">NavbarLangSelector</span>(language_obj<span class="op">,</span> masterLanguage) {</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> navEnd <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">".navbar-nav.ms-auto .nav-item.compact"</span>)<span class="op">;</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (navEnd) {</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> existingLangSelector <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">"nav-lang-selector"</span>)<span class="op">;</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>existingLangSelector) {</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> lang_sel <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">bind</span>(</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>        Inputs<span class="op">.</span><span class="fu">radio</span>(language_obj<span class="op">,</span> {</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>          <span class="dt">label</span><span class="op">:</span> <span class="st">""</span><span class="op">,</span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>          <span class="dt">format</span><span class="op">:</span> (d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">label</span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>        })<span class="op">,</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>        viewof masterLanguage</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>      )<span class="op">;</span></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>      lang_sel<span class="op">.</span><span class="at">id</span> <span class="op">=</span> <span class="st">"nav-lang-selector"</span><span class="op">;</span></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Style the language selector for navbar integration</span></span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>      lang_sel<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">display</span> <span class="op">=</span> <span class="st">"flex"</span><span class="op">;</span></span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>      lang_sel<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">alignItems</span> <span class="op">=</span> <span class="st">"center"</span><span class="op">;</span></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>      lang_sel<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">marginLeft</span> <span class="op">=</span> <span class="st">"10px"</span><span class="op">;</span></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> lang_div <span class="op">=</span> lang_sel<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">"div"</span>)<span class="op">;</span></span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>      lang_div<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">display</span> <span class="op">=</span> <span class="st">"flex"</span><span class="op">;</span></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>      lang_div<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">flexDirection</span> <span class="op">=</span> <span class="st">"column"</span><span class="op">;</span></span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>      navEnd<span class="op">.</span><span class="at">parentNode</span><span class="op">.</span><span class="fu">appendChild</span>(lang_sel)<span class="op">;</span></span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a><span class="fu">NavbarLangSelector</span>(languages<span class="op">,</span> masterLanguage)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-77-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-77-2" data-nodetype="expression"></div></div></div></div><div class="cell"><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb78" data-startfrom="1" data-source-offset="-35"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>appendix <span class="op">=</span> <span class="fu">_lang</span>(general_translations<span class="op">.</span><span class="at">appendix</span>)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Master language selector</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>viewof masterLanguage <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">radio</span>(languages<span class="op">,</span> {</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> <span class="st">"Main language toggle"</span><span class="op">,</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">format</span><span class="op">:</span> (d) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">key</span><span class="op">,</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> languages<span class="op">.</span><span class="fu">find</span>((x) <span class="kw">=&gt;</span> x<span class="op">.</span><span class="at">key</span> <span class="op">===</span> defaultLangKey)<span class="op">,</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-78-1" data-nodetype="declaration"></div></div></div><div class="cell-output cell-output-display"><div><div id="ojs-cell-78-2" data-nodetype="declaration"></div></div></div></div><div class="ojs-auto-generated hidden"><script type="ojs-module-contents">eyJjb250ZW50cyI6WyAgeyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiaW5saW5lIjoidHJ1ZSIsInNvdXJjZSI6Imh0bC5odG1sYDxzcGFuPiR7b3ZlcnZpZXd9PC9zcGFuPmAiLCAiY2VsbE5hbWUiOiJvanMtZWxlbWVudC1pZC0xIn0sICB7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJpbmxpbmUiOiJ0cnVlIiwic291cmNlIjoiaHRsLmh0bWxgPHNwYW4+JHtfbGFuZyh2dWxuZXJhYmlsaXR5X3RyYW5zbGF0aW9ucy5ub3RlYm9va19vdmVydmlld190ZXh0MSl9PC9zcGFuPmAiLCAiY2VsbE5hbWUiOiJvanMtZWxlbWVudC1pZC0yIn0sICB7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJpbmxpbmUiOiJ0cnVlIiwic291cmNlIjoiaHRsLmh0bWxgPHNwYW4+JHtfbGFuZyh2dWxuZXJhYmlsaXR5X3RyYW5zbGF0aW9ucy5ub3RlYm9va19vdmVydmlld190ZXh0Mil9PC9zcGFuPmAiLCAiY2VsbE5hbWUiOiJvanMtZWxlbWVudC1pZC0zIn0sICB7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJpbmxpbmUiOiJ0cnVlIiwic291cmNlIjoiaHRsLmh0bWxgPHNwYW4+JHtleHBvc3VyZVF1ZXN0aW9ufTwvc3Bhbj5gIiwgImNlbGxOYW1lIjoib2pzLWVsZW1lbnQtaWQtNCJ9LCAgeyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiaW5saW5lIjoidHJ1ZSIsInNvdXJjZSI6Imh0bC5odG1sYDxzcGFuPiR7X2xhbmcodnVsbmVyYWJpbGl0eV90cmFuc2xhdGlvbnMuZXhwb3N1cmVfZGVzY3JpcHRpb24pfTwvc3Bhbj5gIiwgImNlbGxOYW1lIjoib2pzLWVsZW1lbnQtaWQtNSJ9LCAgeyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiaW5saW5lIjoidHJ1ZSIsInNvdXJjZSI6Imh0bC5odG1sYDxzcGFuPiR7c2Vuc2l0aXZpdHlRdWVzdGlvbn08L3NwYW4+YCIsICJjZWxsTmFtZSI6Im9qcy1lbGVtZW50LWlkLTYifSwgIHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImlubGluZSI6InRydWUiLCJzb3VyY2UiOiJodGwuaHRtbGA8c3Bhbj4ke19sYW5nKHZ1bG5lcmFiaWxpdHlfdHJhbnNsYXRpb25zLnNlbnNpdGl2aXR5X2Rlc2NyaXB0aW9uKX08L3NwYW4+YCIsICJjZWxsTmFtZSI6Im9qcy1lbGVtZW50LWlkLTcifSwgIHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImlubGluZSI6InRydWUiLCJzb3VyY2UiOiJodGwuaHRtbGA8c3Bhbj4ke2FkYXB0aXZlQ2FwYWNpdHlRdWVzdGlvbn08L3NwYW4+YCIsICJjZWxsTmFtZSI6Im9qcy1lbGVtZW50LWlkLTgifSwgIHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImlubGluZSI6InRydWUiLCJzb3VyY2UiOiJodGwuaHRtbGA8c3Bhbj4ke19sYW5nKHZ1bG5lcmFiaWxpdHlfdHJhbnNsYXRpb25zLmFkYXB0aXZlX2NhcGFjaXR5X2Rlc2NyaXB0aW9uKX08L3NwYW4+YCIsICJjZWxsTmFtZSI6Im9qcy1lbGVtZW50LWlkLTkifSwgIHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImlubGluZSI6InRydWUiLCJzb3VyY2UiOiJodGwuaHRtbGA8c3Bhbj4ke2NvbXBvc2l0ZVF1ZXN0aW9ufTwvc3Bhbj5gIiwgImNlbGxOYW1lIjoib2pzLWVsZW1lbnQtaWQtMTAifSwgIHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImlubGluZSI6InRydWUiLCJzb3VyY2UiOiJodGwuaHRtbGA8c3Bhbj4ke19sYW5nKHZ1bG5lcmFiaWxpdHlfdHJhbnNsYXRpb25zLmNvbXBvc2l0ZV9kZXNjcmlwdGlvbil9PC9zcGFuPmAiLCAiY2VsbE5hbWUiOiJvanMtZWxlbWVudC1pZC0xMSJ9LCAgeyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiaW5saW5lIjoidHJ1ZSIsInNvdXJjZSI6Imh0bC5odG1sYDxzcGFuPiR7X2xhbmcodnVsbmVyYWJpbGl0eV90cmFuc2xhdGlvbnMuY29tcG9zaXRlX2luc2lnaHRzX3RpdGxlKX08L3NwYW4+YCIsICJjZWxsTmFtZSI6Im9qcy1lbGVtZW50LWlkLTEyIn0sICB7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJpbmxpbmUiOiJ0cnVlIiwic291cmNlIjoiaHRsLmh0bWxgPHNwYW4+JHtjb21wb3NpdGVWdWxuZXJhYmlsaXR5SW5zaWdodHN9PC9zcGFuPmAiLCAiY2VsbE5hbWUiOiJvanMtZWxlbWVudC1pZC0xMyJ9LCAgeyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiaW5saW5lIjoidHJ1ZSIsInNvdXJjZSI6Imh0bC5odG1sYDxzcGFuPiR7YXBwZW5kaXh9PC9zcGFuPmAiLCAiY2VsbE5hbWUiOiJvanMtZWxlbWVudC1pZC0xNCJ9XX0=</script></div></section></main><script type="ojs-module-contents">eyJjb250ZW50cyI6W3sibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Ii8vIENvcmUgaW1wb3J0cyBhbmQgZGVwZW5kZW5jaWVzXG5pbXBvcnQgeyBsYW5nIGFzIExhbmcgfSBmcm9tIFwiL2hlbHBlcnMvbGFuZy5qc1wiO1xuaW1wb3J0IHsgYXRsYXNUT0MsIGF0bGFzSGVybywgZG93bmxvYWRCdXR0b24gfSBmcm9tIFwiL2hlbHBlcnMvdWlDb21wb25lbnRzLm9qc1wiO1xuaW1wb3J0IHsgcGF0Y2hXaW5kb3dzQ2FjaGUgfSBmcm9tIFwiL2hlbHBlcnMvZGF0YS5qc1wiO1xuXG4vLyBSZXF1aXJlZCBsaWJyYXJpZXNcbnRvcG9qc29uID0gcmVxdWlyZShcInRvcG9qc29uXCIpO1xuZDMgPSByZXF1aXJlKFwiZDNANlwiKTtcblxuLy8gRGF0YSBpbXBvcnRzXG5nZW5lcmFsX3RyYW5zbGF0aW9ucyA9IGF3YWl0IEZpbGVBdHRhY2htZW50KFxuICBcIi9kYXRhL3NoYXJlZC9nZW5lcmFsVHJhbnNsYXRpb25zLmpzb25cIixcbikuanNvbigpO1xudnVsbmVyYWJpbGl0eV90cmFuc2xhdGlvbnMgPSBhd2FpdCBGaWxlQXR0YWNobWVudChcbiAgXCIvZGF0YS92dWxuZXJhYmlsaXR5X25vdGVib29rL3RyYW5zbGF0aW9ucy5qc29uXCIsXG4pLmpzb24oKTtcblxuLy8gSGVybyBpbWFnZSBjb25maWd1cmF0aW9uXG5oZXJvX3VybCA9IFwiLi8uLi8uLi9pbWFnZXMvZGVmYXVsdF9jcm9wLndlYnBcIjtcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMiIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Ii8vIEdsb2JhbCBjb25maWd1cmF0aW9uIGFuZCBtdXRhYmxlIHN0YXRlIC0gcmVzcG9uc2l2ZSBzaXppbmdcbm1hcFdpZHRoID0gdHlwZW9mIHdpZHRoICE9PSAndW5kZWZpbmVkJyA/IE1hdGgubWluKHdpZHRoLCA2MjUpIDogNjI1XG5tYXBIZWlnaHQgPSA2MDBcblxuLy8gTXV0YWJsZSBzdGF0ZSBmb3IgY3Jvc3Mtc2VjdGlvbiByZWFjdGl2aXR5IC0gQ0VOVFJBTElaRUQgQURNSU4gU0VMRUNUSU9OU1xubXV0YWJsZSBzaGFyZWRBZG1pbjAgPSBudWxsXG5tdXRhYmxlIHNoYXJlZEFkbWluMSA9IG51bGxcbm11dGFibGUgc2hhcmVkQWRtaW4yID0gbnVsbFxuXG4vKipcbiAqIFVwZGF0ZSBhbGwgc2hhcmVkIGFkbWluIHNlbGVjdGlvbnMgc3luY2hyb25vdXNseSBhY3Jvc3MgYWxsIHNlY3Rpb25zXG4gKiBcbiAqIEBwYXJhbSB7c3RyaW5nfG51bGx9IGFkbWluMCAtIEFkbWluMCBzZWxlY3Rpb24gdmFsdWVcbiAqIEBwYXJhbSB7c3RyaW5nfG51bGx9IGFkbWluMSAtIEFkbWluMSBzZWxlY3Rpb24gdmFsdWUgIFxuICogQHBhcmFtIHtzdHJpbmd8bnVsbH0gYWRtaW4yIC0gQWRtaW4yIHNlbGVjdGlvbiB2YWx1ZVxuICovXG5mdW5jdGlvbiB1cGRhdGVTaGFyZWRBZG1pblNlbGVjdGlvbnMoYWRtaW4wLCBhZG1pbjEsIGFkbWluMikge1xuICBtdXRhYmxlIHNoYXJlZEFkbWluMCA9IGFkbWluMDtcbiAgbXV0YWJsZSBzaGFyZWRBZG1pbjEgPSBhZG1pbjE7XG4gIG11dGFibGUgc2hhcmVkQWRtaW4yID0gYWRtaW4yO1xufVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0zIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiLy8gTGFuZ3VhZ2UgY29uZmlndXJhdGlvblxubGFuZ3VhZ2VzID0gW1xuICB7IGtleTogXCJlblwiLCBsYWJlbDogXCJFbmdsaXNoXCIsIGxvY2FsZTogJ2VuLVVTJyB9LFxuICB7IGtleTogXCJmclwiLCBsYWJlbDogXCJGcmFuw6dhaXNcIiwgbG9jYWxlOiAnZnItRlInIH1cbl1cblxuZGVmYXVsdExhbmdLZXkgPSB7XG4gIGNvbnN0IG5hbWUgPSBcImxhbmdcIjtcbiAgY29uc3QgbGlzdCA9IGxhbmd1YWdlcy5tYXAoKGQpID0+IGQua2V5KTtcbiAgY29uc3QgZGVmYXVsdEtleSA9IFwiZW5cIjtcbiAgY29uc3QgcXVlcnlQYXJhbSA9IGF3YWl0IExhbmcuZ2V0UGFyYW1Gcm9tTGlzdCh7IG5hbWUsIGxpc3QgfSk7XG4gIHJldHVybiBxdWVyeVBhcmFtID8/IGRlZmF1bHRLZXk7XG59XG5cbl9sYW5nID0gTGFuZy5sZyhtYXN0ZXJMYW5ndWFnZS5rZXkpXG5cbmdsb2JhbFNlbGVjdGlvbiA9IHtcbiAgcmV0dXJuIHtcbiAgICBsYWJlbDogX2xhbmcoe2VuOiBcIlN1Yi1TYWhhcmFuIEFmcmljYVwiLCBmcjogXCJBZnJpcXVlIHN1YnNhaGFyaWVubmVcIn0pLFxuICAgIGxhYmVsR2VuZXJhbDogX2xhbmcoe2VuOiBcIkFmcmljYVwiLCBmcjogXCJBZnJpcXVlXCJ9KSxcbiBcbiAgfVxufVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC00IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiLy8gQWRtaW4gcmVnaW9uIGNvbmZpZ3VyYXRpb25cbmFkbWluUmVnaW9ucyA9IHtcbiAgcmV0dXJuIHtcbiAgICBsYWJlbHM6IHtcbiAgICAgIGFkbWluMDogX2xhbmcodnVsbmVyYWJpbGl0eV90cmFuc2xhdGlvbnMuY291bnRyeSksXG4gICAgICBhZG1pbjE6IF9sYW5nKHZ1bG5lcmFiaWxpdHlfdHJhbnNsYXRpb25zLnJlZ2lvbiksXG4gICAgICBhZG1pbjI6IF9sYW5nKHZ1bG5lcmFiaWxpdHlfdHJhbnNsYXRpb25zLnN1YnJlZ2lvbilcbiAgICB9XG4gIH07XG59XG5cbi8vIEdldCBjdXJyZW50IGFkbWluIHNlbGVjdGlvbnMgYXMgcmVhY3RpdmUgb2JqZWN0IC0gbm93IHVzaW5nIHNoYXJlZCBzdGF0ZVxuYWRtaW5TZWxlY3Rpb25zID0gKHtcbiAgc2VsZWN0QWRtaW4wOiBzaGFyZWRBZG1pbjAsXG4gIHNlbGVjdEFkbWluMTogc2hhcmVkQWRtaW4xLFxuICBzZWxlY3RBZG1pbjI6IHNoYXJlZEFkbWluMlxufSlcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Ii8vIFNpbXBsaWZpZWQgZGF0YSBsb2FkaW5nIHdpdGggY2FjaGluZyAobm8gbGF6eSBsb2FkaW5nIGZvciBub3cpXG4vLyBHbG9iYWwgY2FjaGUgZm9yIHNoYXJlZCBkYXRhIHRvIGF2b2lkIHJlZHVuZGFudCBsb2Fkc1xubXV0YWJsZSBkYXRhQ2FjaGUgPSBuZXcgTWFwKClcblxuLy8gTG9hZCBTMyBjb25maWd1cmF0aW9uXG5zM0NvbmZpZyA9IGF3YWl0IEZpbGVBdHRhY2htZW50KFxuXHRcIi9kYXRhL3Z1bG5lcmFiaWxpdHlfbm90ZWJvb2svUzNfZGF0YS5qc29uXCIsXG4pLmpzb24oKTtcblxuLyoqXG4gKiBMb2FkIGRhdGEgd2l0aCBjYWNoaW5nIHRvIGF2b2lkIHJlZHVuZGFudCBsb2Fkc1xuICogXG4gKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVW5pcXVlIGNhY2hlIGtleSBmb3IgdGhpcyBkYXRhXG4gKiBAcGFyYW0ge0Z1bmN0aW9ufSBsb2FkZXIgLSBBc3luYyBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlIGRhdGEgdG8gY2FjaGVcbiAqIEByZXR1cm5zIHtQcm9taXNlPCo+fSBDYWNoZWQgZGF0YSBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSBsb2FkZWQgZGF0YVxuICovXG5hc3luYyBmdW5jdGlvbiBsb2FkRGF0YVdpdGhDYWNoZShrZXksIGxvYWRlcikge1xuICBpZiAoZGF0YUNhY2hlLmhhcyhrZXkpKSB7XG4gICAgcmV0dXJuIGRhdGFDYWNoZS5nZXQoa2V5KTtcbiAgfVxuICBcbiAgdHJ5IHtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBwZXJmb3JtYW5jZS5ub3coKTtcbiAgICBcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgbG9hZGVyKCk7XG4gICAgXG4gICAgY29uc3QgbG9hZFRpbWUgPSBwZXJmb3JtYW5jZS5ub3coKSAtIHN0YXJ0VGltZTtcbiAgICBcbiAgICBkYXRhQ2FjaGUuc2V0KGtleSwgZGF0YSk7XG4gICAgcmV0dXJuIGRhdGE7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcihgRXJyb3IgbG9hZGluZyAke2tleX06YCwgZXJyb3IpO1xuICAgIHJldHVybiBudWxsO1xuICB9XG59XG5cbi8qKlxuICogQ3JlYXRlIER1Y2tEQiBjb25uZWN0aW9uIHdpdGggZXhwb3N1cmUgZGF0YSBwYXJxdWV0IGZpbGUgbG9hZGVkIGFzIGEgdmlld1xuICogVXNlcyBjYWNoaW5nIHRvIGF2b2lkIHJlZHVuZGFudCBjb25uZWN0aW9uc1xuICogXG4gKiBAcmV0dXJucyB7UHJvbWlzZTxPYmplY3R8bnVsbD59IER1Y2tEQiBjbGllbnQgd2l0aCBleHBvc3VyZV9kYXRhIHZpZXcsIG9yIG51bGwgb24gZmFpbHVyZVxuICovXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVFeHBvc3VyZURCKCkge1xuICByZXR1cm4gbG9hZERhdGFXaXRoQ2FjaGUoJ2V4cG9zdXJlREInLCBhc3luYyAoKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHBhcnF1ZXRVcmwgPSBhd2FpdCBGaWxlQXR0YWNobWVudChcbiAgICAgICAgXCIvZGF0YS92dWxuZXJhYmlsaXR5X25vdGVib29rL25vdGVib29rX2V4cG9zdXJlLnBhcnF1ZXRcIixcbiAgICAgICkudXJsKCk7XG4gICAgICBjb25zdCBkYiA9IGF3YWl0IER1Y2tEQkNsaWVudC5vZigpO1xuICAgICAgYXdhaXQgZGIucXVlcnkoYFxuICAgICAgICBDUkVBVEUgT1IgUkVQTEFDRSBWSUVXIGV4cG9zdXJlX2RhdGEgQVNcbiAgICAgICAgU0VMRUNUICogRlJPTSByZWFkX3BhcnF1ZXQoJyR7cGFycXVldFVybH0nKVxuICAgICAgYCk7XG4gICAgICByZXR1cm4gZGI7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJGYWlsZWQgdG8gY3JlYXRlIER1Y2tEQiBjb25uZWN0aW9uIGZvciBleHBvc3VyZSBkYXRhOlwiLCBlcnJvcik7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH0pO1xufVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC02IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiLy8gQ2FjaGVkIGJvdW5kYXJ5IGRhdGEgbG9hZGluZ1xuYm91bmRhcmllcyA9IHtcbiAgcmV0dXJuIGxvYWREYXRhV2l0aENhY2hlKCdib3VuZGFyaWVzJywgYXN5bmMgKCkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBpbnB1dDAgPSBhd2FpdCBGaWxlQXR0YWNobWVudChcIi9kYXRhL3NoYXJlZC9hdGxhc19nYXVsX2EwX2FmcmljYV9zaW1wbGUtdmxvd3Jlcy50b3BvanNvblwiKS5qc29uKClcbiAgICAgIGNvbnN0IGlucHV0MSA9IGF3YWl0IEZpbGVBdHRhY2htZW50KFwiL2RhdGEvc2hhcmVkL2F0bGFzX2dhdWxfYTFfYWZyaWNhX3NpbXBsZS12bG93cmVzLnRvcG9qc29uXCIpLmpzb24oKVxuICAgICAgY29uc3QgaW5wdXQyID0gYXdhaXQgRmlsZUF0dGFjaG1lbnQoXCIvZGF0YS9zaGFyZWQvYXRsYXNfZ2F1bF9hMl9hZnJpY2Ffc2ltcGxlLWxvd3Jlcy50b3BvanNvblwiKS5qc29uKClcblxuICAgICAgY29uc3QgZ2VvID0ge1xuICAgICAgICBhZG1pbjA6IHtcbiAgICAgICAgICAuLi50b3BvanNvbi5mZWF0dXJlKGlucHV0MCwgaW5wdXQwLm9iamVjdHNbXCJhdGxhc19nYXVsMjRfYTBfYWZyaWNhXCJdKSxcbiAgICAgICAgICBmZWF0dXJlczogdG9wb2pzb24uZmVhdHVyZShpbnB1dDAsIGlucHV0MC5vYmplY3RzW1wiYXRsYXNfZ2F1bDI0X2EwX2FmcmljYVwiXSkuZmVhdHVyZXNcbiAgICAgICAgfSxcbiAgICAgICAgYWRtaW4xOiB7XG4gICAgICAgICAgLi4udG9wb2pzb24uZmVhdHVyZShpbnB1dDEsIGlucHV0MS5vYmplY3RzW1wiYXRsYXNfZ2F1bDI0X2ExX2FmcmljYVwiXSksXG4gICAgICAgICAgZmVhdHVyZXM6IHRvcG9qc29uLmZlYXR1cmUoaW5wdXQxLCBpbnB1dDEub2JqZWN0c1tcImF0bGFzX2dhdWwyNF9hMV9hZnJpY2FcIl0pLmZlYXR1cmVzXG4gICAgICAgIH0sXG4gICAgICAgIGFkbWluMjoge1xuICAgICAgICAgIC4uLnRvcG9qc29uLmZlYXR1cmUoaW5wdXQyLCBpbnB1dDIub2JqZWN0c1tcImF0bGFzX2dhdWxfYTJfYWZyaWNhX3NpbXBsZS1sb3dyZXNcIl0pLFxuICAgICAgICAgIGZlYXR1cmVzOiB0b3BvanNvbi5mZWF0dXJlKGlucHV0MiwgaW5wdXQyLm9iamVjdHNbXCJhdGxhc19nYXVsX2EyX2FmcmljYV9zaW1wbGUtbG93cmVzXCJdKS5mZWF0dXJlc1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBcbiAgICAgIHJldHVybiBnZW9cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcIkZhaWxlZCB0byBsb2FkIGJvdW5kYXJ5IGRhdGE6XCIsIGVycm9yKTtcbiAgICAgIC8vIFJldHVybiBlbXB0eSBzdHJ1Y3R1cmUgdG8gcHJldmVudCBjcmFzaGVzXG4gICAgICByZXR1cm4ge1xuICAgICAgICBhZG1pbjA6IHsgZmVhdHVyZXM6IFtdIH0sXG4gICAgICAgIGFkbWluMTogeyBmZWF0dXJlczogW10gfSxcbiAgICAgICAgYWRtaW4yOiB7IGZlYXR1cmVzOiBbXSB9XG4gICAgICB9O1xuICAgIH1cbiAgfSk7XG59XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTciLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJkYXRhQWRtaW4wID0ge1xuICBjb25zdCBkYXRhID0gYm91bmRhcmllcy5hZG1pbjAuZmVhdHVyZXMubWFwKGQgPT4gZC5wcm9wZXJ0aWVzKVxuICAvLyBhZGQgYSBibGFuayB2YWx1ZSBhbmQgc29ydCBhbHBoYWJldGljYWxseVxuICByZXR1cm4gW251bGwsIC4uLmRhdGEubWFwKGQgPT4gZC5hZG1pbjBfbmFtZSldLm1hcChkID0+IHtcbiAgICByZXR1cm4ge2xhYmVsOiBkID09IG51bGwgPyBnbG9iYWxTZWxlY3Rpb24ubGFiZWwgOiBkLCB2YWx1ZTogZH1cbiAgfSkuc29ydCgoYSwgYikgPT4ge1xuICAgIC8vIEtlZXAgbnVsbC9ibGFuayB2YWx1ZSBhdCB0aGUgdG9wXG4gICAgaWYgKGEudmFsdWUgPT09IG51bGwpIHJldHVybiAtMTtcbiAgICBpZiAoYi52YWx1ZSA9PT0gbnVsbCkgcmV0dXJuIDE7XG4gICAgLy8gU29ydCBvdGhlcnMgYWxwaGFiZXRpY2FsbHkgYnkgbGFiZWxcbiAgICByZXR1cm4gYS5sYWJlbC5sb2NhbGVDb21wYXJlKGIubGFiZWwpO1xuICB9KVxufVxuXG5kYXRhQWRtaW4xID0ge1xuICAvLyBhZG1pbiAxLCBmaWx0ZXIgYnkgMCAtIHVzaW5nIHNoYXJlZCBzdGF0ZVxuICBsZXQgZGF0YTtcbiAgaWYgKHNoYXJlZEFkbWluMCAmJiBzaGFyZWRBZG1pbjAgIT09IFwiU1NBXCIpIHtcbiAgICAvLyBGaWx0ZXIgYnkgc2VsZWN0ZWQgY291bnRyeVxuICAgIGRhdGEgPSBib3VuZGFyaWVzLmFkbWluMS5mZWF0dXJlcy5tYXAoZCA9PiBkLnByb3BlcnRpZXMpXG4gICAgICAuZmlsdGVyKGQgPT4gZC5hZG1pbjBfbmFtZSA9PSBzaGFyZWRBZG1pbjApO1xuICB9IGVsc2Uge1xuICAgIC8vIElmIG5vIGNvdW50cnkgc2VsZWN0ZWQgb3IgU1NBIHNlbGVjdGVkLCBzaG93IGVtcHR5IChqdXN0IG51bGwgb3B0aW9uKVxuICAgIGRhdGEgPSBbXTtcbiAgfVxuICBcbiAgLy8gYWRkIGJsYW5rIHZhbHVlIGFuZCBzb3J0IGFscGhhYmV0aWNhbGx5XG4gIHJldHVybiBbbnVsbCwgLi4uZGF0YS5tYXAoZCA9PiBkLmFkbWluMV9uYW1lKV0ubWFwKGQgPT4ge1xuICAgIHJldHVybiB7bGFiZWw6IGQsIHZhbHVlOiBkfVxuICB9KS5zb3J0KChhLCBiKSA9PiB7XG4gICAgLy8gS2VlcCBudWxsL2JsYW5rIHZhbHVlIGF0IHRoZSB0b3BcbiAgICBpZiAoYS52YWx1ZSA9PT0gbnVsbCkgcmV0dXJuIC0xO1xuICAgIGlmIChiLnZhbHVlID09PSBudWxsKSByZXR1cm4gMTtcbiAgICAvLyBTb3J0IG90aGVycyBhbHBoYWJldGljYWxseSBieSBsYWJlbFxuICAgIHJldHVybiBhLmxhYmVsLmxvY2FsZUNvbXBhcmUoYi5sYWJlbCk7XG4gIH0pXG59XG5cbmRhdGFBZG1pbjIgPSB7XG4gIGxldCBkYXRhO1xuICBpZiAoc2hhcmVkQWRtaW4wICYmIHNoYXJlZEFkbWluMCAhPT0gXCJTU0FcIiAmJiBzaGFyZWRBZG1pbjEpIHtcbiAgICAvLyBGaWx0ZXIgYnkgc2VsZWN0ZWQgY291bnRyeSBhbmQgcmVnaW9uXG4gICAgZGF0YSA9IGJvdW5kYXJpZXMuYWRtaW4yLmZlYXR1cmVzLm1hcChkID0+IGQucHJvcGVydGllcylcbiAgICAgIC5maWx0ZXIoZCA9PiBkLmFkbWluMF9uYW1lID09IHNoYXJlZEFkbWluMCAmJiBkLmFkbWluMV9uYW1lID09IHNoYXJlZEFkbWluMSk7XG4gIH0gZWxzZSB7XG4gICAgLy8gSWYgbm8gY291bnRyeSBvciByZWdpb24gc2VsZWN0ZWQsIHNob3cgZW1wdHkgKGp1c3QgbnVsbCBvcHRpb24pXG4gICAgZGF0YSA9IFtdO1xuICB9XG4gIFxuICAvLyBhZGQgYmxhbmsgdmFsdWUgYW5kIHNvcnQgYWxwaGFiZXRpY2FsbHlcbiAgcmV0dXJuIFtudWxsLCAuLi5kYXRhLm1hcChkID0+IGQuYWRtaW4yX25hbWUpXS5tYXAoZCA9PiB7XG4gICAgcmV0dXJuIHtsYWJlbDogZCwgdmFsdWU6IGR9XG4gIH0pLnNvcnQoKGEsIGIpID0+IHtcbiAgICAvLyBLZWVwIG51bGwvYmxhbmsgdmFsdWUgYXQgdGhlIHRvcFxuICAgIGlmIChhLnZhbHVlID09PSBudWxsKSByZXR1cm4gLTE7XG4gICAgaWYgKGIudmFsdWUgPT09IG51bGwpIHJldHVybiAxO1xuICAgIC8vIFNvcnQgb3RoZXJzIGFscGhhYmV0aWNhbGx5IGJ5IGxhYmVsXG4gICAgcmV0dXJuIGEubGFiZWwubG9jYWxlQ29tcGFyZShiLmxhYmVsKTtcbiAgfSlcbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtOCIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Ii8vIEJpZGlyZWN0aW9uYWwgc3luY2hyb25pemF0aW9uOiBVcGRhdGUgc2hhcmVkIHN0YXRlIHdoZW4gQU5ZIHNlY3Rpb24ncyBzZWxlY3RvcnMgY2hhbmdlXG4vLyBUaGlzIHJlYWN0aXZlIGNlbGwgbW9uaXRvcnMgYWxsIHNlY3Rpb24gYWRtaW4gc2VsZWN0b3JzIGFuZCB1cGRhdGVzIHNoYXJlZCBzdGF0ZSB3aGVuIGFueSBjaGFuZ2Vcbi8vIFRoZSB1bmRlcnNjb3JlIHByZWZpeCBlbnN1cmVzIHRoaXMgY2VsbCBkb2Vzbid0IGRpc3BsYXkgb3V0cHV0IGluIHRoZSBub3RlYm9va1xuLy8gVXBkYXRlZCB0byBoYW5kbGUgY2FzY2FkaW5nOiB3aGVuIGFkbWluMCBjaGFuZ2VzLCBhZG1pbjEgYW5kIGFkbWluMiByZXNldDsgd2hlbiBhZG1pbjEgY2hhbmdlcywgYWRtaW4yIHJlc2V0c1xuX2FkbWluVXBkYXRlID0ge1xuICAvLyBDaGVjayBleHBvc3VyZSBzZWN0aW9uIHNlbGVjdG9ycyBmaXJzdCAoaGFzIHByaW9yaXR5KVxuICBpZiAoc2VsZWN0QWRtaW4wPy52YWx1ZSAhPT0gc2hhcmVkQWRtaW4wKSB7XG4gICAgLy8gQWRtaW4wIGNoYW5nZWQgLSByZXNldCBhZG1pbjEgYW5kIGFkbWluMlxuICAgIHVwZGF0ZVNoYXJlZEFkbWluU2VsZWN0aW9ucyhzZWxlY3RBZG1pbjA/LnZhbHVlIHx8IG51bGwsIG51bGwsIG51bGwpO1xuICB9IGVsc2UgaWYgKHNlbGVjdEFkbWluMT8udmFsdWUgIT09IHNoYXJlZEFkbWluMSkge1xuICAgIC8vIEFkbWluMSBjaGFuZ2VkIC0gcmVzZXQgYWRtaW4yXG4gICAgdXBkYXRlU2hhcmVkQWRtaW5TZWxlY3Rpb25zKHNoYXJlZEFkbWluMCwgc2VsZWN0QWRtaW4xPy52YWx1ZSB8fCBudWxsLCBudWxsKTtcbiAgfSBlbHNlIGlmIChzZWxlY3RBZG1pbjI/LnZhbHVlICE9PSBzaGFyZWRBZG1pbjIpIHtcbiAgICAvLyBBZG1pbjIgY2hhbmdlZFxuICAgIHVwZGF0ZVNoYXJlZEFkbWluU2VsZWN0aW9ucyhzaGFyZWRBZG1pbjAsIHNoYXJlZEFkbWluMSwgc2VsZWN0QWRtaW4yPy52YWx1ZSB8fCBudWxsKTtcbiAgfVxuICAvLyBDaGVjayBzZW5zaXRpdml0eSBzZWN0aW9uIHNlbGVjdG9yc1xuICBlbHNlIGlmIChzZW5zaXRpdml0eUFkbWluMD8udmFsdWUgIT09IHNoYXJlZEFkbWluMCkge1xuICAgIHVwZGF0ZVNoYXJlZEFkbWluU2VsZWN0aW9ucyhzZW5zaXRpdml0eUFkbWluMD8udmFsdWUgfHwgbnVsbCwgbnVsbCwgbnVsbCk7XG4gIH0gZWxzZSBpZiAoc2Vuc2l0aXZpdHlBZG1pbjE/LnZhbHVlICE9PSBzaGFyZWRBZG1pbjEpIHtcbiAgICB1cGRhdGVTaGFyZWRBZG1pblNlbGVjdGlvbnMoc2hhcmVkQWRtaW4wLCBzZW5zaXRpdml0eUFkbWluMT8udmFsdWUgfHwgbnVsbCwgbnVsbCk7XG4gIH0gZWxzZSBpZiAoc2Vuc2l0aXZpdHlBZG1pbjI/LnZhbHVlICE9PSBzaGFyZWRBZG1pbjIpIHtcbiAgICB1cGRhdGVTaGFyZWRBZG1pblNlbGVjdGlvbnMoc2hhcmVkQWRtaW4wLCBzaGFyZWRBZG1pbjEsIHNlbnNpdGl2aXR5QWRtaW4yPy52YWx1ZSB8fCBudWxsKTtcbiAgfVxuICAvLyBDaGVjayBhZGFwdGl2ZSBjYXBhY2l0eSBzZWN0aW9uIHNlbGVjdG9yc1xuICBlbHNlIGlmIChhZGFwdGl2ZUNhcGFjaXR5QWRtaW4wPy52YWx1ZSAhPT0gc2hhcmVkQWRtaW4wKSB7XG4gICAgdXBkYXRlU2hhcmVkQWRtaW5TZWxlY3Rpb25zKGFkYXB0aXZlQ2FwYWNpdHlBZG1pbjA/LnZhbHVlIHx8IG51bGwsIG51bGwsIG51bGwpO1xuICB9IGVsc2UgaWYgKGFkYXB0aXZlQ2FwYWNpdHlBZG1pbjE/LnZhbHVlICE9PSBzaGFyZWRBZG1pbjEpIHtcbiAgICB1cGRhdGVTaGFyZWRBZG1pblNlbGVjdGlvbnMoc2hhcmVkQWRtaW4wLCBhZGFwdGl2ZUNhcGFjaXR5QWRtaW4xPy52YWx1ZSB8fCBudWxsLCBudWxsKTtcbiAgfSBlbHNlIGlmIChhZGFwdGl2ZUNhcGFjaXR5QWRtaW4yPy52YWx1ZSAhPT0gc2hhcmVkQWRtaW4yKSB7XG4gICAgdXBkYXRlU2hhcmVkQWRtaW5TZWxlY3Rpb25zKHNoYXJlZEFkbWluMCwgc2hhcmVkQWRtaW4xLCBhZGFwdGl2ZUNhcGFjaXR5QWRtaW4yPy52YWx1ZSB8fCBudWxsKTtcbiAgfVxuICAvLyBDaGVjayBjb21wb3NpdGUgc2VjdGlvbiBzZWxlY3RvcnNcbiAgZWxzZSBpZiAoY29tcG9zaXRlQWRtaW4wPy52YWx1ZSAhPT0gc2hhcmVkQWRtaW4wKSB7XG4gICAgdXBkYXRlU2hhcmVkQWRtaW5TZWxlY3Rpb25zKGNvbXBvc2l0ZUFkbWluMD8udmFsdWUgfHwgbnVsbCwgbnVsbCwgbnVsbCk7XG4gIH0gZWxzZSBpZiAoY29tcG9zaXRlQWRtaW4xPy52YWx1ZSAhPT0gc2hhcmVkQWRtaW4xKSB7XG4gICAgdXBkYXRlU2hhcmVkQWRtaW5TZWxlY3Rpb25zKHNoYXJlZEFkbWluMCwgY29tcG9zaXRlQWRtaW4xPy52YWx1ZSB8fCBudWxsLCBudWxsKTtcbiAgfSBlbHNlIGlmIChjb21wb3NpdGVBZG1pbjI/LnZhbHVlICE9PSBzaGFyZWRBZG1pbjIpIHtcbiAgICB1cGRhdGVTaGFyZWRBZG1pblNlbGVjdGlvbnMoc2hhcmVkQWRtaW4wLCBzaGFyZWRBZG1pbjEsIGNvbXBvc2l0ZUFkbWluMj8udmFsdWUgfHwgbnVsbCk7XG4gIH1cbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtOSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6InNlbnNpdGl2aXR5RGF0YUFkbWluMCA9IHtcbiAgY29uc3QgZGF0YSA9IGJvdW5kYXJpZXMuYWRtaW4wLmZlYXR1cmVzLm1hcChkID0+IGQucHJvcGVydGllcylcbiAgLy8gYWRkIGEgYmxhbmsgdmFsdWUgYW5kIHNvcnQgYWxwaGFiZXRpY2FsbHlcbiAgcmV0dXJuIFtudWxsLCAuLi5kYXRhLm1hcChkID0+IGQuYWRtaW4wX25hbWUpXS5tYXAoZCA9PiB7XG4gICAgcmV0dXJuIHtsYWJlbDogZCA9PSBudWxsID8gZ2xvYmFsU2VsZWN0aW9uLmxhYmVsIDogZCwgdmFsdWU6IGQgfHwgXCJTU0FcIn1cbiAgfSkuc29ydCgoYSwgYikgPT4ge1xuICAgIC8vIEtlZXAgbnVsbC9ibGFuayB2YWx1ZSBhdCB0aGUgdG9wXG4gICAgaWYgKGEudmFsdWUgPT09IFwiU1NBXCIpIHJldHVybiAtMTtcbiAgICBpZiAoYi52YWx1ZSA9PT0gXCJTU0FcIikgcmV0dXJuIDE7XG4gICAgLy8gU29ydCBvdGhlcnMgYWxwaGFiZXRpY2FsbHkgYnkgbGFiZWxcbiAgICByZXR1cm4gYS5sYWJlbC5sb2NhbGVDb21wYXJlKGIubGFiZWwpO1xuICB9KVxufVxuXG5cbnNlbnNpdGl2aXR5RGF0YUFkbWluMSA9IHtcbiAgLy8gYWRtaW4gMSwgZmlsdGVyIGJ5IDAgXG4gIGNvbnN0IGRhdGEgPSBib3VuZGFyaWVzLmFkbWluMS5mZWF0dXJlcy5tYXAoZCA9PiBkLnByb3BlcnRpZXMpXG4gIC5maWx0ZXIoZCA9PiBkLmFkbWluMF9uYW1lID09IHNlbnNpdGl2aXR5QWRtaW4wPy52YWx1ZSlcbiAgLy8gYWRkIGJsYW5rIHZhbHVlIGFuZCBzb3J0IGFscGhhYmV0aWNhbGx5XG4gIHJldHVybiBbbnVsbCwgLi4uZGF0YS5tYXAoZCA9PiBkLmFkbWluMV9uYW1lKV0ubWFwKGQgPT4ge1xuICAgIHJldHVybiB7bGFiZWw6IGQsIHZhbHVlOiBkfVxuICB9KS5zb3J0KChhLCBiKSA9PiB7XG4gICAgLy8gS2VlcCBudWxsL2JsYW5rIHZhbHVlIGF0IHRoZSB0b3BcbiAgICBpZiAoYS52YWx1ZSA9PT0gbnVsbCkgcmV0dXJuIC0xO1xuICAgIGlmIChiLnZhbHVlID09PSBudWxsKSByZXR1cm4gMTtcbiAgICAvLyBTb3J0IG90aGVycyBhbHBoYWJldGljYWxseSBieSBsYWJlbFxuICAgIHJldHVybiBhLmxhYmVsLmxvY2FsZUNvbXBhcmUoYi5sYWJlbCk7XG4gIH0pXG59XG5cblxuc2Vuc2l0aXZpdHlEYXRhQWRtaW4yID0ge1xuICBjb25zdCBkYXRhID0gYm91bmRhcmllcy5hZG1pbjIuZmVhdHVyZXMubWFwKGQgPT4gZC5wcm9wZXJ0aWVzKVxuICAuZmlsdGVyKGQgPT4gZC5hZG1pbjBfbmFtZSA9PSBzZW5zaXRpdml0eUFkbWluMD8udmFsdWUgJiYgZC5hZG1pbjFfbmFtZSA9PSBzZW5zaXRpdml0eUFkbWluMT8udmFsdWUpXG4gIC8vIGFkZCBibGFuayB2YWx1ZSBhbmQgc29ydCBhbHBoYWJldGljYWxseVxuICByZXR1cm4gW251bGwsIC4uLmRhdGEubWFwKGQgPT4gZC5hZG1pbjJfbmFtZSldLm1hcChkID0+IHtcbiAgICByZXR1cm4ge2xhYmVsOiBkLCB2YWx1ZTogZH1cbiAgfSkuc29ydCgoYSwgYikgPT4ge1xuICAgIC8vIEtlZXAgbnVsbC9ibGFuayB2YWx1ZSBhdCB0aGUgdG9wXG4gICAgaWYgKGEudmFsdWUgPT09IG51bGwpIHJldHVybiAtMTtcbiAgICBpZiAoYi52YWx1ZSA9PT0gbnVsbCkgcmV0dXJuIDE7XG4gICAgLy8gU29ydCBvdGhlcnMgYWxwaGFiZXRpY2FsbHkgYnkgbGFiZWxcbiAgICByZXR1cm4gYS5sYWJlbC5sb2NhbGVDb21wYXJlKGIubGFiZWwpO1xuICB9KVxufVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0xMCIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6ImNvbXBvc2l0ZURhdGFBZG1pbjAgPSB7XG4gIGNvbnN0IGRhdGEgPSBib3VuZGFyaWVzLmFkbWluMC5mZWF0dXJlcy5tYXAoZCA9PiBkLnByb3BlcnRpZXMpXG4gIC8vIGFkZCBhIGJsYW5rIHZhbHVlIGFuZCBzb3J0IGFscGhhYmV0aWNhbGx5XG4gIHJldHVybiBbbnVsbCwgLi4uZGF0YS5tYXAoZCA9PiBkLmFkbWluMF9uYW1lKV0ubWFwKGQgPT4ge1xuICAgIHJldHVybiB7bGFiZWw6IGQgPT0gbnVsbCA/IGdsb2JhbFNlbGVjdGlvbi5sYWJlbCA6IGQsIHZhbHVlOiBkIHx8IFwiU1NBXCJ9XG4gIH0pLnNvcnQoKGEsIGIpID0+IHtcbiAgICAvLyBLZWVwIG51bGwvYmxhbmsgdmFsdWUgYXQgdGhlIHRvcFxuICAgIGlmIChhLnZhbHVlID09PSBcIlNTQVwiKSByZXR1cm4gLTE7XG4gICAgaWYgKGIudmFsdWUgPT09IFwiU1NBXCIpIHJldHVybiAxO1xuICAgIC8vIFNvcnQgb3RoZXJzIGFscGhhYmV0aWNhbGx5IGJ5IGxhYmVsXG4gICAgcmV0dXJuIGEubGFiZWwubG9jYWxlQ29tcGFyZShiLmxhYmVsKTtcbiAgfSlcbn1cblxuXG5jb21wb3NpdGVEYXRhQWRtaW4xID0ge1xuICAvLyBhZG1pbiAxLCBmaWx0ZXIgYnkgMCBcbiAgY29uc3QgZGF0YSA9IGJvdW5kYXJpZXMuYWRtaW4xLmZlYXR1cmVzLm1hcChkID0+IGQucHJvcGVydGllcylcbiAgLy8gTm90ZTogY29tcG9zaXRlQWRtaW4wIHdpbGwgYmUgYXZhaWxhYmxlIHdoZW4gdGhpcyBmdW5jdGlvbiBpcyBjYWxsZWQgZnJvbSBjb21wb3NpdGUgc2VjdGlvblxuICAvLyBhZGQgYmxhbmsgdmFsdWUgYW5kIHNvcnQgYWxwaGFiZXRpY2FsbHlcbiAgcmV0dXJuIFtudWxsLCAuLi5kYXRhLm1hcChkID0+IGQuYWRtaW4xX25hbWUpXS5tYXAoZCA9PiB7XG4gICAgcmV0dXJuIHtsYWJlbDogZCwgdmFsdWU6IGR9XG4gIH0pLnNvcnQoKGEsIGIpID0+IHtcbiAgICAvLyBLZWVwIG51bGwvYmxhbmsgdmFsdWUgYXQgdGhlIHRvcFxuICAgIGlmIChhLnZhbHVlID09PSBudWxsKSByZXR1cm4gLTE7XG4gICAgaWYgKGIudmFsdWUgPT09IG51bGwpIHJldHVybiAxO1xuICAgIC8vIFNvcnQgb3RoZXJzIGFscGhhYmV0aWNhbGx5IGJ5IGxhYmVsXG4gICAgcmV0dXJuIGEubGFiZWwubG9jYWxlQ29tcGFyZShiLmxhYmVsKTtcbiAgfSlcbn1cblxuXG5jb21wb3NpdGVEYXRhQWRtaW4yID0ge1xuICBjb25zdCBkYXRhID0gYm91bmRhcmllcy5hZG1pbjIuZmVhdHVyZXMubWFwKGQgPT4gZC5wcm9wZXJ0aWVzKVxuICAvLyBOb3RlOiBjb21wb3NpdGVBZG1pbjAgYW5kIGNvbXBvc2l0ZUFkbWluMSB3aWxsIGJlIGF2YWlsYWJsZSB3aGVuIHRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIGZyb20gY29tcG9zaXRlIHNlY3Rpb25cbiAgLy8gYWRkIGJsYW5rIHZhbHVlIGFuZCBzb3J0IGFscGhhYmV0aWNhbGx5XG4gIHJldHVybiBbbnVsbCwgLi4uZGF0YS5tYXAoZCA9PiBkLmFkbWluMl9uYW1lKV0ubWFwKGQgPT4ge1xuICAgIHJldHVybiB7bGFiZWw6IGQsIHZhbHVlOiBkfVxuICB9KS5zb3J0KChhLCBiKSA9PiB7XG4gICAgLy8gS2VlcCBudWxsL2JsYW5rIHZhbHVlIGF0IHRoZSB0b3BcbiAgICBpZiAoYS52YWx1ZSA9PT0gbnVsbCkgcmV0dXJuIC0xO1xuICAgIGlmIChiLnZhbHVlID09PSBudWxsKSByZXR1cm4gMTtcbiAgICAvLyBTb3J0IG90aGVycyBhbHBoYWJldGljYWxseSBieSBsYWJlbFxuICAgIHJldHVybiBhLmxhYmVsLmxvY2FsZUNvbXBhcmUoYi5sYWJlbCk7XG4gIH0pXG59XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTExIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiYWRhcHRpdmVDYXBhY2l0eURhdGFBZG1pbjAgPSB7XG4gIGNvbnN0IGRhdGEgPSBib3VuZGFyaWVzLmFkbWluMC5mZWF0dXJlcy5tYXAoZCA9PiBkLnByb3BlcnRpZXMpXG4gIC8vIGFkZCBhIGJsYW5rIHZhbHVlIGFuZCBzb3J0IGFscGhhYmV0aWNhbGx5XG4gIHJldHVybiBbbnVsbCwgLi4uZGF0YS5tYXAoZCA9PiBkLmFkbWluMF9uYW1lKV0ubWFwKGQgPT4ge1xuICAgcmV0dXJuIHtsYWJlbDogZCA9PSBudWxsID8gZ2xvYmFsU2VsZWN0aW9uLmxhYmVsIDogZCwgdmFsdWU6IGQgfHwgXCJTU0FcIn1cbiAgfSkuc29ydCgoYSwgYikgPT4ge1xuICAgIC8vIEtlZXAgbnVsbC9ibGFuayB2YWx1ZSBhdCB0aGUgdG9wXG4gICAgaWYgKGEudmFsdWUgPT09IFwiU1NBXCIpIHJldHVybiAtMTtcbiAgICBpZiAoYi52YWx1ZSA9PT0gXCJTU0FcIikgcmV0dXJuIDE7XG4gICAgLy8gU29ydCBvdGhlcnMgYWxwaGFiZXRpY2FsbHkgYnkgbGFiZWxcbiAgICByZXR1cm4gYS5sYWJlbC5sb2NhbGVDb21wYXJlKGIubGFiZWwpO1xuICB9KVxufVxuXG5cbmFkYXB0aXZlQ2FwYWNpdHlEYXRhQWRtaW4xID0ge1xuICAvLyBhZG1pbiAxLCBmaWx0ZXIgYnkgMCBcbiAgY29uc3QgZGF0YSA9IGJvdW5kYXJpZXMuYWRtaW4xLmZlYXR1cmVzLm1hcChkID0+IGQucHJvcGVydGllcylcbiAgLmZpbHRlcihkID0+IGQuYWRtaW4wX25hbWUgPT0gYWRhcHRpdmVDYXBhY2l0eUFkbWluMD8udmFsdWUpXG4gIC8vIGFkZCBibGFuayB2YWx1ZSBhbmQgc29ydCBhbHBoYWJldGljYWxseVxuICByZXR1cm4gW251bGwsIC4uLmRhdGEubWFwKGQgPT4gZC5hZG1pbjFfbmFtZSldLm1hcChkID0+IHtcbiAgICByZXR1cm4ge2xhYmVsOiBkLCB2YWx1ZTogZH1cbiAgfSkuc29ydCgoYSwgYikgPT4ge1xuICAgIC8vIEtlZXAgbnVsbC9ibGFuayB2YWx1ZSBhdCB0aGUgdG9wXG4gICAgaWYgKGEudmFsdWUgPT09IG51bGwpIHJldHVybiAtMTtcbiAgICBpZiAoYi52YWx1ZSA9PT0gbnVsbCkgcmV0dXJuIDE7XG4gICAgLy8gU29ydCBvdGhlcnMgYWxwaGFiZXRpY2FsbHkgYnkgbGFiZWxcbiAgICByZXR1cm4gYS5sYWJlbC5sb2NhbGVDb21wYXJlKGIubGFiZWwpO1xuICB9KVxufVxuXG5cbmFkYXB0aXZlQ2FwYWNpdHlEYXRhQWRtaW4yID0ge1xuICBjb25zdCBkYXRhID0gYm91bmRhcmllcy5hZG1pbjIuZmVhdHVyZXMubWFwKGQgPT4gZC5wcm9wZXJ0aWVzKVxuICAuZmlsdGVyKGQgPT4gZC5hZG1pbjBfbmFtZSA9PSBhZGFwdGl2ZUNhcGFjaXR5QWRtaW4wPy52YWx1ZSAmJiBkLmFkbWluMV9uYW1lID09IGFkYXB0aXZlQ2FwYWNpdHlBZG1pbjE/LnZhbHVlKVxuICAvLyBhZGQgYmxhbmsgdmFsdWUgYW5kIHNvcnQgYWxwaGFiZXRpY2FsbHlcbiAgcmV0dXJuIFtudWxsLCAuLi5kYXRhLm1hcChkID0+IGQuYWRtaW4yX25hbWUpXS5tYXAoZCA9PiB7XG4gICAgcmV0dXJuIHtsYWJlbDogZCwgdmFsdWU6IGR9XG4gIH0pLnNvcnQoKGEsIGIpID0+IHtcbiAgICAvLyBLZWVwIG51bGwvYmxhbmsgdmFsdWUgYXQgdGhlIHRvcFxuICAgIGlmIChhLnZhbHVlID09PSBudWxsKSByZXR1cm4gLTE7XG4gICAgaWYgKGIudmFsdWUgPT09IG51bGwpIHJldHVybiAxO1xuICAgIC8vIFNvcnQgb3RoZXJzIGFscGhhYmV0aWNhbGx5IGJ5IGxhYmVsXG4gICAgcmV0dXJuIGEubGFiZWwubG9jYWxlQ29tcGFyZShiLmxhYmVsKTtcbiAgfSlcbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMTIiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiIvLyBVdGlsaXR5IGZ1bmN0aW9ucyBmb3IgZGF0YSBiaW5kaW5nIGFuZCBmb3JtYXR0aW5nXG4vKipcbiAqIEJpbmQgdGFidWxhciBkYXRhIHRvIGdlb2dyYXBoaWMgZmVhdHVyZXMgYnkgbWF0Y2hpbmcgdmFsdWVzIGluIHNwZWNpZmllZCBjb2x1bW5zXG4gKiBcbiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIC0gQ29uZmlndXJhdGlvbiBvYmplY3RcbiAqIEBwYXJhbSB7QXJyYXl9IG9wdGlvbnMuZGF0YSAtIEFycmF5IG9mIHRhYnVsYXIgZGF0YSBvYmplY3RzIHRvIGJpbmRcbiAqIEBwYXJhbSB7c3RyaW5nfSBvcHRpb25zLmRhdGFCaW5kQ29sdW1uIC0gQ29sdW1uIG5hbWUgaW4gdGFidWxhciBkYXRhIHRvIHVzZSBmb3IgbWF0Y2hpbmdcbiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zLmdlb0RhdGEgLSBHZW9KU09OIEZlYXR1cmVDb2xsZWN0aW9uIHRvIGJpbmQgZGF0YSB0b1xuICogQHBhcmFtIHtzdHJpbmd9IG9wdGlvbnMuZ2VvRGF0YUJpbmRDb2x1bW4gLSBQcm9wZXJ0eSBuYW1lIGluIGdlbyBmZWF0dXJlcyB0byBtYXRjaCBhZ2FpbnN0XG4gKiBAcmV0dXJucyB7T2JqZWN0fSBHZW9KU09OIEZlYXR1cmVDb2xsZWN0aW9uIHdpdGggZGF0YSBib3VuZCB0byBlYWNoIGZlYXR1cmUncyBwcm9wZXJ0aWVzLmRhdGFcbiAqIFxuICogQGV4YW1wbGVcbiAqIGNvbnN0IGdlb1dpdGhEYXRhID0gYmluZFRhYnVsYXJUb0dlbyh7XG4gKiAgIGRhdGE6IFt7YWRtaW4wX25hbWU6IFwiS2VueWFcIiwgdmFsdWU6IDEwMH1dLFxuICogICBkYXRhQmluZENvbHVtbjogXCJhZG1pbjBfbmFtZVwiLFxuICogICBnZW9EYXRhOiBib3VuZGFyaWVzLmFkbWluMCxcbiAqICAgZ2VvRGF0YUJpbmRDb2x1bW46IFwiYWRtaW4wX25hbWVcIlxuICogfSk7XG4gKi9cbmZ1bmN0aW9uIGJpbmRUYWJ1bGFyVG9HZW8oe1xuICBkYXRhID0gW10sXG4gIGRhdGFCaW5kQ29sdW1uID0gXCJkYXRhQmluZENvbHVtblwiLFxuICBnZW9EYXRhID0gW10sXG4gIGdlb0RhdGFCaW5kQ29sdW1uID0gXCJnZW9EYXRhQmluZENvbHVtblwiLFxufSkge1xuICBjb25zdCBpbmRleCA9IG5ldyBNYXAoZGF0YS5tYXAoKGQpID0+IFtkW2RhdGFCaW5kQ29sdW1uXSwgZF0pKTtcbiAgY29uc3QgZ2VvanNvbiA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZ2VvRGF0YSkpO1xuXG4gIGZvciAoY29uc3QgZiBvZiBnZW9qc29uLmZlYXR1cmVzKSB7XG4gICAgZi5wcm9wZXJ0aWVzLmRhdGEgPSBpbmRleC5nZXQoZi5wcm9wZXJ0aWVzW2dlb0RhdGFCaW5kQ29sdW1uXSk7XG4gIH1cbiAgcmV0dXJuIGdlb2pzb247XG59XG5cbi8qKlxuICogR2V0IHRoZSBtb3N0IGdyYW51bGFyIGFkbWluIHNlbGVjdGlvbiBmcm9tIGFkbWluIGxldmVsIHNlbGVjdG9yc1xuICogXG4gKiBAcGFyYW0ge09iamVjdH0gYWRtaW4wIC0gQWRtaW4wIHNlbGVjdG9yIG9iamVjdCB3aXRoIC52YWx1ZSBwcm9wZXJ0eVxuICogQHBhcmFtIHtPYmplY3R9IGFkbWluMSAtIEFkbWluMSBzZWxlY3RvciBvYmplY3Qgd2l0aCAudmFsdWUgcHJvcGVydHlcbiAqIEBwYXJhbSB7T2JqZWN0fSBhZG1pbjIgLSBBZG1pbjIgc2VsZWN0b3Igb2JqZWN0IHdpdGggLnZhbHVlIHByb3BlcnR5XG4gKiBAcGFyYW0ge3N0cmluZ30gZ2xvYmFsTGFiZWwgLSBEZWZhdWx0IGxhYmVsIHdoZW4gbm8gc2VsZWN0aW9uIGlzIG1hZGUgKGRlZmF1bHQ6IFwiU3ViLVNhaGFyYW4gQWZyaWNhXCIpXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgbW9zdCBzcGVjaWZpYyBhZG1pbiBsZXZlbCBzZWxlY3RlZCwgb3IgZ2xvYmFsTGFiZWwgaWYgbm9uZSBzZWxlY3RlZFxuICogXG4gKiBAZXhhbXBsZVxuICogZ2V0QWRtaW5TZWxlY3Rpb24oc2VsZWN0QWRtaW4wLCBzZWxlY3RBZG1pbjEsIHNlbGVjdEFkbWluMilcbiAqL1xuZnVuY3Rpb24gZ2V0QWRtaW5TZWxlY3Rpb24oYWRtaW4wLCBhZG1pbjEsIGFkbWluMiwgZ2xvYmFsTGFiZWwgPSBcIlN1Yi1TYWhhcmFuIEFmcmljYVwiKSB7XG4gIGNvbnN0IGEwID0gYWRtaW4wPy52YWx1ZTtcbiAgY29uc3QgYTEgPSBhZG1pbjE/LnZhbHVlO1xuICBjb25zdCBhMiA9IGFkbWluMj8udmFsdWU7XG5cbiAgcmV0dXJuIGEyID8gYTIgOiBhMSA/IGExIDogYTAgPyBhMCA6IGdsb2JhbExhYmVsO1xufVxuXG4vLyBDb252ZW5pZW5jZSB3cmFwcGVycyBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eVxuZnVuY3Rpb24gZ2V0RXhwb3N1cmVBZG1pblNlbGVjdGlvbigpIHtcbiAgcmV0dXJuIGdldEFkbWluU2VsZWN0aW9uKHNlbGVjdEFkbWluMCwgc2VsZWN0QWRtaW4xLCBzZWxlY3RBZG1pbjIpO1xufVxuXG5mdW5jdGlvbiBnZXRTZW5zaXRpdml0eUFkbWluU2VsZWN0aW9uKCkge1xuICByZXR1cm4gZ2V0QWRtaW5TZWxlY3Rpb24oc2Vuc2l0aXZpdHlBZG1pbjAsIHNlbnNpdGl2aXR5QWRtaW4xLCBzZW5zaXRpdml0eUFkbWluMik7XG59XG5cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMTMiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiIvLyBGb3JtYXR0aW5nIHV0aWxpdGllc1xuLyoqXG4gKiBGb3JtYXQgbnVtYmVyIGFzIGNvbXBhY3QgY3VycmVuY3kgKGUuZy4sIFwiJDEuMk1cIilcbiAqL1xuZm9ybWF0TnVtQ29tcGFjdFNob3J0ID0gbmV3IEludGwuTnVtYmVyRm9ybWF0KFwiZW4tVVNcIiwge1xuICBub3RhdGlvbjogXCJjb21wYWN0XCIsXG4gIGNvbXBhY3REaXNwbGF5OiBcInNob3J0XCIsXG4gIHN0eWxlOiBcImN1cnJlbmN5XCIsXG4gIGN1cnJlbmN5OiBcIlVTRFwiLFxufSkuZm9ybWF0O1xuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0xNCIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Ii8vIENvbG9yIHNjYWxlcyBhbmQgdGhlbWVzXG4vKipcbiAqIENvbG9yIHNjYWxlIGRlZmluaXRpb25zIGZvciB2aXN1YWxpemF0aW9uc1xuICovXG5jb2xvclNjYWxlcyA9IHtcbiAgcmV0dXJuIHtcbiAgICByYW5nZToge1xuICAgICAgZ3JlZW46IFsnI0U0RjVEMCcsICcjMDE1MDIzJ10sXG4gICAgICBibHVlOiBbJyNFOEYyRkYnLCAnIzAwM0U2QiddLFxuICAgICAgYnJvd246IFsnI0ZGRkRFNScsICcjQTg3QjAwJ10sXG4gICAgICB5ZWxsb3dHcmVlbjogWycjMjE2NzI5JywgJyNGN0Q3MzInXSwgLy8gUmV2ZXJzZWQ6IGdyZWVuIChsb3cvZ29vZCkgdG8geWVsbG93IChoaWdoL2JhZClcbiAgICAgIG9yYW5nZVJlZDogWycjRjRCQjIxJywgJyNFQzVBNDcnXSxcbiAgICAgIHJlZE9yYW5nZTogWycjRkVFMEQyJywgJyNDQjQzMzUnXSxcbiAgICAgIHZ1bG5lcmFiaWxpdHk6IFsnIzJFOEI1NycsICcjRkZENzAwJywgJyNGRjYzNDcnXSwgLy8gTG93LCBNZWRpdW0sIEhpZ2hcbiAgICAgIGFkYXB0aXZlOiBbJyNGRjZCNkInLCAnIzRFQ0RDNCcsICcjNDVCN0QxJ10gLy8gUG9vciwgRmFpciwgR29vZFxuICAgIH0sXG4gICAgdW5rbm93bjogXCIjZjBmMGYwXCIsXG4gICAgbm9EYXRhOiBcIiNmMGYwZjBcIlxuICB9XG59XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTE1IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiLy8gQ29uc3RhbnRzIGFuZCBtZXRhZGF0YVxuaW50RG9sbGFyVW5pdCA9IGAke2ludERvbGxhclllYXJ9IFVTRGBcbmludERvbGxhclllYXIgPSAyMDE1XG5cbi8qKlxuICogVmFsdWUgb2YgUHJvZHVjdGlvbiAoVm9QKSBub3RlIGNvbmZpZ3VyYXRpb25cbiAqL1xudm9wTm90ZSA9IHtcbiAgcmV0dXJuIHtcbiAgICBjYXB0aW9uOiBfbGFuZyh2dWxuZXJhYmlsaXR5X3RyYW5zbGF0aW9ucy52b3BOb3RlQ2FwdGlvbiksXG4gICAgYmx1cmI6IF9sYW5nKHZ1bG5lcmFiaWxpdHlfdHJhbnNsYXRpb25zLnZvcE5vdGVCbHVyYilcbiAgfVxufVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0xNiIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Ii8qKlxuICogQ3JlYXRlIGEgbG9hZGluZyBzdGF0ZSBVSSBjb21wb25lbnRcbiAqIFxuICogQHBhcmFtIHtzdHJpbmd8bnVsbH0gbWVzc2FnZSAtIE9wdGlvbmFsIGxvYWRpbmcgbWVzc2FnZSAoZGVmYXVsdHMgdG8gdHJhbnNsYXRpb24pXG4gKiBAcmV0dXJucyB7SFRNTEVsZW1lbnR9IEhUTUwgZWxlbWVudCB3aXRoIGxvYWRpbmcgc3Bpbm5lciBhbmQgbWVzc2FnZVxuICovXG5mdW5jdGlvbiBjcmVhdGVMb2FkaW5nU3RhdGUobWVzc2FnZSA9IG51bGwpIHtcbiAgcmV0dXJuIGh0bC5odG1sYFxuICAgIDxkaXYgc3R5bGU9XCJcbiAgICAgIGRpc3BsYXk6IGZsZXg7XG4gICAgICBhbGlnbi1pdGVtczogY2VudGVyO1xuICAgICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7XG4gICAgICBwYWRkaW5nOiA0MHB4O1xuICAgICAgY29sb3I6ICM2YjcyODA7XG4gICAgICBmb250LXN0eWxlOiBpdGFsaWM7XG4gICAgXCI+XG4gICAgICA8ZGl2IHN0eWxlPVwibWFyZ2luLXJpZ2h0OiAxMnB4O1wiPlxuICAgICAgICA8ZGl2IGNsYXNzPVwic3Bpbm5lclwiIHN0eWxlPVwiXG4gICAgICAgICAgd2lkdGg6IDIwcHg7XG4gICAgICAgICAgaGVpZ2h0OiAyMHB4O1xuICAgICAgICAgIGJvcmRlcjogMnB4IHNvbGlkICNlNWU3ZWI7XG4gICAgICAgICAgYm9yZGVyLXRvcDogMnB4IHNvbGlkICMzYjgyZjY7XG4gICAgICAgICAgYm9yZGVyLXJhZGl1czogNTAlO1xuICAgICAgICAgIGFuaW1hdGlvbjogc3BpbiAxcyBsaW5lYXIgaW5maW5pdGU7XG4gICAgICAgIFwiPjwvZGl2PlxuICAgICAgPC9kaXY+XG4gICAgICAke21lc3NhZ2UgfHwgX2xhbmcodnVsbmVyYWJpbGl0eV90cmFuc2xhdGlvbnMubG9hZGluZyl9XG4gICAgPC9kaXY+XG4gICAgPHN0eWxlPlxuICAgICAgQGtleWZyYW1lcyBzcGluIHtcbiAgICAgICAgMCUgeyB0cmFuc2Zvcm06IHJvdGF0ZSgwZGVnKTsgfVxuICAgICAgICAxMDAlIHsgdHJhbnNmb3JtOiByb3RhdGUoMzYwZGVnKTsgfVxuICAgICAgfVxuICAgIDwvc3R5bGU+XG4gIGA7XG59XG5cbi8qKlxuICogQ3JlYXRlIGEgXCJubyBkYXRhIGF2YWlsYWJsZVwiIHN0YXRlIFVJIGNvbXBvbmVudFxuICogXG4gKiBAcGFyYW0ge3N0cmluZ3xudWxsfSBtZXNzYWdlIC0gT3B0aW9uYWwgbWVzc2FnZSAoZGVmYXVsdHMgdG8gdHJhbnNsYXRpb24pXG4gKiBAcmV0dXJucyB7SFRNTEVsZW1lbnR9IEhUTUwgZWxlbWVudCB3aXRoIG5vLWRhdGEgZGlzcGxheVxuICovXG5mdW5jdGlvbiBjcmVhdGVOb0RhdGFTdGF0ZShtZXNzYWdlID0gbnVsbCkge1xuICByZXR1cm4gaHRsLmh0bWxgXG4gICAgPGRpdiBzdHlsZT1cIlxuICAgICAgZGlzcGxheTogZmxleDtcbiAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7XG4gICAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjtcbiAgICAgIHBhZGRpbmc6IDQwcHg7XG4gICAgICBiYWNrZ3JvdW5kOiAjZjlmYWZiO1xuICAgICAgYm9yZGVyOiAycHggZGFzaGVkICNkMWQ1ZGI7XG4gICAgICBib3JkZXItcmFkaXVzOiA4cHg7XG4gICAgICBjb2xvcjogIzZiNzI4MDtcbiAgICAgIHRleHQtYWxpZ246IGNlbnRlcjtcbiAgICAgIG1hcmdpbi10b3A6IDE2cHg7XG4gICAgXCI+XG4gICAgICA8ZGl2PlxuICAgICAgICA8ZGl2IHN0eWxlPVwibWFyZ2luLWJvdHRvbTogOHB4OyBmb250LXNpemU6IDE4cHg7XCI+8J+TijwvZGl2PlxuICAgICAgICA8ZGl2PiR7bWVzc2FnZSB8fCBfbGFuZyh2dWxuZXJhYmlsaXR5X3RyYW5zbGF0aW9ucy5ub19kYXRhX2F2YWlsYWJsZSl9PC9kaXY+XG4gICAgICA8L2Rpdj5cbiAgICA8L2Rpdj5cbiAgYDtcbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMTciLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiIvLyBJbnNpZ2h0IGdlbmVyYXRpb24gdXRpbGl0aWVzXG4vKipcbiAqIEdlbmVyYXRlIGR5bmFtaWMgaW5zaWdodHMgYnkgcmVwbGFjaW5nIHRlbXBsYXRlIHBsYWNlaG9sZGVycyB3aXRoIGFjdHVhbCB2YWx1ZXNcbiAqIFxuICogQHBhcmFtIHtzdHJpbmd9IHRlbXBsYXRlIC0gVGVtcGxhdGUgc3RyaW5nIHdpdGggcGxhY2Vob2xkZXJzIChlLmcuLCBcIntyZWdpb259XCIsIFwie2Ftb3VudH1cIilcbiAqIEBwYXJhbSB7QXJyYXk8T2JqZWN0Pn0gcmVwbGFjZW1lbnRzIC0gQXJyYXkgb2Yge25hbWUsIHZhbHVlfSBvYmplY3RzIGZvciByZXBsYWNlbWVudFxuICogQHJldHVybnMge3N0cmluZ30gVGVtcGxhdGUgd2l0aCBhbGwgcGxhY2Vob2xkZXJzIHJlcGxhY2VkXG4gKiBcbiAqIEBleGFtcGxlXG4gKiBnZW5lcmF0ZUluc2lnaHQoXCJJbiB7cmVnaW9ufSwgZXhwb3N1cmUgaXMge2Ftb3VudH1cIiwgW1xuICogICB7bmFtZTogXCJyZWdpb25cIiwgdmFsdWU6IFwiS2VueWFcIn0sXG4gKiAgIHtuYW1lOiBcImFtb3VudFwiLCB2YWx1ZTogXCIkMS4yTVwifVxuICogXSlcbiAqL1xuZnVuY3Rpb24gZ2VuZXJhdGVJbnNpZ2h0KHRlbXBsYXRlLCByZXBsYWNlbWVudHMpIHtcbiAgcmV0dXJuIExhbmcucmVkdWNlUmVwbGFjZVRlbXBsYXRlSXRlbXModGVtcGxhdGUsIHJlcGxhY2VtZW50cyk7XG59XG5cbi8qKlxuICogQ3JlYXRlIGEgc3R5bGVkIGluc2lnaHQgZGlzcGxheSBjb21wb25lbnQgZnJvbSB0ZXh0IG9yIEhUTUxcbiAqIEhhbmRsZXMgYm90aCBwbGFpbiB0ZXh0ICh3aXRoIHBhcmFncmFwaCBzcGxpdHRpbmcpIGFuZCBIVE1MIGVsZW1lbnRzXG4gKiBcbiAqIEBwYXJhbSB7c3RyaW5nfEhUTUxFbGVtZW50fSBpbnNpZ2h0IC0gSW5zaWdodCB0ZXh0IG9yIEhUTUwgZWxlbWVudCB0byBkaXNwbGF5XG4gKiBAcmV0dXJucyB7SFRNTEVsZW1lbnR9IFN0eWxlZCBIVE1MIGVsZW1lbnQgd2l0aCBpbnNpZ2h0IGNvbnRlbnRcbiAqL1xuZnVuY3Rpb24gY3JlYXRlSW5zaWdodERpc3BsYXkoaW5zaWdodCkge1xuICAvLyBIYW5kbGUgY2FzZSB3aGVyZSBpbnNpZ2h0IGlzIGFscmVhZHkgYW4gSFRNTCBlbGVtZW50IChmcm9tIGh0bC5odG1sKVxuICBpZiAodHlwZW9mIGluc2lnaHQgIT09IFwic3RyaW5nXCIpIHtcbiAgICAvLyBJZiBpdCdzIGFscmVhZHkgYW4gSFRNTCBlbGVtZW50LCBqdXN0IHdyYXAgaXQgaW4gdGhlIHN0YW5kYXJkIGRpc3BsYXlcbiAgICByZXR1cm4gaHRsLmh0bWxgXG4gICAgICA8ZGl2IHN0eWxlPVwiXG4gICAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsICM2NjdlZWEgMCUsICM3NjRiYTIgMTAwJSk7XG4gICAgICAgIGNvbG9yOiB3aGl0ZTtcbiAgICAgICAgcGFkZGluZzogMjBweDtcbiAgICAgICAgYm9yZGVyLXJhZGl1czogMTBweDtcbiAgICAgICAgbWFyZ2luOiAxNnB4IDA7XG4gICAgICAgIGJveC1zaGFkb3c6IDAgNHB4IDZweCByZ2JhKDAsIDAsIDAsIDAuMSk7XG4gICAgICBcIj5cbiAgICAgICAgPGg0IHN0eWxlPVwibWFyZ2luOiAwIDAgMTJweCAwOyBmb250LXNpemU6IDE2cHg7IGZvbnQtd2VpZ2h0OiA2MDA7XCI+XG4gICAgICAgICAgJHtfbGFuZyh2dWxuZXJhYmlsaXR5X3RyYW5zbGF0aW9ucy5xdWlja19pbnNpZ2h0cyl9XG4gICAgICAgIDwvaDQ+XG4gICAgICAgIDxkaXYgc3R5bGU9XCJtYXJnaW46IDA7IGZvbnQtc2l6ZTogMThweDsgbGluZS1oZWlnaHQ6IDEuNTsgb3BhY2l0eTogMC45NTtcIj5cbiAgICAgICAgICAke2luc2lnaHR9XG4gICAgICAgIDwvZGl2PlxuICAgICAgPC9kaXY+XG4gICAgYDtcbiAgfVxuXG4gIC8vIFNwbGl0IGluc2lnaHQgaW50byBwYXJhZ3JhcGhzIGJhc2VkIG9uIGRvdWJsZSBuZXdsaW5lcyBhbmQgcHJvY2VzcyBlYWNoXG4gIGNvbnN0IHBhcmFncmFwaHMgPSBpbnNpZ2h0LnNwbGl0KFwiXFxuXFxuXCIpLmZpbHRlcigocCkgPT4gcC50cmltKCkubGVuZ3RoID4gMCk7XG5cbiAgLy8gQ3JlYXRlIEhUTUwgZWxlbWVudHMgdXNpbmcgaHRsLmh0bWwgZm9yIHByb3BlciByZW5kZXJpbmdcbiAgY29uc3QgcGFyYWdyYXBoRWxlbWVudHMgPSBwYXJhZ3JhcGhzXG4gICAgLm1hcCgocGFyYWdyYXBoKSA9PiB7XG4gICAgICAvLyBIYW5kbGUgc3BlY2lhbCBmb3JtYXR0aW5nIGZvciBzZWN0aW9uIGhlYWRlcnNcbiAgICAgIGlmIChwYXJhZ3JhcGguc3RhcnRzV2l0aChcIvCfk40gU2VsZWN0ZWQgR3JvdXA6XCIpKSB7XG4gICAgICAgIGNvbnN0IGNvbnRlbnQgPSBwYXJhZ3JhcGgucmVwbGFjZShcIvCfk40gU2VsZWN0ZWQgR3JvdXA6XCIsIFwiXCIpLnRyaW0oKTtcbiAgICAgICAgcmV0dXJuIGh0bC5odG1sYDxkaXYgc3R5bGU9XCJcbiAgICAgICAgYmFja2dyb3VuZDogcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjE1KTtcbiAgICAgICAgcGFkZGluZzogMTJweDtcbiAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4O1xuICAgICAgICBtYXJnaW4tYm90dG9tOiAxNnB4O1xuICAgICAgICBib3JkZXItbGVmdDogNHB4IHNvbGlkICNmZmQ3MDA7XG4gICAgICBcIj5cbiAgICAgICAgPGRpdiBzdHlsZT1cImZvbnQtd2VpZ2h0OiBib2xkOyBtYXJnaW4tYm90dG9tOiA4cHg7XCI+8J+TjSBTZWxlY3RlZCBHcm91cDwvZGl2PlxuICAgICAgICA8ZGl2IHN0eWxlPVwiZm9udC1zaXplOiAxNnB4O1wiPiR7Y29udGVudH08L2Rpdj5cbiAgICAgIDwvZGl2PmA7XG4gICAgICB9IGVsc2UgaWYgKHBhcmFncmFwaC5zdGFydHNXaXRoKFwiT3ZlcmFsbCBQb3B1bGF0aW9uIEFuYWx5c2lzOlwiKSkge1xuICAgICAgICBjb25zdCBjb250ZW50ID0gcGFyYWdyYXBoXG4gICAgICAgICAgLnJlcGxhY2UoXCJPdmVyYWxsIFBvcHVsYXRpb24gQW5hbHlzaXM6XCIsIFwiXCIpXG4gICAgICAgICAgLnRyaW0oKTtcbiAgICAgICAgcmV0dXJuIGh0bC5odG1sYDxkaXYgc3R5bGU9XCJcbiAgICAgICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4zKTtcbiAgICAgICAgcGFkZGluZy10b3A6IDE2cHg7XG4gICAgICAgIG1hcmdpbi1ib3R0b206IDE2cHg7XG4gICAgICBcIj5cbiAgICAgICAgPGRpdiBzdHlsZT1cImZvbnQtd2VpZ2h0OiBib2xkOyBtYXJnaW4tYm90dG9tOiAxMnB4O1wiPk92ZXJhbGwgUG9wdWxhdGlvbiBBbmFseXNpczwvZGl2PlxuICAgICAgICA8ZGl2IHN0eWxlPVwiZm9udC1zaXplOiAxNnB4OyBsaW5lLWhlaWdodDogMS42O1wiPiR7Y29udGVudH08L2Rpdj5cbiAgICAgIDwvZGl2PmA7XG4gICAgICB9IGVsc2UgaWYgKHBhcmFncmFwaCA9PT0gXCItLS1cIikge1xuICAgICAgICAvLyBTa2lwIHNlcGFyYXRvciBsaW5lc1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIFJlZ3VsYXIgcGFyYWdyYXBoc1xuICAgICAgICByZXR1cm4gaHRsLmh0bWxgPHAgc3R5bGU9XCJtYXJnaW46IDAgMCAxMnB4IDA7IGZvbnQtc2l6ZTogMTZweDsgbGluZS1oZWlnaHQ6IDEuNjsgb3BhY2l0eTogMC45NTtcIj4ke3BhcmFncmFwaH08L3A+YDtcbiAgICAgIH1cbiAgICB9KVxuICAgIC5maWx0ZXIoKHApID0+IHAgIT09IG51bGwpO1xuXG4gIHJldHVybiBodGwuaHRtbGBcbiAgICA8ZGl2IHN0eWxlPVwiXG4gICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAjNjY3ZWVhIDAlLCAjNzY0YmEyIDEwMCUpO1xuICAgICAgY29sb3I6IHdoaXRlO1xuICAgICAgcGFkZGluZzogMjBweDtcbiAgICAgIGJvcmRlci1yYWRpdXM6IDEwcHg7XG4gICAgICBtYXJnaW46IDE2cHggMDtcbiAgICAgIGJveC1zaGFkb3c6IDAgNHB4IDZweCByZ2JhKDAsIDAsIDAsIDAuMSk7XG4gICAgXCI+XG4gICAgICA8aDQgc3R5bGU9XCJtYXJnaW46IDAgMCAxMnB4IDA7IGZvbnQtc2l6ZTogMTZweDsgZm9udC13ZWlnaHQ6IDYwMDtcIj5cbiAgICAgICAgJHtfbGFuZyh2dWxuZXJhYmlsaXR5X3RyYW5zbGF0aW9ucy5xdWlja19pbnNpZ2h0cyl9XG4gICAgICA8L2g0PlxuICAgICAgPGRpdiBzdHlsZT1cIm1hcmdpbjogMDtcIj5cbiAgICAgICAgJHtwYXJhZ3JhcGhFbGVtZW50c31cbiAgICAgIDwvZGl2PlxuICAgIDwvZGl2PlxuICBgO1xufVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0xOCIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Ii8vIEhlcm8gc2VjdGlvbiB3aXRoIGR5bmFtaWMgdGl0bGVcbm5iVGl0bGUgPSBfbGFuZyh2dWxuZXJhYmlsaXR5X3RyYW5zbGF0aW9ucy5ub3RlYm9va190aXRsZSlcblxuXG5cblxuYXRsYXNIZXJvKG5iVGl0bGUsIGhlcm9fdXJsKVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0xOSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Im92ZXJ2aWV3ID0gX2xhbmcodnVsbmVyYWJpbGl0eV90cmFuc2xhdGlvbnMubm90ZWJvb2tfb3ZlcnZpZXcpO1xuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0yMCIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6ImV4cG9zdXJlUXVlc3Rpb24gPSBfbGFuZyh2dWxuZXJhYmlsaXR5X3RyYW5zbGF0aW9ucy5leHBvc3VyZV9xdWVzdGlvbik7XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTIxIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiLy8gRXhwb3N1cmUgc2VjdGlvbiBzZWxlY3RvcnMgLSBmb2xsb3cgc2hhcmVkIHN0YXRlIGxpa2Ugb3RoZXIgc2VjdGlvbnNcbnZpZXdvZiBzZWxlY3RBZG1pbjAgPSBJbnB1dHMuc2VsZWN0KGRhdGFBZG1pbjAsIHtcbiAgbGFiZWw6IGFkbWluUmVnaW9ucy5sYWJlbHMuYWRtaW4wLCBcbiAgZm9ybWF0OiB4ID0+IHgubGFiZWwsXG4gIHZhbHVlOiBkYXRhQWRtaW4wLmZpbmQoZCA9PiBkLnZhbHVlID09PSBzaGFyZWRBZG1pbjApIHx8IChkYXRhQWRtaW4wLmxlbmd0aCA+IDAgPyBkYXRhQWRtaW4wWzBdIDogbnVsbClcbn0pXG52aWV3b2Ygc2VsZWN0QWRtaW4xID0gSW5wdXRzLnNlbGVjdChkYXRhQWRtaW4xLCB7XG4gIGxhYmVsOiBhZG1pblJlZ2lvbnMubGFiZWxzLmFkbWluMSwgXG4gIGZvcm1hdDogeCA9PiB4LmxhYmVsLFxuICB2YWx1ZTogZGF0YUFkbWluMS5maW5kKGQgPT4gZC52YWx1ZSA9PT0gc2hhcmVkQWRtaW4xKSB8fCAoZGF0YUFkbWluMS5sZW5ndGggPiAwID8gZGF0YUFkbWluMVswXSA6IG51bGwpXG59KVxudmlld29mIHNlbGVjdEFkbWluMiA9IElucHV0cy5zZWxlY3QoZGF0YUFkbWluMiwge1xuICBsYWJlbDogYWRtaW5SZWdpb25zLmxhYmVscy5hZG1pbjIsIFxuICBmb3JtYXQ6IHggPT4geC5sYWJlbCxcbiAgdmFsdWU6IGRhdGFBZG1pbjIuZmluZChkID0+IGQudmFsdWUgPT09IHNoYXJlZEFkbWluMikgfHwgKGRhdGFBZG1pbjIubGVuZ3RoID4gMCA/IGRhdGFBZG1pbjJbMF0gOiBudWxsKVxufSlcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMjIiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJleHBvc3VyZUNvbnRyb2xzRm9ybSA9IGh0bC5odG1sYFxuPGRpdiBzdHlsZT1cIlxuICBiYWNrZ3JvdW5kOiAjZjhmYWZjO1xuICBib3JkZXI6IDJweCBzb2xpZCAjZTJlOGYwO1xuICBib3JkZXItcmFkaXVzOiAxMnB4O1xuICBwYWRkaW5nOiAyNHB4O1xuICBib3gtc2hhZG93OiAwIDRweCA2cHggcmdiYSgwLCAwLCAwLCAwLjA3KTtcbiAgbWFyZ2luOiAxNnB4IDA7XG5cIj5cbiAgPGgzIHN0eWxlPVwibWFyZ2luOiAwIDAgMjBweCAwOyBjb2xvcjogIzJkMzc0ODsgZm9udC1zaXplOiAxLjFyZW07IGZvbnQtd2VpZ2h0OiA2MDA7XCI+XG4gICAgJHtfbGFuZyh2dWxuZXJhYmlsaXR5X3RyYW5zbGF0aW9ucy5nZW9ncmFwaGljX3NlbGVjdGlvbil9XG4gIDwvaDM+XG4gIDxkaXYgc3R5bGU9XCJcbiAgICBkaXNwbGF5OiBmbGV4O1xuICAgIGFsaWduLWl0ZW1zOiBmbGV4LXN0YXJ0O1xuICAgIGdhcDogMjBweDtcbiAgICBmbGV4LXdyYXA6IHdyYXA7XG4gICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuO1xuICBcIiBjbGFzcz1cImZvcm0taW5wdXRzLWNvbnRhaW5lclwiPlxuICAgIDxkaXYgc3R5bGU9XCJmbGV4OiAxOyBtaW4td2lkdGg6IDE4MHB4OyBtYXgtd2lkdGg6IDEwMCU7XCI+JHt2aWV3b2Ygc2VsZWN0QWRtaW4wfTwvZGl2PlxuICAgIDxkaXYgc3R5bGU9XCJmbGV4OiAxOyBtaW4td2lkdGg6IDE4MHB4OyBtYXgtd2lkdGg6IDEwMCU7XCI+JHt2aWV3b2Ygc2VsZWN0QWRtaW4xfTwvZGl2PlxuICAgIDxkaXYgc3R5bGU9XCJmbGV4OiAxOyBtaW4td2lkdGg6IDE4MHB4OyBtYXgtd2lkdGg6IDEwMCU7XCI+JHt2aWV3b2Ygc2VsZWN0QWRtaW4yfTwvZGl2PlxuICA8L2Rpdj5cbjwvZGl2PlxuXG5gXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTIzIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiLy8gRGF0YSBsb2FkaW5nIGFuZCBwcm9jZXNzaW5nIHdpdGggY2FjaGluZ1xuZXhwb3N1cmVEYiA9IGF3YWl0IGNyZWF0ZUV4cG9zdXJlREIoKSAvLyBVc2UgY2FjaGVkIGxvYWRpbmdcblxuXG5leHBvc3VyZURhdGEgPSB7XG4gIGlmICghZXhwb3N1cmVEYikgcmV0dXJuIFtdO1xuICBcbiAgdHJ5IHtcbiAgICBjb25zdCBxdWVyeSA9IGBcbiAgICAgIFNFTEVDVCAqXG4gICAgICBGUk9NIGV4cG9zdXJlX2RhdGFcbiAgICAgIFdIRVJFIGhhemFyZCA9ICdhbnknXG4gICAgYDtcbiAgICBcbiAgICByZXR1cm4gYXdhaXQgZXhwb3N1cmVEYi5xdWVyeShxdWVyeSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG59XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTI0IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiLy8gZ3JhYiB0YWJ1bGFyIGRhdGEgZm9yIGNob3JvcGxldGhcbmRhdGFHZW9JbXBhY3QgPSB7XG4gIC8vIENoZWNrIGlmIGV4cG9zdXJlRGF0YSBleGlzdHMgYW5kIGlzIGFuIGFycmF5IGJlZm9yZSBwcm9jZXNzaW5nXG4gIGlmICghZXhwb3N1cmVEYXRhIHx8ICFBcnJheS5pc0FycmF5KGV4cG9zdXJlRGF0YSkpIHtcbiAgICByZXR1cm4gW107XG4gIH1cbiAgXG4gIC8vIGdldCBkYXRhIGZvciBjaG9yb3BsZXRoIG1hcCBiYXNlZCBvbiBjaG9pY2VcbiAgY29uc3QgZGF0YVNvdXJjZSA9IGV4cG9zdXJlRGF0YTtcblxuICBsZXQgZmlsdGVyZWREYXRhO1xuICBcbiAgLy8gc2VsZWN0IGRpZmZlcmVudCBkYXRhIGJhc2VkIG9uIGFkbWluIHNlbGVjdGlvbnMgdXNpbmcgc2hhcmVkIHN0YXRlXG4gIGlmIChzaGFyZWRBZG1pbjEpIHtcbiAgICBmaWx0ZXJlZERhdGEgPSBkYXRhU291cmNlLmZpbHRlcigoZCkgPT4ge1xuICAgICAgcmV0dXJuIGQuYWRtaW4wX25hbWUgPT0gc2hhcmVkQWRtaW4wXG4gICAgICAgICYmIGQuYWRtaW4xX25hbWUgPT0gc2hhcmVkQWRtaW4xXG4gICAgICAgICYmIGQuYWRtaW4yX25hbWUgLy8gYWx3YXlzIG5vbi1udWxsXG4gICAgfSk7XG4gIH0gZWxzZSBpZiAoc2hhcmVkQWRtaW4wKSB7XG4gICAgLy8gYWRtaW4wIGlzIHNlbGVjdGVkLCB3aXRoIG5vIGFkbWluMVxuICAgIC8vIGdldCBhbGwgYWRtaW4xIGRhdGEgZm9yIHNlbGVjdGVkIGFkbWluMFxuICAgIGZpbHRlcmVkRGF0YSA9IGRhdGFTb3VyY2UuZmlsdGVyKChkKSA9PiB7XG4gICAgICByZXR1cm4gZC5hZG1pbjBfbmFtZSA9PSBzaGFyZWRBZG1pbjBcbiAgICAgICAgJiYgZC5hZG1pbjFfbmFtZSAvLyBhbHdheXMgbm9uLW51bGwgXG4gICAgICAgICYmICFkLmFkbWluMl9uYW1lIC8vIGFsd2F5cyBudWxsXG4gICAgfSk7XG4gIH0gZWxzZSB7XG4gICAgLy8gZW5kIGNhc2U6IGFkbWluMCBpcyBub3Qgc2VsZWN0ZWRcbiAgICAvLyBnZXQgYWxsIGFkbWluMCBkYXRhXG4gICAgZmlsdGVyZWREYXRhID0gZGF0YVNvdXJjZS5maWx0ZXIoKGQpID0+IHtcbiAgICAgIHJldHVybiAhZC5hZG1pbjFfbmFtZSAvLyBhbHdheXMgbnVsbCBcbiAgICAgICAgJiYgIWQuYWRtaW4yX25hbWUgLy8gYWx3YXlzIG51bGxcbiAgICB9KTtcbiAgfVxuICBcbiAgLy8gQWdncmVnYXRlIGRhdGEgYnkgc3VtbWluZyB2YWx1ZXMgZm9yIGVhY2ggYWRtaW5pc3RyYXRpdmUgcmVnaW9uXG4gIGlmIChmaWx0ZXJlZERhdGEubGVuZ3RoID09PSAwKSByZXR1cm4gW107XG4gIFxuICAvLyBEZXRlcm1pbmUgZ3JvdXBpbmcga2V5IGJhc2VkIG9uIGFkbWluIGxldmVsXG4gIC8vIEhhbmRsZSBudWxsIHZhbHVlcyBleHBsaWNpdGx5IHRvIGF2b2lkIFwibnVsbFwiIHN0cmluZ3MgaW4ga2V5c1xuICBsZXQgZ3JvdXBLZXk7XG4gIGlmIChzaGFyZWRBZG1pbjEpIHtcbiAgICAvLyBHcm91cCBieSBhZG1pbjJcbiAgICBncm91cEtleSA9IGQgPT4gYCR7ZC5hZG1pbjBfbmFtZSB8fCAnTlVMTCd9fCR7ZC5hZG1pbjFfbmFtZSB8fCAnTlVMTCd9fCR7ZC5hZG1pbjJfbmFtZSB8fCAnTlVMTCd9YDtcbiAgfSBlbHNlIGlmIChzaGFyZWRBZG1pbjApIHtcbiAgICAvLyBHcm91cCBieSBhZG1pbjFcbiAgICBncm91cEtleSA9IGQgPT4gYCR7ZC5hZG1pbjBfbmFtZSB8fCAnTlVMTCd9fCR7ZC5hZG1pbjFfbmFtZSB8fCAnTlVMTCd9YDtcbiAgfSBlbHNlIHtcbiAgICAvLyBHcm91cCBieSBhZG1pbjBcbiAgICBncm91cEtleSA9IGQgPT4gZC5hZG1pbjBfbmFtZSB8fCAnTlVMTCc7XG4gIH1cbiAgXG4gIGNvbnN0IGdyb3VwZWREYXRhID0gZDMuZ3JvdXAoZmlsdGVyZWREYXRhLCBncm91cEtleSk7XG4gIFxuICByZXR1cm4gQXJyYXkuZnJvbShncm91cGVkRGF0YS5lbnRyaWVzKCkpLm1hcCgoW2tleSwgdmFsdWVzXSkgPT4ge1xuICAgIC8vIFBhcnNlIHRoZSBrZXkgYmFjayB0byBnZXQgYWRtaW4gbmFtZXNcbiAgICBsZXQgYWRtaW4wX25hbWUsIGFkbWluMV9uYW1lLCBhZG1pbjJfbmFtZTtcbiAgICBcbiAgICBpZiAoc2hhcmVkQWRtaW4xKSB7XG4gICAgICBbYWRtaW4wX25hbWUsIGFkbWluMV9uYW1lLCBhZG1pbjJfbmFtZV0gPSBrZXkuc3BsaXQoXCJ8XCIpO1xuICAgIH0gZWxzZSBpZiAoc2hhcmVkQWRtaW4wKSB7XG4gICAgICBbYWRtaW4wX25hbWUsIGFkbWluMV9uYW1lXSA9IGtleS5zcGxpdChcInxcIik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGFkbWluMF9uYW1lID0ga2V5O1xuICAgIH1cbiAgICBcbiAgICAvLyBTdW0gdXAgYWxsIGV4cG9zdXJlIHZhbHVlcyBmb3IgdGhpcyByZWdpb25cbiAgICBjb25zdCB0b3RhbFZhbHVlID0gZDMuc3VtKHZhbHVlcywgZCA9PiBkLnZhbHVlIHx8IDApO1xuICAgIFxuICAgIHJldHVybiB7XG4gICAgICBhZG1pbjBfbmFtZSxcbiAgICAgIGFkbWluMV9uYW1lOiBhZG1pbjFfbmFtZSB8fCBudWxsLFxuICAgICAgYWRtaW4yX25hbWU6IGFkbWluMl9uYW1lIHx8IG51bGwsXG4gICAgICB2YWx1ZTogdG90YWxWYWx1ZVxuICAgIH07XG4gIH0pO1xufVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0yNSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Ii8vIEdlb2dyYXBoaWMgZGF0YSBiaW5kaW5nXG5leHBvc3VyZU1hcERhdGEgPSB7XG4gIGlmICghZGF0YUdlb0ltcGFjdCB8fCBkYXRhR2VvSW1wYWN0Lmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiB7IGZlYXR1cmVzOiBbXSB9O1xuICB9XG5cbiAgLy8gQ2hlY2sgaWYgYm91bmRhcmllcyBleGlzdCBiZWZvcmUgYWNjZXNzaW5nIHByb3BlcnRpZXNcbiAgaWYgKCFib3VuZGFyaWVzKSB7XG4gICAgcmV0dXJuIHsgZmVhdHVyZXM6IFtdIH07XG4gIH1cblxuICAvLyBEZXRlcm1pbmUgd2hpY2ggYWRtaW4gbGV2ZWwgdG8gc2hvd1xuICBpZiAoIXNoYXJlZEFkbWluMCkge1xuICAgIC8vIFNob3cgYWRtaW4wIGxldmVsXG4gICAgaWYgKCFib3VuZGFyaWVzLmFkbWluMCB8fCAhYm91bmRhcmllcy5hZG1pbjAuZmVhdHVyZXMpIHtcbiAgICAgIHJldHVybiB7IGZlYXR1cmVzOiBbXSB9O1xuICAgIH1cbiAgICByZXR1cm4gYmluZFRhYnVsYXJUb0dlbyh7XG4gICAgICBkYXRhOiBkYXRhR2VvSW1wYWN0LFxuICAgICAgZGF0YUJpbmRDb2x1bW46IFwiYWRtaW4wX25hbWVcIixcbiAgICAgIGdlb0RhdGE6IGJvdW5kYXJpZXMuYWRtaW4wLFxuICAgICAgZ2VvRGF0YUJpbmRDb2x1bW46IFwiYWRtaW4wX25hbWVcIlxuICAgIH0pO1xuICB9IGVsc2UgaWYgKCFzaGFyZWRBZG1pbjEpIHtcbiAgICAvLyBTaG93IGFkbWluMSBsZXZlbCB3aXRoaW4gc2VsZWN0ZWQgYWRtaW4wXG4gICAgaWYgKCFib3VuZGFyaWVzLmFkbWluMSB8fCAhYm91bmRhcmllcy5hZG1pbjEuZmVhdHVyZXMpIHtcbiAgICAgIHJldHVybiB7IGZlYXR1cmVzOiBbXSB9O1xuICAgIH1cbiAgICBjb25zdCBkYXRhID0gZGF0YUdlb0ltcGFjdC5tYXAoZCA9PiAoe1xuICAgICAgLi4uZCxcbiAgICAgIGExX2EwOiBbZC5hZG1pbjFfbmFtZSwgZC5hZG1pbjBfbmFtZV0uam9pbihcIl9cIilcbiAgICB9KSk7XG4gICAgXG4gICAgY29uc3QgZ2VvRGF0YSA9IHtcbiAgICAgIC4uLmJvdW5kYXJpZXMuYWRtaW4xLFxuICAgICAgZmVhdHVyZXM6IGJvdW5kYXJpZXMuYWRtaW4xLmZlYXR1cmVzLmZpbHRlcihcbiAgICAgICAgZCA9PiBkLnByb3BlcnRpZXMuYWRtaW4wX25hbWUgPT09IHNoYXJlZEFkbWluMFxuICAgICAgKVxuICAgIH07XG5cbiAgICByZXR1cm4gYmluZFRhYnVsYXJUb0dlbyh7XG4gICAgICBkYXRhOiBkYXRhLFxuICAgICAgZGF0YUJpbmRDb2x1bW46IFwiYWRtaW4xX25hbWVcIixcbiAgICAgIGdlb0RhdGE6IGdlb0RhdGEsXG4gICAgICBnZW9EYXRhQmluZENvbHVtbjogXCJhZG1pbjFfbmFtZVwiXG4gICAgfSk7XG4gIH0gZWxzZSB7XG4gICAgLy8gU2hvdyBhZG1pbjIgbGV2ZWwgd2l0aGluIHNlbGVjdGVkIGFkbWluMVxuICAgIGlmICghYm91bmRhcmllcy5hZG1pbjIgfHwgIWJvdW5kYXJpZXMuYWRtaW4yLmZlYXR1cmVzKSB7XG4gICAgICByZXR1cm4geyBmZWF0dXJlczogW10gfTtcbiAgICB9XG4gICAgY29uc3QgZGF0YSA9IGRhdGFHZW9JbXBhY3QubWFwKGQgPT4gKHtcbiAgICAgIC4uLmQsXG4gICAgICBhMl9hMV9hMDogW2QuYWRtaW4yX25hbWUsIGQuYWRtaW4xX25hbWUsIGQuYWRtaW4wX25hbWVdLmpvaW4oXCJfXCIpXG4gICAgfSkpO1xuICAgIFxuICAgIGNvbnN0IGdlb0RhdGEgPSB7XG4gICAgICAuLi5ib3VuZGFyaWVzLmFkbWluMixcbiAgICAgIGZlYXR1cmVzOiBib3VuZGFyaWVzLmFkbWluMi5mZWF0dXJlcy5maWx0ZXIoZCA9PiBcbiAgICAgICAgZC5wcm9wZXJ0aWVzLmFkbWluMV9uYW1lID09PSBzaGFyZWRBZG1pbjEgJiZcbiAgICAgICAgZC5wcm9wZXJ0aWVzLmFkbWluMF9uYW1lID09PSBzaGFyZWRBZG1pbjBcbiAgICAgIClcbiAgICB9O1xuXG5cblxuICAgIHJldHVybiBiaW5kVGFidWxhclRvR2VvKHtcbiAgICAgIGRhdGE6IGRhdGEsXG4gICAgICBkYXRhQmluZENvbHVtbjogXCJhZG1pbjJfbmFtZVwiLFxuICAgICAgZ2VvRGF0YTogZ2VvRGF0YSxcbiAgICAgIGdlb0RhdGFCaW5kQ29sdW1uOiBcImFkbWluMl9uYW1lXCJcbiAgICB9KTtcbiAgfVxufVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0yNiIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Ii8vIFZpc3VhbGl6YXRpb24gd2l0aCBwcm9wZXIgbG9hZGluZy9uby1kYXRhIHN0YXRlc1xuZXhwb3N1cmVDaG9yb3BsZXRoTWFwID0ge1xuICAvLyBTaG93IGxvYWRpbmcgc3Bpbm5lciBvbmx5IGlmIGRhdGEgaXMgc3RpbGwgbG9hZGluZyAobnVsbC91bmRlZmluZWQpXG4gIGlmIChleHBvc3VyZURhdGEgPT09IG51bGwgfHwgZXhwb3N1cmVEYXRhID09PSB1bmRlZmluZWQpIHtcbiAgICByZXR1cm4gY3JlYXRlTG9hZGluZ1N0YXRlKF9sYW5nKHtlbjogXCJMb2FkaW5nIGV4cG9zdXJlIGRhdGEuLi5cIiwgZnI6IFwiQ2hhcmdlbWVudCBkZXMgZG9ubsOpZXMgZCdleHBvc2l0aW9uLi4uXCJ9KSk7XG4gIH1cbiAgXG4gIC8vIElmIGRhdGEgaXMgbG9hZGVkIGJ1dCBlbXB0eSwgb3IgbWFwIGRhdGEgaXMgZW1wdHksIHNob3cgbm8gZGF0YSBzdGF0ZVxuICBpZiAoIWV4cG9zdXJlRGF0YSB8fCBleHBvc3VyZURhdGEubGVuZ3RoID09PSAwIHx8ICFleHBvc3VyZU1hcERhdGEgfHwgIWV4cG9zdXJlTWFwRGF0YS5mZWF0dXJlcyB8fCBleHBvc3VyZU1hcERhdGEuZmVhdHVyZXMubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIGNyZWF0ZU5vRGF0YVN0YXRlKF9sYW5nKHZ1bG5lcmFiaWxpdHlfdHJhbnNsYXRpb25zLm5vX2RhdGFfYXZhaWxhYmxlKSk7XG4gIH1cblxuICBjb25zdCBkYXRhID0gZXhwb3N1cmVNYXBEYXRhO1xuXG4gIFxuICBjb25zdCBwbG90ID0gUGxvdC5wbG90KHtcbiAgICB3aWR0aDogbWFwV2lkdGgsXG4gICAgaGVpZ2h0OiBtYXBIZWlnaHQsXG4gICAgY2FwdGlvbjogdm9wTm90ZS5jYXB0aW9uLFxuICAgIHByb2plY3Rpb246IHtcbiAgICAgIHR5cGU6IFwiYXppbXV0aGFsLWVxdWFsLWFyZWFcIixcbiAgICAgIGRvbWFpbjogZGF0YVxuICAgIH0sXG4gICAgY29sb3I6IHtcbiAgICAgIGxlZ2VuZDogdHJ1ZSxcbiAgICAgIGxhYmVsOiBgJHtfbGFuZyh7ZW46IFwiVm9QXCIsIGZyOiBcIlZvUFwifSl9ICgke2ludERvbGxhclVuaXR9KWAsXG4gICAgICByYW5nZTogY29sb3JTY2FsZXMucmFuZ2UueWVsbG93R3JlZW4sXG4gICAgICB1bmtub3duOiBjb2xvclNjYWxlcy51bmtub3duLFxuICAgICAgdGlja0Zvcm1hdDogZm9ybWF0TnVtQ29tcGFjdFNob3J0LFxuICAgIH0sXG4gICAgbWFya3M6IFtcbiAgICAgIC8vIEJhc2UgZ2VvZ3JhcGh5IC0gbm8gdG9vbHRpcCBoZXJlXG4gICAgICBQbG90LmdlbyhkYXRhLmZlYXR1cmVzLCB7XG4gICAgICAgIGZpbGw6IGQgPT4ge1xuICAgICAgICAgIGNvbnN0IGRhdGFDb2x1bW4gPSAndmFsdWUnICAgICBcbiAgICAgICAgICBjb25zdCBmaWxsVmFsdWUgPSBkLnByb3BlcnRpZXMuZGF0YSA/IGQucHJvcGVydGllcy5kYXRhW2RhdGFDb2x1bW5dIDogbnVsbDsgLy8gaGFuZGxlIG1pc3NpbmcgZGF0YVxuICAgICAgICAgIHJldHVybiBmaWxsVmFsdWVcbiAgICAgICAgfSxcbiAgICAgICAgc3Ryb2tlOiBcIiNmZmZcIixcbiAgICAgICAgc3Ryb2tlV2lkdGg6IDAuNVxuICAgICAgfSksXG4gICAgICBcbiAgICAgIC8vIEhpZ2hsaWdodCBzZWxlY3RlZCBhZG1pbjIgcmVnaW9uXG4gICAgICBQbG90LmdlbyhcbiAgICAgICAgc2hhcmVkQWRtaW4yXG4gICAgICAgICAgPyBkYXRhLmZlYXR1cmVzLmZpbHRlcihkID0+IGQucHJvcGVydGllcy5hZG1pbjJfbmFtZSA9PT0gc2hhcmVkQWRtaW4yKVxuICAgICAgICAgIDogW10sIFxuICAgICAgICB7XG4gICAgICAgIGZpbGw6IG51bGwsXG4gICAgICAgIHN0cm9rZTogXCIjMzMzXCIsXG4gICAgICAgICAgc3Ryb2tlV2lkdGg6IDEuNVxuICAgICAgICB9XG4gICAgICApLFxuICAgICAgXG4gICAgICAvLyBJbnRlcmFjdGl2ZSBwb2ludGVyXG4gICAgICBQbG90LmdlbyhkYXRhLCBQbG90LnBvaW50ZXIoXG4gICAgICAgIFBsb3QuY2VudHJvaWQoe1xuICAgICAgICBzdHJva2U6IFwiIzMzM1wiLFxuICAgICAgICBzdHJva2VXaWR0aDogMS41LFxuICAgICAgfSkpKSxcbiAgICAgIFxuICAgICAgLy8gVG9vbHRpcCB1c2luZyB0aGUgZXhhY3Qgd29ya2luZyBwYXR0ZXJuXG4gICAgICBQbG90LnRpcChcbiAgICAgICAgZGF0YS5mZWF0dXJlcyxcbiAgICAgICAgUGxvdC5wb2ludGVyKFxuICAgICAgICAgIFBsb3QuY2VudHJvaWQoe1xuICAgICAgICAgICAgY2hhbm5lbHM6IHtcbiAgICAgICAgICAgICAgY291bnRyeToge1xuICAgICAgICAgICAgICAgIGxhYmVsOiBcIkNvdW50cnlcIixcbiAgICAgICAgICAgICAgICB2YWx1ZTogKGQpID0+IGQucHJvcGVydGllcy5hZG1pbjBfbmFtZVxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBuYW1lOiB7XG4gICAgICAgICAgICAgICAgbGFiZWw6IFwiUmVnaW9uXCIsXG4gICAgICAgICAgICAgICAgdmFsdWU6IChkKSA9PiB7XG4gICAgICAgICAgICAgICAgICBpZiAoZC5wcm9wZXJ0aWVzLmFkbWluMl9uYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBgJHtkLnByb3BlcnRpZXMuYWRtaW4yX25hbWV9LCAke2QucHJvcGVydGllcy5hZG1pbjFfbmFtZX1gO1xuICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChkLnByb3BlcnRpZXMuYWRtaW4xX25hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGQucHJvcGVydGllcy5hZG1pbjFfbmFtZTtcbiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBkLnByb3BlcnRpZXMuYWRtaW4wX25hbWU7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgbGFiZWw6IFwiVm9QXCIsXG4gICAgICAgICAgICAgICAgdmFsdWU6IChkKSA9PiB7XG4gICAgICAgICAgICAgICAgICBjb25zdCBkYXRhQ29sdW1uID0gJ3ZhbHVlJ1xuICAgICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IGQucHJvcGVydGllcy5kYXRhID8gZC5wcm9wZXJ0aWVzLmRhdGFbZGF0YUNvbHVtbl0gOiB1bmRlZmluZWRcbiAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRhXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZm9ybWF0OiB7XG4gICAgICAgICAgICAgIGNvdW50cnk6IHRydWUsXG4gICAgICAgICAgICAgIG5hbWU6IHRydWUsXG4gICAgICAgICAgICAgIGRhdGE6IChkKSA9PiBkID8gZm9ybWF0TnVtQ29tcGFjdFNob3J0KGQpIDogXCJObyBkYXRhXCJcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICApXG4gICAgICApXG4gICAgXVxuICB9KTtcblxuICByZXR1cm4gaHRsLmh0bWxgXG4gIDwhLS0gICA8ZGl2IHN0eWxlPVwiIC0tPlxuICA8IS0tICAgICBib3JkZXI6IDFweCBzb2xpZCAjZTVlN2ViOyAtLT5cbiAgPCEtLSAgICAgYm9yZGVyLXJhZGl1czogOHB4OyAtLT5cbiAgPCEtLSAgIHBhZGRpbmc6IDIwcHg7IC0tPlxuICA8IS0tICAgYmFja2dyb3VuZC1jb2xvcjogI2ZmZjsgLS0+XG4gIDwhLS0gICBib3gtc2hhZG93OiAwIDJweCA0cHggcmdiYSgwLDAsMCwwLjEpOyAtLT5cbiAgPCEtLSAgICAgbWFyZ2luOiAxNnB4IDA7IC0tPlxuICA8IS0tIFwiPiAtLT5cbiAgICAke3Bsb3R9XG4gICAgPCEtLSA8L2Rpdj4gLS0+XG4gIGA7XG59XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTI3IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiLy8gRG93bmxvYWQgZnVuY3Rpb25hbGl0eVxuZXhwb3N1cmVEb3dubG9hZEJ1dHRvbiA9IHtcbiAgaWYgKCFkYXRhR2VvSW1wYWN0IHx8IGRhdGFHZW9JbXBhY3QubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIGh0bC5odG1sYGA7XG4gIH1cbiAgcmV0dXJuIGRvd25sb2FkQnV0dG9uKFxuICAgIGRhdGFHZW9JbXBhY3QsIFxuICAgIGBleHBvc3VyZV9kYXRhXyR7Z2V0RXhwb3N1cmVBZG1pblNlbGVjdGlvbigpLnJlcGxhY2UoL1xccysvZywgJ18nKX1fYWxsX2hhemFyZF90eXBlc2AsXG4gICAgX2xhbmcodnVsbmVyYWJpbGl0eV90cmFuc2xhdGlvbnMuZG93bmxvYWRfZGF0YSlcbiAgKTtcbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMjgiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiIvLyBEeW5hbWljIGluc2lnaHRzXG5leHBvc3VyZUluc2lnaHRzID0ge1xuICBpZiAoIWRhdGFHZW9JbXBhY3QgfHwgZGF0YUdlb0ltcGFjdC5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gY3JlYXRlTm9EYXRhU3RhdGUoKTtcbiAgfVxuXG4gIC8vIENhbGN1bGF0ZSB0b3RhbCBleHBvc3VyZSB2YWx1ZVxuICBjb25zdCB0b3RhbFZhbHVlID0gZDMuc3VtKGRhdGFHZW9JbXBhY3QsIGQgPT4gZC52YWx1ZSB8fCAwKTtcbiAgY29uc3QgcmVnaW9uID0gZ2V0RXhwb3N1cmVBZG1pblNlbGVjdGlvbigpO1xuICBjb25zdCBoYXphcmRMYWJlbCA9IFwiQW55XCI7XG4gIFxuICAvLyBHZXQgdG9wIDMgbW9zdCBleHBvc2VkIGNvbW1vZGl0aWVzXG4gIGxldCB0b3BDb21tb2RpdGllcyA9IFtdO1xuICBpZiAoZXhwb3N1cmVEYXRhICYmIGV4cG9zdXJlRGF0YS5sZW5ndGggPiAwKSB7XG4gICAgLy8gRmlsdGVyIGRhdGEgYmFzZWQgb24gY3VycmVudCBhZG1pbiBzZWxlY3Rpb25cbiAgICBsZXQgZmlsdGVyZWRDb21tb2RpdHlEYXRhID0gZXhwb3N1cmVEYXRhO1xuICAgIFxuICAgIGlmIChzaGFyZWRBZG1pbjEpIHtcbiAgICAgIGZpbHRlcmVkQ29tbW9kaXR5RGF0YSA9IGV4cG9zdXJlRGF0YS5maWx0ZXIoZCA9PiBcbiAgICAgICAgZC5hZG1pbjBfbmFtZSA9PT0gc2hhcmVkQWRtaW4wICYmIFxuICAgICAgICBkLmFkbWluMV9uYW1lID09PSBzaGFyZWRBZG1pbjEgJiZcbiAgICAgICAgZC5hZG1pbjJfbmFtZVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKHNoYXJlZEFkbWluMCkge1xuICAgICAgZmlsdGVyZWRDb21tb2RpdHlEYXRhID0gZXhwb3N1cmVEYXRhLmZpbHRlcihkID0+IFxuICAgICAgICBkLmFkbWluMF9uYW1lID09PSBzaGFyZWRBZG1pbjAgJiZcbiAgICAgICAgZC5hZG1pbjFfbmFtZSAmJlxuICAgICAgICAhZC5hZG1pbjJfbmFtZVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZmlsdGVyZWRDb21tb2RpdHlEYXRhID0gZXhwb3N1cmVEYXRhLmZpbHRlcihkID0+IFxuICAgICAgICAhZC5hZG1pbjFfbmFtZSAmJiAhZC5hZG1pbjJfbmFtZVxuICAgICAgKTtcbiAgICB9XG4gICAgXG4gICAgLy8gR3JvdXAgYnkgY29tbW9kaXR5IGFuZCBzdW0gdmFsdWVzXG4gICAgY29uc3QgY29tbW9kaXR5R3JvdXBzID0gZDMuZ3JvdXAoZmlsdGVyZWRDb21tb2RpdHlEYXRhLCBkID0+IGQuY3JvcCk7XG4gICAgY29uc3QgY29tbW9kaXR5VG90YWxzID0gQXJyYXkuZnJvbShjb21tb2RpdHlHcm91cHMuZW50cmllcygpKS5tYXAoKFtjcm9wLCB2YWx1ZXNdKSA9PiAoe1xuICAgICAgY3JvcDogY3JvcCxcbiAgICAgIHRvdGFsVmFsdWU6IGQzLnN1bSh2YWx1ZXMsIGQgPT4gZC52YWx1ZSB8fCAwKVxuICAgIH0pKTtcbiAgICBcbiAgICAvLyBTb3J0IGJ5IHRvdGFsIHZhbHVlIGFuZCBnZXQgdG9wIDNcbiAgICB0b3BDb21tb2RpdGllcyA9IGNvbW1vZGl0eVRvdGFsc1xuICAgICAgLnNvcnQoKGEsIGIpID0+IGIudG90YWxWYWx1ZSAtIGEudG90YWxWYWx1ZSlcbiAgICAgIC5zbGljZSgwLCAzKVxuICAgICAgLmZpbHRlcihkID0+IGQudG90YWxWYWx1ZSA+IDApO1xuICB9XG4gIFxuICAvLyBGb3JtYXQgY3VycmVuY3kgd2l0aG91dCB0aGUgXCIyMDE1IFVTRFwiIHByZWZpeFxuICBjb25zdCBmb3JtYXRDbGVhbkN1cnJlbmN5ID0gKG51bWJlcikgPT4ge1xuICAgIHJldHVybiBuZXcgSW50bC5OdW1iZXJGb3JtYXQoXCJlbi1VU1wiLCB7XG4gICAgICBub3RhdGlvbjogXCJjb21wYWN0XCIsXG4gICAgICBjb21wYWN0RGlzcGxheTogXCJzaG9ydFwiLFxuICAgICAgc3R5bGU6IFwiY3VycmVuY3lcIixcbiAgICAgIGN1cnJlbmN5OiBcIlVTRFwiLFxuICAgIH0pLmZvcm1hdChudW1iZXIpO1xuICB9O1xuICBcbiAgY29uc3QgdGVtcGxhdGUgPSBfbGFuZyh2dWxuZXJhYmlsaXR5X3RyYW5zbGF0aW9ucy5leHBvc3VyZV9pbnNpZ2h0X3RlbXBsYXRlKTtcbiAgY29uc3QgcmVwbGFjZW1lbnRzID0gW1xuICAgIHsgbmFtZTogXCJyZWdpb25cIiwgdmFsdWU6IHJlZ2lvbiB9LFxuICAgIHsgbmFtZTogXCJhbW91bnRcIiwgdmFsdWU6IGZvcm1hdENsZWFuQ3VycmVuY3kodG90YWxWYWx1ZSkgfVxuICBdO1xuICBcbiAgY29uc3QgaW5zaWdodCA9IGdlbmVyYXRlSW5zaWdodCh0ZW1wbGF0ZSwgcmVwbGFjZW1lbnRzKTtcbiAgXG4gIC8vIEFkZCB0b3AgY29tbW9kaXRpZXMgaW5zaWdodCBpZiBhdmFpbGFibGVcbiAgbGV0IGNvbW1vZGl0aWVzSW5zaWdodCA9IFwiXCI7XG4gIGlmICh0b3BDb21tb2RpdGllcy5sZW5ndGggPiAwKSB7XG4gICAgLy8gQ3JlYXRlIGR5bmFtaWMgdGV4dCB3aXRoIHNwZWNpZmljIGNvbW1vZGl0eSBuYW1lc1xuICAgIGNvbnN0IGNvbW1vZGl0eU5hbWVzID0gdG9wQ29tbW9kaXRpZXNcbiAgICAgIC5tYXAoZCA9PiBkLmNyb3AucmVwbGFjZSgvLS9nLCAnICcpKVxuICAgICAgLmpvaW4oXCIsIFwiKTtcbiAgICBcbiAgICBjb25zdCBjb21tb2RpdGllc1RleHQgPSBfbGFuZyh7XG4gICAgICBlbjogYCBUaGUgdG9wIDMgbW9zdCBleHBvc2VkIGNvbW1vZGl0aWVzIGFyZTpgLFxuICAgICAgZnI6IGAgTGVzIDMgcHJvZHVpdHMgbGVzIHBsdXMgZXhwb3PDqXMgc29udDpgXG4gICAgfSk7XG4gICAgXG4gICAgLy8gQ29tYmluZSBpbnNpZ2h0IHRleHQgd2l0aCBjb21tb2RpdGllcyBsaXN0IGFzIEhUTUwgdXNpbmcgcHJvcGVyIGh0bC5odG1sIHN5bnRheFxuICAgIGNvbnN0IGZ1bGxJbnNpZ2h0ID0gaHRsLmh0bWxgXG4gICAgICAke2luc2lnaHR9JHtjb21tb2RpdGllc1RleHR9XG4gICAgICA8b2w+XG4gICAgICAgICR7dG9wQ29tbW9kaXRpZXMubWFwKGQgPT4gaHRsLmh0bWxgPGxpPiR7ZC5jcm9wLnJlcGxhY2UoLy0vZywgJyAnKX0gKCR7Zm9ybWF0Q2xlYW5DdXJyZW5jeShkLnRvdGFsVmFsdWUpfSk8L2xpPmApfVxuICAgICAgPC9vbD5cbiAgICBgO1xuICAgIHJldHVybiBjcmVhdGVJbnNpZ2h0RGlzcGxheShmdWxsSW5zaWdodCk7XG4gIH1cbiAgXG4gIHJldHVybiBjcmVhdGVJbnNpZ2h0RGlzcGxheShpbnNpZ2h0KTtcbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMjkiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJzZW5zaXRpdml0eVF1ZXN0aW9uID0gX2xhbmcodnVsbmVyYWJpbGl0eV90cmFuc2xhdGlvbnMuc2Vuc2l0aXZpdHlfcXVlc3Rpb24pO1xuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0zMCIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Ii8vIFNlbnNpdGl2aXR5IHNlY3Rpb24gc2VsZWN0b3JzIC0gZm9sbG93IHNoYXJlZCBzdGF0ZVxudmlld29mIHNlbnNpdGl2aXR5QWRtaW4wID0gSW5wdXRzLnNlbGVjdChkYXRhQWRtaW4wLCB7XG4gIGxhYmVsOiBhZG1pblJlZ2lvbnMubGFiZWxzLmFkbWluMCwgXG4gIGZvcm1hdDogeCA9PiB4LmxhYmVsLFxuICB2YWx1ZTogZGF0YUFkbWluMC5maW5kKGQgPT4gZC52YWx1ZSA9PT0gc2hhcmVkQWRtaW4wKSB8fCAoZGF0YUFkbWluMC5sZW5ndGggPiAwID8gZGF0YUFkbWluMFswXSA6IG51bGwpXG59KVxudmlld29mIHNlbnNpdGl2aXR5QWRtaW4xID0gSW5wdXRzLnNlbGVjdChkYXRhQWRtaW4xLCB7XG4gIGxhYmVsOiBhZG1pblJlZ2lvbnMubGFiZWxzLmFkbWluMSwgXG4gIGZvcm1hdDogeCA9PiB4LmxhYmVsLFxuICB2YWx1ZTogZGF0YUFkbWluMS5maW5kKGQgPT4gZC52YWx1ZSA9PT0gc2hhcmVkQWRtaW4xKSB8fCAoZGF0YUFkbWluMS5sZW5ndGggPiAwID8gZGF0YUFkbWluMVswXSA6IG51bGwpXG59KVxudmlld29mIHNlbnNpdGl2aXR5QWRtaW4yID0gSW5wdXRzLnNlbGVjdChkYXRhQWRtaW4yLCB7XG4gIGxhYmVsOiBhZG1pblJlZ2lvbnMubGFiZWxzLmFkbWluMiwgXG4gIGZvcm1hdDogeCA9PiB4LmxhYmVsLFxuICB2YWx1ZTogZGF0YUFkbWluMi5maW5kKGQgPT4gZC52YWx1ZSA9PT0gc2hhcmVkQWRtaW4yKSB8fCAoZGF0YUFkbWluMi5sZW5ndGggPiAwID8gZGF0YUFkbWluMlswXSA6IG51bGwpXG59KVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0zMSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6InNlbnNpdGl2aXR5Q29udHJvbHNGb3JtID0gaHRsLmh0bWxgXG48ZGl2IHN0eWxlPVwiXG4gIGJhY2tncm91bmQ6ICNmOGZhZmM7XG4gIGJvcmRlcjogMnB4IHNvbGlkICNlMmU4ZjA7XG4gIGJvcmRlci1yYWRpdXM6IDEycHg7XG4gIHBhZGRpbmc6IDI0cHg7XG4gIGJveC1zaGFkb3c6IDAgNHB4IDZweCByZ2JhKDAsIDAsIDAsIDAuMDcpO1xuICBtYXJnaW46IDE2cHggMDtcblwiPlxuICA8aDMgc3R5bGU9XCJtYXJnaW46IDAgMCAyMHB4IDA7IGNvbG9yOiAjMmQzNzQ4OyBmb250LXNpemU6IDEuMXJlbTsgZm9udC13ZWlnaHQ6IDYwMDtcIj5cbiAgICAke19sYW5nKHZ1bG5lcmFiaWxpdHlfdHJhbnNsYXRpb25zLmdlb2dyYXBoaWNfc2VsZWN0aW9uKX1cbiAgPC9oMz5cbiAgPGRpdiBzdHlsZT1cIlxuICAgIGRpc3BsYXk6IGZsZXg7XG4gICAgYWxpZ24taXRlbXM6IGZsZXgtc3RhcnQ7XG4gICAgZ2FwOiAyMHB4O1xuICAgIGZsZXgtd3JhcDogd3JhcDtcbiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47XG4gIFwiIGNsYXNzPVwiZm9ybS1pbnB1dHMtY29udGFpbmVyXCI+XG4gICAgPGRpdiBzdHlsZT1cImZsZXg6IDE7IG1pbi13aWR0aDogMTgwcHg7IG1heC13aWR0aDogMTAwJTtcIj4ke3ZpZXdvZiBzZW5zaXRpdml0eUFkbWluMH08L2Rpdj5cbiAgICA8ZGl2IHN0eWxlPVwiZmxleDogMTsgbWluLXdpZHRoOiAxODBweDsgbWF4LXdpZHRoOiAxMDAlO1wiPiR7dmlld29mIHNlbnNpdGl2aXR5QWRtaW4xfTwvZGl2PlxuICAgIDxkaXYgc3R5bGU9XCJmbGV4OiAxOyBtaW4td2lkdGg6IDE4MHB4OyBtYXgtd2lkdGg6IDEwMCU7XCI+JHt2aWV3b2Ygc2Vuc2l0aXZpdHlBZG1pbjJ9PC9kaXY+XG4gIDwvZGl2PlxuPC9kaXY+XG5gXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTMyIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiLy8gTG9hZCBpY2ljbGUgbWV0YWRhdGEgYW5kIGRhdGEgd2l0aCBjYWNoaW5nXG5pY2ljbGVLZXlzID0gYXdhaXQgbG9hZERhdGFXaXRoQ2FjaGUoXCJpY2ljbGVLZXlzXCIsIGFzeW5jICgpID0+IHtcbiAgcmV0dXJuIGF3YWl0IEZpbGVBdHRhY2htZW50KFxuICAgIFwiL2RhdGEvdnVsbmVyYWJpbGl0eV9ub3RlYm9vay92dWxuZXJhYmlsaXR5X2ljaWNsZWtleXMuanNvblwiLFxuICApLmpzb24oKTtcbn0pO1xuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0zMyIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Ii8vIExvYWQgZGF0YSB3aXRoIGNhY2hpbmcgLSB1c2luZyBwYXJxdWV0IHZpYSBEdWNrREJcbmNzdl9yYXcgPSBhd2FpdCBsb2FkRGF0YVdpdGhDYWNoZShcInNlbnNpdGl2aXR5RGF0YVwiLCBhc3luYyAoKSA9PiB7XG4gIGNvbnN0IGRiID0gYXdhaXQgRHVja0RCQ2xpZW50Lm9mKHtcbiAgICB2dWxuZXJhYmlsaXR5X2ljaWNsZTogRmlsZUF0dGFjaG1lbnQoXG4gICAgICBcIi9kYXRhL3Z1bG5lcmFiaWxpdHlfbm90ZWJvb2svdnVsbmVyYWJpbGl0eV9pY2ljbGVkYXRhX3VwZGF0ZWQucGFycXVldFwiLFxuICAgICksXG4gIH0pO1xuICBjb25zdCBkYXRhID0gYXdhaXQgZGIucXVlcnkoXCJTRUxFQ1QgKiBGUk9NIHZ1bG5lcmFiaWxpdHlfaWNpY2xlXCIpO1xuXG4gIC8vIENvbnZlcnQgdG8gdGhlIGV4cGVjdGVkIGZvcm1hdDogYXJyYXkgb2YgYXJyYXlzIFthZG1pbjAsIGFkbWluMSwgYWRtaW4yLCBwYXRoLCB2YWx1ZV1cbiAgLy8gVGhlIHBhcnF1ZXQgc2hvdWxkIGhhdmUgY29sdW1uczogYWRtaW4wX25hbWUsIGFkbWluMV9uYW1lLCBhZG1pbjJfbmFtZSwgcGF0aCwgdmFsdWVcbiAgcmV0dXJuIGRhdGFcbiAgICAuZmlsdGVyKChkKSA9PiBkLnBhdGggIT0gbnVsbCAmJiBkLnBhdGggIT09IFwiXCIpXG4gICAgLm1hcCgoZCkgPT4ge1xuICAgICAgLy8gQ29udmVydCBudWxsIHZhbHVlcyB0byBcIk5BXCIgc3RyaW5nIHRvIG1hdGNoIENTViBmb3JtYXRcbiAgICAgIGNvbnN0IGFkbWluMCA9IGQuYWRtaW4wX25hbWUgfHwgXCJTU0FcIjtcbiAgICAgIGNvbnN0IGFkbWluMSA9IGQuYWRtaW4xX25hbWUgfHwgXCJOQVwiO1xuICAgICAgY29uc3QgYWRtaW4yID0gZC5hZG1pbjJfbmFtZSB8fCBcIk5BXCI7XG5cbiAgICAgIHJldHVybiBbYWRtaW4wLCBhZG1pbjEsIGFkbWluMiwgZC5wYXRoLCBkLnZhbHVlIHx8IDBdO1xuICAgIH0pO1xufSk7XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTM0IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiYnJlYWRjcnVtYldpZHRoID0gMjAwO1xuYnJlYWRjcnVtYkhlaWdodCA9IDM1O1xudGFyZ2V0SGVpZ2h0ID0gNDI1O1xuaGVpZ2h0ID0gbmFycm93ID8gbmFycm93SGVpZ2h0IDogdGFyZ2V0SGVpZ2h0O1xubmFycm93SGVpZ2h0ID0gNjAwO1xubmFycm93ID0gd2lkdGggPD0gMDtcbnNlZ21lbnRYID0gKGQpID0+IChuYXJyb3cgPyBkLnkwIDogZC54MCk7XG5zZWdtZW50WSA9IChkKSA9PiAobmFycm93ID8gZC54MCA6IGQueTApO1xuc2VnbWVudFdpZHRoID0gKGQpID0+IChuYXJyb3cgPyBkLnkxIC0gZC55MCA6IGQueDEgLSBkLngwKTtcbnNlZ21lbnRIZWlnaHQgPSAoZCkgPT4gKG5hcnJvdyA/IGQueDEgLSBkLngwIDogZC55MSAtIGQueTApO1xuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0zNSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6InBhcnRpdGlvbiA9IChkYXRhLCBvcmRlciA9IG51bGwpID0+XG4gIGQzXG4gICAgLnBhcnRpdGlvbigpXG4gICAgLnBhZGRpbmcoMSlcbiAgICAuc2l6ZShuYXJyb3cgPyBbaGVpZ2h0LCB3aWR0aF0gOiBbd2lkdGgsIGhlaWdodF0pKFxuICAgIGQzXG4gICAgICAuaGllcmFyY2h5KGRhdGEpXG4gICAgICAuc3VtKChkKSA9PiBkLnZhbHVlKVxuICAgICAgLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgICAgaWYgKG9yZGVyKSB7XG4gICAgICAgICAgLy8gTG9vayB1cCBpbmRpY2VzLCBmYWxsYmFjayB0byA5OTkgaWYgbm90IGRlZmluZWRcbiAgICAgICAgICByZXR1cm4gKG9yZGVyW2EuZGF0YS5uYW1lXSA/PyA5OTkpIC0gKG9yZGVyW2IuZGF0YS5uYW1lXSA/PyA5OTkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBiLnZhbHVlIC0gYS52YWx1ZTtcbiAgICAgIH0pLFxuICApO1xuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0zNiIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6ImZ1bmN0aW9uIGJ1aWxkSGllcmFyY2h5KGNzdikge1xuICAvLyBIZWxwZXIgZnVuY3Rpb24gdGhhdCB0cmFuc2Zvcm1zIHRoZSBnaXZlbiBDU1YgaW50byBhIGhpZXJhcmNoaWNhbCBmb3JtYXQuXG4gIC8vIFNraXAgdGhlIHBvcHVsYXRpb24gbGV2ZWwgYW5kIHN0YXJ0IGRpcmVjdGx5IHdpdGggZGVtb2dyYXBoaWMgY2F0ZWdvcmllc1xuICBjb25zdCByb290ID0geyBuYW1lOiBcInJvb3RcIiwgY2hpbGRyZW46IFtdIH07XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgY3N2Lmxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3Qgc2VxdWVuY2UgPSBjc3ZbaV1bMF07XG4gICAgY29uc3Qgc2l6ZSA9ICtjc3ZbaV1bMV07XG4gICAgLy8gU2tpcCBpbnZhbGlkIHJvd3NcbiAgICBpZiAoIXNlcXVlbmNlIHx8IGlzTmFOKHNpemUpKSB7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG4gICAgY29uc3QgcGFydHMgPSBzZXF1ZW5jZS5zcGxpdChcIl9cIik7XG4gICAgbGV0IGN1cnJlbnROb2RlID0gcm9vdDtcbiAgICAvLyBTa2lwIHRoZSBmaXJzdCBwYXJ0IChwb3B1bGF0aW9uKSBhbmQgc3RhcnQgZnJvbSB0aGUgc2Vjb25kIHBhcnRcbiAgICBmb3IgKGxldCBqID0gMTsgaiA8IHBhcnRzLmxlbmd0aDsgaisrKSB7XG4gICAgICBjb25zdCBjaGlsZHJlbiA9IGN1cnJlbnROb2RlW1wiY2hpbGRyZW5cIl07XG4gICAgICBjb25zdCBub2RlTmFtZSA9IHBhcnRzW2pdO1xuICAgICAgbGV0IGNoaWxkTm9kZSA9IG51bGw7XG4gICAgICBsZXQgZm91bmRDaGlsZCA9IGZhbHNlO1xuICAgICAgLy8gU2VhcmNoIGZvciBleGlzdGluZyBjaGlsZCB3aXRoIHRoZSBzYW1lIG5hbWVcbiAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgY2hpbGRyZW4ubGVuZ3RoOyBrKyspIHtcbiAgICAgICAgaWYgKGNoaWxkcmVuW2tdW1wibmFtZVwiXSA9PT0gbm9kZU5hbWUpIHtcbiAgICAgICAgICBjaGlsZE5vZGUgPSBjaGlsZHJlbltrXTtcbiAgICAgICAgICBmb3VuZENoaWxkID0gdHJ1ZTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgLy8gSWYgbm90IGZvdW5kLCBjcmVhdGUgYSBuZXcgY2hpbGQgbm9kZVxuICAgICAgaWYgKCFmb3VuZENoaWxkKSB7XG4gICAgICAgIGNoaWxkTm9kZSA9IHsgbmFtZTogbm9kZU5hbWUsIGNoaWxkcmVuOiBbXSB9O1xuICAgICAgICBjaGlsZHJlbi5wdXNoKGNoaWxkTm9kZSk7XG4gICAgICB9XG4gICAgICBjdXJyZW50Tm9kZSA9IGNoaWxkTm9kZTtcbiAgICAgIC8vIElmIGl0J3MgdGhlIGxhc3QgcGFydCBvZiB0aGUgc2VxdWVuY2UsIGNyZWF0ZSBhIGxlYWYgbm9kZVxuICAgICAgaWYgKGogPT09IHBhcnRzLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgY2hpbGROb2RlLnZhbHVlID0gc2l6ZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIHJvb3Q7XG59XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTM3IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiY3N2ID0ge1xuICAvLyBDaGVjayBpZiBjc3ZfcmF3IGV4aXN0cyBhbmQgaXMgYW4gYXJyYXkgYmVmb3JlIHByb2Nlc3NpbmdcbiAgaWYgKCFjc3ZfcmF3IHx8ICFBcnJheS5pc0FycmF5KGNzdl9yYXcpIHx8IGNzdl9yYXcubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG4gIFxuICBpZiAoIXNlbnNpdGl2aXR5QWRtaW4wLnZhbHVlKSB7XG4gICAgLy8gTm8gYWRtaW4gc2VsZWN0aW9uIC0gdXNlIFNTQSBkYXRhXG4gICAgcmV0dXJuIGNzdl9yYXdcbiAgICAgIC5maWx0ZXIoXG4gICAgICAgIChpdGVtKSA9PiBpdGVtICYmIGl0ZW1bMF0gPT09IFwiU1NBXCIgJiYgaXRlbVsxXSA9PT0gXCJOQVwiICYmIGl0ZW1bMl0gPT09IFwiTkFcIiAmJiBpdGVtWzNdXG4gICAgICApXG4gICAgICAubWFwKChpdGVtKSA9PiBbaXRlbVszXSwgaXRlbVs0XV0pO1xuICB9IGVsc2UgaWYgKCFzZW5zaXRpdml0eUFkbWluMS52YWx1ZSkge1xuICAgIHJldHVybiBjc3ZfcmF3XG4gICAgICAuZmlsdGVyKFxuICAgICAgICAoaXRlbSkgPT4gaXRlbSAmJiBpdGVtWzBdID09PSBzZW5zaXRpdml0eUFkbWluMC52YWx1ZSAmJiBpdGVtWzFdID09PSBcIk5BXCIgJiYgaXRlbVsyXSA9PT0gXCJOQVwiICYmIGl0ZW1bM11cbiAgICAgIClcbiAgICAgIC5tYXAoKGl0ZW0pID0+IFtpdGVtWzNdLCBpdGVtWzRdXSk7XG4gIH0gZWxzZSBpZiAoc2Vuc2l0aXZpdHlBZG1pbjEudmFsdWUgJiYgIXNlbnNpdGl2aXR5QWRtaW4yLnZhbHVlKSB7XG4gICAgcmV0dXJuIGNzdl9yYXdcbiAgICAgIC5maWx0ZXIoXG4gICAgICAgIChpdGVtKSA9PiBpdGVtICYmIGl0ZW1bMF0gPT09IHNlbnNpdGl2aXR5QWRtaW4wLnZhbHVlICYmIGl0ZW1bMV0gPT09IHNlbnNpdGl2aXR5QWRtaW4xLnZhbHVlICYmIGl0ZW1bMl0gPT09IFwiTkFcIiAmJiBpdGVtWzNdXG4gICAgICApXG4gICAgICAubWFwKChpdGVtKSA9PiBbaXRlbVszXSwgaXRlbVs0XV0pO1xuICB9IGVsc2UgaWYgKHNlbnNpdGl2aXR5QWRtaW4xLnZhbHVlICE9PSBudWxsICYmIHNlbnNpdGl2aXR5QWRtaW4yLnZhbHVlICE9PSBudWxsKSB7XG4gICAgcmV0dXJuIGNzdl9yYXdcbiAgICAgIC5maWx0ZXIoXG4gICAgICAgIChpdGVtKSA9PlxuICAgICAgICAgIGl0ZW0gJiYgaXRlbVswXSA9PT0gc2Vuc2l0aXZpdHlBZG1pbjAudmFsdWUgJiYgaXRlbVsxXSA9PT0gc2Vuc2l0aXZpdHlBZG1pbjEudmFsdWUgJiYgaXRlbVsyXSA9PT0gc2Vuc2l0aXZpdHlBZG1pbjIudmFsdWUgJiYgaXRlbVszXVxuICAgICAgKVxuICAgICAgLm1hcCgoaXRlbSkgPT4gW2l0ZW1bM10sIGl0ZW1bNF1dKTtcbiAgfVxuICByZXR1cm4gW107XG59XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTM4IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiZGF0YSA9IGJ1aWxkSGllcmFyY2h5KGNzdilcblxuLy8gQ3JlYXRlIHBlcmNlbnRhZ2UgdGFibGUgZm9yIGluc2lnaHRzXG5pY2ljbGVfcGN0X3RhYmxlID0ge1xuICBpZiAoIWNzdiB8fCBjc3YubGVuZ3RoID09PSAwKSByZXR1cm4gW107XG4gIFxuICAvLyBBIGxpdHRsZSBmdW5jdGlvbiB0byBiYXNpY2FsbHkgY2FsY3VsYXRlIHRoZSBzYW1lIHRoaW5nIGFzIHRoZSBicmVhZGNydW1iIGJ1dCBmb3IgYWxsIHRoZSBhZG1pbiByZWdpb24uXG4gIC8vIFRoaXMgaXMgd2hhdCB1c2VycyBzaG91bGQgc2VlIGlmIGdvaW5nIHRvIGEgdGFidWxhciB2aWV3IGFuZCBhbHNvIHdoYXQgdGhleSBzaG91bGQgZG93bmxvYWQuIEl0IGlzIG11Y2ggZWFzaWVyIHRvIHVuZGVyc3RhbmQgYW5kIHdvcmsgd2l0aC5cbiAgY29uc3Qgc3VtbWFyaXplX2ljaWNsZSA9IChjc3YsIGljaWNsZV9rZXlzID0gbnVsbCkgPT4ge1xuICAgIGNvbnN0IHJvd3MgPSBjc3YubWFwKChba2V5LCB2YWxdKSA9PiAoe1xuICAgICAgcGFydHM6IGtleS5zcGxpdChcIl9cIikuc2xpY2UoMSksXG4gICAgICB2YWx1ZTogK3ZhbFxuICAgIH0pKTtcbiAgICBjb25zdCB0b3RhbCA9IGQzLnN1bShyb3dzLCAoZCkgPT4gZC52YWx1ZSk7XG5cbiAgICBjb25zdCBtYXhEZXB0aCA9IE1hdGgubWF4KC4uLnJvd3MubWFwKChyKSA9PiByLnBhcnRzLmxlbmd0aCkpO1xuICAgIGNvbnN0IGxldmVsTmFtZXMgPSBpY2ljbGVfa2V5c1xuICAgICAgPyBPYmplY3Qua2V5cyhpY2ljbGVfa2V5cylcbiAgICAgIDogWy4uLkFycmF5KG1heERlcHRoKS5rZXlzKCldLm1hcCgoaSkgPT4gYGxldmVsJHtpICsgMX1gKTtcblxuICAgIGNvbnN0IGxvb2t1cE5hbWUgPSAoZGltLCBrZXkpID0+IHtcbiAgICAgIGlmICghaWNpY2xlX2tleXMpIHJldHVybiBrZXk7XG4gICAgICByZXR1cm4gaWNpY2xlX2tleXNbZGltXT8uW2tleV0/LlswXSA/PyBrZXk7XG4gICAgfTtcblxuICAgIGNvbnN0IGdlbmRlclRvdGFscyA9IHt9O1xuICAgIHJvd3MuZm9yRWFjaCgocikgPT4ge1xuICAgICAgY29uc3QgZ2VuZGVyID0gci5wYXJ0c1swXTtcbiAgICAgIGdlbmRlclRvdGFsc1tnZW5kZXJdID0gKGdlbmRlclRvdGFsc1tnZW5kZXJdIHx8IDApICsgci52YWx1ZTtcbiAgICB9KTtcblxuICAgIC8vIFJlY3Vyc2l2ZSBoZWxwZXJcbiAgICBjb25zdCByZWN1cnNlID0gKHJvd3MsIGRlcHRoID0gMCwgcHJlZml4ID0gW10pID0+IHtcbiAgICAgIGlmICghcm93cy5sZW5ndGgpIHJldHVybiBbXTtcbiAgICAgIGlmIChkZXB0aCA+PSBtYXhEZXB0aCkgcmV0dXJuIFtdO1xuXG4gICAgICByZXR1cm4gZDNcbiAgICAgICAgLnJvbGx1cHMoXG4gICAgICAgICAgcm93cyxcbiAgICAgICAgICAodikgPT4gZDMuc3VtKHYsIChkKSA9PiBkLnZhbHVlKSxcbiAgICAgICAgICAoZCkgPT4gZC5wYXJ0c1tkZXB0aF1cbiAgICAgICAgKVxuICAgICAgICAuZmxhdE1hcCgoW2ssIHN1bV0pID0+IHtcbiAgICAgICAgICBjb25zdCBjdXJyZW50ID0gWy4uLnByZWZpeCwga107XG4gICAgICAgICAgY29uc3Qgcm93T2JqID0ge307XG4gICAgICAgICAgbGV2ZWxOYW1lcy5mb3JFYWNoKChjb2wsIGkpID0+IHtcbiAgICAgICAgICAgIHJvd09ialtjb2xdID0gY3VycmVudFtpXSA/IGxvb2t1cE5hbWUoY29sLCBjdXJyZW50W2ldKSA6IG51bGw7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcm93T2JqLnBjdF90b3RhbCA9ICgxMDAgKiBzdW0pIC8gdG90YWw7XG4gICAgICAgICAgLy8gcGN0IHJlbGF0aXZlIHRvIGdlbmRlclxuICAgICAgICAgIGNvbnN0IGdlbmRlcktleSA9IHByZWZpeFswXTtcbiAgICAgICAgICBpZiAoZ2VuZGVyS2V5ICYmIGdlbmRlclRvdGFsc1tnZW5kZXJLZXldKSB7XG4gICAgICAgICAgICByb3dPYmoucGN0X29mX2dlbmRlciA9ICgxMDAgKiBzdW0pIC8gZ2VuZGVyVG90YWxzW2dlbmRlcktleV07XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICByb3dPYmosXG4gICAgICAgICAgICAuLi5yZWN1cnNlKFxuICAgICAgICAgICAgICByb3dzLmZpbHRlcigocikgPT4gci5wYXJ0c1tkZXB0aF0gPT09IGspLFxuICAgICAgICAgICAgICBkZXB0aCArIDEsXG4gICAgICAgICAgICAgIGN1cnJlbnRcbiAgICAgICAgICAgIClcbiAgICAgICAgICBdO1xuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgcmV0dXJuIHJlY3Vyc2Uocm93cyk7XG4gIH07XG5cbiAgcmV0dXJuIHN1bW1hcml6ZV9pY2ljbGUoY3N2LCBpY2ljbGVLZXlzKTtcbn1cblxuLy8gQ3JlYXRlIGluc2lnaHQgZGF0YSBzdHJ1Y3R1cmVcbmljaWNsZV9pbnNpZ2h0ID0ge1xuICBpZiAoIWljaWNsZV9wY3RfdGFibGUgfHwgaWNpY2xlX3BjdF90YWJsZS5sZW5ndGggPT09IDApIHJldHVybiB7fTtcbiAgXG4gIGNvbnN0IHJvdW5kID0gMTtcbiAgXG4gIC8vIE9ubHkgc3VtIGxlYWYtbGV2ZWwgcm93cyAobW9zdCBzcGVjaWZpYyBjb21iaW5hdGlvbnMpIHRvIGF2b2lkIGRvdWJsZS1jb3VudGluZ1xuICBjb25zdCBsZWFmUm93cyA9IGljaWNsZV9wY3RfdGFibGUuZmlsdGVyKGQgPT4gZC5nZW5kZXIgJiYgZC5wb3ZlcnR5ICYmIGQuZWR1Y2F0aW9uKTtcbiAgXG4gIGNvbnN0IHN1bSA9IChmaWx0ZXIpID0+XG4gICAgK2QzXG4gICAgICAuc3VtKGxlYWZSb3dzLmZpbHRlcihmaWx0ZXIpLCAoZCkgPT4gZC5wY3Rfb2ZfZ2VuZGVyKSAvLyBUb3RhbCBhcyAlIG9mIGdlbmRlciBub3QgdG90YWwgcG9wXG4gICAgICAudG9GaXhlZChyb3VuZCk7XG5cbiAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGZpbmQgc2luZ2xlIHZhbHVlXG4gIGNvbnN0IGZpbmQgPSAoZmlsdGVyKSA9PlxuICAgICsoaWNpY2xlX3BjdF90YWJsZS5maW5kKGZpbHRlcik/LnBjdF90b3RhbCB8fCAwKS50b0ZpeGVkKHJvdW5kKTtcbiAgXG4gIHJldHVybiB7XG4gICAgLy8gVG90YWwgcG9wdWxhdGlvbiBieSBnZW5kZXJcbiAgICBtYWxlOiArZDMuc3VtKGxlYWZSb3dzLmZpbHRlcihkID0+IGQuZ2VuZGVyID09PSBcIm1hbGVcIiksIGQgPT4gZC5wY3RfdG90YWwpLnRvRml4ZWQocm91bmQpLFxuICAgIGZlbWFsZTogK2QzLnN1bShsZWFmUm93cy5maWx0ZXIoZCA9PiBkLmdlbmRlciA9PT0gXCJmZW1hbGVcIiksIGQgPT4gZC5wY3RfdG90YWwpLnRvRml4ZWQocm91bmQpLFxuICAgIFxuICAgIC8vIEVkdWNhdGlvbiBsZXZlbHMgYnkgZ2VuZGVyICh1c2luZyBwY3Rfb2ZfZ2VuZGVyKVxuICAgIHNlY19lZHVfbTogc3VtKChkKSA9PiBkLmdlbmRlciA9PT0gXCJtYWxlXCIgJiYgZC5lZHVjYXRpb24gPT09IFwicHJpbWFyeVwiKSxcbiAgICBzZWNfZWR1X2Y6IHN1bSgoZCkgPT4gZC5nZW5kZXIgPT09IFwiZmVtYWxlXCIgJiYgZC5lZHVjYXRpb24gPT09IFwicHJpbWFyeVwiKSxcbiAgICBub19lZHVfbTogc3VtKChkKSA9PiBkLmdlbmRlciA9PT0gXCJtYWxlXCIgJiYgZC5lZHVjYXRpb24gPT09IFwibm9wcmltYXJ5XCIpLFxuICAgIG5vX2VkdV9mOiBzdW0oKGQpID0+IGQuZ2VuZGVyID09PSBcImZlbWFsZVwiICYmIGQuZWR1Y2F0aW9uID09PSBcIm5vcHJpbWFyeVwiKSxcbiAgICBcbiAgICAvLyBQb3ZlcnR5IGxldmVscyBieSBnZW5kZXIgKHVzaW5nIHBjdF9vZl9nZW5kZXIpXG4gICAgaGlnaF9wb3ZlcnR5X206IHN1bSgoZCkgPT4gZC5nZW5kZXIgPT09IFwibWFsZVwiICYmIGQucG92ZXJ0eSA9PT0gXCJoaWdoXCIpLFxuICAgIGhpZ2hfcG92ZXJ0eV9mOiBzdW0oKGQpID0+IGQuZ2VuZGVyID09PSBcImZlbWFsZVwiICYmIGQucG92ZXJ0eSA9PT0gXCJoaWdoXCIpLFxuICAgIGxvd19wb3ZlcnR5X206IHN1bSgoZCkgPT4gZC5nZW5kZXIgPT09IFwibWFsZVwiICYmIGQucG92ZXJ0eSA9PT0gXCJsb3dcIiksXG4gICAgbG93X3BvdmVydHlfZjogc3VtKChkKSA9PiBkLmdlbmRlciA9PT0gXCJmZW1hbGVcIiAmJiBkLnBvdmVydHkgPT09IFwibG93XCIpLFxuICAgIFxuICAgIC8vIE1vc3QgdnVsbmVyYWJsZSBncm91cCAoaGlnaCBwb3ZlcnR5ICsgbm8gZWR1Y2F0aW9uKVxuICAgIG1vc3RfdnVsbl9tOiBmaW5kKFxuICAgICAgKGQpID0+XG4gICAgICAgIGQuZ2VuZGVyID09PSBcIm1hbGVcIiAmJlxuICAgICAgICBkLnBvdmVydHkgPT09IFwiaGlnaFwiICYmXG4gICAgICAgIGQuZWR1Y2F0aW9uID09PSBcIm5vcHJpbWFyeVwiXG4gICAgKSxcbiAgICBtb3N0X3Z1bG5fZjogZmluZChcbiAgICAgIChkKSA9PlxuICAgICAgICBkLmdlbmRlciA9PT0gXCJmZW1hbGVcIiAmJlxuICAgICAgICBkLnBvdmVydHkgPT09IFwiaGlnaFwiICYmXG4gICAgICAgIGQuZWR1Y2F0aW9uID09PSBcIm5vcHJpbWFyeVwiXG4gICAgKVxuICB9O1xufVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0zOSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Ii8vIEdlbmVyYXRlIGEgc3RyaW5nIHRoYXQgZGVzY3JpYmVzIHRoZSBwb2ludHMgb2YgYSBicmVhZGNydW1iIFNWRyBwb2x5Z29uLlxuZnVuY3Rpb24gYnJlYWRjcnVtYlBvaW50cyhkLCBpKSB7XG4gIGNvbnN0IHRpcFdpZHRoID0gMTA7XG4gIGNvbnN0IHBvaW50cyA9IFtdO1xuICBwb2ludHMucHVzaChcIjAsMFwiKTtcbiAgcG9pbnRzLnB1c2goYCR7YnJlYWRjcnVtYldpZHRofSwwYCk7XG4gIHBvaW50cy5wdXNoKGAke2JyZWFkY3J1bWJXaWR0aCArIHRpcFdpZHRofSwke2JyZWFkY3J1bWJIZWlnaHQgLyAyfWApO1xuICBwb2ludHMucHVzaChgJHticmVhZGNydW1iV2lkdGh9LCR7YnJlYWRjcnVtYkhlaWdodH1gKTtcbiAgcG9pbnRzLnB1c2goYDAsJHticmVhZGNydW1iSGVpZ2h0fWApO1xuICBpZiAoaSA+IDApIHtcbiAgICAvLyBMZWZ0bW9zdCBicmVhZGNydW1iOyBkb24ndCBpbmNsdWRlIDZ0aCB2ZXJ0ZXguXG4gICAgcG9pbnRzLnB1c2goYCR7dGlwV2lkdGh9LCR7YnJlYWRjcnVtYkhlaWdodCAvIDJ9YCk7XG4gIH1cbiAgcmV0dXJuIHBvaW50cy5qb2luKFwiIFwiKTtcbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNDAiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJhbGlhcyA9IHtcbiAgY29uc3QgZmxhdF9hbGlhcyA9IE9iamVjdC5mcm9tRW50cmllcyhcbiAgICBPYmplY3QudmFsdWVzKGljaWNsZUtleXMpLmZsYXRNYXAoKG9iaikgPT5cbiAgICAgIE9iamVjdC5lbnRyaWVzKG9iaikubWFwKChbaywgdl0pID0+IFtrLCB2WzBdXSlcbiAgICApXG4gICk7XG4gIGZsYXRfYWxpYXMucG9wdWxhdGlvbiA9IFwiVG90YWwgUG9wdWxhdGlvblwiO1xuICByZXR1cm4gZmxhdF9hbGlhcztcbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNDEiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJpY2ljbGVfZGljdCA9IG5ldyBPYmplY3Qoe1xuICBnZW5kZXIwOiB7IGVuOiBcIk1hbGVcIiwgZnI6IFwiXCIgfSxcbiAgZ2VuZGVyMTogeyBlbjogXCJGZW1hbGVcIiwgZnI6IFwiXCIgfSxcbiAgcG92ZXJ0eTE6IHsgZW46IFwiTG93IFBvdmVydHlcIiwgZnI6IFwiXCIgfSxcbiAgcG92ZXJ0eTI6IHsgZW46IFwiTW9kZXJhdGUgUG92ZXJ0eVwiLCBmcjogXCJcIiB9LFxuICBwb3ZlcnR5MzogeyBlbjogXCJIaWdoIFBvdmVydHlcIiwgZnI6IFwiXCIgfSxcbiAgZWR1Y2F0aW9uMzogeyBlbjogXCJTZWNvbmRhcnkgRWR1Y2F0aW9uXCIsIGZyOiBcIlwiIH0sXG4gIGVkdWNhdGlvbjI6IHsgZW46IFwiUHJpbWFyeSBFZHVjYXRpb25cIiwgZnI6IFwiXCIgfSxcbiAgZWR1Y2F0aW9uMTogeyBlbjogXCJObyBQcmltYXJ5IEVkdWNhdGlvblwiLCBmcjogXCJcIiB9LFxufSk7XG5cbmljaWNsZV9jb2xvciA9IGQzXG4gIC5zY2FsZU9yZGluYWwoKVxuICAuZG9tYWluKFtcbiAgICBcInBvcHVsYXRpb25cIixcbiAgICBcImdlbmRlcjFcIiwgLy8gZmVtYWxlXG4gICAgXCJnZW5kZXIwXCIsIC8vIG1hbGVcblxuICAgIFwicG92ZXJ0eTFcIiwgLy8gbG93IHBvdmVydHkgPSBnb29kIC8vIFRPRE86IENoZWNrIHRoZSBkaXJlY3Rpb25hbGl0eSBvZiB0aGlzIGluIHByZXByb2Nlc3MgY29kZVxuICAgIFwicG92ZXJ0eTJcIiwgLy8gbWlkLiBwb3ZlcnR5ID0gbWlkXG4gICAgXCJwb3ZlcnR5M1wiLCAvLyBoaWdoIHBvdmVydHkgPSBiYWRcblxuICAgIFwiZWR1Y2F0aW9uM1wiLCAvLyBoaWdoIGVkdS4gPSBnb29kXG4gICAgXCJlZHVjYXRpb24yXCIsIC8vIG1pZC4gZWR1LiA9IG1pZFxuICAgIFwiZWR1Y2F0aW9uMVwiLCAvLyBsb3cgZWR1ID0gYmFkXG4gIF0pXG4gIC5yYW5nZShbXG4gICAgXCIjYTRhNGE0XCIsIC8vIHBvcHVsYXRpb24gLSByZW1vdmVkXG4gICAgXCIjNTlDRDkwXCIsIC8vIGZlbWFsZSAtICM1OUNEOTBcbiAgICBcIiNBNDkxRDNcIiwgLy8gbWFsZVxuXG4gICAgXCIjZjRiYjIxXCIsIC8vIGxvdyBwb3ZlcnR5ID0gZ29vZFxuICAgIFwiI2ZjOGEzNFwiLCAvLyBtaWQuIHBvdmVydHkgPSBtaWRcbiAgICBcIiNlYzVhNDdcIiwgLy8gaGlnaCBwb3ZlcnR5ID0gYmFkXG5cbiAgICBcIiNmNGJiMjFcIiwgLy8gaGlnaCBlZHUgPSBnb29kXG4gICAgXCIjZmM4YTM0XCIsIC8vIG1pZC4gZWR1ID0gbWlkXG4gICAgXCIjZWM1YTQ3XCIsIC8vIGxvdyBlZHUgPSBiYWRcbiAgXSk7XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTQyIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiYnJlYWRjcnVtYiA9IHtcbiAgLy8gT25seSBzaG93IGJyZWFkY3J1bWIgaWYgdGhlcmUncyBhIHNlcXVlbmNlIHRvIGRpc3BsYXlcbiAgLy8gaWYgKCFpY2ljbGUuc2VxdWVuY2UgfHwgaWNpY2xlLnNlcXVlbmNlLmxlbmd0aCA9PT0gMCkge1xuICAvLyAgIHJldHVybiBodGwuaHRtbGA8ZGl2IHN0eWxlPVwiaGVpZ2h0OiAke2JyZWFkY3J1bWJIZWlnaHR9cHg7XCI+PC9kaXY+YDtcbiAgLy8gfVxuXG4gIGNvbnN0IHJlbmRlckJyZWFkY3J1bWIgPSAoKSA9PiB7XG4gICAgY29uc3Qgc3ZnID0gZDNcbiAgICAgIC5jcmVhdGUoXCJzdmdcIilcbiAgICAgIC5hdHRyKFwidmlld0JveFwiLCBgMCAwICR7YnJlYWRjcnVtYldpZHRoICogNC43NX0gJHticmVhZGNydW1iSGVpZ2h0fWApXG4gICAgICAuc3R5bGUoXCJmb250XCIsIFwiMTNweCBzYW5zLXNlcmlmXCIpXG4gICAgICAuc3R5bGUoXCJtYXJnaW5cIiwgXCIycHhcIilcbiAgICAgIC5zdHlsZShcImRpc3BsYXlcIiwgXCJibG9ja1wiKTtcblxuICAgIGNvbnN0IGcgPSBzdmdcbiAgICAgIC5zZWxlY3RBbGwoXCJnXCIpXG4gICAgICAuZGF0YShpY2ljbGUuc2VxdWVuY2UpXG4gICAgICAuam9pbihcImdcIilcbiAgICAgIC5hdHRyKFwidHJhbnNmb3JtXCIsIChkLCBpKSA9PiBgdHJhbnNsYXRlKCR7aSAqIGJyZWFkY3J1bWJXaWR0aH0sIDApYCk7XG5cbiAgICBnLmFwcGVuZChcInBvbHlnb25cIilcbiAgICAgIC5hdHRyKFwicG9pbnRzXCIsIGJyZWFkY3J1bWJQb2ludHMpXG4gICAgICAuYXR0cihcImZpbGxcIiwgKGQpID0+IHtcbiAgICAgICAgcmV0dXJuIGljaWNsZV9jb2xvcihkLmRhdGEubmFtZSlcbiAgICAgICAgfSlcbiAgICAgIC5hdHRyKFwic3Ryb2tlXCIsIFwid2hpdGVcIik7XG5cbiAgICBnLmFwcGVuZChcInRleHRcIilcbiAgICAgIC5hdHRyKFwieFwiLCAoYnJlYWRjcnVtYldpZHRoICsgMTApIC8gMilcbiAgICAgIC5hdHRyKFwieVwiLCAxNSlcbiAgICAgIC5hdHRyKFwiZHlcIiwgXCIwLjM1ZW1cIilcbiAgICAgIC5hdHRyKFwidGV4dC1hbmNob3JcIiwgXCJtaWRkbGVcIilcbiAgICAgIC5hdHRyKFwiZmlsbFwiLCBcIndoaXRlXCIpXG4gICAgICAuYXR0cihcImZvbnQtc2l6ZVwiLCBcIjEycHhcIilcbiAgICAgIC50ZXh0KChkKSA9PiB7XG4gICAgICAgIGNvbnN0IG5hbWUgPSBkLmRhdGEubmFtZTtcbiAgICAgICAgcmV0dXJuIF9sYW5nKGljaWNsZV9kaWN0W25hbWVdKTtcbiAgICAgICAgLy8gRGVmYXVsdCBmYWxsYmFjayAtIGNhcGl0YWxpemUgYW5kIHJlcGxhY2UgdW5kZXJzY29yZXNcbiAgICAgICAgLy8gcmV0dXJuIG5hbWUuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBuYW1lLnNsaWNlKDEpLnJlcGxhY2UoL18vZywgJyAnKTtcbiAgICAgIH0pO1xuXG4gICAgLy8gQWx3YXlzIHNob3cgcGVyY2VudGFnZSBhdCB0aGUgZW5kIG9mIGJyZWFkY3J1bWIgd2hlbiB0aGVyZSdzIGEgc2VxdWVuY2VcbiAgICBpZiAoaWNpY2xlLnNlcXVlbmNlICYmIGljaWNsZS5zZXF1ZW5jZS5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBwZXJjZW50YWdlID0gTnVtYmVyKGljaWNsZS5wZXJjZW50YWdlKSB8fCAwO1xuICAgICAgc3ZnXG4gICAgICAgIC5hcHBlbmQoXCJ0ZXh0XCIpXG4gICAgICAgIC50ZXh0KHBlcmNlbnRhZ2UgPiAwID8gcGVyY2VudGFnZS50b0ZpeGVkKDEpICsgXCIlXCIgOiBcIlwiKVxuICAgICAgICAuYXR0cihcInhcIiwgKGljaWNsZS5zZXF1ZW5jZS5sZW5ndGggKyAwLjI1KSAqIGJyZWFkY3J1bWJXaWR0aClcbiAgICAgICAgLmF0dHIoXCJ5XCIsIGJyZWFkY3J1bWJIZWlnaHQgLyAyKVxuICAgICAgICAuYXR0cihcImR5XCIsIFwiMC4zNWVtXCIpXG4gICAgICAgIC5hdHRyKFwidGV4dC1hbmNob3JcIiwgXCJtaWRkbGVcIilcbiAgICAgICAgLmF0dHIoXCJmb250LXNpemVcIiwgXCIxMnB4XCIpXG4gICAgICAgIC5hdHRyKFwiZmlsbFwiLCBcImJsYWNrXCIpXG4gICAgICAgIC5hdHRyKFwiZm9udC13ZWlnaHRcIiwgXCJib2xkXCIpO1xuICAgIH1cbiAgICByZXR1cm4gc3ZnLm5vZGUoKTtcbiAgfTtcblxuICByZXR1cm4gaHRsLmh0bWxgXG48ZGl2IHN0eWxlPVwiaGVpZ2h0OiAke2JyZWFkY3J1bWJIZWlnaHQgKyAzfXB4OyBvdmVyZmxvdzogaGlkZGVuO1wiPlxuICAgICR7aWNpY2xlLnNlcXVlbmNlICYmIGljaWNsZS5zZXF1ZW5jZS5sZW5ndGggPiAwIFxuICAgICAgPyByZW5kZXJCcmVhZGNydW1iKGljaWNsZS5zZXF1ZW5jZSlcbiAgICAgIDogXCJcIn1cbiAgPC9kaXY+XG5gO1xufVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC00MyIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6InZpZXdvZiBpY2ljbGUgPSB7XG4gIC8vIFNob3cgbG9hZGluZyBzcGlubmVyIG9ubHkgaWYgZGF0YSBpcyBzdGlsbCBsb2FkaW5nIChudWxsL3VuZGVmaW5lZClcbiAgaWYgKGNzdl9yYXcgPT09IG51bGwgfHwgY3N2X3JhdyA9PT0gdW5kZWZpbmVkIHx8IGljaWNsZUtleXMgPT09IG51bGwgfHwgaWNpY2xlS2V5cyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgY29uc3QgbG9hZGluZyA9IGNyZWF0ZUxvYWRpbmdTdGF0ZShfbGFuZyh7ZW46IFwiTG9hZGluZyBzZW5zaXRpdml0eSBkYXRhLi4uXCIsIGZyOiBcIkNoYXJnZW1lbnQgZGVzIGRvbm7DqWVzIGRlIHNlbnNpYmlsaXTDqS4uLlwifSkpO1xuICAgIGNvbnN0IGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICBlbGVtZW50LmlubmVySFRNTCA9IGxvYWRpbmcub3V0ZXJIVE1MO1xuICAgIGVsZW1lbnQudmFsdWUgPSB7IHNlcXVlbmNlOiBbXSwgcGVyY2VudGFnZTogMC4wIH07XG4gICAgcmV0dXJuIGVsZW1lbnQ7XG4gIH1cbiAgXG4gIC8vIElmIGRhdGEgaXMgbG9hZGVkIGJ1dCBlbXB0eSwgc2hvdyBubyBkYXRhIHN0YXRlXG4gIGlmICghY3N2X3JhdyB8fCBjc3ZfcmF3Lmxlbmd0aCA9PT0gMCB8fCAhaWNpY2xlS2V5cykge1xuICAgIGNvbnN0IG5vRGF0YSA9IGNyZWF0ZU5vRGF0YVN0YXRlKF9sYW5nKHZ1bG5lcmFiaWxpdHlfdHJhbnNsYXRpb25zLm5vX2RhdGFfYXZhaWxhYmxlKSk7XG4gICAgY29uc3QgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgIGVsZW1lbnQuaW5uZXJIVE1MID0gbm9EYXRhLm91dGVySFRNTDtcbiAgICBlbGVtZW50LnZhbHVlID0geyBzZXF1ZW5jZTogW10sIHBlcmNlbnRhZ2U6IDAuMCB9O1xuICAgIHJldHVybiBlbGVtZW50O1xuICB9XG5cbiAgY29uc3QgbGF5ZXJMYWJlbHMgPSBbXCJHZW5kZXJcIiwgXCJQb3ZlcnR5XCIsIFwiRWR1Y2F0aW9uXCJdOyAvLyBhZGp1c3QgYXMgbmVlZGVkXG5cbiAgY29uc3QgZ3V0dGVyID0gODA7XG5cbiAgY29uc3Qgb3JkZXIgPSB7XG4gICAgLy8gU2V0IHRoZSBvcmRlciBvZiB0aGUgcmVjdGFuZ2VzIGZvciBpY2ljbGUgY2hhcnQgd29yc2UgLT4gYmV0dGVyXG4gICAgcG92ZXJ0eTE6IDIsXG4gICAgcG92ZXJ0eTI6IDEsXG4gICAgcG92ZXJ0eTM6IDAsXG4gICAgZWR1Y2F0aW9uMTogMCxcbiAgICBlZHVjYXRpb24yOiAxLFxuICAgIGVkdWNhdGlvbjM6IDJcbiAgfTtcblxuICBjb25zdCByb290ID0gcGFydGl0aW9uKGRhdGEsIG9yZGVyKTtcblxuICBsZXQgZnJvemVuID0gZmFsc2U7XG4gIGxldCBmcm96ZW5TZXF1ZW5jZSA9IFtdO1xuICAvLyBjb25zdCBwYWRkaW5nID0gMTA7XG4gIGNvbnN0IHN2ZyA9IGQzLmNyZWF0ZShcInN2Z1wiKTtcbiAgLy8gTWFrZSB0aGlzIGludG8gYSB2aWV3LCBzbyB0aGF0IHRoZSBjdXJyZW50bHkgaG92ZXJlZCBzZXF1ZW5jZSBpcyBhdmFpbGFibGUgdG8gdGhlIGJyZWFkY3J1bWJcbiAgY29uc3QgZWxlbWVudCA9IHN2Zy5ub2RlKCk7XG4gIGVsZW1lbnQudmFsdWUgPSB7IHNlcXVlbmNlOiBbXSwgcGVyY2VudGFnZTogMC4wIH07XG5cbiAgc3ZnXG4gICAgLmF0dHIoXCJ2aWV3Qm94XCIsIGAwIDAgJHt3aWR0aCArIGd1dHRlcn0gJHtoZWlnaHR9YClcbiAgICAuc3R5bGUoXCJmb250XCIsIFwiMTJweCBzYW5zLXNlcmlmXCIpO1xuXG4gIGNvbnN0IHBsb3QgPSBzdmcuYXBwZW5kKFwiZ1wiKS5hdHRyKFwidHJhbnNmb3JtXCIsIGB0cmFuc2xhdGUoJHtndXR0ZXJ9LDApYCk7XG5cbiAgcGxvdFxuICAgIC5hcHBlbmQoXCJyZWN0XCIpXG4gICAgLmF0dHIoXCJ3aWR0aFwiLCB3aWR0aClcbiAgICAuYXR0cihcImhlaWdodFwiLCBoZWlnaHQpXG4gICAgLmF0dHIoXCJmaWxsXCIsIFwibm9uZVwiKTtcblxuICBjb25zdCBzZWdtZW50ID0gcGxvdFxuICAgIC5hcHBlbmQoXCJnXCIpXG4gICAgLmF0dHIoXCJ0cmFuc2Zvcm1cIiwgKGQpID0+XG4gICAgICBuYXJyb3cgPyBgdHJhbnNsYXRlKCR7LXJvb3QueTF9LCA0MClgIDogYHRyYW5zbGF0ZSgwLCAkey1yb290LnkxICsgNDB9KWBcbiAgICApXG4gICAgLnNlbGVjdEFsbChcInJlY3RcIilcbiAgICAuZGF0YShcbiAgICAgIHJvb3QuZGVzY2VuZGFudHMoKS5maWx0ZXIoKGQpID0+IHtcbiAgICAgICAgcmV0dXJuIGQuZGVwdGg7XG4gICAgICB9KVxuICAgIClcbiAgICAuam9pbihcInJlY3RcIilcbiAgICAuYXR0cihcImZpbGxcIiwgKGQpID0+IGljaWNsZV9jb2xvcihkLmRhdGEubmFtZSkpXG4gICAgLmF0dHIoXCJ4XCIsIHNlZ21lbnRYKVxuICAgIC5hdHRyKFwieVwiLCBzZWdtZW50WSlcbiAgICAuYXR0cihcIndpZHRoXCIsIHNlZ21lbnRXaWR0aClcbiAgICAuYXR0cihcImhlaWdodFwiLCBzZWdtZW50SGVpZ2h0KVxuICAgIC5vbihcIm1vdXNlZW50ZXJcIiwgKGV2ZW50LCBkKSA9PiB7XG4gICAgICBpZiAoZnJvemVuKSByZXR1cm47XG4gICAgICAvLyBHZXQgdGhlIGFuY2VzdG9ycyBvZiB0aGUgY3VycmVudCBzZWdtZW50LCBtaW51cyB0aGUgcm9vdFxuICAgICAgY29uc3Qgc2VxdWVuY2UgPSBkLmFuY2VzdG9ycygpLnJldmVyc2UoKS5zbGljZSgxKTtcbiAgICAgIC8vIEhpZ2hsaWdodCB0aGUgYW5jZXN0b3JzXG4gICAgICBzZWdtZW50LmF0dHIoXCJmaWxsLW9wYWNpdHlcIiwgKG5vZGUpID0+XG4gICAgICAgIHNlcXVlbmNlLmluZGV4T2Yobm9kZSkgPj0gMCA/IDEuMCA6IDAuM1xuICAgICAgKTtcbiAgICAgIGNvbnN0IHBlcmNlbnRhZ2UgPSAoMTAwICogKGQudmFsdWUgLyByb290LnZhbHVlKSkudG9QcmVjaXNpb24oMyk7XG4gICAgICBlbGVtZW50LnZhbHVlID0geyBzZXF1ZW5jZSwgcGVyY2VudGFnZSB9O1xuICAgICAgZWxlbWVudC5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudChcImlucHV0XCIpKTtcbiAgICB9KVxuICAgIC5vbihcImNsaWNrXCIsIChldmVudCwgZCkgPT4ge1xuICAgICAgaWYgKGZyb3plbikge1xuICAgICAgICBmcm96ZW4gPSBmYWxzZTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZnJvemVuID0gdHJ1ZTtcbiAgICAgICAgZnJvemVuU2VxdWVuY2UgPSBkLmFuY2VzdG9ycygpLnJldmVyc2UoKS5zbGljZSgxKTtcbiAgICAgICAgc2VnbWVudC5hdHRyKFwiZmlsbC1vcGFjaXR5XCIsIChub2RlKSA9PlxuICAgICAgICAgIGZyb3plblNlcXVlbmNlLmluZGV4T2Yobm9kZSkgPj0gMCA/IDEuMCA6IDAuM1xuICAgICAgICApO1xuICAgICAgICBjb25zdCBwZXJjZW50YWdlID0gKDEwMCAqIChkLnZhbHVlIC8gcm9vdC52YWx1ZSkpLnRvUHJlY2lzaW9uKDMpO1xuICAgICAgICBlbGVtZW50LnZhbHVlID0geyBzZXF1ZW5jZTogZnJvemVuU2VxdWVuY2UsIHBlcmNlbnRhZ2UgfTtcbiAgICAgICAgZWxlbWVudC5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudChcImlucHV0XCIpKTtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7IC8vIHByZXZlbnQgc3ZnIGNsaWNrIGZyb20gZmlyaW5nXG4gICAgICB9XG4gICAgfSk7XG5cbiAgLy8gQWRkIHNpZGViYXIgdGV4dFxuICBjb25zdCBkZXB0aE5vZGVzID0gZDNcbiAgICAucm9sbHVwcyhcbiAgICAgIHJvb3QuZGVzY2VuZGFudHMoKS5maWx0ZXIoKGQpID0+IGQuZGVwdGgpLFxuICAgICAgKHYpID0+IHZbMF0sIC8vIHJlcHJlc2VudGF0aXZlIG5vZGUgcGVyIGRlcHRoXG4gICAgICAoZCkgPT4gZC5kZXB0aFxuICAgIClcbiAgICAuc29ydCgoYSwgYikgPT4gZDMuYXNjZW5kaW5nKGFbMF0sIGJbMF0pKTsgLy8gc29ydCBieSBkZXB0aCBhc2NcblxuICBwbG90XG4gICAgLmFwcGVuZChcImdcIilcbiAgICAuYXR0cihcInRyYW5zZm9ybVwiLCAoZCkgPT5cbiAgICAgIG5hcnJvdyA/IGB0cmFuc2xhdGUoJHstcm9vdC55MX0sIDQwKWAgOiBgdHJhbnNsYXRlKDAsICR7LXJvb3QueTEgKyA0MH0pYFxuICAgIClcbiAgICAuc2VsZWN0QWxsKFwidGV4dC5sYXllci1sYWJlbFwiKVxuICAgIC5kYXRhKFxuICAgICAgZGVwdGhOb2Rlcy5tYXAoKFtkZXB0aCwgcmVwXSkgPT4gKHtcbiAgICAgICAgZGVwdGgsXG4gICAgICAgIHk6IHNlZ21lbnRZKHJlcCkgKyBzZWdtZW50SGVpZ2h0KHJlcCkgLyAyXG4gICAgICB9KSlcbiAgICApXG4gICAgLmpvaW4oXCJ0ZXh0XCIpXG4gICAgLmF0dHIoXCJjbGFzc1wiLCBcImxheWVyLWxhYmVsXCIpXG4gICAgLmF0dHIoXCJ4XCIsIC0xMikgLy8gbGVmdCBvZiB0aGUgaWNpY2xlIGFyZWEgKGluc2lkZSBndXR0ZXIpXG4gICAgLmF0dHIoXCJ5XCIsIChkKSA9PiBkLnkpXG4gICAgLmF0dHIoXCJkeVwiLCBcIjAuMzVlbVwiKVxuICAgIC5hdHRyKFwidGV4dC1hbmNob3JcIiwgXCJlbmRcIilcbiAgICAuYXR0cihcImZvbnQtc2l6ZVwiLCBcIjEycHhcIilcbiAgICAuYXR0cihcImZvbnQtd2VpZ2h0XCIsIFwiNjAwXCIpXG4gICAgLnRleHQoKGQpID0+IGxheWVyTGFiZWxzW2QuZGVwdGggLSAxXSA/PyBgTGF5ZXIgJHtkLmRlcHRofWApO1xuXG4gIC8vIEFkZCBwZXJjZW50YWdlIGxhYmVscyB0byBlYWNoIHNlZ21lbnRcbiAgY29uc3QgbGFiZWxzID0gcGxvdFxuICAgIC5hcHBlbmQoXCJnXCIpXG4gICAgLmF0dHIoXCJ0cmFuc2Zvcm1cIiwgKGQpID0+XG4gICAgICBuYXJyb3cgPyBgdHJhbnNsYXRlKCR7LXJvb3QueTF9LCA0MClgIDogYHRyYW5zbGF0ZSgwLCAkey1yb290LnkxICsgNDB9KWBcbiAgICApXG4gICAgLnNlbGVjdEFsbChcInRleHRcIilcbiAgICAuZGF0YShcbiAgICAgIHJvb3QuZGVzY2VuZGFudHMoKS5maWx0ZXIoKGQpID0+IHtcbiAgICAgICAgcmV0dXJuIGQuZGVwdGggJiYgZC5kYXRhLm5hbWUgIT09IFwicG9wdWxhdGlvblwiO1xuICAgICAgfSlcbiAgICApXG4gICAgLmpvaW4oXCJ0ZXh0XCIpXG4gICAgLmF0dHIoXCJ4XCIsIChkKSA9PiBzZWdtZW50WChkKSArIHNlZ21lbnRXaWR0aChkKSAvIDIpXG4gICAgLmF0dHIoXCJ5XCIsIChkKSA9PiBzZWdtZW50WShkKSArIHNlZ21lbnRIZWlnaHQoZCkgLyAyKVxuICAgIC5hdHRyKFwiZHlcIiwgXCIwLjM1ZW1cIilcbiAgICAuYXR0cihcInRleHQtYW5jaG9yXCIsIFwibWlkZGxlXCIpXG4gICAgLmF0dHIoXCJmb250LXNpemVcIiwgXCIxMnB4XCIpXG4gICAgLmF0dHIoXCJmb250LXdlaWdodFwiLCBcImJvbGRcIilcbiAgICAuYXR0cihcImZpbGxcIiwgKGQpID0+IHtcbiAgICAgIC8vIFVzZSBjb250cmFzdGluZyBjb2xvcnMgZm9yIHRleHQgYmFzZWQgb24gYmFja2dyb3VuZFxuICAgICAgY29uc3QgYmdDb2xvciA9IGljaWNsZV9jb2xvcihkLmRhdGEubmFtZSk7XG4gICAgICAvLyBGb3IgZGFyayBjb2xvcnMsIHVzZSB3aGl0ZSB0ZXh0OyBmb3IgbGlnaHQgY29sb3JzLCB1c2UgYmxhY2sgdGV4dFxuICAgICAgLy8gVXBkYXRlZCB0byBtYXRjaCBuZXcgZ2VuZGVyIGNvbG9yczogI0E0OTFEMyAocHVycGxlKSwgI0QwRjBERSAobGlnaHQgZ3JlZW4pXG4gICAgICBpZiAoXG4gICAgICAgIGJnQ29sb3IgPT09IFwiI0E0OTFEM1wiIHx8XG4gICAgICAgIGJnQ29sb3IgPT09IFwiI2VjNWE0N1wiIHx8XG4gICAgICAgIGJnQ29sb3IgPT09IFwiI2ZjOGEzNFwiXG4gICAgICApIHtcbiAgICAgICAgcmV0dXJuIFwid2hpdGVcIjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBcImJsYWNrXCI7XG4gICAgICB9XG4gICAgfSlcbiAgICAuYXR0cihcInBvaW50ZXItZXZlbnRzXCIsIFwibm9uZVwiKSAvLyBQcmV2ZW50IHRleHQgZnJvbSBpbnRlcmZlcmluZyB3aXRoIG1vdXNlIGV2ZW50c1xuICAgIC50ZXh0KChkKSA9PiB7XG4gICAgICBsZXQgZGF0YU9iaiA9IGQ/LmRhdGE7XG4gICAgICBjb25zdCBnZW5kZXJOYW1lID0gZGF0YU9iai5uYW1lLnN0YXJ0c1dpdGgoXCJnZW5kZXJcIikgPyBfbGFuZyhpY2ljbGVfZGljdFtkYXRhT2JqLm5hbWVdKSA6IG51bGw7XG4gICAgICBjb25zdCBnZW5kZXJfc3RyID0gZ2VuZGVyTmFtZSA/IGdlbmRlck5hbWUgKyBcIiAtIFwiIDogXCJcIlxuICAgICAgY29uc3QgcGVyY2VudGFnZSA9ICgxMDAgKiAoZC52YWx1ZSAvIHJvb3QudmFsdWUpKS50b0ZpeGVkKDEpO1xuICAgICAgLy8gT25seSBzaG93IHBlcmNlbnRhZ2UgaWYgdGhlIHNlZ21lbnQgaXMgbGFyZ2UgZW5vdWdoIHRvIGRpc3BsYXkgdGV4dFxuICAgICAgcmV0dXJuIHNlZ21lbnRXaWR0aChkKSA+IDMwICYmIHNlZ21lbnRIZWlnaHQoZCkgPiAxNVxuICAgICAgICA/IGAke2dlbmRlcl9zdHIgKyBwZXJjZW50YWdlfSVgXG4gICAgICAgIDogXCJcIjtcbiAgICB9KTtcblxuICBjb25zdCBtb3VzZUxlYXZlSGFuZGxlciA9ICgpID0+IHtcbiAgICBpZiAoZnJvemVuKSByZXR1cm47XG4gICAgc2VnbWVudC5hdHRyKFwiZmlsbC1vcGFjaXR5XCIsIDEpO1xuICAgIC8vIFVwZGF0ZSB0aGUgdmFsdWUgb2YgdGhpcyB2aWV3XG4gICAgZWxlbWVudC52YWx1ZSA9IHsgc2VxdWVuY2U6IFtdLCBwZXJjZW50YWdlOiAwLjAgfTtcbiAgICBlbGVtZW50LmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KFwiaW5wdXRcIikpO1xuICB9O1xuXG4gIGNvbnN0IGNsaWNrSGFuZGxlciA9ICgpID0+IHtcbiAgICBpZiAoZnJvemVuKSB7XG4gICAgICBmcm96ZW4gPSBmYWxzZTtcbiAgICAgIGZyb3plblNlcXVlbmNlID0gW107XG4gICAgICBzZWdtZW50LmF0dHIoXCJmaWxsLW9wYWNpdHlcIiwgMSk7XG4gICAgICBlbGVtZW50LnZhbHVlID0geyBzZXF1ZW5jZTogW10sIHBlcmNlbnRhZ2U6IDAuMCB9O1xuICAgICAgZWxlbWVudC5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudChcImlucHV0XCIpKTtcbiAgICB9XG4gIH07XG5cbiAgcGxvdC5vbihcIm1vdXNlbGVhdmVcIiwgbW91c2VMZWF2ZUhhbmRsZXIpO1xuICBwbG90Lm9uKFwiY2xpY2tcIiwgY2xpY2tIYW5kbGVyKTtcblxuICAvLyBBZGQgZGlzcG9zYWwgbWVjaGFuaXNtIHRvIGNsZWFuIHVwIGV2ZW50IGxpc3RlbmVyc1xuICAvLyBUaGlzIHByZXZlbnRzIG1lbW9yeSBsZWFrcyB3aGVuIHRoZSBjZWxsIGlzIHJlLWV2YWx1YXRlZFxuICBpZiAoZWxlbWVudC5kaXNwb3NlKSB7XG4gICAgZWxlbWVudC5kaXNwb3NlKCk7XG4gIH1cbiAgZWxlbWVudC5kaXNwb3NlID0gKCkgPT4ge1xuICAgIHBsb3Qub24oXCJtb3VzZWxlYXZlXCIsIG51bGwpO1xuICAgIHBsb3Qub24oXCJjbGlja1wiLCBudWxsKTtcbiAgICBzZWdtZW50Lm9uKFwibW91c2VlbnRlclwiLCBudWxsKTtcbiAgICBzZWdtZW50Lm9uKFwiY2xpY2tcIiwgbnVsbCk7XG4gIH07XG5cbiAgLy8gYWRkIGxlZ2VuZFxuICBjb25zdCBjb2xvclNjYWxlID0gZDNcbiAgICAuc2NhbGVPcmRpbmFsKClcbiAgICAuZG9tYWluKFtcIkJldHRlclwiLCBcIk1vZGVyYXRlXCIsIFwiV29yc2VcIl0pXG4gICAgLnJhbmdlKFtcIiNGNEJCMjFcIiwgXCIjRkM4QTM0XCIsIFwiI0VDNUE0N1wiXSk7XG5cbiAgc3ZnXG4gICAgLmFwcGVuZChcInJlY3RcIilcbiAgICAuYXR0cihcInhcIiwgMSlcbiAgICAuYXR0cihcInlcIiwgNSlcbiAgICAuYXR0cihcInJ4XCIsIDEwKSAvLyBBZGQgcm91bmRlZCBjb3JuZXJzXG4gICAgLmF0dHIoXCJyeVwiLCAxMCkgLy8gQWRkIHJvdW5kZWQgY29ybmVyc1xuICAgIC5hdHRyKFwid2lkdGhcIiwgMzAwKSAvLyBBZGp1c3QgdGhlIHdpZHRoIHRvIGZpdCB0aGUgbGVnZW5kXG4gICAgLmF0dHIoXCJoZWlnaHRcIiwgMzApIC8vIEFkanVzdCB0aGUgaGVpZ2h0IHRvIGZpdCB0aGUgbGVnZW5kXG4gICAgLmF0dHIoXCJmaWxsXCIsIFwiI2ZmZlwiKTtcbiAgLy8gLmF0dHIoXCJzdHJva2VcIiwgXCJibGFja1wiKTtcblxuICBjb25zdCBsZWdlbmQgPSBzdmdcbiAgICAuc2VsZWN0QWxsKFwiLmxlZ2VuZFwiKVxuICAgIC5kYXRhKGNvbG9yU2NhbGUuZG9tYWluKCkpXG4gICAgLmVudGVyKClcbiAgICAuYXBwZW5kKFwiZ1wiKVxuICAgIC5hdHRyKFwiY2xhc3NcIiwgXCJsZWdlbmRcIilcbiAgICAuYXR0cihcInRyYW5zZm9ybVwiLCBmdW5jdGlvbiAoZCwgaSkge1xuICAgICAgcmV0dXJuIFwidHJhbnNsYXRlKFwiICsgKGkgKiAxMDAgKyAyNSkgKyBcIiwxMSlcIjtcbiAgICB9KTtcblxuICBsZWdlbmRcbiAgICAuYXBwZW5kKFwicmVjdFwiKVxuICAgIC5hdHRyKFwieFwiLCAwKVxuICAgIC5hdHRyKFwid2lkdGhcIiwgMTgpXG4gICAgLmF0dHIoXCJoZWlnaHRcIiwgMTgpXG4gICAgLnN0eWxlKFwiZmlsbFwiLCBjb2xvclNjYWxlKTtcblxuICBsZWdlbmRcbiAgICAuYXBwZW5kKFwidGV4dFwiKVxuICAgIC5hdHRyKFwieFwiLCAyNClcbiAgICAuYXR0cihcInlcIiwgOSlcbiAgICAuYXR0cihcImR5XCIsIFwiLjM1ZW1cIilcbiAgICAudGV4dChmdW5jdGlvbiAoZCkge1xuICAgICAgcmV0dXJuIGQ7XG4gICAgfSk7XG5cbiAgcmV0dXJuIGVsZW1lbnQ7XG59XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTQ0IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiLy8gRG93bmxvYWQgZnVuY3Rpb25hbGl0eVxuc2Vuc2l0aXZpdHlEb3dubG9hZEJ1dHRvbiA9IHtcbiAgaWYgKCFpY2ljbGVfcGN0X3RhYmxlIHx8IGljaWNsZV9wY3RfdGFibGUubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIGh0bC5odG1sYGA7XG4gIH1cbiAgXG4gIHJldHVybiBkb3dubG9hZEJ1dHRvbihcbiAgICBpY2ljbGVfcGN0X3RhYmxlLCBcbiAgICBgc2Vuc2l0aXZpdHlfZGF0YV8ke2dldFNlbnNpdGl2aXR5QWRtaW5TZWxlY3Rpb24oKS5yZXBsYWNlKC9cXHMrL2csICdfJyl9YCxcbiAgICBfbGFuZyh2dWxuZXJhYmlsaXR5X3RyYW5zbGF0aW9ucy5kb3dubG9hZF9kYXRhKVxuICApO1xufVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC00NSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Ii8vIER5bmFtaWMgaW5zaWdodHMgLSByZWFjdGl2ZSB0byBpY2ljbGUgc2VsZWN0aW9uXG5zZW5zaXRpdml0eUluc2lnaHRzID0ge1xuICBpZiAoIWRhdGEgfHwgZGF0YS5sZW5ndGggPT09IDAgfHwgIWNzdiB8fCBjc3YubGVuZ3RoID09PSAwIHx8ICFpY2ljbGVfaW5zaWdodCkge1xuICAgIHJldHVybiBjcmVhdGVOb0RhdGFTdGF0ZSgpO1xuICB9XG5cbiAgY29uc3QgcmVnaW9uID0gZ2V0U2Vuc2l0aXZpdHlBZG1pblNlbGVjdGlvbigpO1xuICBjb25zdCBpbnNpZ2h0ID0gaWNpY2xlX2luc2lnaHQ7XG4gIFxuICAvLyBHZW5lcmF0ZSBkZWZhdWx0IGluc2lnaHRzIChhbHdheXMgc2hvd24pXG4gIGNvbnN0IHRvdGFsTWFsZSA9IGluc2lnaHQubWFsZTtcbiAgY29uc3QgdG90YWxGZW1hbGUgPSBpbnNpZ2h0LmZlbWFsZTtcbiAgY29uc3QgbW9zdFZ1bG5Ub3RhbCA9IChpbnNpZ2h0Lm1vc3RfdnVsbl9tICsgaW5zaWdodC5tb3N0X3Z1bG5fZikudG9GaXhlZCgxKTtcbiAgY29uc3QgZmVtYWxlUGN0ID0gaW5zaWdodC5tb3N0X3Z1bG5fZi50b0ZpeGVkKDEpO1xuICBjb25zdCBtYWxlUGN0ID0gaW5zaWdodC5tb3N0X3Z1bG5fbS50b0ZpeGVkKDEpO1xuICBcbiAgLy8gRWR1Y2F0aW9uIGNvbXBhcmlzb25cbiAgY29uc3Qgbm9FZHVNYWxlID0gaW5zaWdodC5ub19lZHVfbS50b0ZpeGVkKDEpO1xuICBjb25zdCBub0VkdUZlbWFsZSA9IGluc2lnaHQubm9fZWR1X2YudG9GaXhlZCgxKTtcbiAgXG4gIC8vIFBvdmVydHkgY29tcGFyaXNvbiAgXG4gIGNvbnN0IGhpZ2hQb3ZNYWxlID0gaW5zaWdodC5oaWdoX3BvdmVydHlfbS50b0ZpeGVkKDEpO1xuICBjb25zdCBoaWdoUG92RmVtYWxlID0gaW5zaWdodC5oaWdoX3BvdmVydHlfZi50b0ZpeGVkKDEpO1xuICBcbiAgLy8gU3RydWN0dXJlIHRoZSBkZWZhdWx0IGluc2lnaHRzIGFzIHNlcGFyYXRlIHBhcnRzIGZvciBiZXR0ZXIgSFRNTCByZW5kZXJpbmdcbiAgY29uc3QgZGVmYXVsdEluc2lnaHRQYXJ0cyA9IFtcbiAgICBgSW4gJHtyZWdpb259LCBtZW4gcmVwcmVzZW50ICR7dG90YWxNYWxlfSUgYW5kIHdvbWVuIHJlcHJlc2VudCAke3RvdGFsRmVtYWxlfSUgb2YgdGhlIHBvcHVsYXRpb24uYCxcbiAgICBgQW1vbmcgdGhlIG1vc3QgdnVsbmVyYWJsZSBncm91cCAoaGlnaCBwb3ZlcnR5ICsgbm8gcHJpbWFyeSBlZHVjYXRpb24pLCAke2ZlbWFsZVBjdH0lIGFyZSBmZW1hbGUgYW5kICR7bWFsZVBjdH0lIGFyZSBtYWxlLmAsXG4gICAgYEVkdWNhdGlvbiBnYXA6ICR7bm9FZHVGZW1hbGV9JSBvZiB3b21lbiB2cyAke25vRWR1TWFsZX0lIG9mIG1lbiBoYXZlIG5vIHByaW1hcnkgZWR1Y2F0aW9uLmAsXG4gICAgYFBvdmVydHkgZ2FwOiAke2hpZ2hQb3ZGZW1hbGV9JSBvZiB3b21lbiB2cyAke2hpZ2hQb3ZNYWxlfSUgb2YgbWVuIGxpdmUgaW4gaGlnaCBwb3ZlcnR5IGFyZWFzLmBcbiAgXTtcbiAgY29uc3QgZGVmYXVsdEluc2lnaHRUZXh0ID0gZGVmYXVsdEluc2lnaHRQYXJ0cy5qb2luKCdcXG5cXG4nKTtcbiAgcmV0dXJuIGNyZWF0ZUluc2lnaHREaXNwbGF5KGRlZmF1bHRJbnNpZ2h0VGV4dCk7XG59XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTQ2IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiYWRhcHRpdmVDYXBhY2l0eVF1ZXN0aW9uID0gX2xhbmcoXG4gIHZ1bG5lcmFiaWxpdHlfdHJhbnNsYXRpb25zLmFkYXB0aXZlX2NhcGFjaXR5X3F1ZXN0aW9uLFxuKTtcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNDciLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiIvLyBBZGFwdGl2ZSBjYXBhY2l0eSBzZWN0aW9uIHNlbGVjdG9ycyAtIGZvbGxvdyBzaGFyZWQgc3RhdGVcbnZpZXdvZiBhZGFwdGl2ZUNhcGFjaXR5QWRtaW4wID0gSW5wdXRzLnNlbGVjdChkYXRhQWRtaW4wLCB7XG4gIGxhYmVsOiBhZG1pblJlZ2lvbnMubGFiZWxzLmFkbWluMCwgXG4gIGZvcm1hdDogeCA9PiB4LmxhYmVsLFxuICB2YWx1ZTogZGF0YUFkbWluMC5maW5kKGQgPT4gZC52YWx1ZSA9PT0gc2hhcmVkQWRtaW4wKSB8fCAoZGF0YUFkbWluMC5sZW5ndGggPiAwID8gZGF0YUFkbWluMFswXSA6IG51bGwpXG59KVxudmlld29mIGFkYXB0aXZlQ2FwYWNpdHlBZG1pbjEgPSBJbnB1dHMuc2VsZWN0KGRhdGFBZG1pbjEsIHtcbiAgbGFiZWw6IGFkbWluUmVnaW9ucy5sYWJlbHMuYWRtaW4xLCBcbiAgZm9ybWF0OiB4ID0+IHgubGFiZWwsXG4gIHZhbHVlOiBkYXRhQWRtaW4xLmZpbmQoZCA9PiBkLnZhbHVlID09PSBzaGFyZWRBZG1pbjEpIHx8IChkYXRhQWRtaW4xLmxlbmd0aCA+IDAgPyBkYXRhQWRtaW4xWzBdIDogbnVsbClcbn0pXG52aWV3b2YgYWRhcHRpdmVDYXBhY2l0eUFkbWluMiA9IElucHV0cy5zZWxlY3QoZGF0YUFkbWluMiwge1xuICBsYWJlbDogYWRtaW5SZWdpb25zLmxhYmVscy5hZG1pbjIsIFxuICBmb3JtYXQ6IHggPT4geC5sYWJlbCxcbiAgdmFsdWU6IGRhdGFBZG1pbjIuZmluZChkID0+IGQudmFsdWUgPT09IHNoYXJlZEFkbWluMikgfHwgKGRhdGFBZG1pbjIubGVuZ3RoID4gMCA/IGRhdGFBZG1pbjJbMF0gOiBudWxsKVxufSlcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNDgiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJhZGFwdGl2ZUNhcGFjaXR5Q29udHJvbHNGb3JtID0gaHRsLmh0bWxgXG48ZGl2IHN0eWxlPVwiXG4gIGJhY2tncm91bmQ6ICNmOGZhZmM7XG4gIGJvcmRlcjogMnB4IHNvbGlkICNlMmU4ZjA7XG4gIGJvcmRlci1yYWRpdXM6IDEycHg7XG4gIHBhZGRpbmc6IDI0cHg7XG4gIGJveC1zaGFkb3c6IDAgNHB4IDZweCByZ2JhKDAsIDAsIDAsIDAuMDcpO1xuICBtYXJnaW46IDE2cHggMDtcblwiPlxuICA8aDMgc3R5bGU9XCJtYXJnaW46IDAgMCAyMHB4IDA7IGNvbG9yOiAjMmQzNzQ4OyBmb250LXNpemU6IDEuMXJlbTsgZm9udC13ZWlnaHQ6IDYwMDtcIj5cbiAgICAke19sYW5nKHZ1bG5lcmFiaWxpdHlfdHJhbnNsYXRpb25zLmdlb2dyYXBoaWNfc2VsZWN0aW9uKX1cbiAgPC9oMz5cbiAgPGRpdiBzdHlsZT1cIlxuICAgIGRpc3BsYXk6IGZsZXg7XG4gICAgYWxpZ24taXRlbXM6IGZsZXgtc3RhcnQ7XG4gICAgZ2FwOiAyMHB4O1xuICAgIGZsZXgtd3JhcDogd3JhcDtcbiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47XG4gIFwiIGNsYXNzPVwiZm9ybS1pbnB1dHMtY29udGFpbmVyXCI+XG4gICAgPGRpdiBzdHlsZT1cImZsZXg6IDE7IG1pbi13aWR0aDogMTgwcHg7IG1heC13aWR0aDogMTAwJTtcIj4ke3ZpZXdvZiBhZGFwdGl2ZUNhcGFjaXR5QWRtaW4wfTwvZGl2PlxuICAgIDxkaXYgc3R5bGU9XCJmbGV4OiAxOyBtaW4td2lkdGg6IDE4MHB4OyBtYXgtd2lkdGg6IDEwMCU7XCI+JHt2aWV3b2YgYWRhcHRpdmVDYXBhY2l0eUFkbWluMX08L2Rpdj5cbiAgICA8ZGl2IHN0eWxlPVwiZmxleDogMTsgbWluLXdpZHRoOiAxODBweDsgbWF4LXdpZHRoOiAxMDAlO1wiPiR7dmlld29mIGFkYXB0aXZlQ2FwYWNpdHlBZG1pbjJ9PC9kaXY+XG4gIDwvZGl2PlxuPC9kaXY+XG5gXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTQ5IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiLy8gTG9hZCBkYXRhIHdpdGggY2FjaGluZyAtIHVzaW5nIHBhcnF1ZXQgdmlhIER1Y2tEQlxuYWRhcHRpdmVDYXBhY2l0eVJhd0RhdGEgPSBhd2FpdCBsb2FkRGF0YVdpdGhDYWNoZShcbiAgXCJhZGFwdGl2ZUNhcGFjaXR5RGF0YVwiLFxuICBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgZGIgPSBhd2FpdCBEdWNrREJDbGllbnQub2Yoe1xuICAgICAgZW5hYmxpbmdfdmFyczogRmlsZUF0dGFjaG1lbnQoXG4gICAgICAgIFwiL2RhdGEvdnVsbmVyYWJpbGl0eV9ub3RlYm9vay9lbmFibGluZ192YXJzLnBhcnF1ZXRcIixcbiAgICAgICksXG4gICAgfSk7XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IGRiLnF1ZXJ5KFwiU0VMRUNUICogRlJPTSBlbmFibGluZ192YXJzXCIpO1xuXG4gICAgcmV0dXJuIGRhdGE7XG4gIH0sXG4pO1xuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC01MCIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Ii8vIExvYWQgbWV0YWRhdGEgd2l0aCBjYWNoaW5nXG5hZGFwdGl2ZUNhcGFjaXR5TWV0YWRhdGEgPSBhd2FpdCBsb2FkRGF0YVdpdGhDYWNoZShcbiAgXCJhZGFwdGl2ZUNhcGFjaXR5TWV0YWRhdGFcIixcbiAgYXN5bmMgKCkgPT4ge1xuICAgIHJldHVybiBhd2FpdCBGaWxlQXR0YWNobWVudChcbiAgICAgIFwiL2RhdGEvdnVsbmVyYWJpbGl0eV9ub3RlYm9vay9lbmFibGluZ192YXJzX21ldGFkYXRhLmpzb25cIixcbiAgICApLmpzb24oKTtcbiAgfSxcbik7XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTUxIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiLy8gUHJvY2VzcyB0aGUgbmV3IG5vcm1hbGl6ZWQgZGF0YSBzdHJ1Y3R1cmVcbmFkYXB0aXZlQ2FwYWNpdHlEYXRhID0ge1xuICBpZiAoIWFkYXB0aXZlQ2FwYWNpdHlSYXdEYXRhIHx8ICFBcnJheS5pc0FycmF5KGFkYXB0aXZlQ2FwYWNpdHlSYXdEYXRhKSkge1xuICAgIGNvbnNvbGUuZXJyb3IoXCJhZGFwdGl2ZUNhcGFjaXR5UmF3RGF0YSBpcyBub3QgdmFsaWQ6XCIsIGFkYXB0aXZlQ2FwYWNpdHlSYXdEYXRhKTtcbiAgICByZXR1cm4gW107XG4gIH1cbiAgXG4gIHJldHVybiBhZGFwdGl2ZUNhcGFjaXR5UmF3RGF0YS5tYXAoZCA9PiAoe1xuICAgIC4uLmQsXG4gICAgLy8gVXNlIHRoZSBuZXcgbm9ybWFsaXplZCBjb2x1bW5zIGRpcmVjdGx5ICgwLTEgc2NhbGUsIGhpZ2ggPSBnb29kKVxuICAgIHBjdF9lbGVjdHJpY19ub3JtOiBkLnBjdF9lbGVjdHJpY19ub3JtLFxuICAgIHBjdF9waXBlZF93YXRlcl9ub3JtOiBkLnBjdF9waXBlZF93YXRlcl9ub3JtLFxuICAgIG1pbl90b19jaXRpZXNfbm9ybTogZC5taW5fdG9fY2l0aWVzX25vcm0sXG4gICAgY29uZmxpY3RfZGVuc2l0eV9ub3JtOiBkLmNvbmZsaWN0X2RlbnNpdHlfbm9ybSxcbiAgICBwY3RfY2VsbHBob25lX25vcm06IGQucGN0X2NlbGxwaG9uZV9ub3JtLFxuICAgIC8vIEtlZXAgb3JpZ2luYWwgdmFsdWVzIGZvciB0b29sdGlwc1xuICAgIHBjdF9lbGVjdHJpYzogZC5wY3RfZWxlY3RyaWMsXG4gICAgcGN0X3BpcGVkX3dhdGVyOiBkLnBjdF9waXBlZF93YXRlcixcbiAgICBtaW5fdG9fY2l0aWVzOiBkLm1pbl90b19jaXRpZXMsXG4gICAgY29uZmxpY3RfZGVuc2l0eTogZC5jb25mbGljdF9kZW5zaXR5LFxuICAgIHBjdF9jZWxscGhvbmU6IGQucGN0X2NlbGxwaG9uZVxuICB9KSlcbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNTIiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiIvLyBHZXQgY3VycmVudCBhZG1pbiBzZWxlY3Rpb25zIChzYW1lIHZhcmlhYmxlIG5hbWVzIGFzIHNlbnNpdGl2aXR5IHNlY3Rpb24pXG5hZGFwdGl2ZUNhcGFjaXR5QWRtaW5TZWxlY3Rpb25zID0ge1xuICByZXR1cm4ge1xuICAgIHNlbGVjdEFkbWluMDogYWRhcHRpdmVDYXBhY2l0eUFkbWluMD8udmFsdWUgfHwgbnVsbCxcbiAgICBzZWxlY3RBZG1pbjE6IGFkYXB0aXZlQ2FwYWNpdHlBZG1pbjE/LnZhbHVlIHx8IG51bGwsXG4gICAgc2VsZWN0QWRtaW4yOiBhZGFwdGl2ZUNhcGFjaXR5QWRtaW4yPy52YWx1ZSB8fCBudWxsXG4gIH1cbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNTMiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiIvLyBGaWx0ZXIgZGF0YSBiYXNlZCBvbiBhZG1pbiBzZWxlY3Rpb25zIChzYW1lIHBhdHRlcm4gYXMgc2Vuc2l0aXZpdHkpXG5maWx0ZXJlZEFkYXB0aXZlQ2FwYWNpdHlEYXRhID0ge1xuICBjb25zdCBzZWxlY3Rpb25zID0gYWRhcHRpdmVDYXBhY2l0eUFkbWluU2VsZWN0aW9ucztcbiAgXG4gIGlmICghYWRhcHRpdmVDYXBhY2l0eURhdGEgfHwgYWRhcHRpdmVDYXBhY2l0eURhdGEubGVuZ3RoID09PSAwKSB7XG4gICAgY29uc29sZS5lcnJvcihcImFkYXB0aXZlQ2FwYWNpdHlEYXRhIGlzIGVtcHR5IG9yIHVuZGVmaW5lZFwiKTtcbiAgICByZXR1cm4gW107XG4gIH1cbiAgXG4gIGxldCBkYXRhID0gYWRhcHRpdmVDYXBhY2l0eURhdGE7XG5cbiAgaWYgKCFzZWxlY3Rpb25zLnNlbGVjdEFkbWluMCkge1xuICAgICAgZGF0YSA9ICBkYXRhLmZpbHRlcigoZCkgPT4gKGQuYWRtaW4wX25hbWUgPT09IFwiU1NBXCIgfHwgIWQuYWRtaW4wX25hbWUpKSAvLyBTZWxlY3QganVzdCBTU0EgZGF0YSAmIGRvIG5vdCBzaG93IHJlZ2lvbmFsIGF2Z1xuICB9IGVsc2UgaWYgKCFzZWxlY3Rpb25zLnNlbGVjdEFkbWluMSkge1xuICAgICAgZGF0YSA9ICBkYXRhLmZpbHRlcigoZCkgPT4gKGQuYWRtaW4wX25hbWUgPT09IHNlbGVjdGlvbnMuc2VsZWN0QWRtaW4wKSlcbiAgfSBlbHNlIGlmIChzZWxlY3Rpb25zLnNlbGVjdEFkbWluMSAgJiYgIXNlbGVjdGlvbnMuc2VsZWN0QWRtaW4yKSB7XG4gICAgICBkYXRhID0gIGRhdGEuZmlsdGVyKChkKT0+IChkLmFkbWluMF9uYW1lID09PSBzZWxlY3Rpb25zLnNlbGVjdEFkbWluMCAmJiBkLmFkbWluMV9uYW1lID09PSBzZWxlY3Rpb25zLnNlbGVjdEFkbWluMSkpXG4gIH0gZWxzZSBpZiAoc2VsZWN0aW9ucy5zZWxlY3RBZG1pbjEgJiYgc2VsZWN0aW9ucy5zZWxlY3RBZG1pbjIpIHtcbiAgICAgIGRhdGEgPSAgZGF0YS5maWx0ZXIoKGQpID0+IChkLmFkbWluMF9uYW1lID09PSBzZWxlY3Rpb25zLnNlbGVjdEFkbWluMCAmJiBkLmFkbWluMV9uYW1lID09PSBzZWxlY3Rpb25zLnNlbGVjdEFkbWluMSAmJiBkLmFkbWluMl9uYW1lID09PSBzZWxlY3Rpb25zLnNlbGVjdEFkbWluMikpXG4gIH1cblxuIHJldHVybiBkYXRhXG59XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTU0IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGdldCBjdXJyZW50IHJlZ2lvbiBuYW1lICh1c2VzIHNoYXJlZCB1dGlsaXR5KVxuZ2V0QWRhcHRpdmVDYXBhY2l0eVJlZ2lvbiA9ICgpID0+IHtcbiAgcmV0dXJuIGdldEFkbWluU2VsZWN0aW9uKFxuICAgIGFkYXB0aXZlQ2FwYWNpdHlBZG1pbjAsXG4gICAgYWRhcHRpdmVDYXBhY2l0eUFkbWluMSxcbiAgICBhZGFwdGl2ZUNhcGFjaXR5QWRtaW4yXG4gICk7XG59O1xuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC01NSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6IntcbiAgLy8gQ2hlY2sgaWYgYWRhcHRpdmVDYXBhY2l0eVJhd0RhdGEgZXhpc3RzIGFuZCBpcyBhbiBhcnJheSBiZWZvcmUgcHJvY2Vzc2luZ1xuICBpZiAoIWFkYXB0aXZlQ2FwYWNpdHlSYXdEYXRhIHx8ICFBcnJheS5pc0FycmF5KGFkYXB0aXZlQ2FwYWNpdHlSYXdEYXRhKSkge1xuICAgIHJldHVybiBjcmVhdGVOb0RhdGFTdGF0ZSgpO1xuICB9XG4gIFxuICBsZXQgZGF0YSA9IGFkYXB0aXZlQ2FwYWNpdHlSYXdEYXRhO1xuICBjb25zdCBzZWxlY3Rpb25zID0gYWRhcHRpdmVDYXBhY2l0eUFkbWluU2VsZWN0aW9ucztcbiAgY29uc3QgaXNTU0EgPSBzZWxlY3Rpb25zLnNlbGVjdEFkbWluMCA9PT0gXCJTU0FcIiB8fCAhc2VsZWN0aW9ucy5zZWxlY3RBZG1pbjA7XG4gIC8vIERhdGEgZm9yIHRoZSBibHVlIGJhciAtIHRoZSBsb3dlc3Qgc2VsZWN0ZWQgcmVnaW9uXG4gIGxldCByZWdpb25fZGF0YSA9IGRhdGEuZmlsdGVyKFxuICAgIChkKSA9PlxuICAgICAgZC5hZG1pbjBfbmFtZSA9PT0gKHNlbGVjdGlvbnMuc2VsZWN0QWRtaW4wIHx8IFwiU1NBXCIpICYmXG4gICAgICBkLmFkbWluMV9uYW1lID09PSBzZWxlY3Rpb25zLnNlbGVjdEFkbWluMSAmJlxuICAgICAgZC5hZG1pbjJfbmFtZSA9PT0gc2VsZWN0aW9ucy5zZWxlY3RBZG1pbjIsXG4gICk7XG4gIFxuICBsZXQgcmVnaW9uX25hbWUgPSBnZXRBZGFwdGl2ZUNhcGFjaXR5UmVnaW9uKCk7XG5cbiAgLy8gRGF0YSBmb3IgdGhlIGdyZXkgYmFyIHdoaWNoIGlzIHRoZSBwYXJlbnRcbiAgLy8gZWcuIHJlZ2lvbiA9IEFHTyBzbyBwYXJlbnQgPSBTU0Egb3IgcmVnaW9uID0gbmFpcm9iaSBzbyBwYXJlbnQgPSBrZW55YVxuICBsZXQgcGFyZW50X2RhdGEgPSBbXTtcbiAgbGV0IHBhcmVudF9uYW1lID0gXCJcIjtcblxuICBpZiAoIXNlbGVjdGlvbnMuc2VsZWN0QWRtaW4wKSB7XG4gICAgLy8gVG9wLWxldmVsIChTU0Egc2VsZWN0ZWQgc28gbm8gcGFyZW50IGRhdGEgaXMgcmV0dXJuZWQpXG4gICAgcGFyZW50X2RhdGEgPSBbXTtcbiAgfSBlbHNlIGlmICghc2VsZWN0aW9ucy5zZWxlY3RBZG1pbjEpIHtcbiAgICAvLyBhZG1pbjAgc2VsZWN0ZWQgYnV0IG5vIGFkbWluMSBzbyBwYXJlbnQgPSBTU0FcbiAgICBwYXJlbnRfZGF0YSA9IGRhdGEuZmlsdGVyKChkKSA9PiBkLmFkbWluMF9uYW1lID09PSBcIlNTQVwiKTtcbiAgICBwYXJlbnRfbmFtZSA9IFwiU1NBXCI7XG4gIH0gZWxzZSBpZiAoIXNlbGVjdGlvbnMuc2VsZWN0QWRtaW4yKSB7XG4gICAgLy8gYWRtaW4xIHNlbGVjdGVkIGJ1dCBubyBhZG1pbjIgc28gcGFyZW50ID0gYWRtaW4wIHNlbGVjdGlvblxuICAgIHBhcmVudF9kYXRhID0gZGF0YS5maWx0ZXIoXG4gICAgICAoZCkgPT4gZC5hZG1pbjBfbmFtZSA9PT0gc2VsZWN0aW9ucy5zZWxlY3RBZG1pbjAgJiYgIWQuYWRtaW4xX25hbWUsXG4gICAgKTtcbiAgICBwYXJlbnRfbmFtZSA9IHNlbGVjdGlvbnMuc2VsZWN0QWRtaW4wO1xuICB9IGVsc2Uge1xuICAgIC8vIGFkbWluMiBzZWxlY3RlZCBzbyBwYXJlbnQgPSBhZG1pbjEgc2VsZWN0ZWRcbiAgICBwYXJlbnRfZGF0YSA9IGRhdGEuZmlsdGVyKFxuICAgICAgKGQpID0+XG4gICAgICAgIGQuYWRtaW4wX25hbWUgPT09IHNlbGVjdGlvbnMuc2VsZWN0QWRtaW4wICYmXG4gICAgICAgIGQuYWRtaW4xX25hbWUgPT09IHNlbGVjdGlvbnMuc2VsZWN0QWRtaW4xICYmXG4gICAgICAgICFkLmFkbWluMl9uYW1lLFxuICAgICk7XG4gICAgcGFyZW50X25hbWUgPSBzZWxlY3Rpb25zLnNlbGVjdEFkbWluMTtcbiAgfVxuXG4gIC8vIERlZmluZSB0aGUgaW5kaWNhdG9ycyB0byBkaXNwbGF5IHVzaW5nIG5ldyBub3JtYWxpemVkIGRhdGEgc3RydWN0dXJlXG4gIGNvbnN0IGluZGljYXRvcnMgPSBbXG4gICAge1xuICAgICAga2V5OiBcInBjdF9lbGVjdHJpY19ub3JtXCIsXG4gICAgICByYXdLZXk6IFwicGN0X2VsZWN0cmljXCIsXG4gICAgICBsYWJlbDogX2xhbmcoeyBlbjogXCJFbGVjdHJpY2l0eSBBY2Nlc3NcIiwgZnI6IFwiQWNjw6hzIMOgIGwnw6lsZWN0cmljaXTDqVwiIH0pLFxuICAgICAgdW5pdDogXCIlXCIsXG4gICAgfSxcbiAgICB7XG4gICAgICBrZXk6IFwicGN0X3BpcGVkX3dhdGVyX25vcm1cIixcbiAgICAgIHJhd0tleTogXCJwY3RfcGlwZWRfd2F0ZXJcIixcbiAgICAgIGxhYmVsOiBfbGFuZyh7IGVuOiBcIlBpcGVkIFdhdGVyIEFjY2Vzc1wiLCBmcjogXCJBY2PDqHMgw6AgbCdlYXUgY291cmFudGVcIiB9KSxcbiAgICAgIHVuaXQ6IFwiJVwiLFxuICAgIH0sXG4gICAge1xuICAgICAga2V5OiBcIm1pbl90b19jaXRpZXNfbm9ybVwiLFxuICAgICAgcmF3S2V5OiBcIm1pbl90b19jaXRpZXNcIixcbiAgICAgIGxhYmVsOiBfbGFuZyh7XG4gICAgICAgIGVuOiBcIkRpc3RhbmNlIHRvIE1hcmtldFwiLFxuICAgICAgICBmcjogXCJUZW1wcyBkZSB0cmFqZXQgdmVycyBsZXMgdmlsbGVzXCIsXG4gICAgICB9KSxcbiAgICAgIHVuaXQ6IFwiIG1pbi5cIixcbiAgICB9LFxuICAgIHtcbiAgICAgIGtleTogXCJwY3RfY2VsbHBob25lX25vcm1cIixcbiAgICAgIHJhd0tleTogXCJwY3RfY2VsbHBob25lXCIsXG4gICAgICBsYWJlbDogX2xhbmcoe1xuICAgICAgICBlbjogXCJDZWxscGhvbmUgQWNjZXNzXCIsXG4gICAgICAgIGZyOiBcIkFjY8OocyBhdSB0w6lsw6lwaG9uZSBwb3J0YWJsZVwiLFxuICAgICAgfSksXG4gICAgICB1bml0OiBcIiVcIixcbiAgICB9LFxuICAgIHtcbiAgICAgIGtleTogXCJjb25mbGljdF9kZW5zaXR5X25vcm1cIixcbiAgICAgIHJhd0tleTogXCJjb25mbGljdF9kZW5zaXR5XCIsXG4gICAgICBsYWJlbDogX2xhbmcoeyBlbjogXCJMYWNrIG9mIENvbmZsaWN0XCIsIGZyOiBcIkRlbnNpdMOpIGRlIGNvbmZsaXRcIiB9KSxcbiAgICAgIHVuaXQ6IFwiIGNvdW50L2ttwrJcIixcbiAgICB9LFxuICBdO1xuXG4gIGNvbnN0IGNoYXJ0RGF0YSA9IGluZGljYXRvcnMubWFwKChpbmRpY2F0b3IpID0+IHtcbiAgICAvLyBHZXQgbm9ybWFsaXplZCB2YWx1ZSAoMC0xIHNjYWxlLCBoaWdoID0gZ29vZClcbiAgICAvLyBDaGVjayBpZiByZWdpb25fZGF0YSBoYXMgZWxlbWVudHMgYmVmb3JlIGFjY2Vzc2luZyBbMF1cbiAgICBjb25zdCByZWdpb25fbm9ybWFsaXplZFZhbHVlID0gcmVnaW9uX2RhdGEubGVuZ3RoID4gMCBcbiAgICAgID8gKHJlZ2lvbl9kYXRhWzBdPy5baW5kaWNhdG9yLmtleV0gfHwgbnVsbClcbiAgICAgIDogbnVsbDtcbiAgICBjb25zdCBwYXJlbnRfbm9ybWFsaXplZFZhbHVlID0gcGFyZW50X2RhdGEubGVuZ3RoID4gMFxuICAgICAgPyAocGFyZW50X2RhdGFbMF0/LltpbmRpY2F0b3Iua2V5XSB8fCBudWxsKVxuICAgICAgOiBudWxsO1xuICAgIC8vIEdldCBvcmlnaW5hbCB2YWx1ZSBmb3IgdG9vbHRpcHNcbiAgICBjb25zdCByZWdpb25fcmF3VmFsdWUgPSByZWdpb25fZGF0YS5sZW5ndGggPiAwXG4gICAgICA/IChyZWdpb25fZGF0YVswXT8uW2luZGljYXRvci5yYXdLZXldIHx8IG51bGwpXG4gICAgICA6IG51bGw7XG4gICAgY29uc3QgcGFyZW50X3Jhd1ZhbHVlID0gcGFyZW50X2RhdGEubGVuZ3RoID4gMFxuICAgICAgPyAocGFyZW50X2RhdGFbMF0/LltpbmRpY2F0b3IucmF3S2V5XSB8fCBudWxsKVxuICAgICAgOiBudWxsO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGluZGljYXRvcjogaW5kaWNhdG9yLmxhYmVsLFxuICAgICAgcmVnaW9uX25vcm1hbGl6ZWRWYWx1ZSwgLy8gVXNlIG5vcm1hbGl6ZWQgdmFsdWUgZm9yIGNoYXJ0XG4gICAgICByZWdpb25fcmF3VmFsdWUsIC8vIEtlZXAgb3JpZ2luYWwgZm9yIHRvb2x0aXBzXG4gICAgICBwYXJlbnRfbm9ybWFsaXplZFZhbHVlLFxuICAgICAgcGFyZW50X3Jhd1ZhbHVlLFxuICAgICAgdW5pdDogaW5kaWNhdG9yLnVuaXQsXG4gICAgfTtcbiAgfSk7XG5cbiAgLy8gY29uc3Qgc29ydGVkRGF0YSA9IGNoYXJ0RGF0YS5zb3J0KChhLCBiKSA9PiBiLnZhbHVlIC0gYS52YWx1ZSk7XG4gIC8vIHNvcnQgYWxwaGFiZXRpY2FsbHkgc28gY29uc2lzdGVudCBiZXR3ZWVuIHNlbGVjdGlvbnMgdG8gYWxsb3cgZWFzeSBjb21wYXJpc29uc1xuICBjb25zdCBzb3J0ZWREYXRhID0gY2hhcnREYXRhLnNvcnQoKGEsIGIpID0+IGEuaW5kaWNhdG9yLmxvY2FsZUNvbXBhcmUoYi5pbmRpY2F0b3IpKTtcblxuICBjb25zdCBtYXhWYWx1ZSA9IDEuMDsgLy8gVGVjaG5pY2FsbHkgc29tZSB2YWx1ZXMgcGFzcyB0aGlzLCBidXQgaW4gZ2VuZXJhbCB0aGlzIHNob3VsZCBiZSBtYXhcbiAgXG4gIGNvbnN0IHBsb3RfY2hhbm5lbHMgPSB7XG4gICAgW19sYW5nKHtlbjogYCR7cmVnaW9uX25hbWV9IFZhbHVlYCwgZnI6IFwiVmFsZXVyIGRlIGxhIHLDqWdpb24gc8OpbGVjdGlvbm7DqWVcIn0pXTpcbiAgICAgIGQgPT4gZC5yZWdpb25fcmF3VmFsdWUgPT0gbnVsbFxuICAgICAgICA/IG51bGwgLy8gMCBpcyBtZWFuaW5nZnVsIHNvIHRoaXMgc3RheXMgbnVsbFxuICAgICAgICA6IE51bWJlcihkLnJlZ2lvbl9yYXdWYWx1ZSkudG9GaXhlZCgxKSArIChkLnVuaXQgfHwgXCJcIilcbiAgfTtcblxuICBpZiAoIWlzU1NBKSB7XG4gICAgcGxvdF9jaGFubmVsc1tfbGFuZyh7ZW46IGAke3BhcmVudF9uYW1lfSBWYWx1ZWAsIGZyOiBcIk1veWVubmUgcsOpZ2lvbmFsZVwifSldID1cbiAgICAgIGQgPT4gZC5wYXJlbnRfcmF3VmFsdWUgPT0gbnVsbFxuICAgICAgICA/IG51bGwgLy8gMCBpcyBtZWFuaW5nZnVsIHNvIHRoaXMgc3RheXMgbnVsbFxuICAgICAgICA6IE51bWJlcihkLnBhcmVudF9yYXdWYWx1ZSkudG9GaXhlZCgxKSArIChkLnVuaXQgfHwgXCJcIilcbiAgfTtcblxuICBjb25zdCBwbG90ID0gIFBsb3QucGxvdCh7XG4gICAgd2lkdGg6IDEwMDAsIC8vIEZ1bGwgd2lkdGhcbiAgICBoZWlnaHQ6IDQwMCxcbiAgICBtYXJnaW5MZWZ0OiAxNjAsIC8vIFJlZHVjZWQgZm9yIGJldHRlciBzcGFjZSB1dGlsaXphdGlvblxuICAgIG1hcmdpblJpZ2h0OiA0MCwgLy8gUmVkdWNlZCBmb3IgYmV0dGVyIHNwYWNlIHV0aWxpemF0aW9uXG4gICAgbWFyZ2luVG9wOiAxMCwgLy8gUmVkdWNlZCB3aGl0ZSBzcGFjZVxuICAgIG1hcmdpbkJvdHRvbTogNDAsIC8vIFJlZHVjZWQgd2hpdGUgc3BhY2VcbiAgICBjb2xvcjoge1xuICAgICAgbGVnZW5kOiAhaXNTU0EsIC8vIE9ubHkgc2hvdyBsZWdlbmQgaWYgbm90IFNTQVxuICAgICAgZG9tYWluOiBbXG4gICAgICAgIF9sYW5nKHtlbjogYCR7cmVnaW9uX25hbWV9IFZhbHVlYCwgZnI6IGAke3JlZ2lvbl9uYW1lfSBWYWx1ZWB9KSxcbiAgICAgICAgX2xhbmcoe2VuOiBgJHtwYXJlbnRfbmFtZX0gVmFsdWVgLCBmcjogXCJNb3llbm5lIHLDqWdpb25hbGVcIn0pXG4gICAgICBdLFxuICAgICAgcmFuZ2U6IFtcIiM0YTkwZTJcIiwgXCIjZTVlNWU1XCJdXG4gICAgfSxcbiAgICB4OiB7XG4gICAgICBsYWJlbDogX2xhbmcoe2VuOiBcIkFiaWxpdHkgdG8gQWRhcHRcIiwgZnI6IFwiTml2ZWF1IGRlIHBlcmZvcm1hbmNlXCJ9KSxcbiAgICAgIGxhYmVsQW5jaG9yOiBcImNlbnRlclwiLFxuICAgICAgbGFiZWxPZmZzZXQ6IDMwLFxuICAgICAgZG9tYWluOiBbMCwgbWF4VmFsdWVdLCAvLyBOb3JtYWxpemVkIHNjYWxlIDAtMVxuICAgICAgdGlja0Zvcm1hdDogKGQpID0+IChkID09PSAwID8gX2xhbmcoe2VuOiBcIkxvd1wiLCBmcjogXCJGYWlibGVcIn0pIDogZCA9PT0gMSA/IF9sYW5nKHtlbjogXCJIaWdoXCIsIGZyOiBcIsOJbGV2w6lcIn0pIDogXCJcIiksXG4gICAgICB0aWNrczogWzAsIDAuNSwgMS4wXSxcbiAgICAgIHRpY2tTaXplOiA0LFxuICAgICAgbGFiZWxGb250U2l6ZTogMTIsXG4gICAgICBsYWJlbEZvbnRXZWlnaHQ6IFwiNjAwXCJcbiAgICB9LFxuICAgIHk6IHtcbiAgICAgIGxhYmVsOiBudWxsLCAvLyBSZW1vdmUgeS1heGlzIGxhYmVsIHRvIHNhdmUgc3BhY2VcbiAgICAgIHRpY2tTaXplOiAwLFxuICAgICAgZ3JpZDogdHJ1ZSxcbiAgICAgIC8vIGRvbWFpbjogc29ydGVkRGF0YS5tYXAoZCA9PiBkLmluZGljYXRvcikgLy8gT25seSBzaG93IGluZGljYXRvcnMgd2l0aCBkYXRhXG4gICAgfSxcblxuICAgIG1hcmtzOiBbXG4gICAgICAvLyBSZWdpb25hbCBhdmVyYWdlIGJhcnMgKGxpZ2h0IGdyYXkgYmFja2dyb3VuZCkgLSBmdWxsIHdpZHRoXG4gICAgICBQbG90LmJhclgoc29ydGVkRGF0YSwge1xuICAgICAgICB4OiBcInBhcmVudF9ub3JtYWxpemVkVmFsdWVcIixcbiAgICAgICAgeTogXCJpbmRpY2F0b3JcIixcbiAgICAgICAgZmlsbDogXCIjZTVlNWU1XCIsXG4gICAgICAgIG9wYWNpdHk6IDAuN1xuICAgICAgfSksXG4gICAgICBcbiAgICAgIC8vIEFjdHVhbCB2YWx1ZSBiYXJzIChibHVlIGJhcnMpIC0gbmFycm93ZXIgdXNpbmcgaW5zZXRcbiAgICAgIFxuICAgICAgUGxvdC5iYXJYKHNvcnRlZERhdGEsIHtcbiAgICAgICAgeDogXCJyZWdpb25fbm9ybWFsaXplZFZhbHVlXCIsIFxuICAgICAgICB5OiBcImluZGljYXRvclwiLFxuICAgICAgICBmaWxsOiBcIiM0YTkwZTJcIixcbiAgICAgICAgaW5zZXRUb3A6IDE1LCAvLyBNYWtlIGJhcnMgbmFycm93ZXJcbiAgICAgICAgaW5zZXRCb3R0b206IDE1LCBcbiAgICAgICAgY2hhbm5lbHM6IHBsb3RfY2hhbm5lbHMsXG4gICAgICAgIHRpcDoge1xuICAgICAgICAgIGFuY2hvcjogXCJ0b3BcIiwgLy8gUG9zaXRpb24gYWJvdmUgdGhlIGJsdWUgYmFyXG4gICAgICAgICAgZHk6IC0xMCwgLy8gT2Zmc2V0IHVwd2FyZFxuICAgICAgICAgIGZvcm1hdDoge1xuICAgICAgICAgICAgeDogZmFsc2VcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgXVxuICB9KTtcblxuICByZXR1cm4gcGxvdDtcbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNTYiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiIvLyBEb3dubG9hZCBmdW5jdGlvbmFsaXR5XG5hZGFwdGl2ZUNhcGFjaXR5RG93bmxvYWRCdXR0b24gPSB7XG4gIGlmICghZmlsdGVyZWRBZGFwdGl2ZUNhcGFjaXR5RGF0YSB8fCBmaWx0ZXJlZEFkYXB0aXZlQ2FwYWNpdHlEYXRhLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiBodGwuaHRtbGBgO1xuICB9XG4gIFxuICBjb25zdCByZWdpb24gPSBnZXRBZGFwdGl2ZUNhcGFjaXR5UmVnaW9uKCk7XG4gIHJldHVybiBkb3dubG9hZEJ1dHRvbihcbiAgICBmaWx0ZXJlZEFkYXB0aXZlQ2FwYWNpdHlEYXRhLCBcbiAgICBgYWRhcHRpdmVfY2FwYWNpdHlfZGF0YV8ke3JlZ2lvbi5yZXBsYWNlKC9cXHMrL2csICdfJyl9YCxcbiAgICBfbGFuZyh2dWxuZXJhYmlsaXR5X3RyYW5zbGF0aW9ucy5kb3dubG9hZF9kYXRhKVxuICApO1xufVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC01NyIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Ii8vIER5bmFtaWMgSW5zaWdodHMgZm9sbG93aW5nIHdpcmVmcmFtZSB0ZW1wbGF0ZVxuYWRhcHRpdmVDYXBhY2l0eUluc2lnaHRzID0ge1xuICBpZiAoIWZpbHRlcmVkQWRhcHRpdmVDYXBhY2l0eURhdGEgfHwgZmlsdGVyZWRBZGFwdGl2ZUNhcGFjaXR5RGF0YS5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gY3JlYXRlTm9EYXRhU3RhdGUoKTsgLy8gVXNlIHNhbWUgZnVuY3Rpb24gYXMgZXhwb3N1cmVcbiAgfVxuICBcbiAgY29uc3QgZGF0YSA9IGZpbHRlcmVkQWRhcHRpdmVDYXBhY2l0eURhdGFbMF07XG4gIGNvbnN0IHJlZ2lvbiA9IGdldEFkYXB0aXZlQ2FwYWNpdHlSZWdpb24oKTtcbiAgICBcbiAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGRldGVybWluZSB0aHJlc2hvbGQgbGV2ZWxcbiAgY29uc3QgZ2V0VGhyZXNob2xkTGV2ZWwgPSAodmFsdWUsIHRocmVzaG9sZHMsIGlzSW52ZXJzZSA9IGZhbHNlKSA9PiB7XG4gICAgaWYgKGlzSW52ZXJzZSkge1xuICAgICAgLy8gRm9yIGludmVyc2UgaW5kaWNhdG9ycyAobG93ZXIgaXMgYmV0dGVyKVxuICAgICAgaWYgKHZhbHVlIDw9IHRocmVzaG9sZHMubG93WzBdKSByZXR1cm4gX2xhbmcoe2VuOiBcImhpZ2hcIiwgZnI6IFwiw6lsZXbDqVwifSk7XG4gICAgICBpZiAodmFsdWUgPD0gdGhyZXNob2xkcy5taWRbMF0pIHJldHVybiBfbGFuZyh7ZW46IFwibW9kZXJhdGVcIiwgZnI6IFwibW9kw6lyw6lcIn0pO1xuICAgICAgcmV0dXJuIF9sYW5nKHtlbjogXCJsb3dcIiwgZnI6IFwiZmFpYmxlXCJ9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gRm9yIG5vcm1hbCBpbmRpY2F0b3JzIChoaWdoZXIgaXMgYmV0dGVyKVxuICAgICAgaWYgKHZhbHVlID49IHRocmVzaG9sZHMuaGlnaFswXSkgcmV0dXJuIF9sYW5nKHtlbjogXCJoaWdoXCIsIGZyOiBcIsOpbGV2w6lcIn0pO1xuICAgICAgaWYgKHZhbHVlID49IHRocmVzaG9sZHMubWlkWzBdKSByZXR1cm4gX2xhbmcoe2VuOiBcIm1vZGVyYXRlXCIsIGZyOiBcIm1vZMOpcsOpXCJ9KTtcbiAgICAgIHJldHVybiBfbGFuZyh7ZW46IFwibG93XCIsIGZyOiBcImZhaWJsZVwifSk7XG4gICAgfVxuICB9O1xuXG4gIC8vIENyZWF0ZSBpbmRpY2F0b3JzIHVzaW5nIG5ldyBub3JtYWxpemVkIGRhdGEgc3RydWN0dXJlXG4gIGNvbnN0IGluZGljYXRvcnMgPSBbXG4gICAge1xuICAgICAga2V5OiBcInBjdF9lbGVjdHJpY19ub3JtXCIsXG4gICAgICBvcmlnaW5hbEtleTogXCJwY3RfZWxlY3RyaWNcIixcbiAgICAgIGxhYmVsOiBfbGFuZyh7ZW46IFwiRWxlY3RyaWNpdHkgQWNjZXNzXCIsIGZyOiBcIkFjY8OocyDDoCBsJ8OpbGVjdHJpY2l0w6lcIn0pLFxuICAgICAgb3JpZ2luYWxWYWx1ZTogZGF0YS5wY3RfZWxlY3RyaWMsXG4gICAgICBub3JtYWxpemVkVmFsdWU6IGRhdGEucGN0X2VsZWN0cmljX25vcm0sXG4gICAgICB1bml0OiBcIiVcIlxuICAgIH0sXG4gICAge1xuICAgICAga2V5OiBcInBjdF9waXBlZF93YXRlcl9ub3JtXCIsXG4gICAgICBvcmlnaW5hbEtleTogXCJwY3RfcGlwZWRfd2F0ZXJcIiwgXG4gICAgICBsYWJlbDogX2xhbmcoe2VuOiBcIlBpcGVkIFdhdGVyIEFjY2Vzc1wiLCBmcjogXCJBY2PDqHMgw6AgbCdlYXUgY291cmFudGVcIn0pLFxuICAgICAgb3JpZ2luYWxWYWx1ZTogZGF0YS5wY3RfcGlwZWRfd2F0ZXIsXG4gICAgICBub3JtYWxpemVkVmFsdWU6IGRhdGEucGN0X3BpcGVkX3dhdGVyX25vcm0sXG4gICAgICB1bml0OiBcIiVcIlxuICAgIH0sXG4gICAge1xuICAgICAga2V5OiBcIm1pbl90b19jaXRpZXNfbm9ybVwiLFxuICAgICAgb3JpZ2luYWxLZXk6IFwibWluX3RvX2NpdGllc1wiLFxuICAgICAgbGFiZWw6IF9sYW5nKHtlbjogXCJUcmF2ZWwgVGltZSB0byBDaXRpZXNcIiwgZnI6IFwiVGVtcHMgZGUgdHJhamV0IHZlcnMgbGVzIHZpbGxlc1wifSksXG4gICAgICBvcmlnaW5hbFZhbHVlOiBkYXRhLm1pbl90b19jaXRpZXMsXG4gICAgICBub3JtYWxpemVkVmFsdWU6IGRhdGEubWluX3RvX2NpdGllc19ub3JtLFxuICAgICAgdW5pdDogXCIgbWluXCJcbiAgICB9LFxuICAgIHtcbiAgICAgIGtleTogXCJwY3RfY2VsbHBob25lX25vcm1cIixcbiAgICAgIG9yaWdpbmFsS2V5OiBcInBjdF9jZWxscGhvbmVcIixcbiAgICAgIGxhYmVsOiBfbGFuZyh7ZW46IFwiQ2VsbHBob25lIEFjY2Vzc1wiLCBmcjogXCJBY2PDqHMgYXUgdMOpbMOpcGhvbmUgcG9ydGFibGVcIn0pLFxuICAgICAgb3JpZ2luYWxWYWx1ZTogZGF0YS5wY3RfY2VsbHBob25lLFxuICAgICAgbm9ybWFsaXplZFZhbHVlOiBkYXRhLnBjdF9jZWxscGhvbmVfbm9ybSxcbiAgICAgIHVuaXQ6IFwiJVwiXG4gICAgfSxcbiAgICB7XG4gICAgICBrZXk6IFwiY29uZmxpY3RfZGVuc2l0eV9ub3JtXCIsXG4gICAgICBvcmlnaW5hbEtleTogXCJjb25mbGljdF9kZW5zaXR5XCIsXG4gICAgICBsYWJlbDogX2xhbmcoe2VuOiBcIkNvbmZsaWN0IERlbnNpdHlcIiwgZnI6IFwiRGVuc2l0w6kgZGUgY29uZmxpdFwifSksXG4gICAgICBvcmlnaW5hbFZhbHVlOiBkYXRhLmNvbmZsaWN0X2RlbnNpdHksXG4gICAgICBub3JtYWxpemVkVmFsdWU6IGRhdGEuY29uZmxpY3RfZGVuc2l0eV9ub3JtLFxuICAgICAgdW5pdDogXCIgY291bnQva23CslwiXG4gICAgfVxuICBdO1xuXG4gIC8vIEZvcm1hdCBpbmRpY2F0b3JzIHdpdGggcGVyZm9ybWFuY2UgbGV2ZWxzIGJhc2VkIG9uIG5vcm1hbGl6ZWQgdmFsdWVzXG4gIGNvbnN0IHRocmVzaG9sZEluZGljYXRvcnMgPSBpbmRpY2F0b3JzLm1hcChpbmRpY2F0b3IgPT4ge1xuICAgIGNvbnN0IG5vcm1hbGl6ZWRWYWx1ZSA9IHR5cGVvZiBpbmRpY2F0b3Iubm9ybWFsaXplZFZhbHVlID09PSAnbnVtYmVyJyA/IGluZGljYXRvci5ub3JtYWxpemVkVmFsdWUgOiAwO1xuICAgIGNvbnN0IG9yaWdpbmFsVmFsdWUgPSB0eXBlb2YgaW5kaWNhdG9yLm9yaWdpbmFsVmFsdWUgPT09ICdudW1iZXInID8gaW5kaWNhdG9yLm9yaWdpbmFsVmFsdWUgOiAwO1xuICAgIFxuICAgIC8vIERldGVybWluZSBwZXJmb3JtYW5jZSBsZXZlbCBiYXNlZCBvbiBub3JtYWxpemVkIHZhbHVlICgwLTEgc2NhbGUpXG4gICAgbGV0IGxldmVsO1xuICAgIGlmIChub3JtYWxpemVkVmFsdWUgPj0gMC44KSB7XG4gICAgICBsZXZlbCA9IF9sYW5nKHtlbjogXCJoaWdoXCIsIGZyOiBcIsOpbGV2w6lcIn0pO1xuICAgIH0gZWxzZSBpZiAobm9ybWFsaXplZFZhbHVlID49IDAuNSkge1xuICAgICAgbGV2ZWwgPSBfbGFuZyh7ZW46IFwibW9kZXJhdGVcIiwgZnI6IFwibW9kw6lyw6lcIn0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBsZXZlbCA9IF9sYW5nKHtlbjogXCJsb3dcIiwgZnI6IFwiZmFpYmxlXCJ9KTtcbiAgICB9XG4gICAgXG4gICAgY29uc3QgbnVtVmFsdWUgPSBOdW1iZXIob3JpZ2luYWxWYWx1ZSkgfHwgMDtcbiAgICBjb25zdCBmb3JtYXR0ZWRWYWx1ZSA9IG51bVZhbHVlIDwgMSA/IG51bVZhbHVlLnRvRml4ZWQoMykgOiBudW1WYWx1ZS50b0ZpeGVkKDEpO1xuICAgIHJldHVybiBgJHtpbmRpY2F0b3IubGFiZWx9OiAke2Zvcm1hdHRlZFZhbHVlfSR7aW5kaWNhdG9yLnVuaXR9ICgke2xldmVsfSlgO1xuICB9KTtcbiAgICBcbiAgLy8gSWRlbnRpZnkgbGltaXRpbmcgZmFjdG9ycyBiYXNlZCBvbiB0aGUgZXhhY3QgZm9ybWF0IHNwZWNpZmllZFxuICBjb25zdCBsaW1pdGluZ0ZhY3RvcnMgPSBbXTtcbiAgICBcbiAgLy8gQ2hlY2sgZWFjaCBpbmRpY2F0b3IgZm9yIGxpbWl0aW5nIGZhY3RvcnMgdXNpbmcgbm9ybWFsaXplZCB2YWx1ZXNcbiAgaW5kaWNhdG9ycy5mb3JFYWNoKGluZGljYXRvciA9PiB7XG4gICAgY29uc3Qgbm9ybWFsaXplZFZhbHVlID0gdHlwZW9mIGluZGljYXRvci5ub3JtYWxpemVkVmFsdWUgPT09ICdudW1iZXInID8gaW5kaWNhdG9yLm5vcm1hbGl6ZWRWYWx1ZSA6IDA7XG4gICAgY29uc3Qgb3JpZ2luYWxWYWx1ZSA9IHR5cGVvZiBpbmRpY2F0b3Iub3JpZ2luYWxWYWx1ZSA9PT0gJ251bWJlcicgPyBpbmRpY2F0b3Iub3JpZ2luYWxWYWx1ZSA6IDA7XG4gICAgXG4gICAgLy8gRGV0ZXJtaW5lIGlmIHRoaXMgaXMgYSBsaW1pdGluZyBmYWN0b3IgKGxvdyBwZXJmb3JtYW5jZSlcbiAgICBpZiAobm9ybWFsaXplZFZhbHVlIDwgMC41KSB7XG4gICAgICBjb25zdCBudW1WYWx1ZSA9IE51bWJlcihvcmlnaW5hbFZhbHVlKSB8fCAwO1xuICAgICAgbGV0IGZvcm1hdHRlZFZhbHVlO1xuICAgICAgaWYgKGluZGljYXRvci5vcmlnaW5hbEtleSA9PT0gXCJwY3RfZWxlY3RyaWNcIikge1xuICAgICAgICBmb3JtYXR0ZWRWYWx1ZSA9IGAke251bVZhbHVlLnRvRml4ZWQoMSl9JWA7XG4gICAgICB9IGVsc2UgaWYgKGluZGljYXRvci5vcmlnaW5hbEtleSA9PT0gXCJtaW5fdG9fY2l0aWVzXCIpIHtcbiAgICAgICAgZm9ybWF0dGVkVmFsdWUgPSBgJHtudW1WYWx1ZS50b0ZpeGVkKDApfSBtaW5gO1xuICAgICAgfSBlbHNlIGlmIChpbmRpY2F0b3Iub3JpZ2luYWxLZXkgPT09IFwiaW5ldF9kX2ticHNcIikge1xuICAgICAgICBmb3JtYXR0ZWRWYWx1ZSA9IGAkeyhudW1WYWx1ZS8xMDAwKS50b0ZpeGVkKDEpfSBNYnBzYDtcbiAgICAgIH0gZWxzZSBpZiAoaW5kaWNhdG9yLm9yaWdpbmFsS2V5ID09PSBcInBjdF9waXBlZF93YXRlclwiKSB7XG4gICAgICAgIGZvcm1hdHRlZFZhbHVlID0gYCR7bnVtVmFsdWUudG9GaXhlZCgwKX0lYDtcbiAgICAgIH0gZWxzZSBpZiAoaW5kaWNhdG9yLm9yaWdpbmFsS2V5ID09PSBcInBjdF9jZWxscGhvbmVcIikge1xuICAgICAgICBmb3JtYXR0ZWRWYWx1ZSA9IGAke251bVZhbHVlLnRvRml4ZWQoMCl9JWA7XG4gICAgICB9IGVsc2UgaWYgKGluZGljYXRvci5vcmlnaW5hbEtleSA9PT0gXCJjb25mbGljdF9kZW5zaXR5XCIpIHtcbiAgICAgICAgZm9ybWF0dGVkVmFsdWUgPSBgJHsobnVtVmFsdWUgKiAxMDAwKS50b0ZpeGVkKDEpfSBwZXIgMTAwMCBrbcKyYDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZvcm1hdHRlZFZhbHVlID0gYCR7bnVtVmFsdWUudG9GaXhlZCgxKX0ke2luZGljYXRvci51bml0fWA7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGxpbWl0aW5nRmFjdG9ycy5wdXNoKGAke2luZGljYXRvci5sYWJlbH0gKCR7Zm9ybWF0dGVkVmFsdWV9KWApO1xuICAgIH1cbiAgfSk7XG5cbiAgXG4gIC8vIEdlbmVyYXRlIGluc2lnaHQgdGV4dCBpbiB0aGUgZXhhY3QgZm9ybWF0IHNwZWNpZmllZFxuICBjb25zdCBsaW1pdGF0aW9uTGV2ZWwgPSBsaW1pdGluZ0ZhY3RvcnMubGVuZ3RoID4gMiA/IFxuICAgIF9sYW5nKHtlbjogXCJzaWduaWZpY2FudGx5IGxpbWl0ZWRcIiwgZnI6IFwic2lnbmlmaWNhdGl2ZW1lbnQgbGltaXTDqWVcIn0pIDpcbiAgICBsaW1pdGluZ0ZhY3RvcnMubGVuZ3RoID4gMCA/IFxuICAgIF9sYW5nKHtlbjogXCJsaW1pdGVkXCIsIGZyOiBcImxpbWl0w6llXCJ9KSA6XG4gICAgX2xhbmcoe2VuOiBcInN0cm9uZ1wiLCBmcjogXCJmb3J0ZVwifSk7XG4gICAgXG4gIC8vIEZvcm1hdCBmYWN0b3JzIGFzIEhUTUwgbGlzdFxuICBjb25zdCBmYWN0b3JzTGlzdCA9IGxpbWl0aW5nRmFjdG9ycy5sZW5ndGggPiAwID8gXG4gICAgbGltaXRpbmdGYWN0b3JzLm1hcChmYWN0b3IgPT4gaHRsLmh0bWxgPGxpPiR7ZmFjdG9yfTwvbGk+YCkgOlxuICAgIFtodGwuaHRtbGA8bGk+JHtfbGFuZyh7ZW46IFwiU3Ryb25nIGluZnJhc3RydWN0dXJlIGFuZCBzZXJ2aWNlc1wiLCBmcjogXCJJbmZyYXN0cnVjdHVyZSBldCBzZXJ2aWNlcyBzb2xpZGVzXCJ9KX08L2xpPmBdO1xuICAgIFxuICBjb25zdCByZWNvbW1lbmRhdGlvbiA9IGxpbWl0aW5nRmFjdG9ycy5sZW5ndGggPiAwID9cbiAgICBfbGFuZyh7ZW46IFwiQWRkcmVzc2luZyB0aGVzZSBjYW4gaW1wcm92ZSByZXNpbGllbmNlLlwiLCBmcjogXCJUcmFpdGVyIGNlcyBwcm9ibMOobWVzIHBldXQgYW3DqWxpb3JlciBsYSByw6lzaWxpZW5jZS5cIn0pIDpcbiAgICBfbGFuZyh7ZW46IFwiQ29udGludWUgc3RyZW5ndGhlbmluZyB0aGVzZSBzeXN0ZW1zLlwiLCBmcjogXCJDb250aW51ZXIgw6AgcmVuZm9yY2VyIGNlcyBzeXN0w6htZXMuXCJ9KTtcbiAgICBcbiAgY29uc3QgaW5zaWdodCA9IGh0bC5odG1sYDxkaXY+XG4gICAgPHA+JHtfbGFuZyh7XG4gICAgICBlbjogYEluICR7cmVnaW9ufSwgYWRhcHRpdmUgY2FwYWNpdHkgaXMgJHtsaW1pdGF0aW9uTGV2ZWx9IGJ5OmAsXG4gICAgICBmcjogYEVuICR7cmVnaW9ufSwgbGEgY2FwYWNpdMOpIGQnYWRhcHRhdGlvbiBlc3QgJHtsaW1pdGF0aW9uTGV2ZWx9IHBhciA6YFxuICAgIH0pfTwvcD5cbiAgICA8dWw+JHtmYWN0b3JzTGlzdH08L3VsPlxuICAgIDxwPiR7cmVjb21tZW5kYXRpb259PC9wPlxuICA8L2Rpdj5gO1xuICAgIFxuICByZXR1cm4gY3JlYXRlSW5zaWdodERpc3BsYXkoaW5zaWdodCk7XG5cbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNTgiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJjb21wb3NpdGVRdWVzdGlvbiA9IF9sYW5nKHZ1bG5lcmFiaWxpdHlfdHJhbnNsYXRpb25zLmNvbXBvc2l0ZV9xdWVzdGlvbik7XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTU5IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiLy8gQ29tcG9zaXRlIHNlY3Rpb24gc2VsZWN0b3JzIC0gZm9sbG93IHNoYXJlZCBzdGF0ZVxudmlld29mIGNvbXBvc2l0ZUFkbWluMCA9IElucHV0cy5zZWxlY3QoZGF0YUFkbWluMCwge1xuICBsYWJlbDogYWRtaW5SZWdpb25zLmxhYmVscy5hZG1pbjAsIFxuICBmb3JtYXQ6IHggPT4geC5sYWJlbCxcbiAgdmFsdWU6IGRhdGFBZG1pbjAuZmluZChkID0+IGQudmFsdWUgPT09IHNoYXJlZEFkbWluMCkgfHwgKGRhdGFBZG1pbjAubGVuZ3RoID4gMCA/IGRhdGFBZG1pbjBbMF0gOiBudWxsKVxufSlcbnZpZXdvZiBjb21wb3NpdGVBZG1pbjEgPSBJbnB1dHMuc2VsZWN0KGRhdGFBZG1pbjEsIHtcbiAgbGFiZWw6IGFkbWluUmVnaW9ucy5sYWJlbHMuYWRtaW4xLCBcbiAgZm9ybWF0OiB4ID0+IHgubGFiZWwsXG4gIHZhbHVlOiBkYXRhQWRtaW4xLmZpbmQoZCA9PiBkLnZhbHVlID09PSBzaGFyZWRBZG1pbjEpIHx8IChkYXRhQWRtaW4xLmxlbmd0aCA+IDAgPyBkYXRhQWRtaW4xWzBdIDogbnVsbClcbn0pICBcbnZpZXdvZiBjb21wb3NpdGVBZG1pbjIgPSBJbnB1dHMuc2VsZWN0KGRhdGFBZG1pbjIsIHtcbiAgbGFiZWw6IGFkbWluUmVnaW9ucy5sYWJlbHMuYWRtaW4yLCBcbiAgZm9ybWF0OiB4ID0+IHgubGFiZWwsXG4gIHZhbHVlOiBkYXRhQWRtaW4yLmZpbmQoZCA9PiBkLnZhbHVlID09PSBzaGFyZWRBZG1pbjIpIHx8IChkYXRhQWRtaW4yLmxlbmd0aCA+IDAgPyBkYXRhQWRtaW4yWzBdIDogbnVsbClcbn0pXG5cbi8vIENvbXBvbmVudCBzZWxlY3Rpb25cbnZpZXdvZiBjb21wb3NpdGVTZWxlY3RlZENvbXBvbmVudCA9IElucHV0cy5zZWxlY3QoXG4gIFtcbiAgICB7IHZhbHVlOiBcImNvbXBvc2l0ZVwiLCBsYWJlbDogX2xhbmcoe2VuOiBcIkNvbXBvc2l0ZSBWdWxuZXJhYmlsaXR5XCIsIGZyOiBcIlZ1bG7DqXJhYmlsaXTDqSBDb21wb3NpdGVcIn0pIH0sXG4gICAgeyB2YWx1ZTogXCJleHBvc3VyZVwiLCBsYWJlbDogX2xhbmcoe2VuOiBcIkV4cG9zdXJlXCIsIGZyOiBcIkV4cG9zaXRpb25cIn0pIH0sXG4gICAgeyB2YWx1ZTogXCJzZW5zaXRpdml0eVwiLCBsYWJlbDogX2xhbmcoe2VuOiBcIlNlbnNpdGl2aXR5XCIsIGZyOiBcIlNlbnNpYmlsaXTDqVwifSkgfSxcbiAgICB7IHZhbHVlOiBcImFkYXB0aXZlX2NhcGFjaXR5XCIsIGxhYmVsOiBfbGFuZyh7ZW46IFwiQWRhcHRpdmUgQ2FwYWNpdHlcIiwgZnI6IFwiQ2FwYWNpdMOpIGQnQWRhcHRhdGlvblwifSkgfVxuICBdLFxuICB7XG4gICAgbGFiZWw6IF9sYW5nKHtlbjogXCJDb21wb25lbnQgU2VsZWN0aW9uXCIsIGZyOiBcIlPDqWxlY3Rpb24gZGUgQ29tcG9zYW50XCJ9KSxcbiAgICBmb3JtYXQ6IHggPT4geC5sYWJlbCxcbiAgICB2YWx1ZTogeyB2YWx1ZTogXCJjb21wb3NpdGVcIiwgbGFiZWw6IF9sYW5nKHtlbjogXCJDb21wb3NpdGUgVnVsbmVyYWJpbGl0eVwiLCBmcjogXCJWdWxuw6lyYWJpbGl0w6kgQ29tcG9zaXRlXCJ9KSB9XG4gIH1cbilcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNjAiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiIvLyBDb250cm9scyBmb3JtIHdpdGggZXhhY3Qgc2FtZSBIVE1MIHN0cnVjdHVyZVxuY29tcG9zaXRlQ29udHJvbHNGb3JtID0gaHRsLmh0bWxgXG48ZGl2IHN0eWxlPVwiXG4gIGJhY2tncm91bmQ6ICNmOGZhZmM7XG4gIGJvcmRlcjogMnB4IHNvbGlkICNlMmU4ZjA7XG4gIGJvcmRlci1yYWRpdXM6IDEycHg7XG4gIHBhZGRpbmc6IDI0cHg7XG4gIGJveC1zaGFkb3c6IDAgNHB4IDZweCByZ2JhKDAsIDAsIDAsIDAuMDcpO1xuICBtYXJnaW46IDE2cHggMDtcblwiPlxuICA8aDMgc3R5bGU9XCJtYXJnaW46IDAgMCAyMHB4IDA7IGNvbG9yOiAjMmQzNzQ4OyBmb250LXNpemU6IDEuMXJlbTsgZm9udC13ZWlnaHQ6IDYwMDtcIj5cbiAgICAke19sYW5nKHZ1bG5lcmFiaWxpdHlfdHJhbnNsYXRpb25zLmdlb2dyYXBoaWNfc2VsZWN0aW9uKX1cbiAgPC9oMz5cbiAgPGRpdiBzdHlsZT1cIlxuICAgIGRpc3BsYXk6IGZsZXg7XG4gICAgYWxpZ24taXRlbXM6IGZsZXgtc3RhcnQ7XG4gICAgZ2FwOiAyMHB4O1xuICAgIGZsZXgtd3JhcDogd3JhcDtcbiAgICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47XG4gIFwiIGNsYXNzPVwiZm9ybS1pbnB1dHMtY29udGFpbmVyXCI+XG4gICAgPGRpdiBzdHlsZT1cImZsZXg6IDE7IG1pbi13aWR0aDogMTgwcHg7IG1heC13aWR0aDogMTAwJTtcIj4ke3ZpZXdvZiBjb21wb3NpdGVBZG1pbjB9PC9kaXY+XG4gICAgPGRpdiBzdHlsZT1cImZsZXg6IDE7IG1pbi13aWR0aDogMTgwcHg7IG1heC13aWR0aDogMTAwJTtcIj4ke3ZpZXdvZiBjb21wb3NpdGVBZG1pbjF9PC9kaXY+XG4gICAgPGRpdiBzdHlsZT1cImZsZXg6IDE7IG1pbi13aWR0aDogMTgwcHg7IG1heC13aWR0aDogMTAwJTtcIj4ke3ZpZXdvZiBjb21wb3NpdGVBZG1pbjJ9PC9kaXY+XG4gIDwvZGl2PlxuICA8ZGl2IHN0eWxlPVwibWFyZ2luLXRvcDogMTZweDtcIj5cbiAgICA8ZGl2IHN0eWxlPVwiZmxleDogMTsgbWluLXdpZHRoOiAyMDBweDsgbWF4LXdpZHRoOiAxMDAlO1wiPiR7dmlld29mIGNvbXBvc2l0ZVNlbGVjdGVkQ29tcG9uZW50fTwvZGl2PlxuICA8L2Rpdj5cbjwvZGl2PlxuYFxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC02MSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Ii8vIEtlZXAgbWV0YWRhdGEgYXMgSlNPTiAoc21hbGwgZmlsZSwgNEtCKVxuc2Vuc2l0aXZpdHlNZXRhZGF0YSA9IGF3YWl0IGxvYWREYXRhV2l0aENhY2hlKFxuICBcImNvbXBvc2l0ZVVyZ2VuY3lNZXRhZGF0YVwiLFxuICBhc3luYyAoKSA9PiB7XG4gICAgcmV0dXJuIGF3YWl0IEZpbGVBdHRhY2htZW50KFxuICAgICAgXCIvZGF0YS92dWxuZXJhYmlsaXR5X25vdGVib29rL3VyZ2VuY3lfbWV0YWRhdGEuanNvblwiLFxuICAgICkuanNvbigpO1xuICB9LFxuKTtcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNjIiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiIvLyBSZXVzZSBjYWNoZWQgYm91bmRhcnkgZGF0YSAoYWxyZWFkeSBsb2FkZWQgaW4gc2hhcmVkKVxuY29tcG9zaXRlTWFwQm91bmRhcmllcyA9IGJvdW5kYXJpZXM7XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTYzIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiLy8gR2V0IGN1cnJlbnQgYWRtaW4gc2VsZWN0aW9ucyB1c2luZyBzaGFyZWQgc3RhdGVcbmNvbXBvc2l0ZUFkbWluU2VsZWN0aW9ucyA9IHtcbiAgcmV0dXJuIHtcbiAgICBzZWxlY3RBZG1pbjA6IGNvbXBvc2l0ZUFkbWluMD8udmFsdWUgfHwgc2hhcmVkQWRtaW4wIHx8IG51bGwsXG4gICAgc2VsZWN0QWRtaW4xOiBjb21wb3NpdGVBZG1pbjE/LnZhbHVlIHx8IHNoYXJlZEFkbWluMSB8fCBudWxsLFxuICAgIHNlbGVjdEFkbWluMjogY29tcG9zaXRlQWRtaW4yPy52YWx1ZSB8fCBzaGFyZWRBZG1pbjIgfHwgbnVsbFxuICB9XG59XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTY0IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiLy8gRGF0YWJhc2UgY29ubmVjdGlvbiBmb3IgaW5kZXggY2FsY3VsYXRpb25zXG5pbmRleF9kYiA9IER1Y2tEQkNsaWVudC5vZih7XG4gIGV4cG9zdXJlOiBGaWxlQXR0YWNobWVudChcbiAgICBcIi9kYXRhL3Z1bG5lcmFiaWxpdHlfbm90ZWJvb2svbm90ZWJvb2tfZXhwb3N1cmUucGFycXVldFwiLFxuICApLFxuICB1cmdlbmN5OiBGaWxlQXR0YWNobWVudChcIi9kYXRhL3Z1bG5lcmFiaWxpdHlfbm90ZWJvb2svdXJnZW5jeV9pbmRleC5wYXJxdWV0XCIpLFxuICBlbmFibGluZzogRmlsZUF0dGFjaG1lbnQoXG4gICAgXCIvZGF0YS92dWxuZXJhYmlsaXR5X25vdGVib29rL2VuYWJsaW5nX3ZhcnMucGFycXVldFwiLFxuICApLCAvLyBBS0EgYWRhcHRpdmUgY2FwYWNpdHlcbn0pO1xuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC02NSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Ii8qKlxuICogQ29tcHV0ZSBpbmRleCBmcm9tIG5vcm1hbGl6ZWQgdmFsdWVzIGJ5IGF2ZXJhZ2luZyBhbGwgX25vcm0gY29sdW1uc1xuICogVXNlZCBmb3IgdnVsbmVyYWJpbGl0eSBpbmRleCBjYWxjdWxhdGlvbnMgKE5ELUdhaW4gbWV0aG9kb2xvZ3kpXG4gKiBcbiAqIEBwYXJhbSB7T2JqZWN0fSByb3cgLSBEYXRhIHJvdyB3aXRoIG5vcm1hbGl6ZWQgY29sdW1ucyBlbmRpbmcgaW4gXCJfbm9ybVwiXG4gKiBAcmV0dXJucyB7bnVtYmVyfG51bGx9IEF2ZXJhZ2Ugb2YgYWxsIG5vcm1hbGl6ZWQgdmFsdWVzLCBvciBudWxsIGlmIG5vbmUgZm91bmRcbiAqL1xuZnVuY3Rpb24gY29tcHV0ZUluZGV4KHJvdykge1xuICBjb25zdCBub3JtVmFsdWVzID0gT2JqZWN0LmVudHJpZXMocm93KVxuICAgIC5maWx0ZXIoXG4gICAgICAoW2tleSwgdmFsdWVdKSA9PlxuICAgICAgICBrZXkuZW5kc1dpdGgoXCJfbm9ybVwiKSAmJiB0eXBlb2YgdmFsdWUgPT09IFwibnVtYmVyXCIgJiYgIWlzTmFOKHZhbHVlKSxcbiAgICApXG4gICAgLm1hcCgoWywgdmFsdWVdKSA9PiB2YWx1ZSk7XG5cbiAgaWYgKG5vcm1WYWx1ZXMubGVuZ3RoID09PSAwKSByZXR1cm4gbnVsbDtcblxuICBjb25zdCBzdW0gPSBub3JtVmFsdWVzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApO1xuICByZXR1cm4gc3VtIC8gbm9ybVZhbHVlcy5sZW5ndGg7XG59XG5cbi8qKlxuICogR2VuZXJhdGUgU1FMIFdIRVJFIGNsYXVzZSBmb3IgYWRtaW4gbGV2ZWwgZmlsdGVyaW5nXG4gKiBSZXR1cm5zIGNsYXVzZSB0byBmaWx0ZXIgYnkgYWRtaW4wIChjb3VudHJ5IGxldmVsKSBvciBhZG1pbjEgKHJlZ2lvbiBsZXZlbCkgYmFzZWQgb24gc2VsZWN0aW9uXG4gKiBcbiAqIEBwYXJhbSB7c3RyaW5nfG51bGx9IGNvdW50cnlfc2VsIC0gU2VsZWN0ZWQgY291bnRyeSBjb2RlIChvciBcIlNTQVwiIGZvciBhbGwgY291bnRyaWVzKVxuICogQHBhcmFtIHtzdHJpbmd8bnVsbH0gYWRtaW4xX3NlbCAtIFNlbGVjdGVkIGFkbWluMSByZWdpb24gKGN1cnJlbnRseSB1bnVzZWQgYnV0IGtlcHQgZm9yIGNvbnNpc3RlbmN5KVxuICogQHJldHVybnMge3N0cmluZ30gU1FMIFdIRVJFIGNsYXVzZSBmcmFnbWVudFxuICovXG53aGVyZUFkbWluTnVsbCA9IChjb3VudHJ5X3NlbCwgYWRtaW4xX3NlbCkgPT4ge1xuICAvLyBJZiBhbGwgY291bnRyaWVzIHNlbGVjdGVkIChTU0EpIG9yIG5vIHNlbGVjdGlvbiwgcmV0dXJuIGNvdW50cnktbGV2ZWwgZGF0YSAoYWRtaW4xX25hbWUgSVMgTlVMTClcbiAgLy8gT3RoZXJ3aXNlLCByZXR1cm4gcmVnaW9uLWxldmVsIGRhdGEgKGFkbWluMV9uYW1lIElTIE5PVCBOVUxMKVxuICBpZiAoY291bnRyeV9zZWwgPT0gXCJTU0FcIiB8fCAhY291bnRyeV9zZWwpIHtcbiAgICByZXR1cm4gYEFORCBhZG1pbjFfbmFtZSBJUyBOVUxMYDtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gYEFORCBhZG1pbjFfbmFtZSBJUyBOT1QgTlVMTGA7XG4gIH1cbn07XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTY2IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiLy8gQ2FsY3VsYXRlIGV4cG9zdXJlIGluZGV4XG5leHBvc3VyZV9pbmRleCA9IHtcbiAgLy8gQ2hlY2sgaWYgaW5kZXhfZGIgaXMgYXZhaWxhYmxlIGJlZm9yZSBxdWVyeWluZ1xuICBpZiAoIWluZGV4X2RiKSB7XG4gICAgY29uc29sZS5lcnJvcihcImluZGV4X2RiIGlzIG5vdCBhdmFpbGFibGVcIik7XG4gICAgcmV0dXJuIFtdO1xuICB9XG4gIFxuICB0cnkge1xuICAgIHJldHVybiBhd2FpdCBpbmRleF9kYi5xdWVyeShgXG4gICAgICBXSVRIIHJhd19leHBvc3VyZSBBUyAoXG4gICAgICAgICAgU0VMRUNUIFxuICAgICAgICAgICAgYWRtaW4wX25hbWUsIFxuICAgICAgICAgICAgYWRtaW4xX25hbWUsIFxuICAgICAgICAgICAgU1VNKHZhbHVlKSBBUyB0b3RhbF9leHBvc3VyZVxuICAgICAgICAgIEZST00gZXhwb3N1cmVcbiAgICAgICAgICBXSEVSRSBhZG1pbjJfbmFtZSBJUyBOVUxMXG4gICAgICAgICAgICAke3doZXJlQWRtaW5OdWxsKGNvbXBvc2l0ZUFkbWluMC52YWx1ZSwgY29tcG9zaXRlQWRtaW4xLnZhbHVlKX1cbiAgICAgICAgICBHUk9VUCBCWSBhZG1pbjBfbmFtZSwgYWRtaW4xX25hbWVcbiAgICAgICAgKSxcbiAgICAgICAgc3RhdHMgQVMgKFxuICAgICAgICAgIFNFTEVDVFxuICAgICAgICAgICAgTUlOKHRvdGFsX2V4cG9zdXJlKSBBUyBleHBvc3VyZV9taW4sXG4gICAgICAgICAgICBNQVgodG90YWxfZXhwb3N1cmUpIEFTIGV4cG9zdXJlX21heFxuICAgICAgICAgIEZST00gcmF3X2V4cG9zdXJlXG4gICAgICAgICAgV0hFUkUgSVNGSU5JVEUodG90YWxfZXhwb3N1cmUpXG4gICAgICAgIClcbiAgICAgICAgU0VMRUNUIFxuICAgICAgICAgIHIuYWRtaW4wX25hbWUsXG4gICAgICAgICAgci5hZG1pbjFfbmFtZSxcbiAgICAgICAgICByLnRvdGFsX2V4cG9zdXJlLFxuICAgICAgICAgIC0tIE1pbi1tYXggbm9ybWFsaXplIGV4cG9zdXJlXG4gICAgICAgICAgKHIudG90YWxfZXhwb3N1cmUgLSBzLmV4cG9zdXJlX21pbikgLyBOVUxMSUYocy5leHBvc3VyZV9tYXggLSBzLmV4cG9zdXJlX21pbiwgMCkgQVMgZXhwb3N1cmVfbm9ybVxuICAgICAgICBGUk9NIHJhd19leHBvc3VyZSByXG4gICAgICAgIENST1NTIEpPSU4gc3RhdHMgc1xuICAgICAgICBXSEVSRSBJU0ZJTklURShyLnRvdGFsX2V4cG9zdXJlKVxuICAgICAgICBPUkRFUiBCWSByLnRvdGFsX2V4cG9zdXJlIERFU0M7XG4gICAgYCk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcihcIkZhaWxlZCB0byBjYWxjdWxhdGUgZXhwb3N1cmUgaW5kZXg6XCIsIGVycm9yKTtcbiAgICByZXR1cm4gW107XG4gIH1cbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNjciLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiIvLyBDYWxjdWxhdGUgZW5hYmxpbmcgaW5kZXggKGFkYXB0aXZlIGNhcGFjaXR5KVxuZW5hYmxpbmdfaW5kZXggPSB7XG4gIC8vIENoZWNrIGlmIGluZGV4X2RiIGlzIGF2YWlsYWJsZSBiZWZvcmUgcXVlcnlpbmdcbiAgaWYgKCFpbmRleF9kYikge1xuICAgIGNvbnNvbGUuZXJyb3IoXCJpbmRleF9kYiBpcyBub3QgYXZhaWxhYmxlXCIpO1xuICAgIHJldHVybiBbXTtcbiAgfVxuICBcbiAgdHJ5IHtcbiAgICBsZXQgcmVzcCA9IGF3YWl0IGluZGV4X2RiLnF1ZXJ5KGBcblNFTEVDVCAqXG5GUk9NIGVuYWJsaW5nXG5XSEVSRSBhZG1pbjBfbmFtZSAhPSAnU1NBJ1xuJHt3aGVyZUFkbWluTnVsbChjb21wb3NpdGVBZG1pbjAudmFsdWUsIGNvbXBvc2l0ZUFkbWluMS52YWx1ZSl9XG5gKTtcblxuICAgIHJldHVybiByZXNwLm1hcCgocm93KSA9PiAoe1xuICAgICAgLi4ucm93LFxuICAgICAgZW5hYmxpbmdfaW5kZXg6IGNvbXB1dGVJbmRleChyb3cpXG4gICAgfSkpO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoXCJGYWlsZWQgdG8gY2FsY3VsYXRlIGVuYWJsaW5nIGluZGV4OlwiLCBlcnJvcik7XG4gICAgcmV0dXJuIFtdO1xuICB9XG59XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTY4IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiLy8gQ2FsY3VsYXRlIHVyZ2VuY3kgaW5kZXhcbi8vIEluZGV4IGlzIGJhc2VkIG9uIGV4cG9zdXJlIGFuZCBzZW5zaXRpdml0eVxudXJnZW5jeV9pbmRleCA9IHtcbiAgLy8gQ2hlY2sgaWYgaW5kZXhfZGIgaXMgYXZhaWxhYmxlIGJlZm9yZSBxdWVyeWluZ1xuICBpZiAoIWluZGV4X2RiKSB7XG4gICAgY29uc29sZS5lcnJvcihcImluZGV4X2RiIGlzIG5vdCBhdmFpbGFibGVcIik7XG4gICAgcmV0dXJuIFtdO1xuICB9XG4gIFxuICB0cnkge1xuICAgIGxldCBnZW5kZXIgPSBcInRvdGFsXCI7IC8vTk9URTogS2VlcGluZyB0aGlzIGFzIGFuIG9wdGlvbiBpbiBjYXNlIGZ1dHVyZSB1cGRhdGVzIHdhbnQgZ2VuZGVyIHNwZWNpZmljIGluZGV4XG4gICAgLy8gc2Vuc2l0aXZpdHkgZGF0YVxuICAgIGxldCBzZW5zaXRpdml0eURhdGEgPSBhd2FpdCBpbmRleF9kYi5xdWVyeShgXG5TRUxFQ1QgKlxuRlJPTSB1cmdlbmN5XG5XSEVSRSBhZG1pbjBfbmFtZSAhPSAnU1NBJ1xuQU5EIGdlbmRlciA9ICcke2dlbmRlcn0nXG4ke3doZXJlQWRtaW5OdWxsKGNvbXBvc2l0ZUFkbWluMC52YWx1ZSwgY29tcG9zaXRlQWRtaW4xLnZhbHVlKX1cbmApO1xuXG4gICAgLy8gQ2hlY2sgaWYgZXhwb3N1cmVfaW5kZXggZXhpc3RzIGFuZCBpcyBhbiBhcnJheSBiZWZvcmUgdXNpbmdcbiAgICBjb25zdCBleHBvc3VyZU1hcCA9IChleHBvc3VyZV9pbmRleCAmJiBBcnJheS5pc0FycmF5KGV4cG9zdXJlX2luZGV4KSlcbiAgICAgID8gT2JqZWN0LmZyb21FbnRyaWVzKFxuICAgICAgICAgIGV4cG9zdXJlX2luZGV4Lm1hcCgoZCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgYTAgPSBkLmFkbWluMF9uYW1lO1xuICAgICAgICAgICAgY29uc3QgYTEgPSBkLmFkbWluMV9uYW1lO1xuICAgICAgICAgICAgY29uc3Qga2V5ID0gYTEgPyBgJHthMH18fCR7YTF9YCA6IGEwOyAvLyB1c2UgYm90aCBpZiBhZG1pbjEgZXhpc3RzLCBlbHNlIGp1c3QgYWRtaW4wXG4gICAgICAgICAgICByZXR1cm4gW2tleSwgZC5leHBvc3VyZV9ub3JtXTtcbiAgICAgICAgICB9KVxuICAgICAgICApXG4gICAgICA6IHt9O1xuXG4gICAgLy8gbWVyZ2UgaW50byB1cmdlbmN5RGF0YVxuICAgIGNvbnN0IG1lcmdlZCA9IHNlbnNpdGl2aXR5RGF0YS5tYXAoKGQpID0+IHtcbiAgICAgIGNvbnN0IGEwID0gZC5hZG1pbjBfbmFtZTtcbiAgICAgIGNvbnN0IGExID0gZC5hZG1pbjFfbmFtZTtcbiAgICAgIGNvbnN0IGtleSA9IGExID8gYCR7YTB9fHwke2ExfWAgOiBhMDtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uZCxcbiAgICAgICAgZXhwb3N1cmVfbm9ybTogZXhwb3N1cmVNYXBba2V5XSA/PyBudWxsXG4gICAgICB9O1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIG1lcmdlZC5tYXAoKHJvdykgPT4gKHtcbiAgICAgIC4uLnJvdyxcbiAgICAgIHVyZ2VuY3lfaW5kZXg6IGNvbXB1dGVJbmRleChyb3cpXG4gICAgfSkpO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoXCJGYWlsZWQgdG8gY2FsY3VsYXRlIHVyZ2VuY3kgaW5kZXg6XCIsIGVycm9yKTtcbiAgICByZXR1cm4gW107XG4gIH1cbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNjkiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiIvLyBDYWxjdWxhdGUgdnVsbmVyYWJpbGl0eSBpbmRleCAoQUtBIGNvbXBvc2l0ZSBpbmRleCB3aXRoIE5ELWdhaW4gTWV0aG9kb2xvZ3kpXG52dWxuZXJhYmlsaXR5SW5kZXggPSB7XG4gIGNvbnN0IGtleSA9IChyKSA9PiBgJHtyLmFkbWluMF9uYW1lfXwke3IuYWRtaW4xX25hbWV9YDtcbiAgY29uc3QgdG9NYXAgPSAoYXJyLCBrLCB2KSA9PiBPYmplY3QuZnJvbUVudHJpZXMoYXJyLm1hcCgocikgPT4gW2sociksIHYocildKSk7XG5cbiAgY29uc3QgdU1hcCA9IHRvTWFwKHVyZ2VuY3lfaW5kZXgsIGtleSwgKHIpID0+IHIudXJnZW5jeV9pbmRleCk7XG4gIGNvbnN0IGVuTWFwID0gdG9NYXAoZW5hYmxpbmdfaW5kZXgsIGtleSwgKHIpID0+IHIuZW5hYmxpbmdfaW5kZXgpO1xuXG4gIGNvbnN0IGFsbEtleXMgPSBuZXcgU2V0KFsuLi5PYmplY3Qua2V5cyhlbk1hcCksIC4uLk9iamVjdC5rZXlzKHVNYXApXSk7XG5cbiAgY29uc3QgbWVyZ2VkID0gWy4uLmFsbEtleXNdLm1hcCgoaykgPT4ge1xuICAgIGNvbnN0IFthZG1pbjBfbmFtZSwgYWRtaW4xX25hbWVdID0gay5zcGxpdChcInxcIik7XG4gICAgY29uc3QgZW4gPSBlbk1hcFtrXSxcbiAgICAgIHUgPSB1TWFwW2tdO1xuICAgIHJldHVybiB7XG4gICAgICBhZG1pbjBfbmFtZSxcbiAgICAgIGFkbWluMV9uYW1lLFxuICAgICAgZW5hYmxpbmdfaW5kZXg6IGVuID8/IG51bGwsXG4gICAgICB1cmdlbmN5X2luZGV4OiB1ID8/IG51bGwsXG4gICAgICB2dWxuZXJhYmlsaXR5OlxuICAgICAgICB0eXBlb2YgZW4gPT09IFwibnVtYmVyXCIgJiYgdHlwZW9mIHUgPT09IFwibnVtYmVyXCJcbiAgICAgICAgICA/IDEwMCAtIChlbiAtIHUgKyAxKSAqIDUwXG4gICAgICAgICAgOiBudWxsXG4gICAgfTtcbiAgfSk7XG5cbiAgcmV0dXJuIG1lcmdlZC5maWx0ZXIoZCA9PiBkLnZ1bG5lcmFiaWxpdHkgIT09IG51bGwpO1xufVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC03MCIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Ii8vIFVwZGF0ZWQgdnVsbmVyYWJpbGl0eSBpbmRleCBjYWxjdWxhdGlvbiB1c2luZyB0aGUgT2JzZXJ2YWJsZSBhcHByb2FjaFxuY29tcG9uZW50SW5kaWNlc1BlclJlZ2lvbiA9IHtcbiAgLy8gQ2hlY2sgaWYgdnVsbmVyYWJpbGl0eUluZGV4IGV4aXN0cyBhbmQgaXMgdmFsaWQgYmVmb3JlIHByb2Nlc3NpbmdcbiAgaWYgKCF2dWxuZXJhYmlsaXR5SW5kZXggfHwgIUFycmF5LmlzQXJyYXkodnVsbmVyYWJpbGl0eUluZGV4KSB8fCB2dWxuZXJhYmlsaXR5SW5kZXgubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIHsgc2NvcmVzOiB7fSwgYWRtaW5MZXZlbDogbnVsbCwgcmVnaW9uczogW10gfTtcbiAgfVxuICBcbiAgY29uc3Qgc2VsZWN0aW9ucyA9IGNvbXBvc2l0ZUFkbWluU2VsZWN0aW9ucztcbiAgY29uc3QgaXNOdWxsID0gKHZhbCkgPT4gdmFsID09PSBudWxsIHx8IHZhbCA9PT0gdW5kZWZpbmVkIHx8IHZhbCA9PT0gXCJcIiB8fCB2YWwgPT09IFwiXFxcXE5cIjtcbiAgXG4gIC8vIERldGVybWluZSBhZG1pbiBsZXZlbCBhbmQgZ2V0IHVuaXF1ZSByZWdpb25zXG4gIGxldCBhZG1pbkxldmVsLCByZWdpb25zO1xuICBpZiAoIXNlbGVjdGlvbnMuc2VsZWN0QWRtaW4wIHx8IHNlbGVjdGlvbnMuc2VsZWN0QWRtaW4wID09PSBcIlNTQVwiKSB7XG4gICAgLy8gU2hvdyBhbGwgY291bnRyaWVzIChhZG1pbjAgbGV2ZWwpXG4gICAgYWRtaW5MZXZlbCA9IFwiYWRtaW4wX25hbWVcIjtcbiAgICByZWdpb25zID0gWy4uLm5ldyBTZXQodnVsbmVyYWJpbGl0eUluZGV4Lm1hcChkID0+IGQuYWRtaW4wX25hbWUpLmZpbHRlcihkID0+IGQpKV07XG4gIH0gZWxzZSBpZiAoIXNlbGVjdGlvbnMuc2VsZWN0QWRtaW4xKSB7XG4gICAgLy8gU2hvdyBhZG1pbjEgd2l0aGluIHNlbGVjdGVkIGNvdW50cnlcbiAgICBhZG1pbkxldmVsID0gXCJhZG1pbjFfbmFtZVwiO1xuICAgIHJlZ2lvbnMgPSBbLi4ubmV3IFNldCh2dWxuZXJhYmlsaXR5SW5kZXhcbiAgICAgIC5maWx0ZXIoZCA9PiBkLmFkbWluMF9uYW1lID09PSBzZWxlY3Rpb25zLnNlbGVjdEFkbWluMCAmJiAhaXNOdWxsKGQuYWRtaW4xX25hbWUpKVxuICAgICAgLm1hcChkID0+IGQuYWRtaW4xX25hbWUpKV07XG4gIH0gZWxzZSBpZiAoIXNlbGVjdGlvbnMuc2VsZWN0QWRtaW4yKSB7XG4gICAgLy8gU2hvdyBhZG1pbjIgd2l0aGluIHNlbGVjdGVkIGFkbWluMVxuICAgIGFkbWluTGV2ZWwgPSBcImFkbWluMl9uYW1lXCI7XG4gICAgcmVnaW9ucyA9IFsuLi5uZXcgU2V0KHZ1bG5lcmFiaWxpdHlJbmRleFxuICAgICAgLmZpbHRlcihkID0+IGQuYWRtaW4wX25hbWUgPT09IHNlbGVjdGlvbnMuc2VsZWN0QWRtaW4wICYmIFxuICAgICAgICAgICAgICAgICAgIGQuYWRtaW4xX25hbWUgPT09IHNlbGVjdGlvbnMuc2VsZWN0QWRtaW4xICYmIFxuICAgICAgICAgICAgICAgICAgICFpc051bGwoZC5hZG1pbjJfbmFtZSkpXG4gICAgICAubWFwKGQgPT4gZC5hZG1pbjJfbmFtZSkpXTtcbiAgfSBlbHNlIHtcbiAgICAvLyBTaW5nbGUgYWRtaW4yIHNlbGVjdGVkXG4gICAgYWRtaW5MZXZlbCA9IFwiYWRtaW4yX25hbWVcIjtcbiAgICByZWdpb25zID0gW3NlbGVjdGlvbnMuc2VsZWN0QWRtaW4yXTtcbiAgfVxuXG4gIC8vIENhbGN1bGF0ZSBzY29yZXMgZm9yIGVhY2ggcmVnaW9uIHVzaW5nIHRoZSBuZXcgdnVsbmVyYWJpbGl0eSBpbmRleFxuICBjb25zdCByZWdpb25TY29yZXMgPSB7fTtcblxuICByZWdpb25zLmZvckVhY2gocmVnaW9uID0+IHtcbiAgICAvLyBGaW5kIHZ1bG5lcmFiaWxpdHkgZGF0YSBmb3IgdGhpcyByZWdpb25cbiAgICBjb25zdCB2dWxuRGF0YSA9IHZ1bG5lcmFiaWxpdHlJbmRleC5maW5kKGQgPT4gZFthZG1pbkxldmVsXSA9PT0gcmVnaW9uKTtcbiAgICBcbiAgICBpZiAodnVsbkRhdGEpIHtcbiAgICAgIC8vIENvbnZlcnQgdnVsbmVyYWJpbGl0eSBzY29yZSAoMC0xMDApIHRvIDAtMSBzY2FsZSBmb3IgY29uc2lzdGVuY3lcbiAgICAgIGNvbnN0IGNvbXBvc2l0ZVNjb3JlID0gdnVsbkRhdGEudnVsbmVyYWJpbGl0eSA/IHZ1bG5EYXRhLnZ1bG5lcmFiaWxpdHkgLyAxMDAgOiAwO1xuICAgICAgY29uc3QgZW5hYmxpbmdTY29yZSA9IHZ1bG5EYXRhLmVuYWJsaW5nX2luZGV4IHx8IDA7XG4gICAgICBjb25zdCB1cmdlbmN5U2NvcmUgPSB2dWxuRGF0YS51cmdlbmN5X2luZGV4IHx8IDA7XG4gICAgICBcbiAgICAgIC8vIFVyZ2VuY3kgaW5kZXggcmVwcmVzZW50cyBzZW5zaXRpdml0eSAocG9wdWxhdGlvbiBkZW5zaXR5LCBlZHVjYXRpb24sIHBvdmVydHkpXG4gICAgICAvLyBFeHBvc3VyZSBpcyBzZXBhcmF0ZSBhbmQgY29tZXMgZnJvbSBleHBvc3VyZSBkYXRhXG4gICAgICBjb25zdCBzZW5zaXRpdml0eVNjb3JlID0gdXJnZW5jeVNjb3JlOyAvLyBVcmdlbmN5IGluZGV4IElTIHNlbnNpdGl2aXR5XG4gICAgICBcbiAgICAgIC8vIEdldCBleHBvc3VyZSBzY29yZSBmcm9tIGV4cG9zdXJlIGRhdGEgKHdpdGggbnVsbCBjaGVjaylcbiAgICAgIGNvbnN0IGV4cG9zdXJlRGF0YSA9IChleHBvc3VyZV9pbmRleCAmJiBBcnJheS5pc0FycmF5KGV4cG9zdXJlX2luZGV4KSlcbiAgICAgICAgPyBleHBvc3VyZV9pbmRleC5maW5kKGQgPT4gZFthZG1pbkxldmVsXSA9PT0gcmVnaW9uKVxuICAgICAgICA6IG51bGw7XG4gICAgICBjb25zdCBleHBvc3VyZVNjb3JlID0gZXhwb3N1cmVEYXRhID8gZXhwb3N1cmVEYXRhLmV4cG9zdXJlX25vcm0gOiAwO1xuICAgICAgXG4gICAgICAvLyBGSVhFRDogQWRhcHRpdmUgY2FwYWNpdHkgc2hvdWxkIGJlIEhJR0ggd2hlbiBlbmFibGluZyBpcyBISUdIIChub3QgaW52ZXJ0ZWQpXG4gICAgICAvLyBDb3VudHJpZXMgd2l0aCBoaWdoIGVuYWJsaW5nIGZhY3RvcnMgaGF2ZSBISUdIIGFkYXB0aXZlIGNhcGFjaXR5IChnb29kIHRoaW5nKVxuICAgICAgY29uc3QgYWRhcHRpdmVTY29yZSA9IGVuYWJsaW5nU2NvcmU7IC8vIEhpZ2ggZW5hYmxpbmcgPSBoaWdoIGFkYXB0aXZlIGNhcGFjaXR5XG4gICAgICBcbiAgICAgIHJlZ2lvblNjb3Jlc1tyZWdpb25dID0ge1xuICAgICAgICBleHBvc3VyZTogZXhwb3N1cmVTY29yZSxcbiAgICAgICAgc2Vuc2l0aXZpdHk6IHNlbnNpdGl2aXR5U2NvcmUsXG4gICAgICAgIGFkYXB0aXZlX2NhcGFjaXR5OiBhZGFwdGl2ZVNjb3JlLFxuICAgICAgICBjb21wb3NpdGU6IGNvbXBvc2l0ZVNjb3JlLFxuICAgICAgICAvLyBJbmNsdWRlIHJhdyB2YWx1ZXMgZm9yIHJlZmVyZW5jZVxuICAgICAgICBlbmFibGluZ19pbmRleDogZW5hYmxpbmdTY29yZSxcbiAgICAgICAgdXJnZW5jeV9pbmRleDogdXJnZW5jeVNjb3JlLFxuICAgICAgICB2dWxuZXJhYmlsaXR5X3Njb3JlOiB2dWxuRGF0YS52dWxuZXJhYmlsaXR5XG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBObyBkYXRhIGF2YWlsYWJsZSBmb3IgdGhpcyByZWdpb25cbiAgICAgIHJlZ2lvblNjb3Jlc1tyZWdpb25dID0geyAvLyBBbGwgbnVsbCBhcyBhIGRlZmF1bHQgb2YgMCBjb3VsZCBiZSBpbnRlcnByZXRlZCBhcyBhIHNjb3JlIHJhdGhlciB0aGFuIG1pc3NpbmdcbiAgICAgICAgZXhwb3N1cmU6IG51bGwsXG4gICAgICAgIHNlbnNpdGl2aXR5OiBudWxsLFxuICAgICAgICBhZGFwdGl2ZV9jYXBhY2l0eTogbnVsbCxcbiAgICAgICAgY29tcG9zaXRlOiBudWxsLFxuICAgICAgICBlbmFibGluZ19pbmRleDogbnVsbCxcbiAgICAgICAgdXJnZW5jeV9pbmRleDogbnVsbCxcbiAgICAgICAgdnVsbmVyYWJpbGl0eV9zY29yZTogbnVsbFxuICAgICAgfTtcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiB7IFxuICAgIHNjb3JlczogcmVnaW9uU2NvcmVzLCBcbiAgICBhZG1pbkxldmVsOiBhZG1pbkxldmVsLFxuICAgIHJlZ2lvbnM6IHJlZ2lvbnNcbiAgfTtcbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNzEiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiIvLyBTbWFsbCBNdWx0aXBsZXMvRmFjZXRlZCBNYXBzIFZpc3VhbGl6YXRpb24gd2l0aCBwcm9wZXIgbG9hZGluZy9uby1kYXRhIHN0YXRlc1xuY29tcG9zaXRlVnVsbmVyYWJpbGl0eU1hcHMgPSB7XG4gIC8vIFNob3cgbG9hZGluZyBzcGlubmVyIG9ubHkgaWYgZGF0YSBpcyBzdGlsbCBsb2FkaW5nIChudWxsL3VuZGVmaW5lZClcbiAgaWYgKFtleHBvc3VyZV9pbmRleCwgZW5hYmxpbmdfaW5kZXgsIHVyZ2VuY3lfaW5kZXgsIHNlbnNpdGl2aXR5TWV0YWRhdGFdLnNvbWUoKGQpID0+IGQgPT09IG51bGwgfHwgZCA9PT0gdW5kZWZpbmVkKSkge1xuICAgIHJldHVybiBjcmVhdGVMb2FkaW5nU3RhdGUoXG4gICAgICBfbGFuZyh7ZW46IFwiTG9hZGluZyBjb21wb3NpdGUgdnVsbmVyYWJpbGl0eSBkYXRhLi4uXCIsIGZyOiBcIkNoYXJnZW1lbnQgZGVzIGRvbm7DqWVzIGRlIHZ1bG7DqXJhYmlsaXTDqSBjb21wb3NpdGUuLi5cIn0pXG4gICAgKTtcbiAgfVxuXG4gIC8vIC8vIElmIGRhdGEgaXMgbG9hZGVkIGJ1dCBlbXB0eSBvciBwcm9jZXNzaW5nIGZhaWxlZCwgc2hvdyBubyBkYXRhIHN0YXRlXG4gIGlmIChcbiAgICBbZXhwb3N1cmVfaW5kZXgsIGVuYWJsaW5nX2luZGV4LCB1cmdlbmN5X2luZGV4LCBzZW5zaXRpdml0eU1ldGFkYXRhLCBjb21wb25lbnRJbmRpY2VzUGVyUmVnaW9uXVxuICAgICAgLnNvbWUoKGQpID0+ICFkKSB8fCAhY29tcG9uZW50SW5kaWNlc1BlclJlZ2lvbj8uc2NvcmVzXG4gICkge1xuICAgIHJldHVybiBjcmVhdGVOb0RhdGFTdGF0ZShfbGFuZyh2dWxuZXJhYmlsaXR5X3RyYW5zbGF0aW9ucy5ub19kYXRhX2F2YWlsYWJsZSkpO1xuICB9XG5cbiAgY29uc3QgeyBzY29yZXMsIGFkbWluTGV2ZWwgfSA9IGNvbXBvbmVudEluZGljZXNQZXJSZWdpb247XG4gIGNvbnN0IHNlbGVjdGlvbnMgPSBjb21wb3NpdGVBZG1pblNlbGVjdGlvbnM7XG4gIFxuICAvLyBHZXQgdGhlIGFwcHJvcHJpYXRlIGJvdW5kYXJ5IGxldmVsXG4gIGxldCBib3VuZGFyaWVzO1xuICBpZiAoYWRtaW5MZXZlbCA9PT0gXCJhZG1pbjBfbmFtZVwiKSB7XG4gICAgYm91bmRhcmllcyA9IGNvbXBvc2l0ZU1hcEJvdW5kYXJpZXMuYWRtaW4wO1xuICB9IGVsc2UgaWYgKGFkbWluTGV2ZWwgPT09IFwiYWRtaW4xX25hbWVcIikge1xuICAgIGJvdW5kYXJpZXMgPSB7XG4gICAgICAuLi5jb21wb3NpdGVNYXBCb3VuZGFyaWVzLmFkbWluMSxcbiAgICAgIGZlYXR1cmVzOiBjb21wb3NpdGVNYXBCb3VuZGFyaWVzLmFkbWluMS5mZWF0dXJlcy5maWx0ZXIoXG4gICAgICAgIGQgPT4gZC5wcm9wZXJ0aWVzLmFkbWluMF9uYW1lID09PSBzZWxlY3Rpb25zLnNlbGVjdEFkbWluMFxuICAgICAgKVxuICAgIH07XG4gIH0gZWxzZSB7XG4gICAgYm91bmRhcmllcyA9IHtcbiAgICAgIC4uLmNvbXBvc2l0ZU1hcEJvdW5kYXJpZXMuYWRtaW4yLFxuICAgICAgZmVhdHVyZXM6IGNvbXBvc2l0ZU1hcEJvdW5kYXJpZXMuYWRtaW4yLmZlYXR1cmVzLmZpbHRlcihcbiAgICAgICAgZCA9PiBkLnByb3BlcnRpZXMuYWRtaW4wX25hbWUgPT09IHNlbGVjdGlvbnMuc2VsZWN0QWRtaW4wICYmIFxuICAgICAgICAgICAgZC5wcm9wZXJ0aWVzLmFkbWluMV9uYW1lID09PSBzZWxlY3Rpb25zLnNlbGVjdEFkbWluMVxuICAgICAgKVxuICAgIH07XG4gIH1cblxuICAvLyBEZWZpbmUgdGhlIGNvbXBvbmVudHMgdG8gc2hvdyBiYXNlZCBvbiBzZWxlY3Rpb25cbiAgY29uc3Qgc2hvd0FsbENvbXBvbmVudHMgPSBjb21wb3NpdGVTZWxlY3RlZENvbXBvbmVudC52YWx1ZSA9PT0gXCJjb21wb3NpdGVcIjtcbiAgY29uc3QgY29tcG9uZW50cyA9IHNob3dBbGxDb21wb25lbnRzID8gW1xuICAgIHsga2V5OiBcImNvbXBvc2l0ZVwiLCBsYWJlbDogX2xhbmcoe2VuOiBcIkNvbXBvc2l0ZVwiLCBmcjogXCJDb21wb3NpdGVcIn0pLCBzY2hlbWU6IFwiUmVkc1wiLCBpc0NvbXBvc2l0ZTogdHJ1ZSB9LFxuICAgIHsga2V5OiBcImV4cG9zdXJlXCIsIGxhYmVsOiBfbGFuZyh7ZW46IFwiRXhwb3N1cmVcIiwgZnI6IFwiRXhwb3NpdGlvblwifSksIHNjaGVtZTogXCJPcmFuZ2VzXCIsIGlzQ29tcG9zaXRlOiBmYWxzZSB9LFxuICAgIHsga2V5OiBcInNlbnNpdGl2aXR5XCIsIGxhYmVsOiBfbGFuZyh7ZW46IFwiU2Vuc2l0aXZpdHlcIiwgZnI6IFwiU2Vuc2liaWxpdMOpXCJ9KSwgc2NoZW1lOiBcIlB1cnBsZXNcIiwgaXNDb21wb3NpdGU6IGZhbHNlIH0sXG4gICAgeyBrZXk6IFwiYWRhcHRpdmVfY2FwYWNpdHlcIiwgbGFiZWw6IF9sYW5nKHtlbjogXCJBZGFwdGl2ZSBDYXBhY2l0eVwiLCBmcjogXCJDYXBhY2l0w6kgZCdBZGFwdGF0aW9uXCJ9KSwgc2NoZW1lOiBcIkdyZWVuc1wiLCBpc0NvbXBvc2l0ZTogZmFsc2UgfVxuICBdIDogW3tcbiAgICBrZXk6IGNvbXBvc2l0ZVNlbGVjdGVkQ29tcG9uZW50LnZhbHVlLFxuICAgIGxhYmVsOiBjb21wb3NpdGVTZWxlY3RlZENvbXBvbmVudC5sYWJlbCxcbiAgICBzY2hlbWU6IFwiUmVkc1wiLFxuICAgIGlzQ29tcG9zaXRlOiBmYWxzZVxuICB9XTtcblxuICAvLyBDYWxjdWxhdGUgc3VicGxvdCBkaW1lbnNpb25zIC0gdXNlIGZ1bGwgd2lkdGhcbiAgY29uc3QgdG90YWxXaWR0aCA9IDEwMDA7IC8vIEluY3JlYXNlZCB3aWR0aCBmb3IgYmV0dGVyIGNvdmVyYWdlXG4gIGNvbnN0IHRvdGFsSGVpZ2h0ID0gc2hvd0FsbENvbXBvbmVudHMgPyA2MDAgOiAzMDA7XG4gIFxuICAvLyBDcmVhdGUgaW5kaXZpZHVhbCBtYXBzIGZvciBlYWNoIGNvbXBvbmVudFxuICBjb25zdCBtYXBzID0gY29tcG9uZW50cy5tYXAoKGNvbXBvbmVudCwgaW5kZXgpID0+IHtcbiAgICAvLyBDcmVhdGUgZmVhdHVyZXMgZm9yIHRoaXMgY29tcG9uZW50XG4gICAgY29uc3QgY29tcG9uZW50RmVhdHVyZXMgPSBib3VuZGFyaWVzLmZlYXR1cmVzLm1hcChmZWF0dXJlID0+IHtcbiAgICAgIC8vIEdldCB0aGUgY29ycmVjdCByZWdpb24gbmFtZSBiYXNlZCBvbiBhZG1pbiBsZXZlbFxuICAgICAgbGV0IHJlZ2lvbk5hbWU7XG4gICAgICBpZiAoYWRtaW5MZXZlbCA9PT0gXCJhZG1pbjBfbmFtZVwiKSB7XG4gICAgICAgIHJlZ2lvbk5hbWUgPSBmZWF0dXJlLnByb3BlcnRpZXMuYWRtaW4wX25hbWU7XG4gICAgICB9IGVsc2UgaWYgKGFkbWluTGV2ZWwgPT09IFwiYWRtaW4xX25hbWVcIikge1xuICAgICAgICByZWdpb25OYW1lID0gZmVhdHVyZS5wcm9wZXJ0aWVzLmFkbWluMV9uYW1lO1xuICAgICAgfSBlbHNlIGlmIChhZG1pbkxldmVsID09PSBcImFkbWluMl9uYW1lXCIpIHtcbiAgICAgICAgcmVnaW9uTmFtZSA9IGZlYXR1cmUucHJvcGVydGllcy5hZG1pbjJfbmFtZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlZ2lvbk5hbWUgPSBmZWF0dXJlLnByb3BlcnRpZXNbYWRtaW5MZXZlbF07XG4gICAgICB9XG4gICAgICBcbiAgICAgIGNvbnN0IHJlZ2lvblNjb3JlcyA9IHNjb3Jlc1tyZWdpb25OYW1lXSB8fCB7IFxuICAgICAgICBleHBvc3VyZTogMCwgc2Vuc2l0aXZpdHk6IDAsIGFkYXB0aXZlX2NhcGFjaXR5OiAwLCBjb21wb3NpdGU6IDAgXG4gICAgICB9O1xuICAgICAgXG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi5mZWF0dXJlLFxuICAgICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgICAgLi4uZmVhdHVyZS5wcm9wZXJ0aWVzLFxuICAgICAgICAgIHZ1bG5lcmFiaWxpdHk6IHJlZ2lvblNjb3Jlc1tjb21wb25lbnQua2V5XSB8fCAwLFxuICAgICAgICAgIHJlZ2lvbk5hbWU6IHJlZ2lvbk5hbWUsXG4gICAgICAgICAgLy8gQWRkIGluZGl2aWR1YWwgc2NvcmVzIGFzIHByb3BlcnRpZXMgZm9yIGVhc2llciB0b29sdGlwIGFjY2Vzc1xuICAgICAgICAgIGV4cG9zdXJlU2NvcmU6IHJlZ2lvblNjb3Jlcy5leHBvc3VyZSB8fCAwLFxuICAgICAgICAgIHNlbnNpdGl2aXR5U2NvcmU6IHJlZ2lvblNjb3Jlcy5zZW5zaXRpdml0eSB8fCAwLFxuICAgICAgICAgIGFkYXB0aXZlQ2FwYWNpdHlTY29yZTogcmVnaW9uU2NvcmVzLmFkYXB0aXZlX2NhcGFjaXR5IHx8IDAsXG4gICAgICAgICAgY29tcG9zaXRlU2NvcmU6IHJlZ2lvblNjb3Jlcy5jb21wb3NpdGUgfHwgMFxuICAgICAgICB9XG4gICAgICB9O1xuICAgIH0pO1xuXG4gICAgLy8gQ2FsY3VsYXRlIGR5bmFtaWMgZG9tYWluIGZvciB0aGlzIGNvbXBvbmVudCdzIGRhdGFcbiAgICBjb25zdCB2YWxpZFZhbHVlcyA9IGNvbXBvbmVudEZlYXR1cmVzXG4gICAgICAubWFwKGQgPT4gZC5wcm9wZXJ0aWVzLnZ1bG5lcmFiaWxpdHkpXG4gICAgICAuZmlsdGVyKHYgPT4gdiAhPT0gbnVsbCAmJiB2ICE9PSB1bmRlZmluZWQgJiYgIWlzTmFOKHYpKTtcbiAgICBcbiAgICBjb25zdCBtaW5WYWx1ZSA9IHZhbGlkVmFsdWVzLmxlbmd0aCA+IDAgPyBNYXRoLm1pbiguLi52YWxpZFZhbHVlcykgOiAwO1xuICAgIGNvbnN0IG1heFZhbHVlID0gdmFsaWRWYWx1ZXMubGVuZ3RoID4gMCA/IE1hdGgubWF4KC4uLnZhbGlkVmFsdWVzKSA6IDE7XG4gICAgXG4gICAgLy8gRW5zdXJlIHdlIGhhdmUgYSB2YWxpZCByYW5nZVxuICAgIGNvbnN0IGRvbWFpbk1pbiA9IG1pblZhbHVlO1xuICAgIGNvbnN0IGRvbWFpbk1heCA9IG1heFZhbHVlID4gbWluVmFsdWUgPyBtYXhWYWx1ZSA6IG1pblZhbHVlICsgMC4xO1xuXG4gICAgLy8gQ2FsY3VsYXRlIG1hcCBkaW1lbnNpb25zIGJhc2VkIG9uIGNvbXBvbmVudCB0eXBlXG4gICAgY29uc3QgbWFwV2lkdGggPSBjb21wb25lbnQuaXNDb21wb3NpdGUgPyAxMDAwIDogTWF0aC5mbG9vcigxMDAwIC8gMyk7XG4gICAgY29uc3QgbWFwSGVpZ2h0ID0gY29tcG9uZW50LmlzQ29tcG9zaXRlID8gMzAwIDogMjUwO1xuXG4gICAgLy8gQ29sb3Igc2NoZW1lIGJhc2VkIG9uIGNvbXBvbmVudFxuICAgIGxldCBjb2xvclJhbmdlO1xuICAgIGlmIChjb21wb25lbnQua2V5ID09PSBcImFkYXB0aXZlX2NhcGFjaXR5XCIpIHtcbiAgICAgIGNvbG9yUmFuZ2UgPSBbXCIjRjdENzMyXCIsIFwiIzIxNjcyOVwiXTsgLy8gUmVkIChsb3cvYmFkKSB0byBHcmVlbiAoaGlnaC9nb29kKSAtIGhpZ2ggYWRhcHRpdmUgY2FwYWNpdHkgaXMgZ29vZFxuICAgIH0gZWxzZSB7XG4gICAgICBjb2xvclJhbmdlID0gW1wiI0Y0QkIyMVwiLCBcIiNFQzVBNDdcIl07IC8vIFllbGxvdyAobG93KSB0byBSZWQgKGhpZ2gpIGZvciBvdGhlciBjb21wb25lbnRzXG4gICAgfVxuXG4gICAgcmV0dXJuIFBsb3QucGxvdCh7XG4gICAgICB3aWR0aDogbWFwV2lkdGgsXG4gICAgICBoZWlnaHQ6IG1hcEhlaWdodCxcbiAgICAgIHByb2plY3Rpb246IHtcbiAgICAgICAgdHlwZTogXCJhemltdXRoYWwtZXF1YWwtYXJlYVwiLFxuICAgICAgICBkb21haW46IHsgdHlwZTogXCJGZWF0dXJlQ29sbGVjdGlvblwiLCBmZWF0dXJlczogY29tcG9uZW50RmVhdHVyZXMgfVxuICAgICAgfSxcbiAgICAgIGNvbG9yOiB7XG4gICAgICAgIHR5cGU6IFwibGluZWFyXCIsXG4gICAgICAgIHJhbmdlOiBjb2xvclJhbmdlLFxuICAgICAgICBkb21haW46IFtkb21haW5NaW4sIGRvbWFpbk1heF0sIC8vIER5bmFtaWMgZG9tYWluIGJhc2VkIG9uIGFjdHVhbCBkYXRhXG4gICAgICAgIGxlZ2VuZDogdHJ1ZSwgLy8gRW5hYmxlIGxlZ2VuZHMgb24gYWxsIG1hcHNcbiAgICAgICAgbGFiZWw6IGNvbXBvbmVudC5rZXkgPT09IFwiYWRhcHRpdmVfY2FwYWNpdHlcIiA/IFxuICAgICAgICAgIF9sYW5nKHtlbjogXCJBZGFwdGl2ZSBDYXBhY2l0eSAoSGlnaGVyID0gQmV0dGVyKVwiLCBmcjogXCJDYXBhY2l0w6kgZCdBZGFwdGF0aW9uXCJ9KSA6IFxuICAgICAgICAgIGNvbXBvbmVudC5rZXkgPT09IFwiZXhwb3N1cmVcIiA/IFxuICAgICAgICAgICAgX2xhbmcoe2VuOiBcIkNsaW1hdGUgRXhwb3N1cmUgKEhpZ2hlciA9IFdvcnNlKVwiLCBmcjogXCJFeHBvc2l0aW9uIENsaW1hdGlxdWVcIn0pIDpcbiAgICAgICAgICBjb21wb25lbnQua2V5ID09PSBcInNlbnNpdGl2aXR5XCIgPyBcbiAgICAgICAgICAgIF9sYW5nKHtlbjogXCJQb3B1bGF0aW9uIFNlbnNpdGl2aXR5IChIaWdoZXIgPSBXb3JzZSlcIiwgZnI6IFwiU2Vuc2liaWxpdMOpIGRlIGxhIFBvcHVsYXRpb25cIn0pIDpcbiAgICAgICAgICAgIF9sYW5nKHtlbjogXCJDb21wb3NpdGUgVnVsbmVyYWJpbGl0eSAoSGlnaGVyID0gV29yc2UpXCIsIGZyOiBcIlZ1bG7DqXJhYmlsaXTDqSBDb21wb3NpdGVcIn0pXG4gICAgICB9LFxuICAgICAgbWFya3M6IFtcbiAgICAgICAgLy8gR2VvZ3JhcGhpYyBib3VuZGFyaWVzIHdpdGggdnVsbmVyYWJpbGl0eSBjb2xvcmluZyAtIG5vIHRvb2x0aXAgaGVyZVxuICAgICAgICBQbG90Lmdlbyhjb21wb25lbnRGZWF0dXJlcywge1xuICAgICAgICAgIGZpbGw6IGQgPT4gZC5wcm9wZXJ0aWVzLnZ1bG5lcmFiaWxpdHksXG4gICAgICAgICAgc3Ryb2tlOiBcIiNmZmZcIixcbiAgICAgICAgICBzdHJva2VXaWR0aDogMC41XG4gICAgICAgIH0pLFxuICAgICAgICBcbiAgICAgICAgLy8gSW50ZXJhY3RpdmUgcG9pbnRlclxuICAgICAgICBQbG90Lmdlbyhjb21wb25lbnRGZWF0dXJlcywgUGxvdC5wb2ludGVyKFxuICAgICAgICAgIFBsb3QuY2VudHJvaWQoe1xuICAgICAgICAgICAgc3Ryb2tlOiBcIiMzMzNcIixcbiAgICAgICAgICAgIHN0cm9rZVdpZHRoOiAxLjUsXG4gICAgICAgICAgfSlcbiAgICAgICAgKSksXG4gICAgICAgIFxuICAgICAgICAvLyBUb29sdGlwIHVzaW5nIHRoZSBleGFjdCB3b3JraW5nIHBhdHRlcm4gZnJvbSBleHBvc3VyZSBzZWN0aW9uXG4gICAgICAgIFBsb3QudGlwKFxuICAgICAgICAgIGNvbXBvbmVudEZlYXR1cmVzLFxuICAgICAgICAgIFBsb3QucG9pbnRlcihcbiAgICAgICAgICAgIFBsb3QuY2VudHJvaWQoe1xuICAgICAgICAgICAgICBjaGFubmVsczoge1xuICAgICAgICAgICAgICAgIGNvdW50cnk6IHtcbiAgICAgICAgICAgICAgICAgIGxhYmVsOiBfbGFuZyh7ZW46IFwiQ291bnRyeVwiLCBmcjogXCJQYXlzXCJ9KSxcbiAgICAgICAgICAgICAgICAgIHZhbHVlOiAoZCkgPT4gZC5wcm9wZXJ0aWVzLmFkbWluMF9uYW1lIHx8IFwiVW5rbm93blwiXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICByZWdpb246IHtcbiAgICAgICAgICAgICAgICAgIGxhYmVsOiBfbGFuZyh7ZW46IFwiUmVnaW9uXCIsIGZyOiBcIlLDqWdpb25cIn0pLFxuICAgICAgICAgICAgICAgICAgdmFsdWU6IChkKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkLnByb3BlcnRpZXMuYWRtaW4yX25hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYCR7ZC5wcm9wZXJ0aWVzLmFkbWluMl9uYW1lfSwgJHtkLnByb3BlcnRpZXMuYWRtaW4xX25hbWV9YDtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChkLnByb3BlcnRpZXMuYWRtaW4xX25hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZC5wcm9wZXJ0aWVzLmFkbWluMV9uYW1lO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkLnByb3BlcnRpZXMuYWRtaW4wX25hbWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGNvbXBvbmVudDoge1xuICAgICAgICAgICAgICAgICAgbGFiZWw6IF9sYW5nKHtlbjogXCJDb21wb25lbnRcIiwgZnI6IFwiQ29tcG9zYW50XCJ9KSxcbiAgICAgICAgICAgICAgICAgIHZhbHVlOiBjb21wb25lbnQubGFiZWxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHNjb3JlOiB7XG4gICAgICAgICAgICAgICAgICBsYWJlbDogX2xhbmcoe2VuOiBcIlNjb3JlXCIsIGZyOiBcIlNjb3JlXCJ9KSxcbiAgICAgICAgICAgICAgICAgIHZhbHVlOiAoZCkgPT4gZC5wcm9wZXJ0aWVzLnZ1bG5lcmFiaWxpdHkgIT09IG51bGwgJiYgZC5wcm9wZXJ0aWVzLnZ1bG5lcmFiaWxpdHkgIT09IHVuZGVmaW5lZCA/IGQucHJvcGVydGllcy52dWxuZXJhYmlsaXR5LnRvRml4ZWQoMykgOiBcIk5vIGRhdGFcIlxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgLi4uKGNvbXBvbmVudC5rZXkgPT09IFwiY29tcG9zaXRlXCIgPyB7XG4gICAgICAgICAgICAgICAgICBleHBvc3VyZToge1xuICAgICAgICAgICAgICAgICAgICBsYWJlbDogX2xhbmcoe2VuOiBcIkV4cG9zdXJlXCIsIGZyOiBcIkV4cG9zaXRpb25cIn0pLFxuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogKGQpID0+IGQucHJvcGVydGllcy5leHBvc3VyZVNjb3JlICE9PSBudWxsICYmIGQucHJvcGVydGllcy5leHBvc3VyZVNjb3JlICE9PSB1bmRlZmluZWQgPyBkLnByb3BlcnRpZXMuZXhwb3N1cmVTY29yZS50b0ZpeGVkKDMpIDogXCJObyBkYXRhXCJcbiAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICBzZW5zaXRpdml0eToge1xuICAgICAgICAgICAgICAgICAgICBsYWJlbDogX2xhbmcoe2VuOiBcIlNlbnNpdGl2aXR5XCIsIGZyOiBcIlNlbnNpYmlsaXTDqVwifSksXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOiAoZCkgPT4gZC5wcm9wZXJ0aWVzLnNlbnNpdGl2aXR5U2NvcmUgIT09IG51bGwgJiYgZC5wcm9wZXJ0aWVzLnNlbnNpdGl2aXR5U2NvcmUgIT09IHVuZGVmaW5lZCA/IGQucHJvcGVydGllcy5zZW5zaXRpdml0eVNjb3JlLnRvRml4ZWQoMykgOiBcIk5vIGRhdGFcIlxuICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgIGFkYXB0aXZlQ2FwYWNpdHk6IHtcbiAgICAgICAgICAgICAgICAgICAgbGFiZWw6IF9sYW5nKHtlbjogXCJBZGFwdGl2ZSBDYXBhY2l0eVwiLCBmcjogXCJDYXBhY2l0w6kgZCdBZGFwdGF0aW9uXCJ9KSxcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IChkKSA9PiBkLnByb3BlcnRpZXMuYWRhcHRpdmVDYXBhY2l0eVNjb3JlICE9PSBudWxsICYmIGQucHJvcGVydGllcy5hZGFwdGl2ZUNhcGFjaXR5U2NvcmUgIT09IHVuZGVmaW5lZCA/IGQucHJvcGVydGllcy5hZGFwdGl2ZUNhcGFjaXR5U2NvcmUudG9GaXhlZCgzKSA6IFwiTm8gZGF0YVwiXG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSA6IHt9KVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICAgIClcbiAgICAgICAgKVxuICAgICAgXVxuICAgIH0pO1xuICB9KTtcblxuICAvLyBJbmRpdmlkdWFsIGxlZ2VuZHMgYXJlIG5vdyBpbnRlZ3JhdGVkIHdpdGggZWFjaCBtYXBcblxuICAvLyBTZXBhcmF0ZSBjb21wb3NpdGUgYW5kIGNvbXBvbmVudCBtYXBzXG4gIGNvbnN0IGNvbXBvc2l0ZU1hcCA9IHNob3dBbGxDb21wb25lbnRzID8gbWFwc1swXSA6IG51bGw7XG4gIGNvbnN0IGNvbXBvbmVudE1hcHMgPSBzaG93QWxsQ29tcG9uZW50cyA/IG1hcHMuc2xpY2UoMSkgOiBtYXBzO1xuXG4gIC8vIFJldHVybiBtYXBzIGluIGEgY3VzdG9tIGxheW91dCB3aXRoIGxhYmVscyBhbmQgZXh0ZXJuYWwgbGVnZW5kXG4gIHJldHVybiBodGwuaHRtbGBcbiAgICA8ZGl2IHN0eWxlPVwiXG4gICAgICBkaXNwbGF5OiBmbGV4O1xuICAgICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjtcbiAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7XG4gICAgICBnYXA6IDIwcHg7XG4gICAgICB3aWR0aDogMTAwJTtcbiAgICAgIG1heC13aWR0aDogMTAwJTtcbiAgICAgIHBhZGRpbmc6IDE2cHg7XG4gICAgICBiYWNrZ3JvdW5kOiB3aGl0ZTtcbiAgICAgIGJvcmRlci1yYWRpdXM6IDhweDtcbiAgICBcIj5cbiAgICAgIDwhLS0gSW5kaXZpZHVhbCBsZWdlbmRzIGFyZSBub3cgaW50ZWdyYXRlZCB3aXRoIGVhY2ggbWFwIC0tPlxuICAgICAgXG4gICAgICAke3Nob3dBbGxDb21wb25lbnRzID8gaHRsLmh0bWxgXG4gICAgICAgIDwhLS0gQ29tcG9zaXRlIG1hcCAtIGZ1bGwgd2lkdGggd2l0aCBsZWdlbmQgLS0+XG4gICAgICAgIDxkaXYgc3R5bGU9XCJcbiAgICAgICAgICBkaXNwbGF5OiBmbGV4O1xuICAgICAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47XG4gICAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjtcbiAgICAgICAgICB3aWR0aDogMTAwJTtcbiAgICAgICAgICBtYXJnaW4tYm90dG9tOiAyMHB4O1xuICAgICAgICBcIj5cbiAgICAgICAgICA8ZGl2PiR7Y29tcG9zaXRlTWFwfTwvZGl2PlxuICAgICAgICA8L2Rpdj5cbiAgICAgICAgXG4gICAgICAgIDwhLS0gQ29tcG9uZW50IG1hcHMgLSAzIGluIGEgcm93IHdpdGggbGVnZW5kcyAtLT5cbiAgICAgICAgPGRpdiBzdHlsZT1cIlxuICAgICAgICAgIGRpc3BsYXk6IGdyaWQ7XG4gICAgICAgICAgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiAxZnIgMWZyIDFmcjtcbiAgICAgICAgICBnYXA6IDE2cHg7XG4gICAgICAgICAgd2lkdGg6IDEwMCU7XG4gICAgICAgICAgb3ZlcmZsb3c6IHZpc2libGU7XG4gICAgICAgIFwiPlxuICAgICAgICAgICR7Y29tcG9uZW50TWFwcy5tYXAoKG1hcCwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG1hcFN2ZyA9IG1hcC5xdWVyeVNlbGVjdG9yKCdzdmc6bnRoLW9mLXR5cGUoMiknKTsgLy8gTWFwIGlzIHRoZSBzZWNvbmQgc3ZnIG9mIHRoZSBmaWd1cmUuIE1pZ2h0IGNoYW5nZVxuICAgICAgICAgICAgaWYgKG1hcFN2ZykgbWFwU3ZnLnNldEF0dHJpYnV0ZShcIm92ZXJmbG93XCIsIFwidmlzaWJsZVwiKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIGh0bC5odG1sYFxuICAgICAgICAgICAgICA8ZGl2IHN0eWxlPVwiZGlzcGxheTogZmxleDsgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsgYWxpZ24taXRlbXM6IGNlbnRlcjtcIj5cbiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPVwib3ZlcmZsb3c6IHZpc2libGU7XCI+JHttYXB9PC9kaXY+XG4gICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgYDtcbiAgICAgICAgICB9KX1cbiAgICAgICAgPC9kaXY+XG4gICAgICBgIDogaHRsLmh0bWxgXG4gICAgICAgIDwhLS0gU2luZ2xlIGNvbXBvbmVudCBtYXAgd2l0aCBsZWdlbmQgLS0+XG4gICAgICAgIDxkaXYgc3R5bGU9XCJcbiAgICAgICAgICBkaXNwbGF5OiBmbGV4O1xuICAgICAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47XG4gICAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjtcbiAgICAgICAgICB3aWR0aDogMTAwJTtcbiAgICAgICAgXCI+XG4gICAgICAgICAgPGRpdj4ke2NvbXBvbmVudE1hcHNbMF19PC9kaXY+XG4gICAgICAgIDwvZGl2PlxuICAgICAgYH1cbiAgICA8L2Rpdj5cbiAgYDtcbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNzIiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiIvLyBEeW5hbWljIEluc2lnaHRzIGZvbGxvd2luZyB3aXJlZnJhbWUgdGVtcGxhdGVcbmNvbXBvc2l0ZVZ1bG5lcmFiaWxpdHlJbnNpZ2h0cyA9IHtcbiAgaWYgKCFjb21wb25lbnRJbmRpY2VzUGVyUmVnaW9uIHx8ICFjb21wb25lbnRJbmRpY2VzUGVyUmVnaW9uLnNjb3Jlcykge1xuICAgIHJldHVybiBjcmVhdGVOb0RhdGFTdGF0ZSgpO1xuICB9XG5cbiAgY29uc3Qgc2VsZWN0aW9ucyA9IGNvbXBvc2l0ZUFkbWluU2VsZWN0aW9ucztcbiAgY29uc3QgeyBzY29yZXMsIGFkbWluTGV2ZWwgfSA9IGNvbXBvbmVudEluZGljZXNQZXJSZWdpb247XG4gIFxuICAvLyBHZXQgcmVnaW9uIG5hbWUgZm9yIGluc2lnaHRcbiAgbGV0IHJlZ2lvbk5hbWU7XG4gIGlmICghc2VsZWN0aW9ucy5zZWxlY3RBZG1pbjAgfHwgc2VsZWN0aW9ucy5zZWxlY3RBZG1pbjAgPT09IFwiU1NBXCIpIHtcbiAgICByZWdpb25OYW1lID0gXCJTdWItU2FoYXJhbiBBZnJpY2FcIjtcbiAgfSBlbHNlIGlmICghc2VsZWN0aW9ucy5zZWxlY3RBZG1pbjEpIHtcbiAgICByZWdpb25OYW1lID0gc2VsZWN0aW9ucy5zZWxlY3RBZG1pbjA7XG4gIH0gZWxzZSBpZiAoIXNlbGVjdGlvbnMuc2VsZWN0QWRtaW4yKSB7XG4gICAgcmVnaW9uTmFtZSA9IHNlbGVjdGlvbnMuc2VsZWN0QWRtaW4xO1xuICB9IGVsc2Uge1xuICAgIHJlZ2lvbk5hbWUgPSBzZWxlY3Rpb25zLnNlbGVjdEFkbWluMjtcbiAgfVxuICBcbiAgLy8gQ2FsY3VsYXRlIGF2ZXJhZ2Ugc2NvcmVzIGFjcm9zcyBhbGwgcmVnaW9ucyBmb3IgdGhpcyBsZXZlbFxuICBjb25zdCByZWdpb25zID0gT2JqZWN0LmtleXMoc2NvcmVzKTtcbiAgY29uc3QgYXZnU2NvcmVzID0ge1xuICAgIGNvbXBvc2l0ZTogZDMubWVhbihyZWdpb25zLCByID0+IHNjb3Jlc1tyXS5jb21wb3NpdGUpIHx8IDAsXG4gICAgZXhwb3N1cmU6IGQzLm1lYW4ocmVnaW9ucywgciA9PiBzY29yZXNbcl0uZXhwb3N1cmUpIHx8IDAsXG4gICAgc2Vuc2l0aXZpdHk6IGQzLm1lYW4ocmVnaW9ucywgciA9PiBzY29yZXNbcl0uc2Vuc2l0aXZpdHkpIHx8IDAsXG4gICAgYWRhcHRpdmVfY2FwYWNpdHk6IGQzLm1lYW4ocmVnaW9ucywgciA9PiBzY29yZXNbcl0uYWRhcHRpdmVfY2FwYWNpdHkpIHx8IDBcbiAgfTtcbiAgXG4gIC8vIERldGVybWluZSB2dWxuZXJhYmlsaXR5IGxldmVsXG4gIGNvbnN0IHZ1bG5MZXZlbCA9IGF2Z1Njb3Jlcy5jb21wb3NpdGUgPiAwLjcgPyBcbiAgICBfbGFuZyh7ZW46IFwiaGlnaFwiLCBmcjogXCLDqWxldsOpXCJ9KSA6IFxuICAgIGF2Z1Njb3Jlcy5jb21wb3NpdGUgPiAwLjQgPyBcbiAgICBfbGFuZyh7ZW46IFwibW9kZXJhdGVcIiwgZnI6IFwibW9kw6lyw6lcIn0pIDogXG4gICAgX2xhbmcoe2VuOiBcImxvd1wiLCBmcjogXCJmYWlibGVcIn0pO1xuICBcbiAgLy8gSWRlbnRpZnkgbWFpbiBkcml2ZXJzXG4gIGNvbnN0IGRyaXZlcnMgPSBbXTtcbiAgaWYgKGF2Z1Njb3Jlcy5leHBvc3VyZSA+IDAuNikgZHJpdmVycy5wdXNoKF9sYW5nKHtlbjogXCJoaWdoIGV4cG9zdXJlXCIsIGZyOiBcImV4cG9zaXRpb24gw6lsZXbDqWVcIn0pKTtcbiAgaWYgKGF2Z1Njb3Jlcy5zZW5zaXRpdml0eSA+IDAuNikgZHJpdmVycy5wdXNoKF9sYW5nKHtlbjogXCJoaWdoIHNlbnNpdGl2aXR5XCIsIGZyOiBcInNlbnNpYmlsaXTDqSDDqWxldsOpZVwifSkpOyAgXG4gIGlmIChhdmdTY29yZXMuYWRhcHRpdmVfY2FwYWNpdHkgPCAwLjQpIGRyaXZlcnMucHVzaChfbGFuZyh7ZW46IFwibGltaXRlZCBhZGFwdGl2ZSBjYXBhY2l0eVwiLCBmcjogXCJjYXBhY2l0w6kgZCdhZGFwdGF0aW9uIGxpbWl0w6llXCJ9KSk7IC8vIExPVyBhZGFwdGl2ZSBjYXBhY2l0eSBpcyBiYWRcbiAgXG4gIC8vIFJlY29tbWVuZGF0aW9ucyBiYXNlZCBvbiBoaWdoZXN0IHNjb3JpbmcgY29tcG9uZW50c1xuICBjb25zdCByZWNvbW1lbmRhdGlvbnMgPSBbXTtcbiAgaWYgKGF2Z1Njb3Jlcy5leHBvc3VyZSA9PT0gTWF0aC5tYXgoYXZnU2NvcmVzLmV4cG9zdXJlLCBhdmdTY29yZXMuc2Vuc2l0aXZpdHksIGF2Z1Njb3Jlcy5hZGFwdGl2ZV9jYXBhY2l0eSkpIHtcbiAgICByZWNvbW1lbmRhdGlvbnMucHVzaChcbiAgICAgIF9sYW5nKHtlbjogXCJjbGltYXRlIGhhemFyZCBwcmVwYXJlZG5lc3NcIiwgZnI6IFwicHLDqXBhcmF0aW9uIGF1eCBkYW5nZXJzIGNsaW1hdGlxdWVzXCJ9KSxcbiAgICAgIF9sYW5nKHtlbjogXCJyZXNpbGllbnQgaW5mcmFzdHJ1Y3R1cmVcIiwgZnI6IFwiaW5mcmFzdHJ1Y3R1cmUgcsOpc2lsaWVudGVcIn0pXG4gICAgKTtcbiAgfVxuICBpZiAoYXZnU2NvcmVzLnNlbnNpdGl2aXR5ID4gMC41KSB7XG4gICAgcmVjb21tZW5kYXRpb25zLnB1c2goXG4gICAgICBfbGFuZyh7ZW46IFwiZWR1Y2F0aW9uIGFjY2Vzc1wiLCBmcjogXCJhY2PDqHMgw6AgbCfDqWR1Y2F0aW9uXCJ9KSxcbiAgICAgIF9sYW5nKHtlbjogXCJwb3ZlcnR5IHJlZHVjdGlvbiBwcm9ncmFtc1wiLCBmcjogXCJwcm9ncmFtbWVzIGRlIHLDqWR1Y3Rpb24gZGUgbGEgcGF1dnJldMOpXCJ9KVxuICAgICk7XG4gIH1cbiAgaWYgKGF2Z1Njb3Jlcy5hZGFwdGl2ZV9jYXBhY2l0eSA8IDAuNSkgeyAvLyBMT1cgYWRhcHRpdmUgY2FwYWNpdHkgbmVlZHMgaW1wcm92ZW1lbnRcbiAgICByZWNvbW1lbmRhdGlvbnMucHVzaChcbiAgICAgIF9sYW5nKHtlbjogXCJjb25uZWN0aXZpdHkgaW1wcm92ZW1lbnRzXCIsIGZyOiBcImFtw6lsaW9yYXRpb25zIGRlIGxhIGNvbm5lY3Rpdml0w6lcIn0pLFxuICAgICAgX2xhbmcoe2VuOiBcImluc3RpdHV0aW9uYWwgc3RyZW5ndGhlbmluZ1wiLCBmcjogXCJyZW5mb3JjZW1lbnQgaW5zdGl0dXRpb25uZWxcIn0pXG4gICAgKTtcbiAgfVxuXG4gIGNvbnN0IGRyaXZlcnNUZXh0ID0gZHJpdmVycy5sZW5ndGggPiAwID8gXG4gICAgZHJpdmVycy5qb2luKF9sYW5nKHtlbjogXCIgY29tYmluZWQgd2l0aCBcIiwgZnI6IFwiIGNvbWJpbsOpIGF2ZWMgXCJ9KSkgOiBcbiAgICBfbGFuZyh7ZW46IFwibXVsdGlwbGUgZmFjdG9yc1wiLCBmcjogXCJmYWN0ZXVycyBtdWx0aXBsZXNcIn0pO1xuICAgIFxuICBjb25zdCByZWNvbW1lbmRhdGlvbnNUZXh0ID0gcmVjb21tZW5kYXRpb25zLnNsaWNlKDAsIDIpLmpvaW4oX2xhbmcoe2VuOiBcIiBhbmQgXCIsIGZyOiBcIiBldCBcIn0pKSB8fCBcbiAgICBfbGFuZyh7ZW46IFwiY29tcHJlaGVuc2l2ZSBpbnRlcnZlbnRpb25zXCIsIGZyOiBcImludGVydmVudGlvbnMgY29tcGzDqHRlc1wifSk7XG5cbiAgLy8gQ3JlYXRlIGNvbXBvbmVudCBzY29yZXMgYXMgbGlzdCBpdGVtc1xuICBjb25zdCBjb21wb25lbnRTY29yZXMgPSBbXG4gICAgaHRsLmh0bWxgPGxpPjxzdHJvbmc+JHtfbGFuZyh7ZW46IFwiRXhwb3N1cmVcIiwgZnI6IFwiRXhwb3NpdGlvblwifSl9PC9zdHJvbmc+OiAkeyhhdmdTY29yZXMuZXhwb3N1cmUgfHwgMCkudG9GaXhlZCgyKX08L2xpPmAsXG4gICAgaHRsLmh0bWxgPGxpPjxzdHJvbmc+JHtfbGFuZyh7ZW46IFwiU2Vuc2l0aXZpdHlcIiwgZnI6IFwiU2Vuc2liaWxpdMOpXCJ9KX08L3N0cm9uZz46ICR7KGF2Z1Njb3Jlcy5zZW5zaXRpdml0eSB8fCAwKS50b0ZpeGVkKDIpfTwvbGk+YCxcbiAgICBodGwuaHRtbGA8bGk+PHN0cm9uZz4ke19sYW5nKHtlbjogXCJBZGFwdGl2ZSBDYXBhY2l0eVwiLCBmcjogXCJDYXBhY2l0w6kgZCdhZGFwdGF0aW9uXCJ9KX08L3N0cm9uZz46ICR7KGF2Z1Njb3Jlcy5hZGFwdGl2ZV9jYXBhY2l0eSB8fCAwKS50b0ZpeGVkKDIpfTwvbGk+YFxuICBdO1xuXG4gIGNvbnN0IGluc2lnaHQgPSBodGwuaHRtbGA8ZGl2PlxuICAgIDxwPiR7X2xhbmcoe1xuICAgICAgZW46IGAke3JlZ2lvbk5hbWV9IGhhcyBhICR7dnVsbkxldmVsfSB2dWxuZXJhYmlsaXR5IHNjb3JlIG9mICR7KGF2Z1Njb3Jlcy5jb21wb3NpdGUgfHwgMCkudG9GaXhlZCgyKX0uYCxcbiAgICAgIGZyOiBgJHtyZWdpb25OYW1lfSBhIHVuIHNjb3JlIGRlIHZ1bG7DqXJhYmlsaXTDqSAke3Z1bG5MZXZlbH0gZGUgJHsoYXZnU2NvcmVzLmNvbXBvc2l0ZSB8fCAwKS50b0ZpeGVkKDIpfS5gXG4gICAgfSl9PC9wPlxuICAgIFxuICAgIDx1bD4ke2NvbXBvbmVudFNjb3Jlc308L3VsPlxuICAgIFxuICAgIDxwPiR7X2xhbmcoe1xuICAgICAgZW46IGAke2RyaXZlcnNUZXh0fSBkcml2aW5nIHZ1bG5lcmFiaWxpdHkuIFN0cmVuZ3RoZW5pbmcgJHtyZWNvbW1lbmRhdGlvbnNUZXh0fSBjb3VsZCByZWR1Y2UgZnV0dXJlIHJpc2tzLmAsXG4gICAgICBmcjogYCR7ZHJpdmVyc1RleHR9IGfDqW7DqHJlbnQgbGEgdnVsbsOpcmFiaWxpdMOpLiBSZW5mb3JjZXIgJHtyZWNvbW1lbmRhdGlvbnNUZXh0fSBwb3VycmFpdCByw6lkdWlyZSBsZXMgcmlzcXVlcyBmdXR1cnMuYFxuICAgIH0pfTwvcD5cbiAgPC9kaXY+YDtcbiAgXG4gIHJldHVybiBjcmVhdGVJbnNpZ2h0RGlzcGxheShpbnNpZ2h0KTtcbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNzMiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiIvLyBDcmVhdGUgZG93bmxvYWQgZGF0YXNldCB3aXRoIGFsbCBjb21wb3NpdGUgaW5kZXggYW5kIHN1Yi1pbmRpY2VzXG5jb21wb3NpdGVEb3dubG9hZERhdGEgPSB7XG4gIGlmICghY29tcG9uZW50SW5kaWNlc1BlclJlZ2lvbiB8fCAhY29tcG9uZW50SW5kaWNlc1BlclJlZ2lvbi5zY29yZXMpIHJldHVybiBbXTtcbiAgXG4gIGNvbnN0IHsgc2NvcmVzLCBhZG1pbkxldmVsIH0gPSBjb21wb25lbnRJbmRpY2VzUGVyUmVnaW9uO1xuICBjb25zdCByZWdpb25zID0gT2JqZWN0LmtleXMoc2NvcmVzKTtcbiAgXG4gIHJldHVybiByZWdpb25zLm1hcChyZWdpb24gPT4ge1xuICAgIGNvbnN0IHJlZ2lvblNjb3JlcyA9IHNjb3Jlc1tyZWdpb25dO1xuICAgIHJldHVybiB7XG4gICAgICBbX2xhbmcoe2VuOiBcIlJlZ2lvblwiLCBmcjogXCJSw6lnaW9uXCJ9KV06IHJlZ2lvbixcbiAgICAgIFtfbGFuZyh7ZW46IFwiQ29tcG9zaXRlIFZ1bG5lcmFiaWxpdHkgU2NvcmVcIiwgZnI6IFwiU2NvcmUgZGUgVnVsbsOpcmFiaWxpdMOpIENvbXBvc2l0ZVwifSldOiByZWdpb25TY29yZXMuY29tcG9zaXRlID8gcmVnaW9uU2NvcmVzLmNvbXBvc2l0ZS50b0ZpeGVkKDMpIDogXCJOL0FcIixcbiAgICAgIFtfbGFuZyh7ZW46IFwiRXhwb3N1cmUgU2NvcmVcIiwgZnI6IFwiU2NvcmUgZCdFeHBvc2l0aW9uXCJ9KV06IHJlZ2lvblNjb3Jlcy5leHBvc3VyZSA/IHJlZ2lvblNjb3Jlcy5leHBvc3VyZS50b0ZpeGVkKDMpIDogXCJOL0FcIixcbiAgICAgIFtfbGFuZyh7ZW46IFwiU2Vuc2l0aXZpdHkgU2NvcmVcIiwgZnI6IFwiU2NvcmUgZGUgU2Vuc2liaWxpdMOpXCJ9KV06IHJlZ2lvblNjb3Jlcy5zZW5zaXRpdml0eSA/IHJlZ2lvblNjb3Jlcy5zZW5zaXRpdml0eS50b0ZpeGVkKDMpIDogXCJOL0FcIixcbiAgICAgIFtfbGFuZyh7ZW46IFwiQWRhcHRpdmUgQ2FwYWNpdHkgU2NvcmVcIiwgZnI6IFwiU2NvcmUgZGUgQ2FwYWNpdMOpIGQnQWRhcHRhdGlvblwifSldOiByZWdpb25TY29yZXMuYWRhcHRpdmVfY2FwYWNpdHkgPyByZWdpb25TY29yZXMuYWRhcHRpdmVfY2FwYWNpdHkudG9GaXhlZCgzKSA6IFwiTi9BXCIsXG4gICAgICBbX2xhbmcoe2VuOiBcIkVuYWJsaW5nIEluZGV4XCIsIGZyOiBcIkluZGljZSBkJ0VuYWJsaW5nXCJ9KV06IHJlZ2lvblNjb3Jlcy5lbmFibGluZ19pbmRleCA/IHJlZ2lvblNjb3Jlcy5lbmFibGluZ19pbmRleC50b0ZpeGVkKDMpIDogXCJOL0FcIixcbiAgICAgIFtfbGFuZyh7ZW46IFwiVXJnZW5jeSBJbmRleFwiLCBmcjogXCJJbmRpY2UgZCdVcmdlbmNlXCJ9KV06IHJlZ2lvblNjb3Jlcy51cmdlbmN5X2luZGV4ID8gcmVnaW9uU2NvcmVzLnVyZ2VuY3lfaW5kZXgudG9GaXhlZCgzKSA6IFwiTi9BXCIsXG4gICAgICBbX2xhbmcoe2VuOiBcIlJhdyBWdWxuZXJhYmlsaXR5IFNjb3JlXCIsIGZyOiBcIlNjb3JlIGRlIFZ1bG7DqXJhYmlsaXTDqSBCcnV0XCJ9KV06IHJlZ2lvblNjb3Jlcy52dWxuZXJhYmlsaXR5X3Njb3JlIHx8IFwiTi9BXCJcbiAgICB9O1xuICB9KTtcbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNzQiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiIvLyBEb3dubG9hZCBidXR0b24gZm9yIGNvbXBvc2l0ZSBpbmRleCBkYXRhXG52aWV3b2YgY29tcG9zaXRlRG93bmxvYWRCdXR0b24gPSB7XG4gIGlmICghY29tcG9zaXRlRG93bmxvYWREYXRhIHx8IGNvbXBvc2l0ZURvd25sb2FkRGF0YS5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gaHRsLmh0bWxgPHA+JHtfbGFuZyh7ZW46IFwiTm8gZGF0YSBhdmFpbGFibGUgZm9yIGRvd25sb2FkXCIsIGZyOiBcIkF1Y3VuZSBkb25uw6llIGRpc3BvbmlibGUgcG91ciBsZSB0w6lsw6ljaGFyZ2VtZW50XCJ9KX08L3A+YDtcbiAgfVxuICBcbiAgY29uc3QgcmVnaW9uID0gY29tcG9zaXRlU2VsZWN0ZWRDb21wb25lbnQudmFsdWUgPT09IFwiY29tcG9zaXRlXCIgPyBcbiAgICBfbGFuZyh7ZW46IFwiQWxsX1JlZ2lvbnNcIiwgZnI6IFwiVG91dGVzX0xlc19Sw6lnaW9uc1wifSkgOiBcbiAgICBjb21wb3NpdGVTZWxlY3RlZENvbXBvbmVudC5sYWJlbC5yZXBsYWNlKC9cXHMrL2csICdfJyk7XG4gIFxuICByZXR1cm4gZG93bmxvYWRCdXR0b24oXG4gICAgY29tcG9zaXRlRG93bmxvYWREYXRhLCBcbiAgICBgY29tcG9zaXRlX3Z1bG5lcmFiaWxpdHlfZGF0YV8ke3JlZ2lvbn1gLFxuICAgIF9sYW5nKHtlbjogXCJEb3dubG9hZCBDb21wb3NpdGUgSW5kZXggRGF0YVwiLCBmcjogXCJUw6lsw6ljaGFyZ2VyIGxlcyBEb25uw6llcyBkZSBsJ0luZGljZSBDb21wb3NpdGVcIn0pXG4gICk7XG59XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTc1IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiXG4vLyBBZGQgYSBzbWFsbCBkZWxheSB0byBlbnN1cmUgRE9NIGlzIGZ1bGx5IGxvYWRlZFxudG9jX2JvdHRvbSA9IHtcbiAgLy8gV2FpdCBmb3IgRE9NIHRvIGJlIHJlYWR5XG4gIG1hc3Rlckxhbmd1YWdlIC8vSEFDSzogUmVmcmVzaCB3aGVuIGxhbmcgY2hhbmdlcy4uLiBub3Qgc3VyZSB3aHkgbm90IGFscmVhZHkgaGFwcGVuaW5nLi4uXG4gIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAxMDApKTtcbiAgcmV0dXJuIGF0bGFzVE9DKHtcbiAgICBza2lwOiBbJ25vdGVib29rLXRpdGxlJywgJ2FwcGVuZGl4JywgJ3NvdXJjZS1jb2RlJ10sIC8vIGhlYWRpbmcgaWRzIHRvIHNraXBcbiAgICBoZWFkaW5nOiBgPGI+SW4gVGhpcyBOb3RlYm9vazwvYj5gLFxuICAgIHNlbGVjdG9yOiBcImgxLGgyXCIsIC8vIFNlbGVjdG9ycyB0byBpbmNsdWRlIChlLmcuLCBcImgxLGgyLGgzXCIpXG4gIH0pO1xufVxuXG5odGwuaHRtbGBcbiAgICAgIDxkaXYgY2xhc3M9J2Zsb2F0aW5nLXRvYyc+XG4gICAgICAke3RvY19ib3R0b219XG4gICAgICA8L2Rpdj5cbiAgICAgIGBcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNzYiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiIvLyBBYm91dCB0aGlzIG5vdGVib29rXG5hYm91dFNlY3Rpb24gPSBodGwuaHRtbGBcbiAgPGRpdiBzdHlsZT1cIlxuICAgIGJhY2tncm91bmQ6ICNmOGZhZmM7XG4gICAgYm9yZGVyOiAxcHggc29saWQgI2UyZThmMDtcbiAgICBib3JkZXItcmFkaXVzOiA4cHg7XG4gICAgcGFkZGluZzogMjRweDtcbiAgICBtYXJnaW46IDI0cHggMDtcbiAgXCI+XG4gICAgPGgzIHN0eWxlPVwibWFyZ2luOiAwIDAgMTZweCAwOyBjb2xvcjogIzJkMzc0ODtcIj5cbiAgICAgICR7X2xhbmcoeyBlbjogXCJBYm91dCBUaGlzIE5vdGVib29rXCIsIGZyOiBcIsOAIHByb3BvcyBkZSBjZSBjYXJuZXRcIiB9KX1cbiAgICA8L2gzPlxuICAgIDxwIHN0eWxlPVwibWFyZ2luOiAwIDAgMTJweCAwOyBsaW5lLWhlaWdodDogMS42O1wiPlxuICAgICAgJHtfbGFuZyh7XG4gICAgICAgIGVuOiBcIlRoaXMgdnVsbmVyYWJpbGl0eSBhc3Nlc3NtZW50IG5vdGVib29rIGhlbHBzIHlvdSB1bmRlcnN0YW5kIGNsaW1hdGUgdnVsbmVyYWJpbGl0eSB0aHJvdWdoIHRocmVlIGtleSBkaW1lbnNpb25zOiBleHBvc3VyZSB0byBjbGltYXRlIGhhemFyZHMsIHNlbnNpdGl2aXR5IG9mIHBvcHVsYXRpb25zLCBhbmQgYWRhcHRpdmUgY2FwYWNpdHkgb2YgY29tbXVuaXRpZXMuXCIsXG4gICAgICAgIGZyOiBcIkNlIGNhcm5ldCBkJ8OpdmFsdWF0aW9uIGRlIGxhIHZ1bG7DqXJhYmlsaXTDqSB2b3VzIGFpZGUgw6AgY29tcHJlbmRyZSBsYSB2dWxuw6lyYWJpbGl0w6kgY2xpbWF0aXF1ZSDDoCB0cmF2ZXJzIHRyb2lzIGRpbWVuc2lvbnMgY2zDqXMgOiBsJ2V4cG9zaXRpb24gYXV4IGRhbmdlcnMgY2xpbWF0aXF1ZXMsIGxhIHNlbnNpYmlsaXTDqSBkZXMgcG9wdWxhdGlvbnMgZXQgbGEgY2FwYWNpdMOpIGQnYWRhcHRhdGlvbiBkZXMgY29tbXVuYXV0w6lzLlwiLFxuICAgICAgfSl9XG4gICAgPC9wPlxuICAgIDxwIHN0eWxlPVwibWFyZ2luOiAwIDAgMTJweCAwOyBsaW5lLWhlaWdodDogMS42O1wiPlxuICAgICAgJHtfbGFuZyh7XG4gICAgICAgIGVuOiBcIlRoZSBub3RlYm9vayB1c2VzIGludGVyYWN0aXZlIHZpc3VhbGl6YXRpb25zIHRvIGV4cGxvcmUgdnVsbmVyYWJpbGl0eSBwYXR0ZXJucyBhY3Jvc3MgU3ViLVNhaGFyYW4gQWZyaWNhLCB3aXRoIGRhdGEgdGhhdCBjYW4gYmUgZmlsdGVyZWQgYnkgYWRtaW5pc3RyYXRpdmUgcmVnaW9ucyBhbmQgZGVtb2dyYXBoaWMgY2hhcmFjdGVyaXN0aWNzLlwiLFxuICAgICAgICBmcjogXCJMZSBjYXJuZXQgdXRpbGlzZSBkZXMgdmlzdWFsaXNhdGlvbnMgaW50ZXJhY3RpdmVzIHBvdXIgZXhwbG9yZXIgbGVzIHNjaMOpbWFzIGRlIHZ1bG7DqXJhYmlsaXTDqSDDoCB0cmF2ZXJzIGwnQWZyaXF1ZSBzdWJzYWhhcmllbm5lLCBhdmVjIGRlcyBkb25uw6llcyBxdWkgcGV1dmVudCDDqnRyZSBmaWx0csOpZXMgcGFyIHLDqWdpb25zIGFkbWluaXN0cmF0aXZlcyBldCBjYXJhY3TDqXJpc3RpcXVlcyBkw6ltb2dyYXBoaXF1ZXMuXCIsXG4gICAgICB9KX1cbiAgICA8L3A+XG4gICAgPHAgc3R5bGU9XCJtYXJnaW46IDA7IGxpbmUtaGVpZ2h0OiAxLjY7IGZvbnQtc2l6ZTogMTRweDsgY29sb3I6ICM2YjcyODA7XCI+XG4gICAgICAke19sYW5nKHtcbiAgICAgICAgZW46IFwiRm9yIHF1ZXN0aW9ucyBvciBmZWVkYmFjayBhYm91dCB0aGlzIG5vdGVib29rLCBwbGVhc2UgY29udGFjdCB0aGUgQWRhcHRhdGlvbiBBdGxhcyB0ZWFtLlwiLFxuICAgICAgICBmcjogXCJQb3VyIGRlcyBxdWVzdGlvbnMgb3UgY29tbWVudGFpcmVzIHN1ciBjZSBjYXJuZXQsIHZldWlsbGV6IGNvbnRhY3RlciBsJ8OpcXVpcGUgZGUgbCdBdGxhcyBkJ2FkYXB0YXRpb24uXCIsXG4gICAgICB9KX1cbiAgICA8L3A+XG4gIDwvZGl2PlxuYDtcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNzciLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiIvLyBOYXZiYXIgbGFuZ3VhZ2Ugc2VsZWN0b3IgaW50ZWdyYXRpb25cbmZ1bmN0aW9uIE5hdmJhckxhbmdTZWxlY3RvcihsYW5ndWFnZV9vYmosIG1hc3Rlckxhbmd1YWdlKSB7XG4gIGxldCBuYXZFbmQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLm5hdmJhci1uYXYubXMtYXV0byAubmF2LWl0ZW0uY29tcGFjdFwiKTtcbiAgaWYgKG5hdkVuZCkge1xuICAgIGxldCBleGlzdGluZ0xhbmdTZWxlY3RvciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwibmF2LWxhbmctc2VsZWN0b3JcIik7XG4gICAgaWYgKCFleGlzdGluZ0xhbmdTZWxlY3Rvcikge1xuICAgICAgbGV0IGxhbmdfc2VsID0gSW5wdXRzLmJpbmQoXG4gICAgICAgIElucHV0cy5yYWRpbyhsYW5ndWFnZV9vYmosIHtcbiAgICAgICAgICBsYWJlbDogXCJcIixcbiAgICAgICAgICBmb3JtYXQ6IChkKSA9PiBkLmxhYmVsXG4gICAgICAgIH0pLFxuICAgICAgICB2aWV3b2YgbWFzdGVyTGFuZ3VhZ2VcbiAgICAgICk7XG4gICAgICBsYW5nX3NlbC5pZCA9IFwibmF2LWxhbmctc2VsZWN0b3JcIjtcbiAgICAgIFxuICAgICAgLy8gU3R5bGUgdGhlIGxhbmd1YWdlIHNlbGVjdG9yIGZvciBuYXZiYXIgaW50ZWdyYXRpb25cbiAgICAgIGxhbmdfc2VsLnN0eWxlLmRpc3BsYXkgPSBcImZsZXhcIjtcbiAgICAgIGxhbmdfc2VsLnN0eWxlLmFsaWduSXRlbXMgPSBcImNlbnRlclwiO1xuICAgICAgbGFuZ19zZWwuc3R5bGUubWFyZ2luTGVmdCA9IFwiMTBweFwiO1xuICAgICAgbGV0IGxhbmdfZGl2ID0gbGFuZ19zZWwucXVlcnlTZWxlY3RvcihcImRpdlwiKTtcbiAgICAgIGxhbmdfZGl2LnN0eWxlLmRpc3BsYXkgPSBcImZsZXhcIjtcbiAgICAgIGxhbmdfZGl2LnN0eWxlLmZsZXhEaXJlY3Rpb24gPSBcImNvbHVtblwiO1xuXG4gICAgICBuYXZFbmQucGFyZW50Tm9kZS5hcHBlbmRDaGlsZChsYW5nX3NlbCk7XG4gICAgfVxuICB9XG59XG5cbk5hdmJhckxhbmdTZWxlY3RvcihsYW5ndWFnZXMsIG1hc3Rlckxhbmd1YWdlKVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC03OCIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Ii8vIExhbmd1YWdlIGFuZCB0ZXh0IGNvbmZpZ3VyYXRpb25cbmFwcGVuZGl4ID0gX2xhbmcoZ2VuZXJhbF90cmFuc2xhdGlvbnMuYXBwZW5kaXgpXG5cbi8vIE1hc3RlciBsYW5ndWFnZSBzZWxlY3Rvclxudmlld29mIG1hc3Rlckxhbmd1YWdlID0gSW5wdXRzLnJhZGlvKGxhbmd1YWdlcywge1xuICBsYWJlbDogXCJNYWluIGxhbmd1YWdlIHRvZ2dsZVwiLFxuICBmb3JtYXQ6IChkKSA9PiBkLmtleSxcbiAgdmFsdWU6IGxhbmd1YWdlcy5maW5kKCh4KSA9PiB4LmtleSA9PT0gZGVmYXVsdExhbmdLZXkpLFxufSlcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldFF1aWV0Iiwic291cmNlIjoic2hpbnlJbnB1dCgnc2VsZWN0QWRtaW4wJykifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXRRdWlldCIsInNvdXJjZSI6InNoaW55SW5wdXQoJ3NlbGVjdEFkbWluMScpIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0UXVpZXQiLCJzb3VyY2UiOiJzaGlueUlucHV0KCdzZWxlY3RBZG1pbjInKSJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldFF1aWV0Iiwic291cmNlIjoic2hpbnlJbnB1dCgnc2Vuc2l0aXZpdHlBZG1pbjAnKSJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldFF1aWV0Iiwic291cmNlIjoic2hpbnlJbnB1dCgnc2Vuc2l0aXZpdHlBZG1pbjEnKSJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldFF1aWV0Iiwic291cmNlIjoic2hpbnlJbnB1dCgnc2Vuc2l0aXZpdHlBZG1pbjInKSJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldFF1aWV0Iiwic291cmNlIjoic2hpbnlJbnB1dCgnaWNpY2xlJykifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXRRdWlldCIsInNvdXJjZSI6InNoaW55SW5wdXQoJ2FkYXB0aXZlQ2FwYWNpdHlBZG1pbjAnKSJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldFF1aWV0Iiwic291cmNlIjoic2hpbnlJbnB1dCgnYWRhcHRpdmVDYXBhY2l0eUFkbWluMScpIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0UXVpZXQiLCJzb3VyY2UiOiJzaGlueUlucHV0KCdhZGFwdGl2ZUNhcGFjaXR5QWRtaW4yJykifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXRRdWlldCIsInNvdXJjZSI6InNoaW55SW5wdXQoJ2NvbXBvc2l0ZUFkbWluMCcpIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0UXVpZXQiLCJzb3VyY2UiOiJzaGlueUlucHV0KCdjb21wb3NpdGVBZG1pbjEnKSJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldFF1aWV0Iiwic291cmNlIjoic2hpbnlJbnB1dCgnY29tcG9zaXRlQWRtaW4yJykifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXRRdWlldCIsInNvdXJjZSI6InNoaW55SW5wdXQoJ2NvbXBvc2l0ZVNlbGVjdGVkQ29tcG9uZW50JykifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXRRdWlldCIsInNvdXJjZSI6InNoaW55SW5wdXQoJ2NvbXBvc2l0ZURvd25sb2FkQnV0dG9uJykifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXRRdWlldCIsInNvdXJjZSI6InNoaW55SW5wdXQoJ21hc3Rlckxhbmd1YWdlJykifV19</script><script type="module">"file:"===window.location.protocol&&alert("The OJS runtime does not work with file:// URLs. Please use a web server to view this document."),window._ojs.paths.runtimeToDoc="../../notebooks/nb_vulnerability",window._ojs.paths.runtimeToRoot="../..",window._ojs.paths.docToRoot="../..",window._ojs.selfContained=!1,window._ojs.runtime.interpretFromScriptTags()</script><script id="quarto-html-after-body" type="application/javascript">window.document.addEventListener("DOMContentLoaded",function(t){const e=t=>{for(const e of t.classList)if(e.startsWith("code-annotation-"))return!0;return!1},n=function(t){const e=t.trigger;e.blur(),e.classList.add("code-copy-button-checked");var n=e.getAttribute("title");let o;e.setAttribute("title","Copied!"),window.bootstrap&&(e.setAttribute("data-bs-toggle","tooltip"),e.setAttribute("data-bs-placement","left"),e.setAttribute("data-bs-title","Copied!"),o=new bootstrap.Tooltip(e,{trigger:"manual",customClass:"code-copy-button-tooltip",offset:[0,-8]}),o.show()),setTimeout(function(){o&&(o.hide(),e.removeAttribute("data-bs-title"),e.removeAttribute("data-bs-toggle"),e.removeAttribute("data-bs-placement")),e.setAttribute("title",n),e.classList.remove("code-copy-button-checked")},1e3),t.clearSelection()},o=function(t){const n=t.parentElement.cloneNode(!0).querySelector("code");for(const t of n.children)e(t)&&t.remove();return n.innerText};new window.ClipboardJS(".code-copy-button:not([data-in-quarto-modal])",{text:o}).on("success",n),window.document.getElementById("quarto-embedded-source-code-modal")&&new window.ClipboardJS(".code-copy-button[data-in-quarto-modal]",{text:o,container:window.document.getElementById("quarto-embedded-source-code-modal")}).on("success",n);for(var i=new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//),a=new RegExp(/^mailto:/),l=new RegExp("https://adaptationatlas.github.io/atlas_notebooks/"),r=t=>l.test(t)||i.test(t)||a.test(t),d=window.document.querySelectorAll("a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)"),c=0;c<d.length;c++){const t=d[c];r(t.href)||void 0!==t.dataset.originalHref&&(t.href=t.dataset.originalHref)}function s(t,e,n,o){const i={allowHTML:!0,maxWidth:500,delay:100,arrow:!1,appendTo:function(t){return t.parentElement},interactive:!0,interactiveBorder:10,theme:"quarto",placement:"bottom-start"};e&&(i.content=e),n&&(i.onTrigger=n),o&&(i.onUntrigger=o),window.tippy(t,i)}const u=window.document.querySelectorAll('a[role="doc-noteref"]');for(c=0;c<u.length;c++){const t=u[c];s(t,function(){let e=t.getAttribute("data-footnote-href")||t.getAttribute("href");try{e=new URL(e).hash}catch{}const n=e.replace(/^#\/?/,""),o=window.document.getElementById(n);return o?o.innerHTML:""})}const h=window.document.querySelectorAll("a.quarto-xref"),m=(t,e)=>{const n=t=>{if(t.classList.remove("page-full","page-columns"),t.children)for(const e of t.children)n(e)};if(n(e),null===t||t.startsWith("sec-")){const t=document.createElement("div");if(e.children&&e.children.length>2){t.appendChild(e.children[0].cloneNode(!0));for(let n=1;n<e.children.length;n++){const o=e.children[n];if("P"!==o.tagName||""!==o.innerText){t.appendChild(o.cloneNode(!0));break}}return window.Quarto?.typesetMath&&window.Quarto.typesetMath(t),t.innerHTML}return window.Quarto?.typesetMath&&window.Quarto.typesetMath(e),e.innerHTML}{const t=e.querySelector("a.anchorjs-link");return t&&t.remove(),window.Quarto?.typesetMath&&window.Quarto.typesetMath(e),e.classList.contains("callout")?e.outerHTML:e.innerHTML}};for(c=0;c<h.length;c++){const t=h[c];s(t,void 0,function(e){e.disable();let n,o=t.getAttribute("href");if(o.startsWith("#"))n=o;else try{n=new URL(o).hash}catch{}if(n){const t=n.replace(/^#\/?/,""),i=window.document.getElementById(t);if(null!==i)try{const n=m(t,i.cloneNode(!0));e.setContent(n)}finally{e.enable(),e.show()}else fetch(o.split("#")[0]).then(t=>t.text()).then(n=>{const o=(new DOMParser).parseFromString(n,"text/html").getElementById(t);if(null!==o){const n=m(t,o);e.setContent(n)}}).finally(()=>{e.enable(),e.show()})}else fetch(o).then(t=>t.text()).then(t=>{const n=(new DOMParser).parseFromString(t,"text/html").querySelector("main.content");if(null!==n){n.children.length>0&&"HEADER"===n.children[0].tagName&&n.children[0].remove();const t=m(null,n);e.setContent(t)}}).finally(()=>{e.enable(),e.show()})},function(t){})}let w;const g=t=>{window.document;const e=t.getAttribute("data-target-cell"),n=t.getAttribute("data-target-annotation"),o=window.document.querySelector('span[data-code-cell="'+e+'"][data-code-annotation="'+n+'"]').getAttribute("data-code-lines").split(",").map(t=>e+"-"+t);let i=null,a=null,l=null;if(o.length>0){const n=window.document.getElementById(o[0]);if(i=n.offsetTop,a=n.offsetHeight,l=n.parentElement.parentElement,o.length>1){const t=window.document.getElementById(o[o.length-1]);a=t.offsetTop+t.offsetHeight-i}if(null!==i&&null!==a&&null!==l){let t=window.document.getElementById("code-annotation-line-highlight");null===t&&(t=window.document.createElement("div"),t.setAttribute("id","code-annotation-line-highlight"),t.style.position="absolute",l.appendChild(t)),t.style.top=i-2+"px",t.style.height=a+4+"px",t.style.left=0;let n=window.document.getElementById("code-annotation-line-highlight-gutter");null===n&&(n=window.document.createElement("div"),n.setAttribute("id","code-annotation-line-highlight-gutter"),n.style.position="absolute",window.document.getElementById(e).querySelector(".code-annotation-gutter").appendChild(n)),n.style.top=i-2+"px",n.style.height=a+4+"px"}w=t}},p=()=>{["code-annotation-line-highlight","code-annotation-line-highlight-gutter"].forEach(t=>{const e=window.document.getElementById(t);e&&e.remove()}),w=void 0};window.addEventListener("resize",function(t){let e,n=!1;return(...o)=>{n?(e&&clearTimeout(e),e=setTimeout(()=>{t.apply(this,o),e=n=!1},10)):(t.apply(this,o),n=!0)}}(()=>{elRect=void 0,w&&g(w)}));const f=window.document.querySelectorAll("dt[data-target-cell]");for(const t of f)t.addEventListener("click",t=>{const e=t.target;if(e!==w){p();const t=window.document.querySelector("dt[data-target-cell].code-annotation-active");t&&t.classList.remove("code-annotation-active"),g(e),e.classList.add("code-annotation-active")}else p(),e.classList.remove("code-annotation-active")});const b=t=>{const e=t.parentElement;if(e){const n=e.dataset.cites;return n?{el:t,cites:n.split(" ")}:b(t.parentElement)}};var y=window.document.querySelectorAll('a[role="doc-biblioref"]');for(c=0;c<y.length;c++){const t=y[c],e=b(t);e&&s(e.el,function(){var t=window.document.createElement("div");return e.cites.forEach(function(e){var n=window.document.createElement("div");n.classList.add("hanging-indent"),n.classList.add("csl-entry");var o=window.document.getElementById("ref-"+e);o&&(n.innerHTML=o.innerHTML),t.appendChild(n)}),t.innerHTML})}})</script></div></body></html>