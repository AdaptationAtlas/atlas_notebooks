---
module: "Exposure Section"
nb-authors:
  - Johnson Mwakazi
  - Pete Stewart
  - Brayden Youngberg
date-created: "2025-02-19"
date-edited: today
---

```{ojs}
exposureQuestion = _lang(vulnerability_translations.exposure_question);
```

# `{ojs} exposureQuestion` {#exposure}

`{ojs} _lang(vulnerability_translations.exposure_description)`

```{ojs}
exposureControlsForm = createGeographicControlsForm();
```

```{ojs}
// Data loading
exposureData = localDb.query(`
SELECT *
FROM exposure
WHERE hazard = 'any'
AND ${sqlAdminQuery()}
`);

totalExposure = Object.values(
  exposureData.reduce((acc, row) => {
    const key = adminKey(row);
    acc[key] ??= {
      admin0_name: row.admin0_name,
      admin1_name: row.admin1_name,
      admin2_name: row.admin2_name,
      total_value: 0,
    };
    const val = Number(row.value);
    acc[key].total_value += Number.isFinite(val) ? val : 0;
    return acc;
  }, {}),
);

exposureMapData = mergeDataToBoundaries({
  boundaries: filteredBoundaries(),
  data: totalExposure,
  boundaryKey: (feature) => adminKey(feature.properties),
  dataKey: adminKey,
  dataProp: "data",
  defaultValue: null,
});
```

```{ojs}
// Visualization with proper loading/no-data states
exposureChoroplethMap = {
  // Show loading spinner only if data is still loading (null/undefined)
  if (exposureData === null || exposureData === undefined) {
    return createLoadingState(_lang({en: "Loading exposure data...", fr: "Chargement des données d'exposition..."}));
  }
  
  // If data is loaded but empty, or map data is empty, show no data state
  if (!exposureData || exposureData.length === 0 || !exposureMapData || !exposureMapData.features || exposureMapData.features.length === 0) {
    return createNoDataState(_lang(vulnerability_translations.no_data_available));
  }

  const data = exposureMapData;
  
  const plot = renderGeoMap({
    features: data.features,
    width: mapWidth,
    height: mapHeight,
    caption: vopNote.caption,
    projection: {
      type: "azimuthal-equal-area",
      domain: data
    },
    color: {
      legend: true,
      label: `${_lang({en: "VoP", fr: "VoP"})} (${intDollarUnit})`,
      range: colorScales.range.yellowGreen,
      unknown: colorScales.unknown,
      tickFormat: formatNumCompactShort
    },
    valueAccessor: (d) => {
      const dataColumn = "total_value";
      const fillValue = d.properties.data ? d.properties.data?.[dataColumn] : null;
      return fillValue;
    },
    tooltip: {
      channels: {
        country: {
          label: "Country",
          value: (d) => d.properties.admin0_name
        },
        name: {
          label: "Region",
          value: (d) => {
            if (d.properties.admin2_name) {
              return `${d.properties.admin2_name}, ${d.properties.admin1_name}`;
            } else {
              return d.properties.admin1_name;
            }
          }
        },
        data: {
          label: "VoP",
          value: (d) => {
            const dataColumn = "total_value";
            const data = d.properties.data ? d.properties.data[dataColumn] : undefined;
            return data;
          }
        }
      },
      format: {
        country: true,
        name: true,
        data: (d) => d ? formatNumCompactShort(d) : "No data"
      }
    },
    extraMarks: [
      Plot.geo(
        admin2Select?.admin2_name
          ? data.features.filter(d => d.properties.admin2_name === admin2Select?.admin2_name)
          : [],
        {
          fill: null,
          stroke: "#333",
          strokeWidth: 1.5
        }
      )
    ]
  });

  return plot
}
```

```{ojs}
// Download functionality
exposureDownloadButton = {
  // TODO: Integrate this check into downloadButton directly
  if (!exposureData || exposureData.length === 0) {
    return htl.html`${_lang({en: "No data available for download", fr: "Aucune donnée disponible pour le téléchargement"})}`;
  }
  return downloadButton(
    exposureData, 
    `exposure_data_${getAdminNameString().replace(", ", "_")}_all_hazard_types`,
    _lang(vulnerability_translations.download_data)
  );
}
```

```{ojs}
// Dynamic insights
exposureInsights = {
  if (!totalExposure || totalExposure.length === 0) {
    return createNoDataState();
  }

  // Calculate total exposure value
  const totalValue = d3.sum(totalExposure, d => d.total_value || 0);
  const region = getAdminNameString();
  const hazardLabel = "Any";
  
  // Get top 3 most exposed commodities
  let topCommodities = [];
  if (exposureData && exposureData.length > 0) {
    // Filter data based on current admin selection
    const filteredCommodityData = exposureData;
    
    // Group by commodity and sum values
    const commodityGroups = d3.group(filteredCommodityData, d => d.crop);
    const commodityTotals = Array.from(commodityGroups.entries()).map(([crop, values]) => ({
      crop: crop,
      totalValue: d3.sum(values, d => d.value || 0)
    }));
    
    // Sort by total value and get top 3
    topCommodities = commodityTotals
      .sort((a, b) => b.totalValue - a.totalValue)
      .slice(0, 3)
      .filter(d => d.totalValue > 0);
  }
  
  // Format currency without the "2015 USD" prefix
  const formatCleanCurrency = (number) => {
    return new Intl.NumberFormat("en-US", {
      notation: "compact",
      compactDisplay: "short",
      style: "currency",
      currency: "USD",
    }).format(number);
  };
  
  const template = _lang(vulnerability_translations.exposure_insight_template);
  const replacements = [
    { name: "region", value: region },
    { name: "amount", value: formatCleanCurrency(totalValue) }
  ];
  
  const insight = Lang.reduceReplaceTemplateItems(template, replacements);
  
  // Add top commodities insight if available
  let commoditiesInsight = "";
  if (topCommodities.length > 0) {
    // Create dynamic text with specific commodity names
    const commodityNames = topCommodities
      .map(d => d.crop.replace(/-/g, ' '))
      .join(", ");
    
    const commoditiesText = _lang({
      en: ` The top 3 most exposed commodities are:`,
      fr: ` Les 3 produits les plus exposés sont:`
    });
    
    // Combine insight text with commodities list as HTML using proper htl.html syntax
    const fullInsight = htl.html`
      ${insight}${commoditiesText}
      <ol>
        ${topCommodities.map(d => htl.html`<li>${d.crop.replace(/-/g, ' ')} (${formatCleanCurrency(d.totalValue)})</li>`)}
      </ol>
    `;
    return createInsightDisplay(fullInsight);
  }
  
  return createInsightDisplay(insight);
}
```
