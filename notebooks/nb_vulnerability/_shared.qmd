---
module: "Shared State and Utilities"
nb-authors:
  - Johnson Mwakazi
  - Brayden Youngberg
  - Pete Stewart
date-created: "2025-02-19"
date-edited: today
---

```{ojs}
// Global configuration and mutable state - responsive sizing
mapWidth = typeof width !== "undefined" ? Math.min(width, 625) : 625;
mapHeight = 600;
```

```{ojs}
// Language configuration
viewof masterLanguage = Inputs.radio(languages, {
  label: "Main language toggle",
  format: (d) => d.key,
  value: languages.find((x) => x.key === defaultLangKey),
})

languages = [
  { key: "en", label: "English", locale: 'en-US' },
  { key: "fr", label: "FranÃ§ais", locale: 'fr-FR' }
]

defaultLangKey = {
  const name = "lang";
  const list = languages.map((d) => d.key);
  const defaultKey = "en";
  const queryParam = await Lang.getParamFromList({ name, list });
  return queryParam ?? defaultKey;
}

_lang = Lang.lg(masterLanguage.key)
```

```{ojs}
localDb = {
  const db = await DuckDBClient.of({
    exposure: FileAttachment(
      "/data/vulnerability_notebook/notebook_exposure.parquet"
    ),
    vulnerability_icicle: FileAttachment(
      "/data/vulnerability_notebook/vulnerability_icicledata.parquet",
    ),
    urgency: FileAttachment(
      "/data/vulnerability_notebook/urgency_index.parquet"
    ),
    enabling: FileAttachment(
        "/data/vulnerability_notebook/enabling_vars.parquet",
    ),
  });
return db
}
```

```{ojs}
// Simplified data loading with caching (no lazy loading for now)
// Global cache for shared data to avoid redundant loads
mutable dataCache = new Map()

/**
 * Load data with caching to avoid redundant loads
 * 
 * @param {string} key - Unique cache key for this data
 * @param {Function} loader - Async function that returns the data to cache
 * @returns {Promise<*>} Cached data if available, otherwise loaded data
 */
async function loadDataWithCache(key, loader) {
  if (dataCache.has(key)) {
    return dataCache.get(key);
  }
  
  try {
    const startTime = performance.now();
    
    const data = await loader();
    
    const loadTime = performance.now() - startTime;
    
    dataCache.set(key, data);
    return data;
  } catch (error) {
    console.error(`Error loading ${key}:`, error);
    return null;
  }
}
```

```{ojs}
import { getAdminBoundaries } from "/components/_atlasBoundaries.ojs";

boundaries = getAdminBoundaries([0, 1, 2]);

adminKey = (d) => `${d.admin0_name}|${d.admin1_name}|${d.admin2_name}`;

function getAdminSelection(
  admin0,
  admin1,
  admin2,
  globalLabel = "Sub-Saharan Africa",
) {
  const a0 = admin0?.value;
  const a1 = admin1?.value;
  const a2 = admin2?.value;

  return a2 ? a2 : a1 ? a1 : a0 ? a0 : globalLabel;
}

filteredBoundaries = () => {
  // SSA â†’ admin0, no filtering
  if (!admin0Select?.admin0_name) {
    return boundaries.admin0;
  }

  // Country selected â†’ admin1 within admin0
  if (!admin1Select?.admin1_name) {
    return {
      ...boundaries.admin1,
      features: boundaries.admin1.features.filter(
        (d) => d.properties.admin0_name === admin0Select.admin0_name,
      ),
    };
  }

  // Admin1 selected â†’ admin2 within admin1
  return {
    ...boundaries.admin2,
    features: boundaries.admin2.features.filter(
      (d) =>
        d.properties.admin0_name === admin0Select.admin0_name &&
        d.properties.admin1_name === admin1Select.admin1_name,
    ),
  };
};
```

```{ojs}
// Utility functions for data binding and formatting

function mergeDataToBoundaries({
  boundaries,
  data,
  boundaryKey,
  dataKey,
  dataProp = "data",
  defaultValue = null,
}) {
  const index = new Map(data.map((d) => [dataKey(d), d]));

  return {
    type: "FeatureCollection",
    features: boundaries.features.map((feature) => {
      const key = boundaryKey(feature);
      return {
        ...feature,
        properties: {
          ...feature.properties,
          [dataProp]: index.get(key) ?? defaultValue,
        },
      };
    }),
  };
}

//TODO: Remove this (below) and migrate dependencies over to above

/**
 * Bind tabular data to geographic features by matching values in specified columns
 *
 * @param {Object} options - Configuration object
 * @param {Array} options.data - Array of tabular data objects to bind
 * @param {string} options.dataBindColumn - Column name in tabular data to use for matching
 * @param {Object} options.geoData - GeoJSON FeatureCollection to bind data to
 * @param {string} options.geoDataBindColumn - Property name in geo features to match against
 * @returns {Object} GeoJSON FeatureCollection with data bound to each feature's properties.data
 *
 * @example
 * const geoWithData = bindTabularToGeo({
 *   data: [{admin0_name: "Kenya", value: 100}],
 *   dataBindColumn: "admin0_name",
 *   geoData: boundaries.admin0,
 *   geoDataBindColumn: "admin0_name"
 * });
 */
function bindTabularToGeo({
  data = [],
  dataBindColumn = "dataBindColumn",
  geoData = [],
  geoDataBindColumn = "geoDataBindColumn",
}) {
  const index = new Map(data.map((d) => [d[dataBindColumn], d]));
  const geojson = JSON.parse(JSON.stringify(geoData));

  for (const f of geojson.features) {
    f.properties.data = index.get(f.properties[geoDataBindColumn]);
  }
  return geojson;
}
```

```{ojs}
// Formatting utilities
/**
 * Format number as compact currency (e.g., "$1.2M")
 */
formatNumCompactShort = new Intl.NumberFormat("en-US", {
  notation: "compact",
  compactDisplay: "short",
  style: "currency",
  currency: "USD",
}).format;
```

```{ojs}
// Color scales and themes
/**
 * Color scale definitions for visualizations
 */
colorScales = {
  return {
    range: {
      green: ['#E4F5D0', '#015023'],
      blue: ['#E8F2FF', '#003E6B'],
      brown: ['#FFFDE5', '#A87B00'],
      yellowGreen: ['#216729', '#F7D732'], // Reversed: green (low/good) to yellow (high/bad)
      orangeRed: ['#F4BB21', '#EC5A47'],
      redOrange: ['#FEE0D2', '#CB4335'],
      vulnerability: ['#2E8B57', '#FFD700', '#FF6347'], // Low, Medium, High
      adaptive: ['#FF6B6B', '#4ECDC4', '#45B7D1'] // Poor, Fair, Good
    },
    unknown: "#f0f0f0",
    noData: "#f0f0f0"
  }
}
```

```{ojs}
// Constants and metadata
intDollarUnit = `${intDollarYear} USD`
intDollarYear = 2015

/**
 * Value of Production (VoP) note configuration
 */
vopNote = {
  return {
    caption: _lang(vulnerability_translations.vopNoteCaption),
    blurb: _lang(vulnerability_translations.vopNoteBlurb)
  }
}
```

```{ojs}
/**
 * Create a loading state UI component
 *
 * @param {string|null} message - Optional loading message (defaults to translation)
 * @returns {HTMLElement} HTML element with loading spinner and message
 */
function createLoadingState(message = null) {
  return htl.html`
    <div style="
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: #6b7280;
      font-style: italic;
    ">
      <div style="margin-right: 12px;">
        <div class="spinner" style="
          width: 20px;
          height: 20px;
          border: 2px solid #e5e7eb;
          border-top: 2px solid #3b82f6;
          border-radius: 50%;
          animation: spin 1s linear infinite;
        "></div>
      </div>
      ${message || _lang(vulnerability_translations.loading)}
    </div>
    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  `;
}

/**
 * Create a "no data available" state UI component
 *
 * @param {string|null} message - Optional message (defaults to translation)
 * @returns {HTMLElement} HTML element with no-data display
 */
function createNoDataState(message = null) {
  return htl.html`
    <div style="
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      background: #f9fafb;
      border: 2px dashed #d1d5db;
      border-radius: 8px;
      color: #6b7280;
      text-align: center;
      margin-top: 16px;
    ">
      <div>
        <div style="margin-bottom: 8px; font-size: 18px;">ðŸ“Š</div>
        <div>${message || _lang(vulnerability_translations.no_data_available)}</div>
      </div>
    </div>
  `;
}
```

```{ojs}
/**
 * Create a styled insight display component from text or HTML
 * Handles both plain text (with paragraph splitting) and HTML elements
 *
 * @param {string|HTMLElement} insight - Insight text or HTML element to display
 * @returns {HTMLElement} Styled HTML element with insight content
 */
function createInsightDisplay(insight) {
  const containerStyle = `
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
    margin: 16px 0;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  `;
  const bodyStyle = "font-size: 16px; line-height: 1.6; opacity: 0.95;";

  const title = _lang(vulnerability_translations.quick_insights);

  const renderBody = () => {
    // For when raw html is returned
    if (typeof insight !== "string") {
      return htl.html`<div style="${bodyStyle}">${insight}</div>`;
    }

    const paragraphs = insight.split("\n\n").filter((p) => p.trim().length > 0);

    const paragraphElements = paragraphs
      .map((paragraph) => {
        if (paragraph === "---") {
          return null;
        }
        return htl.html`<p style="${bodyStyle}">${paragraph}</p>`;
      })
      .filter((p) => p !== null);

    return htl.html`<div>${paragraphElements}</div>`;
  };

  return htl.html`
    <div style="
      ${containerStyle}
    ">
      <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">${title}</h3>
      ${renderBody()}
    </div>
  `;
}
```

```{ojs}
/**
 * Create a shared geographic selection controls form.
 *
 * @returns {HTMLElement} Styled HTML element with admin selection controls.
 */
function createGeographicControlsForm() {
  return htl.html`
    <div style="
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
      margin: 16px 0;
    ">
      <h3 style="margin: 0 0 20px 0; color: #2d3748; font-size: 1.1rem; font-weight: 600;">
        ${_lang(vulnerability_translations.geographic_selection)}
      </h3>
      <div style="
        display: flex;
        align-items: flex-start;
        gap: 20px;
        flex-wrap: wrap;
        justify-content: space-between;
      " class="form-inputs-container">
        <div style="flex: 1; min-width: 180px; max-width: 100%;">${admin012Form(masterLanguage.key)}</div>
      </div>
    </div>
  `;
}
```
