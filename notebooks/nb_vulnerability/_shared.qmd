---
module: "Shared State and Utilities"
nb-authors:
  - Johnson Mwakazi
  - Pete Stewart
  - Brayden Youngberg
date-created: "2025-02-19"
date-edited: today
---

```{ojs}
// Global configuration and mutable state - responsive sizing
mapWidth = typeof width !== "undefined" ? Math.min(width, 625) : 625;
mapHeight = 600;
```

```{ojs}
// Language configuration
languages = [
  { key: "en", label: "English", locale: 'en-US' },
  { key: "fr", label: "FranÃ§ais", locale: 'fr-FR' }
]

defaultLangKey = {
  const name = "lang";
  const list = languages.map((d) => d.key);
  const defaultKey = "en";
  const queryParam = await Lang.getParamFromList({ name, list });
  return queryParam ?? defaultKey;
}

_lang = Lang.lg(masterLanguage.key)
```

```{ojs}
localDb = {
  const db = await DuckDBClient.of({
    exposure: FileAttachment(
      "/data/vulnerability_notebook/notebook_exposure.parquet"
    ),
    vulnerability_icicle: FileAttachment(
      "/data/vulnerability_notebook/vulnerability_icicledata_updated.parquet",
    ),
    urgency: FileAttachment(
      "/data/vulnerability_notebook/urgency_index.parquet"
    ),
    enabling: FileAttachment(
        "/data/vulnerability_notebook/enabling_vars.parquet",
    ),
  });
return db
}
```

```{ojs}
// Simplified data loading with caching (no lazy loading for now)
// Global cache for shared data to avoid redundant loads
mutable dataCache = new Map()

/**
 * Load data with caching to avoid redundant loads
 * 
 * @param {string} key - Unique cache key for this data
 * @param {Function} loader - Async function that returns the data to cache
 * @returns {Promise<*>} Cached data if available, otherwise loaded data
 */
async function loadDataWithCache(key, loader) {
  if (dataCache.has(key)) {
    return dataCache.get(key);
  }
  
  try {
    const startTime = performance.now();
    
    const data = await loader();
    
    const loadTime = performance.now() - startTime;
    
    dataCache.set(key, data);
    return data;
  } catch (error) {
    console.error(`Error loading ${key}:`, error);
    return null;
  }
}
```

```{ojs}
import { getAdminBoundaries } from "/components/_atlasBoundaries.ojs";

boundaries = getAdminBoundaries([0, 1, 2]);

function getAdminSelection(
  admin0,
  admin1,
  admin2,
  globalLabel = "Sub-Saharan Africa",
) {
  const a0 = admin0?.value;
  const a1 = admin1?.value;
  const a2 = admin2?.value;

  return a2 ? a2 : a1 ? a1 : a0 ? a0 : globalLabel;
}
```

```{ojs}
// Utility functions for data binding and formatting
/**
 * Bind tabular data to geographic features by matching values in specified columns
 *
 * @param {Object} options - Configuration object
 * @param {Array} options.data - Array of tabular data objects to bind
 * @param {string} options.dataBindColumn - Column name in tabular data to use for matching
 * @param {Object} options.geoData - GeoJSON FeatureCollection to bind data to
 * @param {string} options.geoDataBindColumn - Property name in geo features to match against
 * @returns {Object} GeoJSON FeatureCollection with data bound to each feature's properties.data
 *
 * @example
 * const geoWithData = bindTabularToGeo({
 *   data: [{admin0_name: "Kenya", value: 100}],
 *   dataBindColumn: "admin0_name",
 *   geoData: boundaries.admin0,
 *   geoDataBindColumn: "admin0_name"
 * });
 */
function bindTabularToGeo({
  data = [],
  dataBindColumn = "dataBindColumn",
  geoData = [],
  geoDataBindColumn = "geoDataBindColumn",
}) {
  const index = new Map(data.map((d) => [d[dataBindColumn], d]));
  const geojson = JSON.parse(JSON.stringify(geoData));

  for (const f of geojson.features) {
    f.properties.data = index.get(f.properties[geoDataBindColumn]);
  }
  return geojson;
}
```

```{ojs}
// Formatting utilities
/**
 * Format number as compact currency (e.g., "$1.2M")
 */
formatNumCompactShort = new Intl.NumberFormat("en-US", {
  notation: "compact",
  compactDisplay: "short",
  style: "currency",
  currency: "USD",
}).format;
```

```{ojs}
// Color scales and themes
/**
 * Color scale definitions for visualizations
 */
colorScales = {
  return {
    range: {
      green: ['#E4F5D0', '#015023'],
      blue: ['#E8F2FF', '#003E6B'],
      brown: ['#FFFDE5', '#A87B00'],
      yellowGreen: ['#216729', '#F7D732'], // Reversed: green (low/good) to yellow (high/bad)
      orangeRed: ['#F4BB21', '#EC5A47'],
      redOrange: ['#FEE0D2', '#CB4335'],
      vulnerability: ['#2E8B57', '#FFD700', '#FF6347'], // Low, Medium, High
      adaptive: ['#FF6B6B', '#4ECDC4', '#45B7D1'] // Poor, Fair, Good
    },
    unknown: "#f0f0f0",
    noData: "#f0f0f0"
  }
}
```

```{ojs}
// Constants and metadata
intDollarUnit = `${intDollarYear} USD`
intDollarYear = 2015

/**
 * Value of Production (VoP) note configuration
 */
vopNote = {
  return {
    caption: _lang(vulnerability_translations.vopNoteCaption),
    blurb: _lang(vulnerability_translations.vopNoteBlurb)
  }
}
```

```{ojs}
/**
 * Create a loading state UI component
 *
 * @param {string|null} message - Optional loading message (defaults to translation)
 * @returns {HTMLElement} HTML element with loading spinner and message
 */
function createLoadingState(message = null) {
  return htl.html`
    <div style="
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: #6b7280;
      font-style: italic;
    ">
      <div style="margin-right: 12px;">
        <div class="spinner" style="
          width: 20px;
          height: 20px;
          border: 2px solid #e5e7eb;
          border-top: 2px solid #3b82f6;
          border-radius: 50%;
          animation: spin 1s linear infinite;
        "></div>
      </div>
      ${message || _lang(vulnerability_translations.loading)}
    </div>
    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  `;
}

/**
 * Create a "no data available" state UI component
 *
 * @param {string|null} message - Optional message (defaults to translation)
 * @returns {HTMLElement} HTML element with no-data display
 */
function createNoDataState(message = null) {
  return htl.html`
    <div style="
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      background: #f9fafb;
      border: 2px dashed #d1d5db;
      border-radius: 8px;
      color: #6b7280;
      text-align: center;
      margin-top: 16px;
    ">
      <div>
        <div style="margin-bottom: 8px; font-size: 18px;">ðŸ“Š</div>
        <div>${message || _lang(vulnerability_translations.no_data_available)}</div>
      </div>
    </div>
  `;
}
```

```{ojs}
/**
 * Create a styled insight display component from text or HTML
 * Handles both plain text (with paragraph splitting) and HTML elements
 *
 * @param {string|HTMLElement} insight - Insight text or HTML element to display
 * @returns {HTMLElement} Styled HTML element with insight content
 */
function createInsightDisplay(insight) {
  // Handle case where insight is already an HTML element (from htl.html)
  if (typeof insight !== "string") {
    // If it's already an HTML element, just wrap it in the standard display
    return htl.html`
      <div style="
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin: 16px 0;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      ">
        <h4 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">
          ${_lang(vulnerability_translations.quick_insights)}
        </h4>
        <div style="margin: 0; font-size: 18px; line-height: 1.5; opacity: 0.95;">
          ${insight}
        </div>
      </div>
    `;
  }

  // Split insight into paragraphs based on double newlines and process each
  const paragraphs = insight.split("\n\n").filter((p) => p.trim().length > 0);

  // Create HTML elements using htl.html for proper rendering
  const paragraphElements = paragraphs
    .map((paragraph) => {
      console.log(paragraph);
      // Handle special formatting for section headers
      if (paragraph.startsWith("Overall Population Analysis:")) {
        const content = paragraph
          .replace("Overall Population Analysis:", "")
          .trim();
        return htl.html`<div style="
        border-top: 1px solid rgba(255, 255, 255, 0.3);
        padding-top: 16px;
        margin-bottom: 16px;
      ">
        <div style="font-weight: bold; margin-bottom: 12px;">Overall Population Analysis</div>
        <div style="font-size: 16px; line-height: 1.6;">${content}</div>
      </div>`;
      } else if (paragraph === "---") {
        // Skip separator lines
        return null;
      } else {
        // Regular paragraphs
        return htl.html`<p style="margin: 0 0 12px 0; font-size: 16px; line-height: 1.6; opacity: 0.95;">${paragraph}</p>`;
      }
    })
    .filter((p) => p !== null);

  return htl.html`
    <div style="
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin: 16px 0;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    ">
      <h4 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">
        ${_lang(vulnerability_translations.quick_insights)}
      </h4>
      <div style="margin: 0;">
        ${paragraphElements}
      </div>
    </div>
  `;
}
```
