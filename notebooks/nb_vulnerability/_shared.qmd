---
pagetitle: "Shared State and Utilities"
nb-authors:
  - Johnson Mwakazi
  - Pete Stewart
  - Brayden Youngberg
date-created: "2025-02-19"
date-edited: today
---


```{ojs}
// Global configuration and mutable state - responsive sizing
mapWidth = typeof width !== 'undefined' ? Math.min(width, 625) : 625
mapHeight = 600

// Mutable state for cross-section reactivity - CENTRALIZED ADMIN SELECTIONS
mutable sharedAdmin0 = null
mutable sharedAdmin1 = null
mutable sharedAdmin2 = null

/**
 * Update all shared admin selections synchronously across all sections
 * 
 * @param {string|null} admin0 - Admin0 selection value
 * @param {string|null} admin1 - Admin1 selection value  
 * @param {string|null} admin2 - Admin2 selection value
 */
function updateSharedAdminSelections(admin0, admin1, admin2) {
  mutable sharedAdmin0 = admin0;
  mutable sharedAdmin1 = admin1;
  mutable sharedAdmin2 = admin2;
}
```

```{ojs}
// Language configuration
languages = [
  { key: "en", label: "English", locale: 'en-US' },
  { key: "fr", label: "Fran√ßais", locale: 'fr-FR' }
]

defaultLangKey = {
  const name = "lang";
  const list = languages.map((d) => d.key);
  const defaultKey = "en";
  const queryParam = await Lang.getParamFromList({ name, list });
  return queryParam ?? defaultKey;
}

_lang = Lang.lg(masterLanguage.key)

globalSelection = {
  return {
    label: _lang({en: "Sub-Saharan Africa", fr: "Afrique subsaharienne"}),
    labelGeneral: _lang({en: "Africa", fr: "Afrique"}),
 
  }
}
```

```{ojs}
// Admin region configuration
adminRegions = {
  return {
    labels: {
      admin0: _lang(vulnerability_translations.country),
      admin1: _lang(vulnerability_translations.region),
      admin2: _lang(vulnerability_translations.subregion)
    }
  };
}

// Get current admin selections as reactive object - now using shared state
adminSelections = ({
  selectAdmin0: sharedAdmin0,
  selectAdmin1: sharedAdmin1,
  selectAdmin2: sharedAdmin2
})
```

```{ojs}
// Simplified data loading with caching (no lazy loading for now)
// Global cache for shared data to avoid redundant loads
mutable dataCache = new Map()

// Load S3 configuration
s3Config = await FileAttachment(
	"/data/vulnerability_notebook/S3_data.json",
).json();

/**
 * Load data with caching to avoid redundant loads
 * 
 * @param {string} key - Unique cache key for this data
 * @param {Function} loader - Async function that returns the data to cache
 * @returns {Promise<*>} Cached data if available, otherwise loaded data
 */
async function loadDataWithCache(key, loader) {
  if (dataCache.has(key)) {
    return dataCache.get(key);
  }
  
  try {
    const startTime = performance.now();
    
    const data = await loader();
    
    const loadTime = performance.now() - startTime;
    
    dataCache.set(key, data);
    return data;
  } catch (error) {
    console.error(`Error loading ${key}:`, error);
    return null;
  }
}

/**
 * Create DuckDB connection with exposure data parquet file loaded as a view
 * Uses caching to avoid redundant connections
 * 
 * @returns {Promise<Object>} DuckDB client with exposure_data view
 */
async function createExposureDB() {
  return loadDataWithCache('exposureDB', async () => {
    const parquetUrl = await FileAttachment(
      "/data/vulnerability_notebook/notebook_exposure.parquet",
    ).url();
    const db = await DuckDBClient.of();
    await db.query(`
      CREATE OR REPLACE VIEW exposure_data AS
      SELECT * FROM read_parquet('${parquetUrl}')
    `);
    return db;
  });
}
```

```{ojs}
// Cached boundary data loading
boundaries = {
  return loadDataWithCache('boundaries', async () => {
    const input0 = await FileAttachment("/data/shared/atlas_gaul_a0_africa_simple-vlowres.topojson").json()
    const input1 = await FileAttachment("/data/shared/atlas_gaul_a1_africa_simple-vlowres.topojson").json()
    const input2 = await FileAttachment("/data/shared/atlas_gaul_a2_africa_simple-lowres.topojson").json()

    const geo = {
      admin0: {
        ...topojson.feature(input0, input0.objects["atlas_gaul24_a0_africa"]),
        features: topojson.feature(input0, input0.objects["atlas_gaul24_a0_africa"]).features
      },
      admin1: {
        ...topojson.feature(input1, input1.objects["atlas_gaul24_a1_africa"]),
        features: topojson.feature(input1, input1.objects["atlas_gaul24_a1_africa"]).features
      },
      admin2: {
        ...topojson.feature(input2, input2.objects["atlas_gaul_a2_africa_simple-lowres"]),
        features: topojson.feature(input2, input2.objects["atlas_gaul_a2_africa_simple-lowres"]).features
      }
    }
    
    return geo
  });
}
```

```{ojs}
dataAdmin0 = {
  const data = boundaries.admin0.features.map(d => d.properties)
  // add a blank value and sort alphabetically
  return [null, ...data.map(d => d.admin0_name)].map(d => {
    return {label: d == null ? globalSelection.label : d, value: d}
  }).sort((a, b) => {
    // Keep null/blank value at the top
    if (a.value === null) return -1;
    if (b.value === null) return 1;
    // Sort others alphabetically by label
    return a.label.localeCompare(b.label);
  })
}

dataAdmin1 = {
  // admin 1, filter by 0 - using shared state
  let data;
  if (sharedAdmin0 && sharedAdmin0 !== "SSA") {
    // Filter by selected country
    data = boundaries.admin1.features.map(d => d.properties)
      .filter(d => d.admin0_name == sharedAdmin0);
  } else {
    // If no country selected or SSA selected, show empty (just null option)
    data = [];
  }
  
  // add blank value and sort alphabetically
  return [null, ...data.map(d => d.admin1_name)].map(d => {
    return {label: d, value: d}
  }).sort((a, b) => {
    // Keep null/blank value at the top
    if (a.value === null) return -1;
    if (b.value === null) return 1;
    // Sort others alphabetically by label
    return a.label.localeCompare(b.label);
  })
}

dataAdmin2 = {
  let data;
  if (sharedAdmin0 && sharedAdmin0 !== "SSA" && sharedAdmin1) {
    // Filter by selected country and region
    data = boundaries.admin2.features.map(d => d.properties)
      .filter(d => d.admin0_name == sharedAdmin0 && d.admin1_name == sharedAdmin1);
  } else {
    // If no country or region selected, show empty (just null option)
    data = [];
  }
  
  // add blank value and sort alphabetically
  return [null, ...data.map(d => d.admin2_name)].map(d => {
    return {label: d, value: d}
  }).sort((a, b) => {
    // Keep null/blank value at the top
    if (a.value === null) return -1;
    if (b.value === null) return 1;
    // Sort others alphabetically by label
    return a.label.localeCompare(b.label);
  })
}
```

```{ojs}
// Bidirectional synchronization: Update shared state when ANY section's selectors change
// This reactive cell monitors all section admin selectors and updates shared state when any change
// The underscore prefix ensures this cell doesn't display output in the notebook
_adminUpdate = {
  // Check exposure section selectors first
  if (selectAdmin0?.value !== sharedAdmin0) {
    updateSharedAdminSelections(selectAdmin0?.value, null, null);
  } else if (selectAdmin1?.value !== sharedAdmin1) {
    updateSharedAdminSelections(sharedAdmin0, selectAdmin1?.value, null);
  } else if (selectAdmin2?.value !== sharedAdmin2) {
    updateSharedAdminSelections(
      sharedAdmin0,
      sharedAdmin1,
      selectAdmin2?.value,
    );
  }
  // Check sensitivity section selectors
  else if (sensitivityAdmin0?.value !== sharedAdmin0) {
    updateSharedAdminSelections(sensitivityAdmin0?.value, null, null);
  } else if (sensitivityAdmin1?.value !== sharedAdmin1) {
    updateSharedAdminSelections(sharedAdmin0, sensitivityAdmin1?.value, null);
  } else if (sensitivityAdmin2?.value !== sharedAdmin2) {
    updateSharedAdminSelections(
      sharedAdmin0,
      sharedAdmin1,
      sensitivityAdmin2?.value,
    );
  }
  // Check adaptive capacity section selectors
  else if (adaptiveCapacityAdmin0?.value !== sharedAdmin0) {
    updateSharedAdminSelections(adaptiveCapacityAdmin0?.value, null, null);
  } else if (adaptiveCapacityAdmin1?.value !== sharedAdmin1) {
    updateSharedAdminSelections(
      sharedAdmin0,
      adaptiveCapacityAdmin1?.value,
      null,
    );
  } else if (adaptiveCapacityAdmin2?.value !== sharedAdmin2) {
    updateSharedAdminSelections(
      sharedAdmin0,
      sharedAdmin1,
      adaptiveCapacityAdmin2?.value,
    );
  }
  // Check composite section selectors
  else if (compositeAdmin0?.value !== sharedAdmin0) {
    updateSharedAdminSelections(compositeAdmin0?.value, null, null);
  } else if (compositeAdmin1?.value !== sharedAdmin1) {
    updateSharedAdminSelections(sharedAdmin0, compositeAdmin1?.value, null);
  } else if (compositeAdmin2?.value !== sharedAdmin2) {
    updateSharedAdminSelections(
      sharedAdmin0,
      sharedAdmin1,
      compositeAdmin2?.value,
    );
  }
}
```

```{ojs}
sensitivityDataAdmin0 = {
  const data = boundaries.admin0.features.map(d => d.properties)
  // add a blank value and sort alphabetically
  return [null, ...data.map(d => d.admin0_name)].map(d => {
    return {label: d == null ? globalSelection.label : d, value: d || "SSA"}
  }).sort((a, b) => {
    // Keep null/blank value at the top
    if (a.value === "SSA") return -1;
    if (b.value === "SSA") return 1;
    // Sort others alphabetically by label
    return a.label.localeCompare(b.label);
  })
}


sensitivityDataAdmin1 = {
  // admin 1, filter by 0 
  const data = boundaries.admin1.features.map(d => d.properties)
  .filter(d => d.admin0_name == sensitivityAdmin0?.value)
  // add blank value and sort alphabetically
  return [null, ...data.map(d => d.admin1_name)].map(d => {
    return {label: d, value: d}
  }).sort((a, b) => {
    // Keep null/blank value at the top
    if (a.value === null) return -1;
    if (b.value === null) return 1;
    // Sort others alphabetically by label
    return a.label.localeCompare(b.label);
  })
}


sensitivityDataAdmin2 = {
  const data = boundaries.admin2.features.map(d => d.properties)
  .filter(d => d.admin0_name == sensitivityAdmin0?.value && d.admin1_name == sensitivityAdmin1?.value)
  // add blank value and sort alphabetically
  return [null, ...data.map(d => d.admin2_name)].map(d => {
    return {label: d, value: d}
  }).sort((a, b) => {
    // Keep null/blank value at the top
    if (a.value === null) return -1;
    if (b.value === null) return 1;
    // Sort others alphabetically by label
    return a.label.localeCompare(b.label);
  })
}
```

```{ojs}
compositeDataAdmin0 = {
  const data = boundaries.admin0.features.map(d => d.properties)
  // add a blank value and sort alphabetically
  return [null, ...data.map(d => d.admin0_name)].map(d => {
    return {label: d == null ? globalSelection.label : d, value: d || "SSA"}
  }).sort((a, b) => {
    // Keep null/blank value at the top
    if (a.value === "SSA") return -1;
    if (b.value === "SSA") return 1;
    // Sort others alphabetically by label
    return a.label.localeCompare(b.label);
  })
}


compositeDataAdmin1 = {
  // admin 1, filter by 0 
  const data = boundaries.admin1.features.map(d => d.properties)
  // Note: compositeAdmin0 will be available when this function is called from composite section
  // add blank value and sort alphabetically
  return [null, ...data.map(d => d.admin1_name)].map(d => {
    return {label: d, value: d}
  }).sort((a, b) => {
    // Keep null/blank value at the top
    if (a.value === null) return -1;
    if (b.value === null) return 1;
    // Sort others alphabetically by label
    return a.label.localeCompare(b.label);
  })
}


compositeDataAdmin2 = {
  const data = boundaries.admin2.features.map(d => d.properties)
  // Note: compositeAdmin0 and compositeAdmin1 will be available when this function is called from composite section
  // add blank value and sort alphabetically
  return [null, ...data.map(d => d.admin2_name)].map(d => {
    return {label: d, value: d}
  }).sort((a, b) => {
    // Keep null/blank value at the top
    if (a.value === null) return -1;
    if (b.value === null) return 1;
    // Sort others alphabetically by label
    return a.label.localeCompare(b.label);
  })
}
```

```{ojs}
adaptiveCapacityDataAdmin0 = {
  const data = boundaries.admin0.features.map(d => d.properties)
  // add a blank value and sort alphabetically
  return [null, ...data.map(d => d.admin0_name)].map(d => {
   return {label: d == null ? globalSelection.label : d, value: d || "SSA"}
  }).sort((a, b) => {
    // Keep null/blank value at the top
    if (a.value === "SSA") return -1;
    if (b.value === "SSA") return 1;
    // Sort others alphabetically by label
    return a.label.localeCompare(b.label);
  })
}


adaptiveCapacityDataAdmin1 = {
  // admin 1, filter by 0 
  const data = boundaries.admin1.features.map(d => d.properties)
  .filter(d => d.admin0_name == adaptiveCapacityAdmin0?.value)
  // add blank value and sort alphabetically
  return [null, ...data.map(d => d.admin1_name)].map(d => {
    return {label: d, value: d}
  }).sort((a, b) => {
    // Keep null/blank value at the top
    if (a.value === null) return -1;
    if (b.value === null) return 1;
    // Sort others alphabetically by label
    return a.label.localeCompare(b.label);
  })
}


adaptiveCapacityDataAdmin2 = {
  const data = boundaries.admin2.features.map(d => d.properties)
  .filter(d => d.admin0_name == adaptiveCapacityAdmin0?.value && d.admin1_name == adaptiveCapacityAdmin1?.value)
  // add blank value and sort alphabetically
  return [null, ...data.map(d => d.admin2_name)].map(d => {
    return {label: d, value: d}
  }).sort((a, b) => {
    // Keep null/blank value at the top
    if (a.value === null) return -1;
    if (b.value === null) return 1;
    // Sort others alphabetically by label
    return a.label.localeCompare(b.label);
  })
}
```

```{ojs}
// Utility functions for data binding and formatting
/**
 * Bind tabular data to geographic features by matching values in specified columns
 * 
 * @param {Object} options - Configuration object
 * @param {Array} options.data - Array of tabular data objects to bind
 * @param {string} options.dataBindColumn - Column name in tabular data to use for matching
 * @param {Object} options.geoData - GeoJSON FeatureCollection to bind data to
 * @param {string} options.geoDataBindColumn - Property name in geo features to match against
 * @returns {Object} GeoJSON FeatureCollection with data bound to each feature's properties.data
 * 
 * @example
 * const geoWithData = bindTabularToGeo({
 *   data: [{admin0_name: "Kenya", value: 100}],
 *   dataBindColumn: "admin0_name",
 *   geoData: boundaries.admin0,
 *   geoDataBindColumn: "admin0_name"
 * });
 */
function bindTabularToGeo({
  data = [],
  dataBindColumn = "dataBindColumn",
  geoData = [],
  geoDataBindColumn = "geoDataBindColumn",
}) {
  const index = new Map(data.map((d) => [d[dataBindColumn], d]));
  const geojson = JSON.parse(JSON.stringify(geoData));

  for (const f of geojson.features) {
    f.properties.data = index.get(f.properties[geoDataBindColumn]);
  }
  return geojson;
}

/**
 * Get the most granular admin selection from admin level selectors
 * 
 * @param {Object} admin0 - Admin0 selector object with .value property
 * @param {Object} admin1 - Admin1 selector object with .value property
 * @param {Object} admin2 - Admin2 selector object with .value property
 * @param {string} globalLabel - Default label when no selection is made (default: "Sub-Saharan Africa")
 * @returns {string} The most specific admin level selected, or globalLabel if none selected
 * 
 * @example
 * getAdminSelection(selectAdmin0, selectAdmin1, selectAdmin2)
 */
function getAdminSelection(admin0, admin1, admin2, globalLabel = "Sub-Saharan Africa") {
  const a0 = admin0?.value;
  const a1 = admin1?.value;
  const a2 = admin2?.value;

  return a2 ? a2 : a1 ? a1 : a0 ? a0 : globalLabel;
}

// Convenience wrappers for backward compatibility
function getExposureAdminSelection() {
  return getAdminSelection(selectAdmin0, selectAdmin1, selectAdmin2);
}

function getSensitivityAdminSelection() {
  return getAdminSelection(sensitivityAdmin0, sensitivityAdmin1, sensitivityAdmin2);
}

```

```{ojs}
// Formatting utilities
/**
 * Format number as compact currency (e.g., "$1.2M")
 */
formatNumCompactShort = new Intl.NumberFormat("en-US", {
  notation: "compact",
  compactDisplay: "short",
  style: "currency",
  currency: "USD",
}).format;
```

```{ojs}
// Color scales and themes
/**
 * Color scale definitions for visualizations
 */
colorScales = {
  return {
    range: {
      green: ['#E4F5D0', '#015023'],
      blue: ['#E8F2FF', '#003E6B'],
      brown: ['#FFFDE5', '#A87B00'],
      yellowGreen: ['#216729', '#F7D732'], // Reversed: green (low/good) to yellow (high/bad)
      orangeRed: ['#F4BB21', '#EC5A47'],
      redOrange: ['#FEE0D2', '#CB4335'],
      vulnerability: ['#2E8B57', '#FFD700', '#FF6347'], // Low, Medium, High
      adaptive: ['#FF6B6B', '#4ECDC4', '#45B7D1'] // Poor, Fair, Good
    },
    unknown: "#f0f0f0",
    noData: "#f0f0f0"
  }
}
```

```{ojs}
// Constants and metadata
intDollarUnit = `${intDollarYear} USD`
intDollarYear = 2015

/**
 * Value of Production (VoP) note configuration
 */
vopNote = {
  return {
    caption: _lang(vulnerability_translations.vopNoteCaption),
    blurb: _lang(vulnerability_translations.vopNoteBlurb)
  }
}
```

```{ojs}
/**
 * Create a loading state UI component
 * 
 * @param {string|null} message - Optional loading message (defaults to translation)
 * @returns {HTMLElement} HTML element with loading spinner and message
 */
function createLoadingState(message = null) {
  return htl.html`
    <div style="
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: #6b7280;
      font-style: italic;
    ">
      <div style="margin-right: 12px;">
        <div class="spinner" style="
          width: 20px;
          height: 20px;
          border: 2px solid #e5e7eb;
          border-top: 2px solid #3b82f6;
          border-radius: 50%;
          animation: spin 1s linear infinite;
        "></div>
      </div>
      ${message || _lang(vulnerability_translations.loading)}
    </div>
    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  `;
}

/**
 * Create a "no data available" state UI component
 * 
 * @param {string|null} message - Optional message (defaults to translation)
 * @returns {HTMLElement} HTML element with no-data display
 */
function createNoDataState(message = null) {
  return htl.html`
    <div style="
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      background: #f9fafb;
      border: 2px dashed #d1d5db;
      border-radius: 8px;
      color: #6b7280;
      text-align: center;
      margin-top: 16px;
    ">
      <div>
        <div style="margin-bottom: 8px; font-size: 18px;">üìä</div>
        <div>${message || _lang(vulnerability_translations.no_data_available)}</div>
      </div>
    </div>
  `;
}
```

```{ojs}
// Insight generation utilities
/**
 * Generate dynamic insights by replacing template placeholders with actual values
 * 
 * @param {string} template - Template string with placeholders (e.g., "{region}", "{amount}")
 * @param {Array<Object>} replacements - Array of {name, value} objects for replacement
 * @returns {string} Template with all placeholders replaced
 * 
 * @example
 * generateInsight("In {region}, exposure is {amount}", [
 *   {name: "region", value: "Kenya"},
 *   {name: "amount", value: "$1.2M"}
 * ])
 */
function generateInsight(template, replacements) {
  return Lang.reduceReplaceTemplateItems(template, replacements);
}

/**
 * Create a styled insight display component from text or HTML
 * Handles both plain text (with paragraph splitting) and HTML elements
 * 
 * @param {string|HTMLElement} insight - Insight text or HTML element to display
 * @returns {HTMLElement} Styled HTML element with insight content
 */
function createInsightDisplay(insight) {
  // Handle case where insight is already an HTML element (from htl.html)
  if (typeof insight !== "string") {
    // If it's already an HTML element, just wrap it in the standard display
    return htl.html`
      <div style="
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin: 16px 0;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      ">
        <h4 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">
          ${_lang(vulnerability_translations.quick_insights)}
        </h4>
        <div style="margin: 0; font-size: 18px; line-height: 1.5; opacity: 0.95;">
          ${insight}
        </div>
      </div>
    `;
  }

  // Split insight into paragraphs based on double newlines and process each
  const paragraphs = insight.split("\n\n").filter((p) => p.trim().length > 0);

  // Create HTML elements using htl.html for proper rendering
  const paragraphElements = paragraphs
    .map((paragraph) => {
      // Handle special formatting for section headers
      if (paragraph.startsWith("üìç Selected Group:")) {
        const content = paragraph.replace("üìç Selected Group:", "").trim();
        return htl.html`<div style="
        background: rgba(255, 255, 255, 0.15);
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 16px;
        border-left: 4px solid #ffd700;
      ">
        <div style="font-weight: bold; margin-bottom: 8px;">üìç Selected Group</div>
        <div style="font-size: 16px;">${content}</div>
      </div>`;
      } else if (paragraph.startsWith("Overall Population Analysis:")) {
        const content = paragraph
          .replace("Overall Population Analysis:", "")
          .trim();
        return htl.html`<div style="
        border-top: 1px solid rgba(255, 255, 255, 0.3);
        padding-top: 16px;
        margin-bottom: 16px;
      ">
        <div style="font-weight: bold; margin-bottom: 12px;">Overall Population Analysis</div>
        <div style="font-size: 16px; line-height: 1.6;">${content}</div>
      </div>`;
      } else if (paragraph === "---") {
        // Skip separator lines
        return null;
      } else {
        // Regular paragraphs
        return htl.html`<p style="margin: 0 0 12px 0; font-size: 16px; line-height: 1.6; opacity: 0.95;">${paragraph}</p>`;
      }
    })
    .filter((p) => p !== null);

  return htl.html`
    <div style="
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin: 16px 0;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    ">
      <h4 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">
        ${_lang(vulnerability_translations.quick_insights)}
      </h4>
      <div style="margin: 0;">
        ${paragraphElements}
      </div>
    </div>
  `;
}
```
