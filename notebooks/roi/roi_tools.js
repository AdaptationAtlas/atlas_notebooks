import*as w from"https://cdn.jsdelivr.net/npm/d3@7/+esm";export function avlossCalc(n,s,l=!1,u=1e6,o=!0){const c=l?Math.max(0,n-Math.min(s,n)):n*(1-s);if(c<0)return NaN;const a=n,m=(p,B)=>{const M=new Float64Array(p);for(let r=0;r<p;r+=2){const F=Math.random(),C=Math.random(),y=Math.sqrt(-2*Math.log(F)),x=2*Math.PI*C;M[r]=1+y*Math.cos(x)*B,r+1<p&&(M[r+1]=1+y*Math.sin(x)*B)}return M},t=m(u,c),e=m(u,a),i=p=>o?w.median(w.shuffle(Array.from(p)).slice(0,5e4)):w.median(p),b=i(t),v=i(e);let h=0,P=0,A=0;for(let p=0;p<u;p++)t[p]<=b&&(h+=t[p]),e[p]<=v&&(P+=e[p]),A+=e[p];return Math.max(0,(h-P)/A)}export function calcIRR(n,s=.1,l=100,u=1e-6){const o=m=>n.reduce((t,e,i)=>t+e/Math.pow(1+m,i),0);let c=s,a=s+.05;for(let m=0;m<l;m++){const t=o(c),e=o(a),i=e-t;if(Math.abs(i)<1e-10)return null;const b=a-e*(a-c)/i;if(Math.abs(b-a)<u)return b;c=a,a=b}return null}export function calcMIRR(n,s,l){const u=n.length-1,o=n.map(t=>t>0?t:0),c=n.map(t=>t<0?t:0),a=o.reduce((t,e,i)=>t+e*Math.pow(1+l,u-i),0),m=c.reduce((t,e,i)=>t+e/Math.pow(1+s,i),0);return m===0||a<=0?null:Math.pow(a/Math.abs(m),1/u)-1}export function npvDiscreteCumulative(n,s){return n.map((l,u)=>n.slice(0,u+1).reduce((o,c,a)=>o+c/Math.pow(1+s,a),0))}function f(n,s=.1,l=.5,u=.9){const o=n.filter(c=>Number.isFinite(c)).sort((c,a)=>c-a);return{p10:w.quantileSorted(o,s)??null,p50:w.quantileSorted(o,l)??null,p90:w.quantileSorted(o,u)??null,mean:o.length?w.mean(o):null,n:o.length}}function I(n,s,l){if(!(n<=s&&s<=l))return s;const u=Math.random(),o=(s-n)/(l-n||1);return u<o?n+Math.sqrt(u*(l-n)*(s-n)):l-Math.sqrt((1-u)*(l-n)*(l-s))}export function avlossCalcUncertainty(n,s,{runs:l=9,reps:u=2e5,approx:o=!0,qLow:c=.1,qMid:a=.5,qHigh:m=.9}={}){const t=Array.from({length:l},()=>Math.abs(avlossCalc(n,s,!1,u,o)??0));return{...f(t,c,a,m),samples:t}}export function runSimulationFromCashflowRows(n,{simulations:s=2e3,yearKey:l="year",benefitKey:u="project_benefit",costKey:o="cost",discountRate:c=null,benefitScale:a={low:1,mode:1,high:1},costScale:m={low:1,mode:1,high:1},qLow:t=.1,qMid:e=.5,qHigh:i=.9}={}){if(!Array.isArray(n)||n.length===0)return{simulations:0,yearly:[],final:{npv:f([],t,e,i),irr:f([],t,e,i),mirr:f([],t,e,i),bcr:f([],t,e,i),probNpvPositive:null,probBcrAbove1:null}};const b=[...n].filter(r=>Number.isFinite(r?.[l])).sort((r,F)=>r[l]-F[l]),v=c??b.find(r=>Number.isFinite(r.discount_rate))?.discount_rate??.12,h=[];for(let r=0;r<s;r++){const F=I(a.low,a.mode,a.high),C=I(m.low,m.mode,m.high),y=b.map(d=>(Number(d[u])||0)*F),x=b.map(d=>(Number(d[o])||0)*C),N=y.map((d,V)=>d-x[V]),S=npvDiscreteCumulative(N,v),R=npvDiscreteCumulative(y,v),W=npvDiscreteCumulative(x,v),g=R.map((d,V)=>{const _=W[V];return _===0?null:d/_}),j=N.map((d,V)=>{const _=calcIRR(N.slice(0,V+1));return _==null?null:_*100}),D=N.map((d,V)=>{const _=calcMIRR(N.slice(0,V+1),v,v);return _==null?null:_*100});h.push({npvSeries:S,bcrSeries:g,irrSeries:j,mirrSeries:D,irrFinal:calcIRR(N),mirrFinal:calcMIRR(N,v,v)})}const P=b.map((r,F)=>{const C=h.map(S=>S.npvSeries[F]).filter(Number.isFinite),y=h.map(S=>S.bcrSeries[F]).filter(Number.isFinite),x=h.map(S=>S.irrSeries[F]).filter(Number.isFinite),N=h.map(S=>S.mirrSeries[F]).filter(Number.isFinite);return{year:r[l],npv:f(C,t,e,i),bcr:f(y,t,e,i),irr:f(x,t,e,i),mirr:f(N,t,e,i)}}),A=h.map(r=>r.npvSeries.at(-1)).filter(Number.isFinite),p=h.map(r=>r.irrFinal==null?null:r.irrFinal*100).filter(Number.isFinite),B=h.map(r=>r.mirrFinal==null?null:r.mirrFinal*100).filter(Number.isFinite),M=h.map(r=>r.bcrSeries.at(-1)).filter(Number.isFinite);return{simulations:s,yearly:P,final:{npv:f(A,t,e,i),irr:f(p,t,e,i),mirr:f(B,t,e,i),bcr:f(M,t,e,i),probNpvPositive:A.length?A.filter(r=>r>0).length/A.length:null,probBcrAbove1:M.length?M.filter(r=>r>1).length/M.length:null}}}
