---
pagetitle: "Identifying Climate Information Readiness"
nb-authors:
  - Johnson Mwakazi
  - Brayden Youngberg
  - Pete Stewart
  - Shalika Vyas
  - Harold Achicanoy
date-created: "2025-11-17"
date-edited: today
---

```{ojs}
// Load translations first
cis = await FileAttachment("/data/cis/translations.json").json()
```

```{ojs}
// Import all UI components - these MUST be imported before any code that uses them
import { atlasHero, downloadButton } from "/helpers/uiComponents.ojs"
import { atlasTOC, tocStyle } from "/helpers/toc.ojs"
import { dropdownInput as multiSelect, dropdownCSS } from "/helpers/multiSelect.ojs"
```

```{ojs}
// Global registry to track all child selectors for each master
// This is a plain object at module scope
selectorRegistry = ({
  admin0: {},
  admin1: {},
  admin2: {}
})
```

```{ojs}
// Helper function to update a selector's DOM to match a value
updateSelectorDOM = function(selectorForm, newValue, optionsArray, placeholderKey) {
  const selectInput = selectorForm.querySelector('select.dropdown-select');
  const dropdownList = selectorForm.querySelector('ul.dropdown-list');
  const dropdownButton = selectorForm.querySelector('.dropdown-button button');
  
  if (!selectInput) return;
  
  // Update the hidden select element
  Array.from(selectInput.options).forEach(option => {
    option.selected = newValue.includes(option.value);
  });
  
  // Update the form value
  selectorForm.value = newValue;
  
  // Update the visual dropdown list items
  if (dropdownList) {
    const listItems = dropdownList.querySelectorAll('li');
    listItems.forEach(li => {
      const value = li.id;
      if (newValue.includes(value)) {
        li.classList.add('selected');
      } else {
        li.classList.remove('selected');
      }
    });
  }
  
  // Update placeholder text
  if (dropdownButton) {
    const filterSelected = dropdownButton.querySelector('.filter-selected');
    if (filterSelected) {
      if (newValue.length > 0) {
        const labels = optionsArray
          .filter(opt => newValue.includes(opt.value))
          .map(opt => typeof opt.label === 'string' ? opt.label : (opt.label?.outerHTML || String(opt.label)));
        filterSelected.innerHTML = labels.join(', ');
      } else {
        filterSelected.innerHTML = _lang(cis[placeholderKey]);
      }
    }
  }
}
```

```{ojs}
// Helper function to create synchronized admin selectors
createSyncedAdminSelector = function(level, masterView, masterValue, options, uniqueId, labelKey, placeholderKey) {
  const levelKey = `admin${level}`;
  const registry = selectorRegistry[levelKey];
  
  // Check if selector already exists for this uniqueId
  if (registry[uniqueId]) {
    const entry = registry[uniqueId];
    // Update the selector's DOM to match current master value
    updateSelectorDOM(entry.selector, masterValue, options, placeholderKey);
    // Update options in registry
    entry.options = options;
    return entry.selector;
  }
  
  // Create a new selector initialized with the current master value
  const selector = multiSelect({
    inputLabel: _lang(cis[labelKey]),
    inputId: `admin${level}Select-${uniqueId}`,
    placeholderText: _lang(cis[placeholderKey]),
    options: options,
    selected: masterValue.slice(), // Initialize with current master value
    maxSelections: 10
  });
  
  // Register this selector in the registry
  registry[uniqueId] = { selector, options, placeholderKey };
  
  // Flag to prevent circular updates
  let isUpdating = false;
  
  // When this selector changes, update the master selector and all other child selectors
  selector.addEventListener('input', () => {
    if (isUpdating) return;
    isUpdating = true;
    
    const newValue = selector.value;
    
    // Update master view's value directly
    masterView.value = newValue;
    
    // Update master selector's DOM
    updateSelectorDOM(masterView, newValue, options, placeholderKey);
    
    // Update all other child selectors for this level (except this one)
    Object.keys(registry).forEach(id => {
      if (id !== uniqueId) {
        const entry = registry[id];
        updateSelectorDOM(entry.selector, newValue, entry.options, entry.placeholderKey);
      }
    });
    
    // Dispatch input event to trigger reactivity
    masterView.dispatchEvent(new CustomEvent('input', { bubbles: true }));
    
    isUpdating = false;
  });
  
  // Listen to master's input events to update this selector
  const masterListener = () => {
    if (isUpdating) return;
    isUpdating = true;
    
    const newValue = masterView.value;
    const currentValue = selector.value;
    if (JSON.stringify(newValue) !== JSON.stringify(currentValue)) {
      updateSelectorDOM(selector, newValue, options, placeholderKey);
    }
    
    isUpdating = false;
  };
  
  masterView.addEventListener('input', masterListener);
  
  // Store the listener so we can clean it up if needed
  selector._masterListener = masterListener;
  selector._uniqueId = uniqueId;
  
  return selector;
}
```

```{ojs}
// Language setup - MUST be defined before includes and any code that uses _lang
import { lang as Lang } from "/helpers/lang.js"

general_translations = await FileAttachment("/data/shared/generalTranslations.json").json()

languages = [
  { key: "en", label: "English", locale: 'en-US' },
  { key: "fr", label: "Français", locale: 'fr-FR' }
]

defaultLangKey = {
  const name = "lang";
  const list = languages.map((d) => d.key);
  const defaultKey = "en";
  const queryParam = await Lang.getParamFromList({ name, list });
  return queryParam ?? defaultKey;
}

viewof masterLanguage = Inputs.radio(languages, {
  label: "Main language toggle",
  format: (d) => d.key,
  value: languages.find((x) => x.key === defaultLangKey),
})

_lang = Lang.lg(masterLanguage.key)
```

```{ojs}
//| echo: false

// Hero section - nbTitle and hero_url are defined in source code section
hero_url = "./../../images/default_crop.webp";
nbTitle = _lang({
  en: "Identifying Climate Information Readiness",
  fr: "Identifiant la Readiness des informations climatiques",
});
atlasHero(nbTitle, hero_url);
```


```{ojs}
overviewTitle = _lang(cis.overviewTitle);
overviewContent = _lang(cis.overviewContent);

```

# `{ojs} overviewTitle` {#overviewTitle}

`{ojs} overviewContent` 


{{< include _cis_readiness_index.qmd >}}

{{< include _cis_hazard_intersection.qmd >}}

{{< include _cis_implementation.qmd >}}

# `{ojs} appendix` {#appendix}

```{ojs}
toc_bottom = atlasTOC({
  skip: ["notebook-title", "appendix", "source-code"], // These should be the section headings in the {# headings}
  heading: `${Lang.toSentenceCase(_lang(general_translations.toc))}`,
});

htl.html`
      ${tocStyle}
      ${toc_bottom}
      `;
```

# Source code {#source-code .hidden}

<!--
NOTE:Everything below this point will not appear in the notebook.
This is useful to hide all of the code, master selectors (language, admin level, etc.),
and other things that are needed for the notebook to run but would be messy if
actually appearing in the notebook.
-->

<!-- Import UI Components FIRST -->
<!-- NOTE: Imports have been moved to the top of the file (after translations) to ensure they're available to all cells -->

<!-- Text and Language Translations -->

```{ojs}
// This cell is to contain headings used elsewhere
// (nbTitle is now defined earlier before the includes)
// key_insights = _lang({en: "Key Insights", fr: "Résumé"})
heading1 = _lang({ en: "Heading 1", fr: "Titre 1" });
heading2 = _lang({ en: "Heading 2", fr: "Titre 2" });
heading3 = _lang({ en: "Heading 3", fr: "Titre 3" });
heading4 = _lang({ en: "Heading 4", fr: "Titre 4" });
nbSummary = _lang({ en: "Summary", fr: "Résumé" });
appendix = _lang(general_translations.appendix);
```

```{ojs}
mutable hoverCountry = "SSA" // This mutable is defined here and updated in _template_plot.qmd. It should only be defined once.

keyInsights = {
  let template = _lang({
        en: `This is where some key insights should go, they will be dynamic based on the selections such as country (**:::country:::**) and crop type (**:::cropType:::**)`,
        fr: `Ceci est là où les résumés clés devraient être, ils seront dynamiques en fonction des sélections comme pays (**:::country:::**) et type de culture (**:::cropType:::**)`
  })

  let fill_items = [
      { name: "country", value: hoverCountry },
      { name: "cropType", value: _lang({en: 'potatoes', fr: 'pomme de terre'}) }
    ]
  let keyText =  md`${Lang.reduceReplaceTemplateItems(template, fill_items)}`
  return keyText
}
```


```{ojs}
// import { NavbarLangSelector } from "/helpers/uiComponents.ojs"
function NavbarLangSelector(language_obj, masterLanguage) {
  let navEnd = document.querySelector(".navbar-nav.ms-auto .nav-item.compact");
  if (navEnd) {
    let existingLangSelector = document.getElementById("nav-lang-selector");
    if (!existingLangSelector) {
      let lang_sel = Inputs.bind(
        Inputs.radio(language_obj, {
          label: "",
          format: (d) => d.label
        }),
        viewof masterLanguage
      );
      lang_sel.id = "nav-lang-selector";

      // Hack the css together for the observable inputs
      lang_sel.style.display = "flex";
      lang_sel.style.alignItems = "center";
      lang_sel.style.marginLeft = "10px";
      let lang_div = lang_sel.querySelector("div");
      lang_div.style.display = "flex";
      lang_div.style.flexDirection = "column";

      // Insert the new item after the GitHub icon and other elements
      navEnd.parentNode.appendChild(lang_sel);
    }
  }
}

NavbarLangSelector(languages, masterLanguage)
```

```{ojs}
prettyLanguageView = {
  return Inputs.bind(
    Inputs.radio(languages, {
      label: _lang(general_translations.language),
      format: (d) => d.label
    }),
    viewof masterLanguage
  );
}
```

<!--

# Prototypes for future use to hack a sidebar into notebooks:

{.column-margin}

```{ojs}
htl.html`
<style>
.sticky-margin-div {
  position: fixed;
  }
@media (max-width: 768px) {
  .sticky-margin-div {
    position: static;
    }
}
</style>

<div class = "sticky-margin-div">
    <div>
      ${Inputs.radio(languages, {
        label: "Main language toggle",
        format: (d) => d.key,
        value: languages.find((x) => x.key === defaultLangKey),
      })}
    </div>
  </div>`
```

:-::

-->

<!-- Floating Sidebar: Self-contained HTML, CSS, and JS -->
<!--
<div id="floating-sidebar">

</div>

<style>
  #floating-sidebar {
    position: fixed;
    top: 150px;           /* Distance from top of the page */
    left: 20px;          /* Distance from left of the page */
    width: 260px;        /* Sidebar width */
    min-height: 400px;   /* Minimum height */
    max-height: 80vh;    /* Max height relative to viewport */
    background: #ffffff;
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    border-radius: 8px;
    padding: 20px;
    overflow-y: auto;
    z-index: 9999;
    transition: box-shadow 0.2s;
  }
  #floating-sidebar:hover {
    box-shadow: 0 8px 24px rgba(0,0,0,0.18);
  }
  /* Responsive: hide on small screens */
  @media (max-width: 800px) {
    #floating-sidebar {
      display: none;
    }
  }
</style>

<script>
  // Optional: Add any JS for interactivity here
  // Example: Toggle sidebar visibility with a keyboard shortcut (Ctrl+B)
  document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'b') {
      const sidebar = document.getElementById('floating-sidebar');
      sidebar.style.display = (sidebar.style.display === 'none') ? 'block' : 'none';
    }
  });
</script> -->
